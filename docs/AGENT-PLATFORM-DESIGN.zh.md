# Vitamin-Code é€šç”¨ Agent å¹³å°è®¾è®¡æ–¹æ¡ˆ

> Vitamin-Code é€šç”¨ Agent å¹³å°è®¾è®¡æ–¹æ¡ˆï¼Œèåˆ Swarm èœ‚ç¾¤æ™ºèƒ½ã€Google Agents ç™½çš®ä¹¦æ ¸å¿ƒç†å¿µã€Aime åŠ¨æ€è§„åˆ’æ¶æ„ä¸ oh-my-opencode å®æˆ˜ç»éªŒ

## ç›®å½•

- [1. è®¾è®¡ç›®æ ‡](#1-è®¾è®¡ç›®æ ‡)
  - [1.1 æ ¸å¿ƒç›®æ ‡](#11-æ ¸å¿ƒç›®æ ‡)
  - [1.2 è®¾è®¡åŸåˆ™](#12-è®¾è®¡åŸåˆ™)
  - [1.3 Swarm èœ‚ç¾¤æ ¸å¿ƒå“²å­¦](#13-swarm-èœ‚ç¾¤æ ¸å¿ƒå“²å­¦)
  - [1.4 Google Agents ç™½çš®ä¹¦æ ¸å¿ƒç†å¿µ](#14-google-agents-ç™½çš®ä¹¦æ ¸å¿ƒç†å¿µ)
  - [1.5 Oh-My-OpenCode å®æˆ˜å“²å­¦](#15-oh-my-opencode-å®æˆ˜å“²å­¦)
    - [1.5.1 æ ¸å¿ƒå“²å­¦ï¼šè§„åˆ’ä¸æ‰§è¡Œåˆ†ç¦»](#151-æ ¸å¿ƒå“²å­¦è§„åˆ’ä¸æ‰§è¡Œåˆ†ç¦»)
    - [1.5.2 Category + Skill è·¯ç”±ç³»ç»Ÿ](#152-category--skill-è·¯ç”±ç³»ç»Ÿ)
    - [1.5.3 ä¸“ä¸š Agent çŸ©é˜µè®¾è®¡åŸåˆ™](#153-ä¸“ä¸š-agent-çŸ©é˜µè®¾è®¡åŸåˆ™)
    - [1.5.4 é‡è§„åˆ’è§¦å‘æœºåˆ¶](#154-é‡è§„åˆ’è§¦å‘æœºåˆ¶)
  - [1.6 å¤šæºæ¶æ„èåˆè¯´æ˜](#16-å¤šæºæ¶æ„èåˆè¯´æ˜)
    - [1.6.1 OpenCode å‚è€ƒ â€” åŸºåº§å¹³å°](#161-opencode-å‚è€ƒ--åŸºåº§å¹³å°)
    - [1.6.2 oh-my-opencode â€” è§„åˆ’/æ‰§è¡Œåˆ†ç¦»ä¸æŠ€èƒ½è·¯ç”±](#162-oh-my-opencode--è§„åˆ’--æ‰§è¡Œåˆ†ç¦»ä¸æŠ€èƒ½è·¯ç”±)
    - [1.6.3 Swarm-IDE â€” æ¶²æ€æ‹“æ‰‘ä¸æç®€åä½œåŸè¯­](#163-swarm-ide--æ¶²æ€æ‹“æ‰‘ä¸æç®€åä½œåŸè¯­)
    - [1.6.4 Aime â€” åŠ¨æ€è§„åˆ’å½¢å¼åŒ–](#164-aime-arxiv250711988--åŠ¨æ€è§„åˆ’å½¢å¼åŒ–)
    - [1.6.5 åˆ†å±‚èåˆæ€»è§ˆ](#165-åˆ†å±‚èåˆæ€»è§ˆ)
- [2. æ¶æ„æ¦‚è§ˆ](#2-æ¶æ„æ¦‚è§ˆ)
- [3. æ ¸å¿ƒæŠ½è±¡å±‚è®¾è®¡](#3-æ ¸å¿ƒæŠ½è±¡å±‚è®¾è®¡)
  - [3.4 Grounding çŸ¥è¯†æ¥åœ°ç³»ç»Ÿ](#34-grounding-çŸ¥è¯†æ¥åœ°ç³»ç»Ÿ)
  - [3.5 Memory è®°å¿†ç³»ç»Ÿ](#35-memory-è®°å¿†ç³»ç»Ÿ)
  - [3.6 æŒä¹…åŒ–å­˜å‚¨ç­–ç•¥](#36-æŒä¹…åŒ–å­˜å‚¨ç­–ç•¥)
- [4. Agent æ³¨å†Œç³»ç»Ÿ](#4-agent-æ³¨å†Œç³»ç»Ÿ)
- [5. Tool æ³¨å†Œç³»ç»Ÿ](#5-tool-æ³¨å†Œç³»ç»Ÿ)
- [6. Workflow ç¼–æ’ç³»ç»Ÿ](#6-workflow-ç¼–æ’ç³»ç»Ÿ)
  - [6.5 æ ¸å¿ƒåŠ¨æ€è§„åˆ’å™¨ (Dynamic Planner)](#65-æ ¸å¿ƒåŠ¨æ€è§„åˆ’å™¨-dynamic-planner)
    - [6.5.1 è®¾è®¡åŠ¨æœºä¸é—®é¢˜åˆ†æ](#651-è®¾è®¡åŠ¨æœºä¸é—®é¢˜åˆ†æ)
    - [6.5.2 åŠ¨æ€è§„åˆ’å™¨æ¶æ„æ€»è§ˆ](#652-åŠ¨æ€è§„åˆ’å™¨æ¶æ„æ€»è§ˆ)
    - [6.5.3 é¢†åŸŸåˆ†æå™¨ (Domain Analyzer)](#653-é¢†åŸŸåˆ†æå™¨-domain-analyzer)
    - [6.5.4 åŠ¨æ€è§„åˆ’å™¨æ ¸å¿ƒ (Dynamic Planner Core)](#654-åŠ¨æ€è§„åˆ’å™¨æ ¸å¿ƒ-dynamic-planner-core)
    - [6.5.5 Actor å·¥å‚ (Actor Factory)](#655-actor-å·¥å‚-actor-factory)
    - [6.5.6 è¿›åº¦ç®¡ç†æ¨¡å— (Progress Management)](#656-è¿›åº¦ç®¡ç†æ¨¡å—-progress-management)
    - [6.5.7 å¹¶è¡Œè°ƒåº¦ (Parallel Orchestration)](#657-å¹¶è¡Œè°ƒåº¦-parallel-orchestration)
    - [6.5.8 å®Œæ•´å·¥ä½œæµç¨‹](#658-å®Œæ•´å·¥ä½œæµç¨‹)
    - [6.5.9 è‡ªåŠ© Agent æåˆæ¥å£](#659-è‡ªåŠ©-agent-æåˆæ¥å£)
- [7. Swarm èœ‚ç¾¤åŠ¨æ€æ‰©å®¹ç³»ç»Ÿ](#7-swarm-èœ‚ç¾¤åŠ¨æ€æ‰©å®¹ç³»ç»Ÿ)
  - [7.10 å¤šæœºæ‰©å®¹ä¸æœåŠ¡å‘ç°](#710-å¤šæœºæ‰©å®¹ä¸æœåŠ¡å‘ç°)
  - [7.11 å‰ç«¯å…¥å£ä¸å¼‚æ­¥ä»»åŠ¡é“¾è·¯](#711-å‰ç«¯å…¥å£ä¸å¼‚æ­¥ä»»åŠ¡é“¾è·¯)
- [8. Web äº§å“ç³»ç»Ÿ](#8-web-äº§å“ç³»ç»Ÿ)
  - [8.1 äº§å“å®šä½ä¸å‚è€ƒ](#81-äº§å“å®šä½ä¸å‚è€ƒ)
  - [8.2 Spaceï¼ˆé¡¹ç›®ç©ºé—´ï¼‰æ¨¡å‹](#82-spaceé¡¹ç›®ç©ºé—´æ¨¡å‹)
  - [8.3 ç”¨æˆ·ç«¯ï¼ˆUser Appï¼‰](#83-ç”¨æˆ·ç«¯user-app)
  - [8.4 ç®¡ç†ç«¯ï¼ˆAdmin Appï¼‰](#84-ç®¡ç†ç«¯admin-app)
  - [8.5 å‰ç«¯æŠ€æœ¯æ¶æ„](#85-å‰ç«¯æŠ€æœ¯æ¶æ„)
  - [8.6 API è·¯ç”±æ€»è§ˆ](#86-api-è·¯ç”±æ€»è§ˆ)
- [9. åœºæ™¯æ¨¡æ¿ç³»ç»Ÿ](#9-åœºæ™¯æ¨¡æ¿ç³»ç»Ÿ)
  - [9.1 æ¨¡æ¿å®šä¹‰](#91-æ¨¡æ¿å®šä¹‰)
  - [9.2 é¢„ç½®æ¨¡æ¿](#92-é¢„ç½®æ¨¡æ¿)
  - [9.3 åŠ¨æ€æ¨¡æ¿æåˆç³»ç»Ÿ](#93-åŠ¨æ€æ¨¡æ¿æåˆç³»ç»Ÿ)
    - [9.3.1 è®¾è®¡åŠ¨æœº](#931-è®¾è®¡åŠ¨æœº)
    - [9.3.2 æ¨¡æ¿è§£æè·¯ç”±å™¨ï¼ˆTemplate Resolution Routerï¼‰](#932-æ¨¡æ¿è§£æè·¯ç”±å™¨template-resolution-router)
    - [9.3.3 æ„å›¾åˆ†æå™¨ï¼ˆIntent Analyzerï¼‰](#933-æ„å›¾åˆ†æå™¨intent-analyzer)
    - [9.3.4 æ¨¡æ¿åˆæˆå™¨ï¼ˆTemplate Synthesizerï¼‰](#934-æ¨¡æ¿åˆæˆå™¨template-synthesizer)
    - [9.3.5 åˆæˆæ¨¡æ¿éªŒè¯ä¸æ²™ç›’è¯•è·‘](#935-åˆæˆæ¨¡æ¿éªŒè¯ä¸æ²™ç›’è¯•è·‘)
    - [9.3.6 æ¨¡æ¿ç¼“å­˜ä¸å­¦ä¹ ](#936-æ¨¡æ¿ç¼“å­˜ä¸å­¦ä¹ )
    - [9.3.7 å®Œæ•´æµç¨‹ç¤ºæ„](#937-å®Œæ•´æµç¨‹ç¤ºæ„)
    - [9.3.8 ç¤ºä¾‹åœºæ™¯](#938-ç¤ºä¾‹åœºæ™¯)
- [10. æƒé™ä¸å®‰å…¨](#10-æƒé™ä¸å®‰å…¨)
- [11. Agent è¯„ä¼°ä½“ç³»](#11-agent-è¯„ä¼°ä½“ç³»)
  - [11.1 è¯„ä¼°çš„åŸºæœ¬æ¦‚å¿µ](#111-è¯„ä¼°çš„åŸºæœ¬æ¦‚å¿µ)
  - [11.2 ä¸ºä»€ä¹ˆéœ€è¦è¯„ä¼°ä½“ç³»](#112-ä¸ºä»€ä¹ˆéœ€è¦è¯„ä¼°ä½“ç³»)
  - [11.3 è¯„åˆ†å™¨ç±»å‹](#113-è¯„åˆ†å™¨ç±»å‹)
  - [11.4 èƒ½åŠ›è¯„ä¼° vs å›å½’è¯„ä¼°](#114-èƒ½åŠ›è¯„ä¼°-vs-å›å½’è¯„ä¼°)
  - [11.5 ä¸åŒç±»å‹ Agent çš„è¯„ä¼°æ–¹æ³•](#115-ä¸åŒç±»å‹-agent-çš„è¯„ä¼°æ–¹æ³•)
    - [11.5.1 ç¼–ç  Agent](#1151-ç¼–ç -agent)
    - [11.5.2 å¯¹è¯ Agent](#1152-å¯¹è¯-agent)
    - [11.5.3 ç ”ç©¶ Agent](#1153-ç ”ç©¶-agent)
    - [11.5.4 è®¡ç®—æœºæ“ä½œ Agent](#1154-è®¡ç®—æœºæ“ä½œ-agent)
  - [11.6 å¤„ç†éç¡®å®šæ€§](#116-å¤„ç†éç¡®å®šæ€§)
  - [11.7 è¯„ä¼°ä½“ç³»æ„å»ºè·¯çº¿å›¾](#117-è¯„ä¼°ä½“ç³»æ„å»ºè·¯çº¿å›¾)
    - [11.7.1 æ”¶é›†ä»»åŠ¡](#1171-æ”¶é›†ä»»åŠ¡)
    - [11.7.2 è®¾è®¡è¯„åˆ†å™¨](#1172-è®¾è®¡è¯„åˆ†å™¨)
    - [11.7.3 é•¿æœŸç»´æŠ¤](#1173-é•¿æœŸç»´æŠ¤)
  - [11.8 è¯„ä¼°çš„å±€é™æ€§ä¸äº’è¡¥æ‰‹æ®µ](#118-è¯„ä¼°çš„å±€é™æ€§ä¸äº’è¡¥æ‰‹æ®µ)
  - [11.9 æ¨èè¯„ä¼°æ¡†æ¶](#119-æ¨èè¯„ä¼°æ¡†æ¶)
- [12. å¯è§†åŒ–è°ƒè¯•ç³»ç»Ÿ](#12-å¯è§†åŒ–è°ƒè¯•ç³»ç»Ÿ)
  - [12.1 è®¾è®¡ç›®æ ‡](#121-è®¾è®¡ç›®æ ‡)
  - [12.2 è°ƒè¯•ç³»ç»Ÿæ¶æ„](#122-è°ƒè¯•ç³»ç»Ÿæ¶æ„)
  - [12.3 æ–­ç‚¹ç±»å‹ä¸è°ƒè¯•äº‹ä»¶](#123-æ–­ç‚¹ç±»å‹ä¸è°ƒè¯•äº‹ä»¶)
  - [12.4 è°ƒè¯•å¼•æ“å®ç°](#124-è°ƒè¯•å¼•æ“å®ç°)
  - [12.5 è°ƒè¯• API](#125-è°ƒè¯•-api)
  - [12.6 å‰ç«¯è°ƒè¯•é¢æ¿è®¾è®¡](#126-å‰ç«¯è°ƒè¯•é¢æ¿è®¾è®¡)
  - [12.7 è°ƒè¯•æ—¶åº â€” å®Œæ•´é“¾è·¯](#127-è°ƒè¯•æ—¶åº--å®Œæ•´é“¾è·¯)
  - [12.8 è½¨è¿¹å›æ”¾ä¸å¯¹æ¯”åˆ†æ](#128-è½¨è¿¹å›æ”¾ä¸å¯¹æ¯”åˆ†æ)
  - [12.9 æ€§èƒ½å½±å“ä¸ç”Ÿäº§å®‰å…¨](#129-æ€§èƒ½å½±å“ä¸ç”Ÿäº§å®‰å…¨)
- [13. å®ç°è·¯çº¿å›¾](#13-å®ç°è·¯çº¿å›¾)
- [14. API è®¾è®¡](#14-api-è®¾è®¡)
- [15. ç¤ºä¾‹åœºæ™¯](#15-ç¤ºä¾‹åœºæ™¯)
  - [15.1 æ¨¡æ¿é©±åŠ¨åœºæ™¯](#151-æ¨¡æ¿é©±åŠ¨åœºæ™¯)
  - [15.2 Swarm èœ‚ç¾¤åä½œåœºæ™¯](#152-swarm-èœ‚ç¾¤åä½œåœºæ™¯)

---

## 1. è®¾è®¡ç›®æ ‡

### 1.1 æ ¸å¿ƒç›®æ ‡

å°† Vitamin-Code æ‰“é€ ä¸ºä¸€ä¸ª**é€šç”¨ Agent å¹³å°**ï¼Œæ”¯æŒï¼š

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| éœ€æ±‚åˆ†æ | åˆ†æç”¨æˆ·æ•…äº‹ã€æå–åŠŸèƒ½ç‚¹ã€è¯†åˆ«è¾¹ç•Œæ¡ä»¶ |
| éœ€æ±‚æ–‡æ¡£ | æ’°å†™ PRDã€æŠ€æœ¯è®¾è®¡æ–‡æ¡£ã€API æ–‡æ¡£ |
| BUG ä¿®å¤ | é—®é¢˜å®šä½ã€æ ¹å› åˆ†æã€ä¿®å¤æ–¹æ¡ˆã€éªŒè¯æµ‹è¯• |
| ç‰¹æ€§å¼€å‘ | éœ€æ±‚ç†è§£ â†’ è®¾è®¡ â†’ å®ç° â†’ æµ‹è¯• â†’ æ–‡æ¡£ |
| ä»£ç å®¡æŸ¥ | ä»£ç è´¨é‡ã€å®‰å…¨æ€§ã€æ€§èƒ½ã€æœ€ä½³å®è·µ |
| é¡¹ç›®ç®¡ç† | ä»»åŠ¡åˆ†è§£ã€è¿›åº¦è·Ÿè¸ªã€é£é™©è¯„ä¼° |
| çŸ¥è¯†ç®¡ç† | æ–‡æ¡£ç”Ÿæˆã€çŸ¥è¯†åº“æ„å»ºã€é—®ç­”ç³»ç»Ÿ |

### 1.2 è®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è®¾è®¡åŸåˆ™                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. å¯æ‰©å±•æ€§ - æ–° Agent/Tool å¯çƒ­æ’æ‹”ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç          â”‚
â”‚  2. å¯ç»„åˆæ€§ - Agent å¯ç»„åˆã€Tool å¯å¤ç”¨ã€Workflow å¯åµŒå¥—       â”‚
â”‚  3. å¯é…ç½®æ€§ - é€šè¿‡é…ç½®è€Œéä»£ç å®šä¹‰è¡Œä¸º                         â”‚
â”‚  4. å¯è§‚æµ‹æ€§ - æ‰§è¡Œè¿‡ç¨‹å¯è¿½è¸ªã€å¯å›æ”¾ã€å¯è°ƒè¯•                   â”‚
â”‚  5. å®‰å…¨æ€§   - ç»†ç²’åº¦æƒé™æ§åˆ¶ã€æ²™ç®±æ‰§è¡Œã€å®¡è®¡æ—¥å¿—               â”‚
â”‚  6. åŠ¨æ€æ€§   - Swarm èœ‚ç¾¤æ¨¡å¼ï¼ŒAgent å¯åŠ¨æ€åˆ›å»º/é”€æ¯/æ‰©å®¹       â”‚
â”‚  7. å»ä¸­å¿ƒåŒ– - æ‰å¹³åä½œï¼Œäººç±»å¯ä»‹å…¥ä»»æ„å±‚çº§                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 Swarm èœ‚ç¾¤æ ¸å¿ƒå“²å­¦

å€Ÿé‰´ Swarm-IDE çš„è®¾è®¡æ€æƒ³ï¼Œæˆ‘ä»¬å¼•å…¥ä»¥ä¸‹æ ¸å¿ƒå“²å­¦ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Swarm èœ‚ç¾¤æ ¸å¿ƒå“²å­¦                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ğŸ“Œ æç®€åŸè¯­ (Minimal Primitives)                                           â”‚
â”‚     ç³»ç»Ÿåªä¾èµ–å°‘é‡é€šä¿¡åŸè¯­å³å¯è¡¨è¾¾å¤š Agent è¡Œä¸º                             â”‚
â”‚     æ ¸å¿ƒæ˜¯ create + sendï¼Œå¤æ‚åä½œç”±æ­¤ç»„åˆè€Œæ¥                               â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Œ æ¶²æ€æ‹“æ‰‘ (Liquid Topology)                                               â”‚
â”‚     æ‹“æ‰‘ä¸é¢„è®¾ã€åœ¨è¿è¡Œä¸­è‡ªæ¼”åŒ–                                               â”‚
â”‚     é‡åˆ°å¤æ‚ä»»åŠ¡æ—¶ç”± Agent ä¸»åŠ¨"é›‡ä½£"ä¸‹å±                                    â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Œ æ‰å¹³åä½œ (Flat Collaboration)                                            â”‚
â”‚     äººç±»å¯ä»¥åƒèŠå¤©ä¸€æ ·ä»‹å…¥ä»»æ„å±‚çº§                                           â”‚
â”‚     ä½¿å¤æ‚æ‹“æ‰‘å¯è§‚å¯Ÿã€å¯è°ƒè¯•ã€å¯ä»‹å…¥                                         â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Œ ç»Ÿä¸€è§†è§’ (Unified Perspective)                                           â”‚
â”‚     ç”¨æˆ·å’Œ Agent å®Œå…¨ç­‰ä»·ï¼Œç”¨æˆ·åªæ˜¯ä¸€ç§ç‰¹æ®Šçš„ Agent                          â”‚
â”‚     æ‰€æœ‰è§†è§’å¯åˆ‡æ¢ï¼Œæ¶ˆé™¤äººæœºäº¤äº’çš„è¾¹ç•Œæ„Ÿ                                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¦‚å¿µç®€åŒ–ï¼šæ²¡æœ‰ nodes å’Œ edges çš„å¤æ‚æŠ½è±¡ï¼Œåªéœ€æŠŠç³»ç»Ÿç†è§£ä¸º"å¾ˆå¤šä¸ªäºº"ï¼š
          æ¯ä¸ªäººéƒ½èƒ½ç”Ÿå­©å­ã€ä¹Ÿèƒ½å’Œä»»æ„ä¸€ä¸ªäººè¯´è¯ã€‚
          åªè¦æœ‰è¿™ä¸¤ç§èƒ½åŠ›ï¼Œå°±èƒ½å®ç°ä»»æ„ç»“æ„ã€‚
```

### 1.4 Google Agents ç™½çš®ä¹¦æ ¸å¿ƒç†å¿µ

> åŸºäº Google "Agents" ç™½çš®ä¹¦ï¼ˆ2024ï¼‰ã€‚ä»¥ä¸‹ä¸ºç™½çš®ä¹¦æ ¸å¿ƒæ¦‚å¿µä¸æœ¬å¹³å°è®¾è®¡çš„æ˜ å°„ç´¢å¼•ï¼Œå®Œæ•´ç™½çš®ä¹¦å†…å®¹è¯·å‚é˜…åŸæ–‡ã€‚

| ç™½çš®ä¹¦æ¦‚å¿µ | è¯´æ˜ | æœ¬å¹³å°å¯¹åº”è®¾è®¡ |
|------------|------|----------------|
| **Agent è®¤çŸ¥æ¶æ„** | Agent = æ¨¡å‹ + å·¥å…· + ç¼–æ’å±‚ï¼›æœ¬è´¨æ˜¯"ä¸Šä¸‹æ–‡çª—å£ç­–å±•" | Section 3 æ ¸å¿ƒæŠ½è±¡å±‚ `ExecutionContext` |
| **Groundingï¼ˆçŸ¥è¯†æ¥åœ°ï¼‰** | é€šè¿‡å¤–éƒ¨æ•°æ®æºæ¶ˆé™¤å¹»è§‰ï¼Œæä¾›å®æ—¶çŸ¥è¯† | Section 3.4 `GroundingService` |
| **å·¥å…·ç±»å‹ä½“ç³»** | Extensionsï¼ˆAPI è°ƒç”¨ï¼‰/ Functionsï¼ˆå®¢æˆ·ç«¯æ‰§è¡Œï¼‰/ Data Storesï¼ˆå‘é‡æ£€ç´¢ï¼‰ | Section 5 Tool æ³¨å†Œç³»ç»Ÿï¼Œ`ToolCategory` åˆ†ç±» |
| **ç¼–æ’æ¨¡å¼** | ReActï¼ˆæ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯ï¼‰/ CoTï¼ˆæ€ç»´é“¾ï¼‰/ ToTï¼ˆæ€ç»´æ ‘ï¼‰/ Self-Refineï¼ˆè‡ªæˆ‘è¿­ä»£ï¼‰ | Section 2.2 `Orchestrator.patterns`ï¼ŒSection 6.5.9 `orchestrationPattern` å‚æ•° |
| **å¤š Agent åä½œ** | åè°ƒå™¨æ¨¡å¼ / é¡ºåºæµæ°´çº¿ / è¿­ä»£ä¼˜åŒ– / äººåœ¨ç¯è·¯ï¼ˆHITLï¼‰ | Section 7 Swarm èœ‚ç¾¤ç³»ç»Ÿï¼ŒSection 6 Workflow ç¼–æ’ |
| **Agentic ç³»ç»Ÿåˆ†çº§** | Level 0ï¼ˆçº¯æ¨ç†ï¼‰â†’ Level 4ï¼ˆåŠ¨æ€åˆ›å»ºæ–°èƒ½åŠ›ï¼‰ | Section 6.5.3 `ComplexityAssessment.level`ï¼Œé©±åŠ¨ `ExecutionMode` é€‰æ‹© |
| **5 æ­¥é—®é¢˜è§£å†³æµç¨‹** | è¯†åˆ« â†’ ç ”ç©¶ â†’ åˆ¶å®šç­–ç•¥ â†’ æ‰§è¡Œ â†’ éªŒè¯/å­¦ä¹  | Section 6.5.4 Dynamic Planner çš„ plan â†’ replan â†’ getNextAction å¾ªç¯ |
| **è®°å¿†ç³»ç»Ÿ** | çŸ­æœŸ / é•¿æœŸ / å·¥ä½œ / æƒ…æ™¯ / è¯­ä¹‰ / ç¨‹åºè®°å¿† | Section 3.5 `MemoryService` ç»Ÿä¸€æ¥å£ |
| **Agent ç”Ÿå‘½å‘¨æœŸ** | Create â†’ Init â†’ Runï¼ˆThink â‡„ Act â†’ Observeï¼‰â†’ Pause â†’ Terminate | Section 7.5 `AgentRunner` ä¸»å¾ªç¯ |
| **Agent Ops è¿ç»´** | KPI ä½“ç³» + å¯è§‚æµ‹æ€§ä¸‰æ”¯æŸ±ï¼ˆè¿½è¸ª/æ—¥å¿—/æŒ‡æ ‡ï¼‰+ CI/CD | Section 11 Agent è¯„ä¼°ä½“ç³» |
| **å¤š Agent è®¾è®¡æ¨¡å¼** | åè°ƒå™¨ / é¡ºåº / è¿­ä»£ä¼˜åŒ– / HITL / ä¸“å®¶å›¢é˜Ÿ | Section 7 Swarm + Section 6.1 `WorkflowStep` ç±»å‹ |
| **æ ¸å¿ƒæ´å¯Ÿ** | "æ— æ‰€ä¸èƒ½"ä½¿å…¶å¾ˆéš¾å¯é åšå¥½ä¸€ä»¶äº‹ï¼›å…¨é¢è¯„ä¼°æ¯”åˆå§‹ Prompt å½±å“æ›´é‡è¦ | Section 11 è¯„ä¼°ä½“ç³»çš„æ ¸å¿ƒè®¾è®¡åŠ¨æœº |

### 1.5 Oh-My-OpenCode å®æˆ˜å“²å­¦

> æ•´åˆ oh-my-opencode é¡¹ç›®çš„æ ¸å¿ƒè®¾è®¡ç†å¿µå’Œå®æˆ˜ç»éªŒ

#### 1.5.1 æ ¸å¿ƒå“²å­¦ï¼šè§„åˆ’ä¸æ‰§è¡Œåˆ†ç¦»

**ä¼ ç»Ÿ AI Agent çš„é—®é¢˜ï¼š** è§„åˆ’å’Œæ‰§è¡Œæ··åœ¨ä¸€èµ· â†’ ä¸Šä¸‹æ–‡æ±¡æŸ“å’Œç›®æ ‡æ¼‚ç§» â†’ äº§å‡ºä½è´¨é‡ä»£ç ï¼ˆAI slopï¼‰

**oh-my-opencode è§£å†³æ–¹æ¡ˆï¼š** ä¸¥æ ¼åŒé˜¶æ®µåˆ†ç¦»

| é˜¶æ®µ | è§’è‰² | èŒè´£ | å…³é”®çº¦æŸ |
|------|------|------|----------|
| è§„åˆ’ | Plannerï¼ˆè§„åˆ’è€…ï¼‰ | åˆ†æéœ€æ±‚ï¼Œè¾“å‡ºè®¡åˆ’ Markdown | **åªè¯»æ¨¡å¼**ï¼Œä»…å¯åˆ›å»º/ä¿®æ”¹è®¡åˆ’æ–‡ä»¶ |
| è§„åˆ’ | Advisorï¼ˆé¡¾é—®ï¼‰ | éœ€æ±‚åˆ†æã€Gap æ£€æµ‹ | æ— å†™å…¥æƒé™ |
| è§„åˆ’ | Reviewerï¼ˆå®¡æ ¸å®˜ï¼‰ | æ— æƒ…å®¡æŸ¥ï¼Œç›´åˆ°è®¡åˆ’å®Œç¾ | temp â‰¤ 0.1ï¼Œå¦å†³æƒ |
| æ‰§è¡Œ | Orchestratorï¼ˆç¼–æ’è€…ï¼‰ | ä¸»æ§ç¼–æ’ï¼Œå§”æ´¾å­ä»»åŠ¡ | Extended Thinkingï¼Œ**ä¸äº²è‡ªå†™ç ** |
| æ‰§è¡Œ | SpecialistÃ—N | æŒ‰é¢†åŸŸæ‰§è¡Œå…·ä½“ä»»åŠ¡ | å·¥å…·é›†æŒ‰è§’è‰²é™å®š |

> **oh-my-opencode å®é™…è§’è‰²æ˜ å°„ï¼š** Planner=Prometheusï¼ŒAdvisor=Metisï¼ŒReviewer=Momusï¼ŒOrchestrator=Atlasï¼ŒSpecialist åŒ…æ‹¬ Oracle/Librarian/Explore/Frontend Engineer/Multimodal Looker ç­‰

**æ ¸å¿ƒåŸåˆ™ï¼š**

- ğŸ“Œ **å•è®¡åˆ’åŸåˆ™**ï¼šæ— è®ºä»»åŠ¡å¤šå¤§ï¼Œæ‰€æœ‰ TODO éƒ½åœ¨ä¸€ä¸ª .md æ–‡ä»¶ä¸­
- ğŸ“Œ **ä¸»åŠ¨å§”æ´¾**ï¼šç¼–æ’è€…ä¸äº²è‡ªåŠ¨æ‰‹ï¼Œè€Œæ˜¯å§”æ´¾ç»™ä¸“ä¸š Agent
- ğŸ“Œ **ä¼šè¯æ¢å¤**ï¼šé€šè¿‡çŠ¶æ€æ–‡ä»¶æ”¯æŒè·¨ä¼šè¯çš„è¿›åº¦æ¢å¤

#### 1.5.2 Category + Skill è·¯ç”±ç³»ç»Ÿ

oh-my-opencode çš„æ™ºèƒ½ä»»åŠ¡è·¯ç”±æœºåˆ¶ï¼ˆå…·ä½“æ¨¡å‹ç»‘å®šç”±é…ç½®é©±åŠ¨ï¼Œä¸ç¡¬ç¼–ç ï¼‰ï¼š

| ç»„ä»¶ | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| **Category åˆ†ç±»å™¨** | è¯·æ±‚è·¯ç”± | å°†ç”¨æˆ·è¯·æ±‚åˆ†å‘åˆ°å¯¹åº”é¢†åŸŸ Agentï¼ˆcoding/search/frontend/docs/planningï¼‰ |
| **Skill æŠ€èƒ½æ³¨å…¥** | åŠ¨æ€çŸ¥è¯† | é€šè¿‡ SKILL.md æŒ‰è§¦å‘æ¡ä»¶åŠ¨æ€æ³¨å…¥ä¸“ä¸šçŸ¥è¯†ç‰‡æ®µ |
| **Bypass æœºåˆ¶** | å¿«é€Ÿé€šé“ | çŸ­è¯·æ±‚(<100å­—)/å•æ–‡ä»¶æ“ä½œ/æ˜ç¡® Category â†’ è·³è¿‡è§„åˆ’ç›´æ¥æ‰§è¡Œ |

**Skill å®šä¹‰æ ¼å¼ï¼š**

```yaml
---
name: react-best-practices
triggers:
  - "*.tsx"
  - "*.jsx"
category: frontend
---
# React æœ€ä½³å®è·µ
- ä½¿ç”¨å‡½æ•°ç»„ä»¶å’Œ Hooks
- é¿å… prop drillingï¼Œä½¿ç”¨ Context
```

**è§¦å‘æ–¹å¼ï¼š** æ–‡ä»¶ååŒ¹é…ï¼ˆ*.tsx, *.pyï¼‰ã€å…³é”®è¯åŒ¹é…ï¼ˆrefactor, debugï¼‰ã€Category è‡ªåŠ¨å…³è”

#### 1.5.3 ä¸“ä¸š Agent çŸ©é˜µè®¾è®¡åŸåˆ™

oh-my-opencode ä½¿ç”¨ 10 ä¸ªä¸“ä¸šåŒ– Agent åä½œï¼Œå…¶è§’è‰²åˆ†å±‚ä¸çº¦æŸè®¾è®¡å€¼å¾—å€Ÿé‰´ã€‚
ä»¥ä¸‹æå–**ä¸æ¨¡å‹æ— å…³**çš„è®¾è®¡åŸåˆ™ï¼ˆå…·ä½“æ¨¡å‹ç»‘å®šç”±é…ç½®å†³å®šï¼Œä¸ç¡¬ç¼–ç ï¼‰ï¼š

| å±‚çº§ | è§’è‰²ç±»å‹ | èŒè´£ | å…³é”®çº¦æŸ |
|------|---------|------|---------|
| ä¸»åŠ›å±‚ | ç¼–æ’è€… (Orchestrator) | ä¸»æ§ç¼–æ’ï¼Œå…¨å·¥å…·æƒé™ | temp â‰¤ 0.1ï¼ŒFallback é“¾ |
| ä¸»åŠ›å±‚ | è®¡åˆ’æ‰§è¡Œå™¨ (Executor) | æŒæœ‰ TODOï¼Œå§”æ´¾å­ä»»åŠ¡ | ä¸ç›´æ¥å†™ä»£ç ï¼ŒExtended Thinking |
| è§„åˆ’å±‚ | æˆ˜ç•¥è§„åˆ’å¸ˆ (Planner) | åˆ¶å®šæ–¹æ¡ˆï¼Œåªè¾“å‡º Markdown | åªè¯»æƒé™ï¼Œæ— ä»£ç å†™å…¥ |
| è§„åˆ’å±‚ | é¢„åˆ†æå™¨ (Pre-Analyzer) | Gap æ£€æµ‹ï¼Œæ„å›¾è¯†åˆ« | ä¸­ç­‰æ¸©åº¦ (0.2-0.3) |
| è§„åˆ’å±‚ | å®¡æ ¸å®˜ (Reviewer) | è®¡åˆ’å®¡æŸ¥ï¼Œè¦æ±‚ä¿®æ”¹ç›´åˆ°é€šè¿‡ | temp â‰¤ 0.1ï¼Œå¦å†³æƒ |
| ä¸“ä¸šå±‚ | é¡¾é—® (Advisor) | è°ƒè¯•ã€æˆ˜ç•¥å»ºè®® | æ— å†™/ç¼–è¾‘æƒé™ |
| ä¸“ä¸šå±‚ | æ–‡æ¡£å‘˜ (Librarian) | æ–‡æ¡£æ£€ç´¢ã€å¼€æºå®ç°æŸ¥è¯¢ | åªè¯» + æœç´¢å·¥å…· |
| ä¸“ä¸šå±‚ | æ¢ç´¢è€… (Explorer) | ä»£ç åº“å¿«é€Ÿ Grep | åªè¯»ï¼Œè½»é‡æ¨¡å‹ |
| ä¸“ä¸šå±‚ | å‰ç«¯å·¥ç¨‹å¸ˆ (Frontend) | UI/UX å¼€å‘ | é™å®šå‰ç«¯å·¥å…·é›† |
| ä¸“ä¸šå±‚ | å¤šæ¨¡æ€è§‚å¯Ÿè€… (Looker) | PDF/å›¾åƒåˆ†æ | åªè¯» |
| ä¸“ä¸šå±‚ | å­ä»»åŠ¡æ‰§è¡Œå™¨ (Junior) | å§”æ´¾ä»»åŠ¡å®é™…æ‰§è¡Œ | Category æ´¾ç”Ÿï¼Œæ— å†å§”æ´¾ |

**æ ¸å¿ƒè®¾è®¡çº¦æŸï¼š**

- **æ¸©åº¦æ§åˆ¶**ï¼šä»£ç ç”Ÿæˆç±» Agent ä¸€å¾‹ temp â‰¤ 0.1
- **å·¥å…·æœ€å°æƒé™**ï¼šæŒ‰è§’è‰²ç²¾ç¡®æ§åˆ¶å¯ç”¨å·¥å…·é›†ï¼Œåªå¼€æ”¾å¿…è¦å·¥å…·
- **æ€è€ƒé¢„ç®—**ï¼šå…³é”®å†³ç­– Agent åˆ†é… Extended Thinking é¢„ç®—
- **æ¨¡å‹å›é€€**ï¼šä¸»æ¨¡å‹ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢å¤‡é€‰ï¼Œå›é€€é“¾ç”±é…ç½®é©±åŠ¨
- **è¾“å‡ºéªŒè¯**ï¼šæ°¸ä¸ä¿¡ä»» "I'm done"ï¼Œå¿…é¡»é€šè¿‡éªŒè¯æ‰ç®—å®Œæˆ

#### 1.5.4 é‡è§„åˆ’è§¦å‘æœºåˆ¶

åŸºäº oh-my-opencode çš„ AIME åŠ¨æ€è§„åˆ’è®¾è®¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           é‡è§„åˆ’è§¦å‘æœºåˆ¶                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  è§¦å‘æ¡ä»¶ï¼š                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  äº‹ä»¶è§¦å‘                                                            â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  â€¢ onTaskFailed: { maxRetries: 2 }                                  â”‚    â”‚
â”‚  â”‚    ä»»åŠ¡å¤±è´¥è¶…è¿‡é˜ˆå€¼ â†’ è§¦å‘é‡è§„åˆ’                                     â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  â€¢ onNewEvidence: { significanceLevel: "high" }                     â”‚    â”‚
â”‚  â”‚    å‘ç°é‡è¦æ–°ä¿¡æ¯ â†’ è§¦å‘é‡è§„åˆ’                                       â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  â€¢ onDependencyBlocked: true                                        â”‚    â”‚
â”‚  â”‚    ä¾èµ–ä»»åŠ¡é˜»å¡ â†’ è§¦å‘é‡è§„åˆ’                                         â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  é˜ˆå€¼è§¦å‘                                                            â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  â€¢ progressStalled: { minutes: 5 }                                  â”‚    â”‚
â”‚  â”‚    5 åˆ†é’Ÿæ— è¿›å±• â†’ è§¦å‘é‡è§„åˆ’                                         â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  â€¢ tokenBudgetLow: { remainingPercent: 0.2 }                        â”‚    â”‚
â”‚  â”‚    Token é¢„ç®—å‰©ä½™ < 20% â†’ è§¦å‘ç­–ç•¥è°ƒæ•´                               â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  é¢‘ç‡æ§åˆ¶ï¼ˆé˜²æ­¢æ­»å¾ªç¯ï¼‰ï¼š                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  FrequencyControl:                                                   â”‚    â”‚
â”‚  â”‚    maxReplansPerPlan: 3        # å•è®¡åˆ’æœ€å¤§é‡è§„åˆ’æ¬¡æ•°                â”‚    â”‚
â”‚  â”‚    cooldownSeconds: 60         # ä¸¤æ¬¡é‡è§„åˆ’æœ€å°é—´éš”                  â”‚    â”‚
â”‚  â”‚    escalationThreshold: 3      # è¶…è¿‡æ­¤é˜ˆå€¼è¯·æ±‚äººå·¥å¹²é¢„              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  è¯„ä¼°å†³ç­–æµç¨‹ï¼š                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                                                              â”‚
â”‚  æ‰§è¡ŒçŠ¶æ€                                                                    â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚  â”‚ æ£€æŸ¥å¤±è´¥ä»»åŠ¡æ•°é‡   â”‚                                                      â”‚
â”‚  â”‚ failedCount >= 2? â”‚                                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚            â”‚                                                                 â”‚
â”‚       YES  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚            â”‚                                  â”‚                             â”‚
â”‚            â–¼                                  â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ æ£€æŸ¥é«˜é‡è¦æ€§è¯æ®   â”‚              â”‚ æ·»åŠ åŸå› ï¼š      â”‚                     â”‚
â”‚  â”‚ criticalEvidence? â”‚              â”‚ "N tasks failed"â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚            â”‚                                                                 â”‚
â”‚       YES  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚            â”‚                                  â”‚                             â”‚
â”‚            â–¼                                  â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ æ£€æŸ¥é˜»å¡ä»»åŠ¡      â”‚              â”‚ æ·»åŠ åŸå› ï¼š      â”‚                     â”‚
â”‚  â”‚ blockedTasks > 0? â”‚              â”‚ "Critical evid" â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚            â”‚                                                                 â”‚
â”‚            â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  è¿”å›ï¼š{ shouldReplan: reasons.length > 0,        â”‚                      â”‚
â”‚  â”‚         reasons: [...], priority: calculated }    â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1.6 å¤šæºæ¶æ„èåˆè¯´æ˜

æœ¬è®¾è®¡æ–¹æ¡ˆå¹¶éå…¨æ–°åˆ›é€ ï¼Œè€Œæ˜¯åœ¨æ·±å…¥åˆ†æå¤šä¸ªå‰æ²¿ Agent ç³»ç»Ÿåï¼Œæå–å„è‡ªæ ¸å¿ƒä¼˜åŠ¿å¹¶**åˆ†å±‚èåˆ**çš„äº§ç‰©ã€‚æ¯ä¸ªå‚è€ƒæºçš„è´¡çŒ®é›†ä¸­åœ¨ä¸åŒæ¶æ„å±‚æ¬¡ï¼Œé¿å…åŒå±‚ç«äº‰ã€‚

### 1.6.1 OpenCode å‚è€ƒ â€” åŸºåº§å¹³å°

| å€Ÿé‰´å±‚é¢ | å…·ä½“å†…å®¹ | æ˜ å°„ç« èŠ‚ |
|----------|----------|----------|
| Session æ¨¡å‹ | ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€æ¶ˆæ¯æŒä¹…åŒ–ã€åˆ†æ”¯ä¼šè¯ | Â§3 Session ç®¡ç† |
| Provider æŠ½è±¡ | ç»Ÿä¸€çš„ LLM æä¾›å•†æ¥å£ï¼ˆOpenAI / Anthropic / Google ç­‰ï¼‰ï¼Œçƒ­åˆ‡æ¢ | Â§5 Provider å±‚ |
| Tool æ‰§è¡Œæ¨¡å‹ | å·¥å…·æ³¨å†Œ â†’ å‚æ•°æ ¡éªŒ â†’ æ²™ç®±æ‰§è¡Œ â†’ ç»“æœå›ä¼  | Â§4 æ³¨å†Œç³»ç»Ÿ |
| å­˜å‚¨å±‚ | SQLite + æ–‡ä»¶ç³»ç»Ÿçš„æ··åˆæŒä¹…åŒ–æ–¹æ¡ˆ | Â§3.4 Storage |
| CLI å…¥å£ | å‘½ä»¤è¡Œæ¶æ„ï¼Œæ”¯æŒ headless æ¨¡å¼ | Â§8 Web äº§å“ |

**èåˆç­–ç•¥**ï¼šå¤ç”¨ OpenCode çš„ CLI æ¶æ„å’Œ Provider æ’ä»¶ä½“ç³»ä½œä¸ºåŸºç¡€è®¾æ–½å‚è€ƒï¼Œåœ¨å…¶ä¸Šå åŠ é¢†åŸŸæŠ½è±¡ï¼ˆÂ§2 Domainï¼‰å’Œ Agent åä½œå±‚ï¼ˆÂ§7 Swarmï¼‰ã€‚

### 1.6.2 oh-my-opencode â€” è§„åˆ’ / æ‰§è¡Œåˆ†ç¦»ä¸æŠ€èƒ½è·¯ç”±

| å€Ÿé‰´å±‚é¢ | å…·ä½“å†…å®¹ | æ˜ å°„ç« èŠ‚ |
|----------|----------|----------|
| è§„åˆ’/æ‰§è¡Œç‰©ç†åˆ†ç¦» | Planner åªè¯»åˆ†æ â†’ Orchestrator æ‰§è¡Œå§”æ´¾ï¼Œé˜²æ­¢"ç›´æ¥åŠ¨æ‰‹" | Â§6.5 åŠ¨æ€è§„åˆ’å™¨, Â§1.5.1 |
| Category åˆ†ç±» | è¯·æ±‚å…ˆç»åˆ†ç±»å™¨è·¯ç”±åˆ°å¯¹åº”é¢†åŸŸ Agent | Â§4 Agent æ³¨å†Œè¡¨è·¯ç”±å±‚ |
| Skill æŠ€èƒ½æ³¨å…¥ | é€šè¿‡ `SKILL.md` æŒ‰è§¦å‘æ¡ä»¶æ³¨å…¥é¢†åŸŸçŸ¥è¯†ï¼Œé›¶ä»£ç æ‰©å±• | Â§1.5.2 Category+Skill |
| Agent è§’è‰²çŸ©é˜µ | Planner / Advisor / Reviewer / Orchestrator / Specialist äº”å±‚åˆ†å·¥ | Â§1.5.1 è§„åˆ’æ‰§è¡Œåˆ†ç¦» |
| Bypass æœºåˆ¶ | ç®€å•è¯·æ±‚è·³è¿‡è§„åˆ’ç›´è¾¾æ‰§è¡Œï¼Œé™ä½å»¶è¿Ÿ | Â§1.5.2 Bypass å¿«é€Ÿé€šé“ |
| é‡è§„åˆ’è§¦å‘ | é˜»å¡æ£€æµ‹ã€å…³é”®è¯æ®ã€å¤–éƒ¨å˜æ›´é©±åŠ¨é‡æ–°è§„åˆ’ | Â§1.5.4 é‡è§„åˆ’è§¦å‘ |

**èåˆç­–ç•¥**ï¼šå°† oh-my-opencode çš„è§’è‰²çŸ©é˜µæŠ½è±¡ä¸ºå¯é…ç½®çš„ Agent æ¨¡æ¿ï¼ˆÂ§9.2ï¼‰ï¼ŒSkill å®šä¹‰æ ¼å¼ç›´æ¥å¤ç”¨å…¶ `SKILL.md` è§„èŒƒï¼ŒCategory åˆ†ç±»å™¨æ˜ å°„ä¸ºé¢†åŸŸæ³¨å†Œè¡¨çš„è·¯ç”±å±‚ã€‚

### 1.6.3 Swarm-IDE â€” æ¶²æ€æ‹“æ‰‘ä¸æç®€åä½œåŸè¯­

| å€Ÿé‰´å±‚é¢ | å…·ä½“å†…å®¹ | æ˜ å°„ç« èŠ‚ |
|----------|----------|----------|
| æç®€åŸè¯­ | ä»… `create`ï¼ˆåˆ›å»º Agentï¼‰+ `send`ï¼ˆå‘é€æ¶ˆæ¯ï¼‰ä¸¤ä¸ªæ ¸å¿ƒæ“ä½œ | Â§7.3 createAgent, Â§7.4 sendMessage |
| æ¶²æ€æ‹“æ‰‘ | æ— é¢„è®¾ç»“æ„ï¼ŒAgent åœ¨è¿è¡Œæ—¶æŒ‰éœ€"é›‡ä½£"ä¸‹å±ï¼Œçˆ¶å­å…³ç³»åŠ¨æ€æ¼”åŒ– | Â§7.2 SwarmWorkspace |
| ç»Ÿä¸€è§†è§’ | äººç±»ä½œä¸º `humanAgentId` å‚ä¸åŒä¸€æ¶ˆæ¯ç½‘ç»œï¼Œå¯éšæ—¶ä»‹å…¥ä»»æ„å±‚çº§ | Â§7.2 humanAgentId |
| å¼¹æ€§æ‰©ç¼©å®¹ | è´Ÿè½½é©±åŠ¨çš„ Agent è‡ªåŠ¨åˆ›å»º + ç©ºé—²è¶…æ—¶è‡ªåŠ¨å›æ”¶ | Â§7.7 å¼¹æ€§æ‰©ç¼©å®¹ |
| å¯è§‚æµ‹æ€§ | å®æ—¶æ‹“æ‰‘å›¾ã€æ¶ˆæ¯æµå¯è§†åŒ–ã€LLM å†å²é¢æ¿ | Â§8 Web äº§å“ |

**èåˆç­–ç•¥**ï¼šå°† Swarm-IDE çš„ `create + send` åŸè¯­ä½œä¸º Swarm ç³»ç»Ÿçš„åº•å±‚ APIï¼Œåœ¨å…¶ä¸Šå°è£… AgentRunner æ¶ˆæ¯å¾ªç¯ï¼ˆÂ§7.5ï¼‰å’Œ SwarmScaler å¼¹æ€§ç­–ç•¥ï¼ˆÂ§7.7ï¼‰ï¼Œä½¿æç®€åŸè¯­èƒ½æ‰¿è½½å¤æ‚å¤š Agent å·¥ä½œæµã€‚å…¶"æ¯ä¸ªäººéƒ½èƒ½ç”Ÿå­©å­ã€ä¹Ÿèƒ½å’Œä»»æ„ä¸€ä¸ªäººè¯´è¯"çš„å“²å­¦è´¯ç©¿æ•´ä¸ª Swarm è®¾è®¡ã€‚

### 1.6.4 Aime (arXiv:2507.11988) â€” åŠ¨æ€è§„åˆ’å½¢å¼åŒ–

| å€Ÿé‰´å±‚é¢ | å…·ä½“å†…å®¹ | æ˜ å°„ç« èŠ‚ |
|----------|----------|----------|
| åŠ¨æ€è§„åˆ’å…¬å¼ | $L_{t+1}, g_{t+1} = \text{LLM}\_\text{planner}(P, (G, L_t, H_t))$ | Â§6.5.4 DynamicPlanner |
| ActorFactory | $A_t = F\_\text{factory}(g_t)$ â€” æ ¹æ®å­ç›®æ ‡åŠ¨æ€ç»„è£…æ‰§è¡Œè€… | Â§6.5.5 ActorFactory |
| è¿›åº¦ç®¡ç† | å¤šç²’åº¦è¿›åº¦è¿½è¸ªï¼ˆå­ç›®æ ‡å®Œæˆç‡ã€æ­¥éª¤è¿›åº¦ã€ä¿¡å¿ƒåˆ†æ•°ï¼‰ | Â§6.5.6 ProgressManager |
| å¤æ‚åº¦è¯„ä¼° | åŸºäº token / å·¥å…·æ•° / ä¾èµ–æ•°çš„ä»»åŠ¡å¤æ‚åº¦é‡åŒ– | Â§6.5.3 IntentAnalyzer |

**èåˆç­–ç•¥**ï¼šé‡‡ç”¨ Aime çš„æ•°å­¦æ¡†æ¶ä¸ºåŠ¨æ€è§„åˆ’å™¨æä¾›ä¸¥æ ¼å®šä¹‰ï¼Œä½†å°†å…¶"å•ä¸€ Actor"æ¨¡å‹æ‰©å±•ä¸º Swarm èœ‚ç¾¤æ¨¡å‹ â€” ActorFactory äº§å‡ºçš„ä¸æ˜¯å•ä¸ªæ‰§è¡Œè€…ï¼Œè€Œæ˜¯ä¸€ç»„é€šè¿‡ Â§7 Swarm ç³»ç»Ÿåä½œçš„ Agent é›†ç¾¤ã€‚Aime æä¾›"è§„åˆ’ä»€ä¹ˆ"çš„å½¢å¼åŒ–ï¼ŒSwarm æä¾›"å¦‚ä½•åä½œ"çš„è¿è¡Œæ—¶ã€‚

### 1.6.5 åˆ†å±‚èåˆæ€»è§ˆ

```
è¯·æ±‚å…¥å£
  â”‚
  â”œâ”€ CLI / Web â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Vitamin-Code åŸºåº§
  â”‚
  â–¼
Category + Skill è·¯ç”± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ oh-my-opencode
  â”œâ”€ Bypass â†’ ç›´æ¥æ‰§è¡Œï¼ˆç®€å•ä»»åŠ¡ï¼‰
  â””â”€ Complex â†’ è¿›å…¥è§„åˆ’
        â”‚
        â–¼
DynamicPlanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Aime å½¢å¼åŒ–
  â”œâ”€ æ„å›¾åˆ†æ + å¤æ‚åº¦è¯„ä¼°
  â”œâ”€ ç”Ÿæˆå¸¦ä¾èµ–çš„å­ç›®æ ‡å›¾
  â””â”€ topologicalLevels å¹¶è¡Œè°ƒåº¦
        â”‚
        â–¼
ActorFactory â†’ Swarm Agent é›†ç¾¤ â”€â”€â”€â”€â”€â”€â”€â”€ Swarm-IDE åŸè¯­
  â”œâ”€ create + send æç®€åŸè¯­
  â”œâ”€ æ¶²æ€æ‹“æ‰‘ï¼ŒæŒ‰éœ€é›‡ä½£
  â””â”€ äººç±»éšæ—¶ä»‹å…¥ (humanAgentId)
        â”‚
        â–¼
Provider / Tool / Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Vitamin-Code åŸºåº§
```

> **æ ¸å¿ƒåŸåˆ™**ï¼šå„å‚è€ƒæºçš„è´¡çŒ®é›†ä¸­åœ¨ä¸åŒå±‚æ¬¡ â€” OpenCode æä¾›åŸºç¡€è®¾æ–½å‚è€ƒï¼Œoh-my-opencode æä¾›è·¯ç”±ä¸è§’è‰²æ¨¡å‹ï¼ŒAime æä¾›è§„åˆ’å½¢å¼åŒ–ï¼ŒSwarm-IDE æä¾›è¿è¡Œæ—¶åä½œåŸè¯­ï¼ˆå«å¹¶è¡Œè°ƒåº¦ï¼‰ã€‚è‡ªåº•å‘ä¸Šï¼Œæ¯å±‚åªä¾èµ–ä¸‹å±‚æ¥å£ï¼Œä¸ä¾µå…¥ä¸Šå±‚é€»è¾‘ã€‚

---

## 2. æ¶æ„æ¦‚è§ˆ

### 2.1 åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®¢æˆ·ç«¯å±‚ (Client Layer)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   CLI   â”‚  â”‚   Web   â”‚  â”‚   IDE   â”‚  â”‚   API   â”‚           â”‚
â”‚  â”‚ Terminalâ”‚  â”‚  React  â”‚  â”‚ VS Code â”‚  â”‚  REST   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚            â”‚            â”‚            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç½‘å…³å±‚ (Gateway Layer)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Hono HTTP Server + WebSocket                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ Session â”‚  â”‚  Agent  â”‚  â”‚  Tool   â”‚  â”‚Workflow â”‚  â”‚ Swarm   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  API    â”‚  â”‚  API    â”‚  â”‚  API    â”‚  â”‚  API    â”‚  â”‚  API    â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç¼–æ’å±‚ (Orchestration Layer)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Session    â”‚  â”‚   Workflow   â”‚  â”‚    Swarm     â”‚  â”‚   State      â”‚    â”‚
â”‚  â”‚   Manager    â”‚  â”‚   Engine     â”‚  â”‚  Coordinator â”‚  â”‚   Machine    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚    Event     â”‚  â”‚    Agent     â”‚  â”‚   Message    â”‚                      â”‚
â”‚  â”‚    Bus       â”‚  â”‚    Router    â”‚  â”‚    Queue     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ ¸å¿ƒå±‚ (Core Layer)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Agent Registry                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚  Code   â”‚ â”‚ Analyst â”‚ â”‚  Writer â”‚ â”‚   QA    â”‚ â”‚ Dynamic â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ Agents  â”‚ â”‚ Agents  â”‚ â”‚ Agents  â”‚ â”‚ Agents  â”‚ â”‚ Agents  â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          Tool Registry                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚  File   â”‚ â”‚  Code   â”‚ â”‚   Doc   â”‚ â”‚  Swarm  â”‚ â”‚  Data   â”‚        â”‚   â”‚
â”‚  â”‚  â”‚  Tools  â”‚ â”‚  Tools  â”‚ â”‚  Tools  â”‚ â”‚  Tools  â”‚ â”‚  Tools  â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Swarm Runtime                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚ Agent   â”‚ â”‚ Message â”‚ â”‚Topology â”‚ â”‚  Wake   â”‚ â”‚ Runner  â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ Factory â”‚ â”‚ Broker  â”‚ â”‚ Graph   â”‚ â”‚ Manager â”‚ â”‚  Pool   â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚Provider â”‚  â”‚   MCP   â”‚  â”‚ Storage â”‚  â”‚  Auth   â”‚  â”‚  Plugin â”‚           â”‚
â”‚  â”‚(AIæ¨¡å‹) â”‚  â”‚ (æ‰©å±•)  â”‚  â”‚(SQLite) â”‚  â”‚ (è®¤è¯)  â”‚  â”‚ (æ’ä»¶)  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¦‚å¿µæ¨¡å‹

```typescript
// æ ¸å¿ƒå®ä½“å…³ç³»
interface AgentPlatform {
  // æ³¨å†Œè¡¨
  agents: AgentRegistry       // Agent æ³¨å†Œè¡¨
  tools: ToolRegistry         // Tool æ³¨å†Œè¡¨
  workflows: WorkflowRegistry // Workflow æ³¨å†Œè¡¨
  templates: TemplateRegistry // åœºæ™¯æ¨¡æ¿æ³¨å†Œè¡¨
  
  // Swarm èœ‚ç¾¤è¿è¡Œæ—¶
  swarm: SwarmRuntime         // èœ‚ç¾¤è¿è¡Œæ—¶
  topology: TopologyGraph     // åŠ¨æ€æ‹“æ‰‘å›¾
  messageHub: MessageHub      // æ¶ˆæ¯ä¸­å¿ƒ
  
  // çŸ¥è¯†æ¥åœ°ç³»ç»Ÿï¼ˆGoogle Agentsï¼‰
  grounding: GroundingSystem  // çŸ¥è¯†æ¥åœ°
  memory: MemorySystem        // è®°å¿†ç³»ç»Ÿ
  orchestrator: Orchestrator  // ç¼–æ’å¼•æ“
  
  // è¿è¡Œæ—¶
  spaces: SpaceManager          // Space é¡¹ç›®ç©ºé—´ç®¡ç†ï¼ˆÂ§8.2ï¼‰
  sessions: SessionManager    // ä¼šè¯ç®¡ç†
  executor: WorkflowExecutor  // å·¥ä½œæµæ‰§è¡Œå™¨
  scheduler: TaskScheduler    // ä»»åŠ¡è°ƒåº¦å™¨
  
  // åŸºç¡€è®¾æ–½
  providers: ProviderRegistry // AI æ¨¡å‹æä¾›å•†
  plugins: PluginManager      // æ’ä»¶ç®¡ç†å™¨
  config: ConfigManager       // é…ç½®ç®¡ç†å™¨
  debug: DebugManager         // å¯è§†åŒ–è°ƒè¯•å¼•æ“ï¼ˆÂ§12ï¼‰
}

// Swarm èœ‚ç¾¤æ ¸å¿ƒæ¥å£
interface SwarmRuntime {
  // åŠ¨æ€åˆ›å»º Agent
  createAgent(spec: DynamicAgentSpec): Promise<AgentInstance>
  
  // å‘é€æ¶ˆæ¯åˆ°ä»»æ„ Agent
  sendMessage(to: AgentID, message: SwarmMessage): Promise<void>
  
  // å”¤é†’ Agent
  wakeAgent(agentId: AgentID): Promise<void>
  
  // è·å– Agent æ‹“æ‰‘
  getTopology(): TopologyGraph
  
  // é”€æ¯ Agent
  destroyAgent(agentId: AgentID): Promise<void>
}

// Grounding çŸ¥è¯†æ¥åœ°æ¥å£ï¼ˆGoogle Agentsï¼‰
interface GroundingSystem {
  // æ•°æ®æºç®¡ç†
  registerSource(source: GroundingSource): Promise<void>
  
  // çŸ¥è¯†æ£€ç´¢
  retrieve(query: string, options?: RetrievalOptions): Promise<GroundingResult[]>
  
  // RAG å¢å¼ºç”Ÿæˆ
  augment(prompt: string, context: GroundingResult[]): string
}

interface GroundingSource {
  id: string
  type: 'web_search' | 'data_store' | 'code_repo' | 'api' | 'database'
  config: Record<string, unknown>
  
  // æ£€ç´¢æ–¹æ³•
  search(query: string): Promise<GroundingResult[]>
}

// Memory è®°å¿†ç³»ç»Ÿæ¥å£ï¼ˆGoogle Agentsï¼‰
// å®Œæ•´æ¥å£å®šä¹‰è§ Section 3.5 MemoryService
interface MemorySystem {
  shortTerm: ShortTermMemory   // çŸ­æœŸè®°å¿†ï¼ˆä¼šè¯ä¸Šä¸‹æ–‡ï¼‰
  longTerm: LongTermMemory     // é•¿æœŸè®°å¿†ï¼ˆè¯­ä¹‰æ£€ç´¢ï¼‰
  working: WorkingMemory       // å·¥ä½œè®°å¿†ï¼ˆä»»åŠ¡çŠ¶æ€ï¼‰
  episodic: EpisodicMemory     // æƒ…æ™¯è®°å¿†ï¼ˆç»éªŒæ¨¡å¼ï¼‰
  consolidate(): Promise<void> // çŸ­æœŸ â†’ é•¿æœŸæ•´åˆ
  forget(criteria: ForgetCriteria): Promise<void>
}
// ShortTermMemory, LongTermMemory, WorkingMemory, EpisodicMemory
// å„å­æ¥å£è¯¦è§ Section 3.5

// Orchestrator ç¼–æ’å¼•æ“ï¼ˆGoogle Agentsï¼‰
interface Orchestrator {
  // ç¼–æ’æ¨¡å¼
  patterns: {
    react: ReActOrchestrator        // ReAct æ¨¡å¼
    cot: ChainOfThoughtOrchestrator // æ€ç»´é“¾æ¨¡å¼
    tot: TreeOfThoughtOrchestrator  // æ€ç»´æ ‘æ¨¡å¼
    selfRefine: SelfRefineOrchestrator // è‡ªæˆ‘è¿­ä»£æ¨¡å¼
  }
  
  // æ‰§è¡Œç¼–æ’
  execute(pattern: OrchestrationPattern, task: Task): Promise<Result>
}

interface ReActOrchestrator {
  // Thought â†’ Action â†’ Observation å¾ªç¯
  step(thought: string): Promise<{ action: Action; observation: string }>
  
  // æœ€å¤§è¿­ä»£æ¬¡æ•°
  maxIterations: number
}

interface ChainOfThoughtOrchestrator {
  // ç”Ÿæˆæ¨ç†é“¾
  generateChain(problem: string): Promise<ThoughtStep[]>
  
  // æ‰§è¡Œæ¨ç†é“¾
  executeChain(steps: ThoughtStep[]): Promise<string>
}

interface TreeOfThoughtOrchestrator {
  // ç”Ÿæˆæ€ç»´æ ‘
  generateTree(problem: string, depth: number): Promise<ThoughtTree>
  
  // æœç´¢æœ€ä¼˜è·¯å¾„
  search(tree: ThoughtTree, strategy: 'bfs' | 'dfs'): Promise<ThoughtPath>
  
  // è¯„ä¼°è·¯å¾„
  evaluate(path: ThoughtPath): Promise<number>
}
```

---

## 3. æ ¸å¿ƒæŠ½è±¡å±‚è®¾è®¡

### 3.1 Domain é¢†åŸŸæŠ½è±¡

å°†ä¸åŒåœºæ™¯æŠ½è±¡ä¸º **Domainï¼ˆé¢†åŸŸï¼‰**ï¼Œæ¯ä¸ª Domain åŒ…å«ç‰¹å®šçš„ Agentsã€Toolsã€Workflowsï¼š

```typescript
// domain/types.ts
export interface Domain {
  id: string                           // é¢†åŸŸå”¯ä¸€æ ‡è¯†
  name: string                         // æ˜¾ç¤ºåç§°
  description: string                  // æè¿°
  icon?: string                        // å›¾æ ‡
  
  // é¢†åŸŸèµ„æº
  agents: AgentDefinition[]            // è¯¥é¢†åŸŸçš„ Agents
  tools: ToolDefinition[]              // è¯¥é¢†åŸŸçš„ Tools
  workflows: WorkflowDefinition[]      // è¯¥é¢†åŸŸçš„ Workflows
  skills: SkillDefinition[]            // è¯¥é¢†åŸŸçš„ Skills
  
  // é¢†åŸŸé…ç½®
  defaultAgent?: string                // é»˜è®¤ Agent
  permissions?: PermissionRuleset      // æƒé™è§„åˆ™
  settings?: Record<string, unknown>   // é¢†åŸŸè®¾ç½®
}

// é¢„ç½®é¢†åŸŸ
export const BUILTIN_DOMAINS = {
  coding: "coding",           // ç¼–ç å¼€å‘
  analysis: "analysis",       // éœ€æ±‚åˆ†æ
  documentation: "documentation", // æ–‡æ¡£æ’°å†™
  testing: "testing",         // æµ‹è¯•è´¨é‡
  operations: "operations",   // è¿ç»´éƒ¨ç½²
  management: "management",   // é¡¹ç›®ç®¡ç†
} as const
```

### 3.2 Capability èƒ½åŠ›æŠ½è±¡

å®šä¹‰é€šç”¨èƒ½åŠ›æ¥å£ï¼Œä¾› Agents å’Œ Tools å®ç°ï¼š

```typescript
// capability/types.ts
export interface Capability {
  id: string
  name: string
  category: CapabilityCategory
  
  // èƒ½åŠ›æ£€æŸ¥
  check(): Promise<CapabilityStatus>
  
  // ä¾èµ–å£°æ˜
  dependencies?: string[]
  
  // é…ç½® schema
  configSchema?: z.ZodType
}

export type CapabilityCategory = 
  | "file"        // æ–‡ä»¶æ“ä½œ
  | "code"        // ä»£ç åˆ†æ
  | "document"    // æ–‡æ¡£å¤„ç†
  | "api"         // API è°ƒç”¨
  | "data"        // æ•°æ®å¤„ç†
  | "search"      // æœç´¢æŸ¥è¯¢
  | "reasoning"   // æ¨ç†è§„åˆ’
  | "communication" // é€šä¿¡åä½œ
```

### 3.3 Context ä¸Šä¸‹æ–‡æŠ½è±¡

ç»Ÿä¸€çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæºå¸¦æ‰€æœ‰å¿…è¦ä¿¡æ¯ï¼š

```typescript
// context/types.ts
export interface ExecutionContext {
  // åŸºç¡€ä¿¡æ¯
  sessionID: string
  domain: string
  workspace: WorkspaceInfo
  space?: SpaceInfo             // å…³è”çš„ Space é¡¹ç›®ç©ºé—´ï¼ˆÂ§8.2ï¼‰
  
  // ç”¨æˆ·ä¿¡æ¯
  user?: UserInfo
  permissions: PermissionSet
  
  // æ‰§è¡ŒçŠ¶æ€
  state: ExecutionState
  history: Message[]
  artifacts: Artifact[]
  
  // å·¥å…·è®¿é—®
  tools: ToolAccessor
  agents: AgentAccessor
  
  // äº‹ä»¶å‘å¸ƒ
  emit(event: Event): Promise<void>
  
  // æƒé™è¯·æ±‚
  ask(request: PermissionRequest): Promise<void>
  
  // è¿›åº¦æŠ¥å‘Š
  progress(info: ProgressInfo): void
  
  // Grounding çŸ¥è¯†æ¥åœ°
  grounding: GroundingAccessor
  
  // Memory è®°å¿†è®¿é—®
  memory: MemoryAccessor
}
```

### 3.4 Grounding çŸ¥è¯†æ¥åœ°ç³»ç»Ÿ

åŸºäº Google Agents ç™½çš®ä¹¦çš„ Grounding æœºåˆ¶ï¼Œå®ç°çŸ¥è¯†å¢å¼ºï¼š

> **å®ç°ä¼˜å…ˆçº§ï¼š** å½“å‰å®šä¹‰äº† 7 ç§æ•°æ®æºç±»å‹ã€å¤šç§å‘é‡åº“å’ŒçŸ¥è¯†å›¾è°±ã€‚MVP é˜¶æ®µå»ºè®®ä»…å®ç° **code_repo + data_store** ä¸¤ç§æ•°æ®æºï¼Œå‘é‡æ£€ç´¢ä½¿ç”¨å•ä¸€å¼•æ“ï¼ˆå¦‚ SQLite + vec æ‰©å±•ï¼‰ï¼Œå…¶ä½™æ•°æ®æºç±»å‹æŒ‰éœ€æ‰©å±•ã€‚

```typescript
// grounding/types.ts

/**
 * Grounding çŸ¥è¯†æ¥åœ°ç³»ç»Ÿ
 * è§£å†³æ¨¡å‹çŸ¥è¯†æ—¶æ•ˆæ€§å’Œå¹»è§‰é—®é¢˜
 */
export interface GroundingService {
  // æ•°æ®æº
  sources: Map<string, GroundingSource>
  
  // æ³¨å†Œæ•°æ®æº
  register(source: GroundingSource): void
  
  // æ£€ç´¢çŸ¥è¯†
  retrieve(query: RetrievalQuery): Promise<GroundingResult[]>
  
  // RAG å¢å¼º
  augment(prompt: string, results: GroundingResult[]): AugmentedPrompt
}

/**
 * Grounding æ•°æ®æºç±»å‹
 */
export type GroundingSourceType = 
  | "web_search"     // ç½‘ç»œæœç´¢ï¼ˆå®æ—¶ä¿¡æ¯ï¼‰
  | "vector_store"   // å‘é‡æ•°æ®åº“ï¼ˆè¯­ä¹‰æ£€ç´¢ï¼‰
  | "code_repo"      // ä»£ç ä»“åº“ï¼ˆä»£ç æ£€ç´¢ï¼‰
  | "api_endpoint"   // API ç«¯ç‚¹ï¼ˆå®æ—¶æ•°æ®ï¼‰
  | "database"       // æ•°æ®åº“ï¼ˆç»“æ„åŒ–æŸ¥è¯¢ï¼‰
  | "knowledge_graph" // çŸ¥è¯†å›¾è°±ï¼ˆå…³ç³»æ¨ç†ï¼‰
  | "document_index" // æ–‡æ¡£ç´¢å¼•ï¼ˆå…¨æ–‡æ£€ç´¢ï¼‰

/**
 * Grounding æ•°æ®æºå®šä¹‰
 */
export interface GroundingSource {
  id: string
  type: GroundingSourceType
  name: string
  description: string
  
  // æ•°æ®æºé…ç½®
  config: GroundingSourceConfig
  
  // æ£€ç´¢å®ç°
  search(query: string, options?: SearchOptions): Promise<GroundingResult[]>
  
  // å¥åº·æ£€æŸ¥
  healthCheck(): Promise<HealthStatus>
}

/**
 * å„ç±»å‹æ•°æ®æºé…ç½®
 */
export type GroundingSourceConfig = 
  | WebSearchConfig
  | VectorStoreConfig
  | CodeRepoConfig
  | ApiEndpointConfig
  | DatabaseConfig
  | KnowledgeGraphConfig

// å‘é‡å­˜å‚¨é…ç½®
interface VectorStoreConfig {
  type: "vector_store"
  provider: "pinecone" | "weaviate" | "chroma" | "milvus" | "qdrant"
  collection: string
  embeddingModel: string
  dimensions: number
  topK: number
  minScore: number
}

// ä»£ç ä»“åº“é…ç½®
interface CodeRepoConfig {
  type: "code_repo"
  provider: "local" | "github" | "gitlab"
  path?: string
  repo?: string
  branch?: string
  includePatterns: string[]
  excludePatterns: string[]
}

// çŸ¥è¯†å›¾è°±é…ç½®
interface KnowledgeGraphConfig {
  type: "knowledge_graph"
  provider: "neo4j" | "dgraph" | "amazon_neptune"
  endpoint: string
  schema: GraphSchema
}

/**
 * æ£€ç´¢æŸ¥è¯¢
 */
export interface RetrievalQuery {
  text: string                    // æŸ¥è¯¢æ–‡æœ¬
  sources?: string[]              // æŒ‡å®šæ•°æ®æº
  filters?: RetrievalFilter[]     // è¿‡æ»¤æ¡ä»¶
  limit?: number                  // ç»“æœæ•°é‡
  minRelevance?: number           // æœ€å°ç›¸å…³åº¦
  rerank?: boolean                // æ˜¯å¦é‡æ’åº
}

/**
 * æ£€ç´¢ç»“æœ
 */
export interface GroundingResult {
  source: string                  // æ•°æ®æº ID
  content: string                 // å†…å®¹
  metadata: Record<string, unknown>
  relevance: number               // ç›¸å…³åº¦åˆ†æ•°
  citation?: Citation             // å¼•ç”¨ä¿¡æ¯
}

/**
 * RAG å¢å¼º Prompt
 */
export interface AugmentedPrompt {
  original: string                // åŸå§‹ Prompt
  context: string                 // æ£€ç´¢ä¸Šä¸‹æ–‡
  augmented: string               // å¢å¼ºåçš„ Prompt
  citations: Citation[]           // å¼•ç”¨åˆ—è¡¨
}
```

#### 3.4.1 Grounding ä½¿ç”¨ç¤ºä¾‹

```typescript
// ä½¿ç”¨ Grounding å¢å¼ºå›ç­”è´¨é‡
async function answerWithGrounding(
  question: string,
  grounding: GroundingService,
  model: LanguageModel
): Promise<GroundedAnswer> {
  // 1. æ£€ç´¢ç›¸å…³çŸ¥è¯†
  const results = await grounding.retrieve({
    text: question,
    sources: ["code_repo", "vector_store", "web_search"],
    limit: 10,
    minRelevance: 0.7,
    rerank: true
  })
  
  // 2. æ„å»ºå¢å¼º Prompt
  const augmented = grounding.augment(question, results)
  
  // 3. ç”Ÿæˆå›ç­”
  const response = await model.generate({
    prompt: augmented.augmented,
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šåŠ©æ‰‹ï¼ŒåŸºäºæä¾›çš„ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ã€‚
                   åŠ¡å¿…åœ¨å›ç­”ä¸­å¼•ç”¨ä¿¡æ¯æ¥æºã€‚
                   å¦‚æœä¸Šä¸‹æ–‡ä¸è¶³ä»¥å›ç­”ï¼Œè¯·æ˜ç¡®è¯´æ˜ã€‚`
  })
  
  return {
    answer: response.text,
    citations: augmented.citations,
    confidence: calculateConfidence(results)
  }
}
```

### 3.5 Memory è®°å¿†ç³»ç»Ÿ

åŸºäº Google Agents ç™½çš®ä¹¦çš„è®°å¿†æ¶æ„ï¼Œå®ç°å¤šå±‚æ¬¡è®°å¿†ç®¡ç†ï¼š

> **å®ç°ä¼˜å…ˆçº§ï¼š** å…­å±‚è®°å¿†æ¶æ„åº”åˆ†é˜¶æ®µå®ç°ã€‚**Phase 1**ï¼šä»…å®ç° shortTermï¼ˆä¼šè¯ä¸Šä¸‹æ–‡ï¼‰+ workingï¼ˆä»»åŠ¡çŠ¶æ€ï¼‰ï¼›**Phase 2**ï¼šæ·»åŠ  longTermï¼ˆè¯­ä¹‰æ£€ç´¢ï¼‰+ episodicï¼ˆç»éªŒæ¨¡å¼ï¼‰ï¼›**Phase 3**ï¼šæ‰©å±• semantic + proceduralã€‚è®°å¿†æ•´åˆå’Œé—å¿˜ç­–ç•¥å¯åœ¨ Phase 2 åå¼•å…¥ã€‚

```typescript
// memory/types.ts

/**
 * è®°å¿†ç³»ç»Ÿå®Œæ•´æ¥å£
 */
export interface MemoryService {
  // è®°å¿†å±‚
  shortTerm: ShortTermMemoryStore   // çŸ­æœŸè®°å¿†
  longTerm: LongTermMemoryStore     // é•¿æœŸè®°å¿†
  working: WorkingMemoryStore       // å·¥ä½œè®°å¿†
  episodic: EpisodicMemoryStore     // æƒ…æ™¯è®°å¿†
  semantic: SemanticMemoryStore     // è¯­ä¹‰è®°å¿†
  procedural: ProceduralMemoryStore // ç¨‹åºè®°å¿†
  
  // è®°å¿†ç®¡ç†
  manager: MemoryManager
}

/**
 * çŸ­æœŸè®°å¿†å­˜å‚¨
 * ç®¡ç†å½“å‰ä¼šè¯çš„ä¸Šä¸‹æ–‡çª—å£
 */
export interface ShortTermMemoryStore {
  // è·å–ä¼šè¯ä¸Šä¸‹æ–‡
  getContext(sessionId: string): Promise<ConversationContext>
  
  // è¿½åŠ æ¶ˆæ¯
  append(sessionId: string, message: Message): Promise<void>
  
  // Token çª—å£ç®¡ç†
  getTokenCount(sessionId: string): Promise<number>
  truncate(sessionId: string, maxTokens: number): Promise<void>
  
  // æ»‘åŠ¨çª—å£
  getWindow(sessionId: string, windowSize: number): Promise<Message[]>
  
  // æ‘˜è¦å‹ç¼©
  summarize(sessionId: string): Promise<string>
}

/**
 * é•¿æœŸè®°å¿†å­˜å‚¨
 * æŒä¹…åŒ–çš„ç”¨æˆ·çŸ¥è¯†å’Œåå¥½
 */
export interface LongTermMemoryStore {
  // å­˜å‚¨è®°å¿†
  store(entry: LongTermMemoryEntry): Promise<void>
  
  // è¯­ä¹‰æ£€ç´¢
  recall(query: string, options?: RecallOptions): Promise<LongTermMemoryEntry[]>
  
  // ç”¨æˆ·ç”»åƒ
  getUserProfile(userId: string): Promise<UserProfile>
  updateUserProfile(userId: string, updates: Partial<UserProfile>): Promise<void>
  
  // åå¥½å­¦ä¹ 
  learnPreference(userId: string, preference: Preference): Promise<void>
  getPreferences(userId: string): Promise<Preference[]>
}

export interface LongTermMemoryEntry {
  id: string
  userId: string
  content: string
  embedding: number[]           // å‘é‡åµŒå…¥
  type: 'fact' | 'preference' | 'skill' | 'episode'
  importance: number            // é‡è¦æ€§æƒé‡
  accessCount: number           // è®¿é—®æ¬¡æ•°
  lastAccess: Date
  createdAt: Date
  metadata: Record<string, unknown>
}

/**
 * å·¥ä½œè®°å¿†å­˜å‚¨
 * å½“å‰ä»»åŠ¡çš„ä¸´æ—¶çŠ¶æ€
 */
export interface WorkingMemoryStore {
  // ä»»åŠ¡çŠ¶æ€
  getTaskState(taskId: string): Promise<TaskState>
  setTaskState(taskId: string, state: TaskState): Promise<void>
  
  // æ¨ç†ä¸­é—´ç»“æœ
  setVariable(taskId: string, key: string, value: unknown): void
  getVariable(taskId: string, key: string): unknown
  
  // å‡è®¾ç®¡ç†
  addHypothesis(taskId: string, hypothesis: Hypothesis): void
  getHypotheses(taskId: string): Hypothesis[]
  validateHypothesis(taskId: string, hypothesisId: string, result: boolean): void
  
  // æ³¨æ„åŠ›ç„¦ç‚¹
  setFocus(taskId: string, focus: AttentionFocus): void
  getFocus(taskId: string): AttentionFocus
}

/**
 * æƒ…æ™¯è®°å¿†å­˜å‚¨ (Phase 2)
 * å…·ä½“äº‹ä»¶å’Œç»å†çš„è®°å½•
 * æ ¸å¿ƒæ¥å£ï¼šrecordEpisode / findSimilar / getSuccessPatterns / getFailureCases
 * è¯¦ç»†æ¥å£å®šä¹‰å¾… Phase 2 è®¾è®¡ç¡®å®š
 */
export type EpisodicMemoryStore = /* Phase 2 */

/**
 * è¯­ä¹‰è®°å¿†å­˜å‚¨ (Phase 3)
 * é¢†åŸŸçŸ¥è¯†å’Œæ¦‚å¿µå…³è”
 * æ ¸å¿ƒæ¥å£ï¼šstoreKnowledge / queryKnowledge / getRelatedConcepts / graphQuery
 * è¯¦ç»†æ¥å£å®šä¹‰å¾… Phase 3 è®¾è®¡ç¡®å®š
 */
export type SemanticMemoryStore = /* Phase 3 */

/**
 * ç¨‹åºè®°å¿†å­˜å‚¨ (Phase 3)
 * æŠ€èƒ½å’Œæ“ä½œæµç¨‹ï¼ˆSkillProcedureï¼šè§¦å‘æ¡ä»¶ + æ“ä½œæ­¥éª¤ + æˆåŠŸç‡ï¼‰
 * æ ¸å¿ƒæ¥å£ï¼šregisterSkill / getSkill / matchProcedure / updateSkill
 * è¯¦ç»†æ¥å£å®šä¹‰å¾… Phase 3 è®¾è®¡ç¡®å®š
 */
export type ProceduralMemoryStore = /* Phase 3 */
  successRate: number           // æˆåŠŸç‡
  usageCount: number            // ä½¿ç”¨æ¬¡æ•°
  lastUsed: Date
}

/**
 * è®°å¿†ç®¡ç†å™¨
 * è´Ÿè´£è®°å¿†çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
 */
export interface MemoryManager {
  // è®°å¿†æ•´åˆï¼ˆçŸ­æœŸâ†’é•¿æœŸï¼‰
  consolidate(sessionId: string): Promise<ConsolidationResult>
  
  // è®°å¿†é—å¿˜
  forget(criteria: ForgetCriteria): Promise<ForgetResult>
  
  // è®°å¿†ä¼˜åŒ–
  optimize(): Promise<OptimizationResult>
  
  // é‡è¦æ€§è¯„ä¼°
  evaluateImportance(entry: MemoryEntry): number
  
  // è®°å¿†æ£€ç´¢ç­–ç•¥
  setRetrievalStrategy(strategy: RetrievalStrategy): void
}

export interface ForgetCriteria {
  // æ—¶é—´è¡°å‡
  olderThan?: Duration
  
  // é‡è¦æ€§é˜ˆå€¼
  importanceBelow?: number
  
  // è®¿é—®é¢‘ç‡
  accessCountBelow?: number
  
  // ç±»å‹è¿‡æ»¤
  types?: MemoryType[]
}

export interface RetrievalStrategy {
  // æƒé‡é…ç½®
  weights: {
    semanticSimilarity: number    // è¯­ä¹‰ç›¸ä¼¼åº¦æƒé‡
    temporalRecency: number       // æ—¶é—´è¿‘åº¦æƒé‡
    accessFrequency: number       // è®¿é—®é¢‘ç‡æƒé‡
    importance: number            // é‡è¦æ€§æƒé‡
    taskRelevance: number         // ä»»åŠ¡ç›¸å…³æ€§æƒé‡
  }
  
  // æ£€ç´¢å‚æ•°
  topK: number
  minScore: number
  diversify: boolean              // ç»“æœå¤šæ ·åŒ–
}
```

#### 3.5.1 Memory ä½¿ç”¨ç¤ºä¾‹

```typescript
// å¸¦è®°å¿†çš„ Agent å¯¹è¯
async function conversationWithMemory(
  userId: string,
  sessionId: string,
  message: string,
  memory: MemoryService,
  model: LanguageModel
): Promise<Response> {
  // 1. è·å–çŸ­æœŸè®°å¿†ï¼ˆå½“å‰ä¼šè¯ï¼‰
  const recentContext = await memory.shortTerm.getWindow(sessionId, 10)
  
  // 2. æ£€ç´¢é•¿æœŸè®°å¿†ï¼ˆç›¸å…³çŸ¥è¯†ï¼‰
  const relevantMemories = await memory.longTerm.recall(message, {
    userId,
    limit: 5,
    minRelevance: 0.6
  })
  
  // 3. è·å–ç”¨æˆ·åå¥½
  const preferences = await memory.longTerm.getPreferences(userId)
  
  // 4. æ£€ç´¢ç›¸ä¼¼ç»å†
  const similarEpisodes = await memory.episodic.findSimilar(message, 3)
  
  // 5. æ„å»ºä¸Šä¸‹æ–‡
  const context = buildContextWithMemory({
    recentContext,
    relevantMemories,
    preferences,
    similarEpisodes
  })
  
  // 6. ç”Ÿæˆå›ç­”
  const response = await model.generate({
    systemPrompt: context.systemPrompt,
    messages: context.messages
  })
  
  // 7. æ›´æ–°è®°å¿†
  await memory.shortTerm.append(sessionId, {
    role: 'user',
    content: message
  })
  await memory.shortTerm.append(sessionId, {
    role: 'assistant',
    content: response.text
  })
  
  // 8. å­¦ä¹ åå¥½ï¼ˆå¦‚æœæœ‰æ–°å‘ç°ï¼‰
  if (response.detectedPreferences) {
    for (const pref of response.detectedPreferences) {
      await memory.longTerm.learnPreference(userId, pref)
    }
  }
  
  return response
}
```

---

### 3.6 æŒä¹…åŒ–å­˜å‚¨ç­–ç•¥

Sessionã€Agentã€Message ç­‰æ ¸å¿ƒæ•°æ®è¿è¡Œåœ¨æœåŠ¡ç«¯ï¼Œå¿…é¡»æœ‰å¯é çš„æŒä¹…åŒ–ä¿éšœã€‚æ–¹æ¡ˆé‡‡ç”¨**åˆ†å±‚å­˜å‚¨ + é€‚é…å™¨æ¨¡å¼**ï¼ŒMVP ä½¿ç”¨ SQLiteï¼Œç”Ÿäº§ç¯å¢ƒå¯åˆ‡æ¢ä¸º PostgreSQL / Turso ç­‰ã€‚

#### 3.6.1 å­˜å‚¨é€‚é…å™¨æŠ½è±¡

```typescript
// storage/adapter.ts

/**
 * å­˜å‚¨é€‚é…å™¨æ¥å£
 * æ‰€æœ‰æ•°æ®è®¿é—®é€šè¿‡æ­¤æ¥å£ï¼Œè¿è¡Œæ—¶é€šè¿‡é…ç½®é€‰æ‹©å®ç°
 */
export interface StorageAdapter {
  // Session å­˜å‚¨
  sessions: SessionStore
  // Agent å®ä¾‹å­˜å‚¨
  agents: AgentInstanceStore
  // æ¶ˆæ¯å­˜å‚¨
  messages: MessageStore
  // ç¾¤ç»„å­˜å‚¨
  groups: GroupStore
  groupMembers: GroupMemberStore
  // ä»»åŠ¡å­˜å‚¨
  tasks: TaskStore
  // äº‹åŠ¡æ”¯æŒ
  transaction<T>(fn: (tx: StorageAdapter) => Promise<T>): Promise<T>
  // å¥åº·æ£€æŸ¥
  healthCheck(): Promise<StorageHealth>
}

export interface SessionStore {
  create(session: SessionRecord): Promise<void>
  get(id: string): Promise<SessionRecord | null>
  update(id: string, patch: Partial<SessionRecord>): Promise<void>
  // æŒ‰ç”¨æˆ·æŸ¥è¯¢æ´»è·ƒä¼šè¯
  listByUser(userId: string, status?: SessionStatus): Promise<SessionRecord[]>
  // è¿‡æœŸæ¸…ç†
  purgeExpired(olderThan: Date): Promise<number>
}

export interface AgentInstanceStore {
  insert(agent: AgentInstanceRecord): Promise<void>
  get(id: string): Promise<AgentInstanceRecord>
  update(id: string, patch: Partial<AgentInstanceRecord>): Promise<void>
  findByRole(workspaceId: string, role: string): Promise<AgentInstanceRecord | null>
  listByWorkspace(workspaceId: string): Promise<AgentInstanceRecord[]>
  // å¢é‡è¿½åŠ  LLM å†å²ï¼ˆé¿å…å…¨é‡è¦†ç›–ï¼‰
  appendLLMMessage(agentId: string, message: LLMMessage): Promise<void>
  // æ‰¹é‡è¿½åŠ ï¼ˆä¸€è½®æ¨ç†ç»“æŸæ—¶ï¼‰
  appendLLMMessages(agentId: string, messages: LLMMessage[]): Promise<void>
}

export interface MessageStore {
  insert(message: SwarmMessage): Promise<void>
  after(groupId: string, afterId?: string): Promise<SwarmMessage[]>
  // æŒ‰æ—¶é—´èŒƒå›´åˆ†é¡µæŸ¥è¯¢
  queryByTimeRange(groupId: string, start: Date, end: Date, limit?: number): Promise<SwarmMessage[]>
}
```

#### 3.6.2 LLM å†å²å¢é‡å†™å…¥

å½“å‰ `AgentRunner.llmLoop()` åœ¨æ¨ç†å¾ªç¯**ç»“æŸåä¸€æ¬¡æ€§æŒä¹…åŒ–** LLM å†å²ï¼Œå­˜åœ¨è¿›ç¨‹å´©æºƒä¸¢å¤±é£é™©ã€‚æ”¹ä¸º**æ¯è½® tool call åå¢é‡å†™å…¥**ï¼š

```typescript
// ä¿®æ”¹å‰ï¼ˆå±é™©ï¼‰ï¼šæ¨ç†ç»“æŸåæ‰¹é‡å†™
// await Storage.agents.updateLLMHistory(this.agent.id, this.agent.llmHistory)

// ä¿®æ”¹åï¼ˆå®‰å…¨ï¼‰ï¼šæ¯æ­¥å¢é‡è¿½åŠ 
// 1. assistant æ¶ˆæ¯ â†’ ç«‹å³è¿½åŠ 
this.agent.llmHistory.push(assistantMessage)
await Storage.agents.appendLLMMessage(this.agent.id, assistantMessage)

// 2. tool ç»“æœ â†’ ç«‹å³è¿½åŠ 
this.agent.llmHistory.push(toolResultMessage)
await Storage.agents.appendLLMMessage(this.agent.id, toolResultMessage)
```

#### 3.6.3 Session ç”Ÿå‘½å‘¨æœŸ

```typescript
export interface SessionRecord {
  id: string
  userId: string
  workspaceId?: string
  domain: string
  status: SessionStatus
  // åˆ›å»º / æ´»è·ƒ / è¿‡æœŸæ—¶é—´
  createdAt: Date
  lastActiveAt: Date
  expiresAt?: Date
  // å…³è”çš„ Swarm workspaceï¼ˆå¦‚æœ‰ï¼‰
  swarmWorkspaceId?: string
  // å…ƒæ•°æ®
  metadata: Record<string, unknown>
}

export type SessionStatus =
  | "active"       // æ´»è·ƒä¸­
  | "suspended"    // æŒ‚èµ·ï¼ˆç”¨æˆ·å…³é—­æµè§ˆå™¨ä½†å¯æ¢å¤ï¼‰
  | "completed"    // æ­£å¸¸ç»“æŸ
  | "expired"      // è¶…æ—¶è¿‡æœŸ
  | "failed"       // å¼‚å¸¸ç»ˆæ­¢

/**
 * Session æ¢å¤ç­–ç•¥ï¼š
 * 1. ç”¨æˆ·é‡è¿æ—¶é€šè¿‡ sessionId æ¢å¤
 * 2. å…³è”çš„ Agent ä¿æŒè¿è¡Œï¼Œæ¶ˆæ¯æŒç»­ç´¯ç§¯
 * 3. å‰ç«¯é‡è¿åé€šè¿‡ lastEventId è¡¥å‘ç¼ºå¤±çš„ SSE äº‹ä»¶
 */
```

#### 3.6.4 å­˜å‚¨é€‚é…å™¨å®ç°è·¯å¾„

| é˜¶æ®µ | å­˜å‚¨å¼•æ“ | é€‚ç”¨åœºæ™¯ |
|------|---------|----------|
| **MVP** | SQLite + WAL æ¨¡å¼ | å•æœºéƒ¨ç½²ï¼Œå¼€å‘è€…æœ¬åœ°ä½¿ç”¨ |
| **ç”Ÿäº§å•æœº** | SQLite + Litestream åŒæ­¥ | å•æœº + S3 å¤‡ä»½ï¼Œå…¼é¡¾ç®€å•ä¸å¯é  |
| **å¤šæœº** | PostgreSQL / Turso | å¤šèŠ‚ç‚¹å…±äº«å­˜å‚¨ï¼Œæ”¯æŒå¹¶å‘å†™å…¥ |

> **è¿ç§»ç­–ç•¥**ï¼šæ‰€æœ‰æ•°æ®è®¿é—®å‡é€šè¿‡ `StorageAdapter` æ¥å£ï¼Œåˆ‡æ¢å­˜å‚¨å¼•æ“åªéœ€æ›¿æ¢é€‚é…å™¨å®ç° + æ‰§è¡Œ schema è¿ç§»è„šæœ¬ï¼Œä¸Šå±‚ä»£ç é›¶æ”¹åŠ¨ã€‚

---

## 4. Agent æ³¨å†Œç³»ç»Ÿ

### 4.1 Agent å®šä¹‰è§„èŒƒ

```typescript
// agent/types.ts
export interface AgentDefinition {
  // åŸºç¡€ä¿¡æ¯
  id: string                          // å”¯ä¸€æ ‡è¯† (å¦‚ "requirement-analyst")
  name: string                        // æ˜¾ç¤ºåç§°
  description: string                 // æè¿°
  version: string                     // ç‰ˆæœ¬å·
  
  // åˆ†ç±»ä¿¡æ¯
  domain: string                      // æ‰€å±é¢†åŸŸ
  category: AgentCategory             // ç±»åˆ«
  tags: string[]                      // æ ‡ç­¾
  
  // èƒ½åŠ›é…ç½®
  capabilities: string[]              // æ”¯æŒçš„èƒ½åŠ›
  tools: ToolBinding[]                // å·¥å…·ç»‘å®š
  skills: string[]                    // æŠ€èƒ½å¼•ç”¨
  
  // è¿è¡Œé…ç½®
  mode: "primary" | "subagent" | "all"
  model?: ModelSpec                   // æŒ‡å®šæ¨¡å‹
  temperature?: number
  maxSteps?: number
  
  // Prompt æ¨¡æ¿
  systemPrompt: string | PromptTemplate
  
  // æƒé™è§„åˆ™
  permissions: PermissionRuleset
  
  // å…ƒæ•°æ®
  metadata?: Record<string, unknown>
}

// Agent ç±»åˆ«
export type AgentCategory = 
  | "orchestrator"   // ç¼–æ’è€… - è´Ÿè´£ä»»åŠ¡åˆ†è§£å’Œåè°ƒ
  | "specialist"     // ä¸“å®¶ - ç‰¹å®šé¢†åŸŸæ·±åº¦èƒ½åŠ›
  | "advisor"        // é¡¾é—® - æä¾›å»ºè®®å’Œå®¡æŸ¥
  | "executor"       // æ‰§è¡Œè€… - å…·ä½“ä»»åŠ¡æ‰§è¡Œ
  | "utility"        // å·¥å…·å‹ - è¾…åŠ©åŠŸèƒ½

// å·¥å…·ç»‘å®š
export interface ToolBinding {
  tool: string                        // å·¥å…· ID
  alias?: string                      // åˆ«å
  config?: Record<string, unknown>    // å·¥å…·é…ç½®
  required?: boolean                  // æ˜¯å¦å¿…éœ€
}
```

### 4.2 Agent æ³¨å†Œè¡¨

```typescript
// agent/registry.ts
export class AgentRegistry {
  private agents = new Map<string, AgentDefinition>()
  private factories = new Map<string, AgentFactory>()
  
  // æ³¨å†Œ Agent
  register(definition: AgentDefinition): void {
    this.validate(definition)
    this.agents.set(definition.id, definition)
    Bus.publish(AgentEvent.Registered, { agent: definition.id })
  }
  
  // æ‰¹é‡æ³¨å†Œï¼ˆä»é…ç½®ï¼‰
  registerFromConfig(config: AgentConfig[]): void {
    for (const cfg of config) {
      this.register(this.parseConfig(cfg))
    }
  }
  
  // ä»ç›®å½•æ‰«ææ³¨å†Œ
  async scanAndRegister(dirs: string[]): Promise<void> {
    for (const dir of dirs) {
      const files = await glob(`${dir}/**/*.agent.{json,yaml,md}`)
      for (const file of files) {
        const def = await this.loadAgentFile(file)
        this.register(def)
      }
    }
  }
  
  // è·å– Agent
  get(id: string): AgentDefinition | undefined {
    return this.agents.get(id)
  }
  
  // æŒ‰é¢†åŸŸæŸ¥è¯¢
  byDomain(domain: string): AgentDefinition[] {
    return [...this.agents.values()].filter(a => a.domain === domain)
  }
  
  // æŒ‰èƒ½åŠ›æŸ¥è¯¢
  byCapability(capability: string): AgentDefinition[] {
    return [...this.agents.values()]
      .filter(a => a.capabilities.includes(capability))
  }
  
  // å®ä¾‹åŒ– Agent
  async instantiate(id: string, ctx: ExecutionContext): Promise<Agent> {
    const def = this.get(id)
    if (!def) throw new Error(`Agent not found: ${id}`)
    
    const factory = this.factories.get(def.category) ?? defaultFactory
    return factory.create(def, ctx)
  }
}
```

### 4.3 Agent å®šä¹‰æ–¹å¼

#### æ–¹å¼ä¸€ï¼šJSON/YAML é…ç½®

```yaml
# agents/requirement-analyst.agent.yaml
id: requirement-analyst
name: éœ€æ±‚åˆ†æå¸ˆ
description: ä¸“æ³¨äºç”¨æˆ·éœ€æ±‚åˆ†æã€ç”¨ä¾‹æå–ã€è¾¹ç•Œæ¡ä»¶è¯†åˆ«
version: "1.0.0"

domain: analysis
category: specialist
tags: [requirement, analysis, use-case]

capabilities:
  - document.read
  - document.write
  - reasoning.analysis

tools:
  - tool: read
  - tool: write
  - tool: search
  - tool: ask_user
    alias: clarify
    config:
      defaultPrefix: "å…³äºéœ€æ±‚ï¼Œæˆ‘æƒ³ç¡®è®¤ï¼š"

model:
  provider: anthropic
  model: claude-sonnet-4-20250514

systemPrompt: |
  ä½ æ˜¯ä¸€ä½èµ„æ·±çš„éœ€æ±‚åˆ†æå¸ˆï¼Œæ“…é•¿ï¼š
  
  ## æ ¸å¿ƒèƒ½åŠ›
  - ä»ç”¨æˆ·æè¿°ä¸­æå–ç»“æ„åŒ–éœ€æ±‚
  - è¯†åˆ«åŠŸèƒ½æ€§éœ€æ±‚å’ŒéåŠŸèƒ½æ€§éœ€æ±‚
  - å‘ç°éšå«éœ€æ±‚å’Œè¾¹ç•Œæ¡ä»¶
  - è¯„ä¼°éœ€æ±‚çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
  
  ## å·¥ä½œæµç¨‹
  1. ç†è§£ç”¨æˆ·çš„ä¸šåŠ¡èƒŒæ™¯
  2. æå–æ ¸å¿ƒç”¨ä¾‹ (Use Cases)
  3. åˆ†ææ¯ä¸ªç”¨ä¾‹çš„å‰ç½®æ¡ä»¶ã€åç½®æ¡ä»¶ã€å¼‚å¸¸æµç¨‹
  4. è¾“å‡ºç»“æ„åŒ–çš„éœ€æ±‚æ–‡æ¡£

permissions:
  read: allow
  edit: ask
  bash: deny
```

#### æ–¹å¼äºŒï¼šMarkdown é…ç½®

```markdown
<!-- agents/requirement-analyst.agent.md -->
---
id: requirement-analyst
name: éœ€æ±‚åˆ†æå¸ˆ
domain: analysis
category: specialist
capabilities:
  - document.read
  - document.write
  - reasoning.analysis
tools:
  - read
  - write
  - ask_user
---

# éœ€æ±‚åˆ†æå¸ˆ

ä½ æ˜¯ä¸€ä½èµ„æ·±çš„éœ€æ±‚åˆ†æå¸ˆï¼Œæ“…é•¿ä»æ¨¡ç³Šçš„ç”¨æˆ·æè¿°ä¸­æå–æ¸…æ™°çš„éœ€æ±‚ã€‚

## åˆ†ææ¡†æ¶

ä½¿ç”¨ä»¥ä¸‹æ¡†æ¶è¿›è¡Œéœ€æ±‚åˆ†æï¼š

### 1. ç”¨æˆ·æ•…äº‹ (User Stories)
- As a [è§’è‰²], I want [åŠŸèƒ½], so that [ä»·å€¼]

### 2. éªŒæ”¶æ ‡å‡† (Acceptance Criteria)
- Given [å‰ç½®æ¡ä»¶], When [æ“ä½œ], Then [é¢„æœŸç»“æœ]

### 3. è¾¹ç•Œæ¡ä»¶
- è¾“å…¥è¾¹ç•Œ
- å¹¶å‘åœºæ™¯
- å¼‚å¸¸å¤„ç†
```

#### æ–¹å¼ä¸‰ï¼šTypeScript ä»£ç 

```typescript
// agents/requirement-analyst.agent.ts
import { defineAgent } from "@aspect-build/agent-sdk"

export default defineAgent({
  id: "requirement-analyst",
  name: "éœ€æ±‚åˆ†æå¸ˆ",
  domain: "analysis",
  category: "specialist",
  
  capabilities: ["document.read", "document.write", "reasoning.analysis"],
  
  tools: [
    { tool: "read" },
    { tool: "write" },
    { tool: "ask_user", alias: "clarify" },
  ],
  
  // åŠ¨æ€ Prompt æ„å»º
  systemPrompt: async (ctx) => {
    const projectInfo = await ctx.workspace.getProjectInfo()
    return `
      ä½ æ˜¯ ${projectInfo.name} é¡¹ç›®çš„éœ€æ±‚åˆ†æå¸ˆã€‚
      
      ## é¡¹ç›®èƒŒæ™¯
      ${projectInfo.description}
      
      ## å·²æœ‰éœ€æ±‚æ–‡æ¡£
      ${await listRequirementDocs(ctx)}
      
      ## ä½ çš„ä»»åŠ¡
      åˆ†æç”¨æˆ·éœ€æ±‚ï¼Œè¾“å‡ºç»“æ„åŒ–æ–‡æ¡£ã€‚
    `
  },
  
  // ç”Ÿå‘½å‘¨æœŸé’©å­
  hooks: {
    beforeExecute: async (ctx, input) => {
      // é¢„å¤„ç†
    },
    afterExecute: async (ctx, output) => {
      // åå¤„ç†ï¼Œå¦‚ä¿å­˜åˆ°çŸ¥è¯†åº“
    },
  },
})
```

---

## 5. Tool æ³¨å†Œç³»ç»Ÿ

### 5.1 Tool å®šä¹‰è§„èŒƒ

```typescript
// tool/types.ts
export interface ToolDefinition {
  // åŸºç¡€ä¿¡æ¯
  id: string                          // å”¯ä¸€æ ‡è¯†
  name: string                        // æ˜¾ç¤ºåç§°
  description: string                 // æè¿°ï¼ˆç»™ LLM çœ‹ï¼‰
  version: string                     // ç‰ˆæœ¬
  
  // åˆ†ç±»ä¿¡æ¯
  domain?: string                     // æ‰€å±é¢†åŸŸï¼ˆå¯é€‰ï¼‰
  category: ToolCategory              // å·¥å…·ç±»åˆ«
  tags: string[]                      // æ ‡ç­¾
  
  // å‚æ•°å®šä¹‰
  parameters: z.ZodType               // Zod schema
  
  // è¾“å‡ºå®šä¹‰
  output?: z.ZodType                  // è¾“å‡º schema
  
  // æ‰§è¡Œå‡½æ•°
  execute: ToolExecutor
  
  // æƒé™è¦æ±‚
  requiredPermissions?: string[]
  
  // UI é…ç½®
  ui?: ToolUIConfig
  
  // å…ƒæ•°æ®
  metadata?: Record<string, unknown>
}

// å·¥å…·ç±»åˆ«
export type ToolCategory = 
  | "file"          // æ–‡ä»¶æ“ä½œ
  | "code"          // ä»£ç åˆ†æ
  | "document"      // æ–‡æ¡£å¤„ç†
  | "search"        // æœç´¢æŸ¥è¯¢
  | "api"           // API è°ƒç”¨
  | "data"          // æ•°æ®å¤„ç†
  | "shell"         // å‘½ä»¤æ‰§è¡Œ
  | "communication" // é€šä¿¡åä½œ
  | "utility"       // é€šç”¨å·¥å…·

// æ‰§è¡Œå™¨ç±»å‹
type ToolExecutor = (
  params: unknown,
  ctx: ToolContext
) => Promise<ToolResult>

// å·¥å…·ä¸Šä¸‹æ–‡
interface ToolContext {
  sessionID: string
  messageID: string
  callID: string
  agent: string
  abort: AbortSignal
  
  // æƒé™è¯·æ±‚
  ask(request: PermissionRequest): Promise<void>
  
  // å…ƒæ•°æ®è®¾ç½®
  metadata(data: Record<string, unknown>): void
  
  // è¿›åº¦æŠ¥å‘Š
  progress(info: ProgressInfo): void
}

// å·¥å…·ç»“æœ
interface ToolResult {
  title: string
  output: string
  metadata?: Record<string, unknown>
  attachments?: Attachment[]
}
```

### 5.2 Tool æ³¨å†Œè¡¨

```typescript
// tool/registry.ts
export class ToolRegistry {
  private tools = new Map<string, ToolDefinition>()
  private mcpTools = new Map<string, MCPToolAdapter>()
  
  // æ³¨å†Œå·¥å…·
  register(definition: ToolDefinition): void {
    this.validate(definition)
    this.tools.set(definition.id, definition)
    Bus.publish(ToolEvent.Registered, { tool: definition.id })
  }
  
  // ä» MCP æœåŠ¡å™¨åŠ è½½
  async loadFromMCP(server: MCPServer): Promise<void> {
    const tools = await server.listTools()
    for (const tool of tools) {
      const adapter = new MCPToolAdapter(tool, server)
      this.mcpTools.set(adapter.id, adapter)
    }
  }
  
  // æ‰«æç›®å½•æ³¨å†Œ
  async scanAndRegister(dirs: string[]): Promise<void> {
    for (const dir of dirs) {
      const files = await glob(`${dir}/**/*.tool.{ts,js}`)
      for (const file of files) {
        const module = await import(file)
        if (module.default) {
          this.register(module.default)
        }
      }
    }
  }
  
  // è·å–å·¥å…·
  get(id: string): ToolDefinition | undefined {
    return this.tools.get(id) ?? this.mcpTools.get(id)
  }
  
  // æŒ‰ç±»åˆ«æŸ¥è¯¢
  byCategory(category: ToolCategory): ToolDefinition[] {
    return [...this.tools.values()].filter(t => t.category === category)
  }
  
  // è·å– Agent å¯ç”¨å·¥å…·
  forAgent(agentDef: AgentDefinition): ToolDefinition[] {
    const toolIds = agentDef.tools.map(t => typeof t === "string" ? t : t.tool)
    return toolIds.map(id => this.get(id)).filter(Boolean)
  }
  
  // è½¬æ¢ä¸º AI SDK æ ¼å¼
  toAISDKTools(ids: string[]): Record<string, CoreTool> {
    const result: Record<string, CoreTool> = {}
    for (const id of ids) {
      const def = this.get(id)
      if (def) {
        result[id] = this.convertToCoreTool(def)
      }
    }
    return result
  }
}
```

### 5.3 é€šç”¨å·¥å…·ç¤ºä¾‹

#### æ–‡æ¡£ç”Ÿæˆå·¥å…·

```typescript
// tools/document/generate-doc.tool.ts
import { defineTool } from "@aspect-build/tool-sdk"

export default defineTool({
  id: "generate_document",
  name: "ç”Ÿæˆæ–‡æ¡£",
  description: "æ ¹æ®æ¨¡æ¿å’Œæ•°æ®ç”Ÿæˆç»“æ„åŒ–æ–‡æ¡£",
  category: "document",
  
  parameters: z.object({
    template: z.enum([
      "prd",           // äº§å“éœ€æ±‚æ–‡æ¡£
      "tech-design",   // æŠ€æœ¯è®¾è®¡æ–‡æ¡£
      "api-doc",       // API æ–‡æ¡£
      "user-guide",    // ç”¨æˆ·æŒ‡å—
      "test-plan",     // æµ‹è¯•è®¡åˆ’
      "release-note",  // å‘å¸ƒè¯´æ˜
    ]).describe("æ–‡æ¡£æ¨¡æ¿ç±»å‹"),
    
    title: z.string().describe("æ–‡æ¡£æ ‡é¢˜"),
    content: z.record(z.string(), z.any()).describe("æ–‡æ¡£å†…å®¹æ•°æ®"),
    outputPath: z.string().optional().describe("è¾“å‡ºè·¯å¾„"),
    format: z.enum(["markdown", "html", "pdf"]).default("markdown"),
  }),
  
  async execute(params, ctx) {
    const template = await loadTemplate(params.template)
    const rendered = await renderTemplate(template, params.content)
    
    if (params.outputPath) {
      await ctx.ask({
        permission: "edit",
        patterns: [params.outputPath],
        metadata: { template: params.template },
      })
      await writeFile(params.outputPath, rendered)
    }
    
    return {
      title: `Generated ${params.template}: ${params.title}`,
      output: rendered,
      metadata: { 
        template: params.template,
        outputPath: params.outputPath,
      },
    }
  },
})
```

#### API è°ƒç”¨å·¥å…·

```typescript
// tools/api/http-request.tool.ts
export default defineTool({
  id: "http_request",
  name: "HTTP è¯·æ±‚",
  description: "å‘é€ HTTP è¯·æ±‚åˆ°å¤–éƒ¨ API",
  category: "api",
  
  parameters: z.object({
    url: z.string().url().describe("è¯·æ±‚ URL"),
    method: z.enum(["GET", "POST", "PUT", "DELETE", "PATCH"]).default("GET"),
    headers: z.record(z.string()).optional(),
    body: z.any().optional(),
    timeout: z.number().default(30000),
  }),
  
  requiredPermissions: ["network"],
  
  async execute(params, ctx) {
    await ctx.ask({
      permission: "network",
      patterns: [new URL(params.url).hostname],
      metadata: { url: params.url, method: params.method },
    })
    
    const response = await fetch(params.url, {
      method: params.method,
      headers: params.headers,
      body: params.body ? JSON.stringify(params.body) : undefined,
      signal: AbortSignal.timeout(params.timeout),
    })
    
    const data = await response.text()
    
    return {
      title: `${params.method} ${params.url}`,
      output: data,
      metadata: {
        status: response.status,
        headers: Object.fromEntries(response.headers),
      },
    }
  },
})
```

#### æ•°æ®åˆ†æå·¥å…·

```typescript
// tools/data/analyze-data.tool.ts
export default defineTool({
  id: "analyze_data",
  name: "æ•°æ®åˆ†æ",
  description: "å¯¹ç»“æ„åŒ–æ•°æ®è¿›è¡Œç»Ÿè®¡åˆ†æ",
  category: "data",
  
  parameters: z.object({
    source: z.union([
      z.object({ type: z.literal("file"), path: z.string() }),
      z.object({ type: z.literal("inline"), data: z.array(z.any()) }),
    ]).describe("æ•°æ®æº"),
    
    analysis: z.array(z.enum([
      "summary",      // åŸºæœ¬ç»Ÿè®¡
      "distribution", // åˆ†å¸ƒåˆ†æ
      "correlation",  // ç›¸å…³æ€§åˆ†æ
      "trend",        // è¶‹åŠ¿åˆ†æ
      "anomaly",      // å¼‚å¸¸æ£€æµ‹
    ])).describe("åˆ†æç±»å‹"),
    
    groupBy: z.string().optional(),
    filters: z.record(z.any()).optional(),
  }),
  
  async execute(params, ctx) {
    const data = await loadData(params.source)
    const results: Record<string, unknown> = {}
    
    for (const type of params.analysis) {
      results[type] = await runAnalysis(type, data, params)
    }
    
    return {
      title: "Data Analysis Results",
      output: formatAnalysisResults(results),
      metadata: { rowCount: data.length, analysisTypes: params.analysis },
    }
  },
})
```

---

## 6. Workflow ç¼–æ’ç³»ç»Ÿ

### 6.1 Workflow å®šä¹‰è§„èŒƒ

```typescript
// workflow/types.ts
export interface WorkflowDefinition {
  id: string
  name: string
  description: string
  version: string
  
  // è§¦å‘æ¡ä»¶
  triggers?: WorkflowTrigger[]
  
  // è¾“å…¥å‚æ•°
  inputs: z.ZodType
  
  // è¾“å‡ºå®šä¹‰
  outputs?: z.ZodType
  
  // æ­¥éª¤å®šä¹‰
  steps: WorkflowStep[]
  
  // é”™è¯¯å¤„ç†
  onError?: ErrorHandler
  
  // è¶…æ—¶è®¾ç½®
  timeout?: number
}

// å·¥ä½œæµæ­¥éª¤
export type WorkflowStep = 
  | AgentStep      // è°ƒç”¨ Agent
  | ToolStep       // è°ƒç”¨ Tool
  | ConditionStep  // æ¡ä»¶åˆ†æ”¯
  | ParallelStep   // å¹¶è¡Œæ‰§è¡Œ
  | LoopStep       // å¾ªç¯æ‰§è¡Œ
  | SubWorkflowStep // å­å·¥ä½œæµ
  | HumanStep      // äººå·¥ä»‹å…¥

// Agent æ­¥éª¤
export interface AgentStep {
  type: "agent"
  id: string
  agent: string                       // Agent ID
  input: string | InputTemplate       // è¾“å…¥æ¨¡æ¿
  output?: string                     // è¾“å‡ºå˜é‡å
  config?: Partial<AgentDefinition>   // ä¸´æ—¶é…ç½®è¦†ç›–
}

// å·¥å…·æ­¥éª¤
export interface ToolStep {
  type: "tool"
  id: string
  tool: string                        // Tool ID
  params: Record<string, unknown>     // å‚æ•°
  output?: string                     // è¾“å‡ºå˜é‡å
}

// æ¡ä»¶åˆ†æ”¯
export interface ConditionStep {
  type: "condition"
  id: string
  condition: string                   // è¡¨è¾¾å¼
  then: WorkflowStep[]
  else?: WorkflowStep[]
}

// å¹¶è¡Œæ‰§è¡Œ
export interface ParallelStep {
  type: "parallel"
  id: string
  branches: WorkflowStep[][]
  mergeStrategy?: "all" | "any" | "race"
}

// äººå·¥ä»‹å…¥
export interface HumanStep {
  type: "human"
  id: string
  prompt: string                      // æç¤ºç”¨æˆ·çš„é—®é¢˜
  options?: string[]                  // å¯é€‰é€‰é¡¹
  timeout?: number                    // è¶…æ—¶æ—¶é—´
  output?: string                     // è¾“å‡ºå˜é‡å
}
```

### 6.2 Workflow ç¤ºä¾‹

#### éœ€æ±‚åˆ°å¼€å‘å®Œæ•´æµç¨‹

```yaml
# workflows/requirement-to-dev.workflow.yaml
id: requirement-to-dev
name: éœ€æ±‚åˆ°å¼€å‘å®Œæ•´æµç¨‹
description: ä»éœ€æ±‚åˆ†æåˆ°ä»£ç å®ç°çš„å®Œæ•´å·¥ä½œæµ
version: "1.0.0"

inputs:
  type: object
  properties:
    requirement:
      type: string
      description: åŸå§‹éœ€æ±‚æè¿°
    priority:
      type: string
      enum: [high, medium, low]
      default: medium

steps:
  # 1. éœ€æ±‚åˆ†æ
  - type: agent
    id: analyze
    agent: requirement-analyst
    input: |
      è¯·åˆ†æä»¥ä¸‹éœ€æ±‚ï¼š
      
      {{ inputs.requirement }}
      
      è¾“å‡ºç»“æ„åŒ–çš„éœ€æ±‚æ–‡æ¡£ã€‚
    output: requirementDoc

  # 2. äººå·¥ç¡®è®¤
  - type: human
    id: confirm_requirement
    prompt: |
      éœ€æ±‚åˆ†æå·²å®Œæˆï¼Œè¯·ç¡®è®¤ï¼š
      
      {{ steps.analyze.output }}
      
      æ˜¯å¦ç»§ç»­è¿›è¡ŒæŠ€æœ¯è®¾è®¡ï¼Ÿ
    options: [ç»§ç»­, ä¿®æ”¹éœ€æ±‚, å–æ¶ˆ]
    output: confirmation

  # 3. æ¡ä»¶åˆ¤æ–­
  - type: condition
    id: check_confirmation
    condition: "steps.confirm_requirement.output == 'ç»§ç»­'"
    then:
      # 4. æŠ€æœ¯è®¾è®¡
      - type: agent
        id: design
        agent: tech-architect
        input: |
          åŸºäºä»¥ä¸‹éœ€æ±‚æ–‡æ¡£ï¼Œè¿›è¡ŒæŠ€æœ¯è®¾è®¡ï¼š
          
          {{ steps.analyze.output }}
          
          è¾“å‡ºæŠ€æœ¯è®¾è®¡æ–‡æ¡£ï¼ŒåŒ…æ‹¬ï¼š
          - ç³»ç»Ÿæ¶æ„
          - æ•°æ®æ¨¡å‹
          - API è®¾è®¡
          - å®ç°æ–¹æ¡ˆ
        output: designDoc

      # 5. ä»£ç å®ç°ï¼ˆå¹¶è¡Œï¼‰
      - type: parallel
        id: implement
        branches:
          # åˆ†æ”¯ 1: åç«¯å®ç°
          - - type: agent
              id: backend
              agent: build
              input: |
                æ ¹æ®æŠ€æœ¯è®¾è®¡æ–‡æ¡£å®ç°åç«¯ä»£ç ï¼š
                
                {{ steps.design.output }}
              output: backendCode

          # åˆ†æ”¯ 2: å‰ç«¯å®ç°
          - - type: agent
              id: frontend
              agent: build
              input: |
                æ ¹æ®æŠ€æœ¯è®¾è®¡æ–‡æ¡£å®ç°å‰ç«¯ä»£ç ï¼š
                
                {{ steps.design.output }}
              output: frontendCode

      # 6. ä»£ç å®¡æŸ¥
      - type: agent
        id: review
        agent: code-reviewer
        input: |
          è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç å˜æ›´ï¼š
          
          ## åç«¯ä»£ç 
          {{ steps.implement.backend.output }}
          
          ## å‰ç«¯ä»£ç 
          {{ steps.implement.frontend.output }}
        output: reviewResult

      # 7. ç”Ÿæˆæµ‹è¯•
      - type: agent
        id: test
        agent: qa-engineer
        input: |
          æ ¹æ®éœ€æ±‚å’Œå®ç°ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼š
          
          ## éœ€æ±‚
          {{ steps.analyze.output }}
          
          ## ä»£ç å˜æ›´
          {{ steps.implement.backend.output }}
        output: testCases

    else:
      - type: tool
        id: cancel
        tool: notify
        params:
          message: "å·¥ä½œæµå·²å–æ¶ˆ"

outputs:
  requirementDoc: "{{ steps.analyze.output }}"
  designDoc: "{{ steps.design.output }}"
  reviewResult: "{{ steps.review.output }}"
  testCases: "{{ steps.test.output }}"
```

### 6.3 Workflow æ‰§è¡Œå¼•æ“

```typescript
// workflow/engine.ts
export class WorkflowEngine {
  private registry: WorkflowRegistry
  private agentRegistry: AgentRegistry
  private toolRegistry: ToolRegistry
  
  async execute(
    workflowId: string, 
    inputs: unknown, 
    ctx: ExecutionContext
  ): Promise<WorkflowResult> {
    const workflow = this.registry.get(workflowId)
    if (!workflow) throw new Error(`Workflow not found: ${workflowId}`)
    
    // éªŒè¯è¾“å…¥
    const validatedInputs = workflow.inputs.parse(inputs)
    
    // åˆ›å»ºæ‰§è¡ŒçŠ¶æ€
    const state = new WorkflowState(workflow, validatedInputs)
    
    // æ‰§è¡Œæ­¥éª¤
    for (const step of workflow.steps) {
      if (ctx.abort.aborted) {
        state.status = "cancelled"
        break
      }
      
      try {
        await this.executeStep(step, state, ctx)
      } catch (error) {
        if (workflow.onError) {
          await workflow.onError(error, state, ctx)
        } else {
          throw error
        }
      }
    }
    
    return state.toResult()
  }
  
  private async executeStep(
    step: WorkflowStep, 
    state: WorkflowState, 
    ctx: ExecutionContext
  ): Promise<void> {
    switch (step.type) {
      case "agent":
        return this.executeAgentStep(step, state, ctx)
      case "tool":
        return this.executeToolStep(step, state, ctx)
      case "condition":
        return this.executeConditionStep(step, state, ctx)
      case "parallel":
        return this.executeParallelStep(step, state, ctx)
      case "human":
        return this.executeHumanStep(step, state, ctx)
      case "subworkflow":
        return this.executeSubWorkflowStep(step, state, ctx)
    }
  }
  
  private async executeAgentStep(
    step: AgentStep, 
    state: WorkflowState, 
    ctx: ExecutionContext
  ): Promise<void> {
    const agent = await this.agentRegistry.instantiate(step.agent, ctx)
    const input = this.renderTemplate(step.input, state)
    
    const result = await agent.run(input)
    
    if (step.output) {
      state.setVariable(step.output, result)
    }
    state.recordStep(step.id, result)
  }
  
  private async executeParallelStep(
    step: ParallelStep, 
    state: WorkflowState, 
    ctx: ExecutionContext
  ): Promise<void> {
    const promises = step.branches.map(branch => 
      this.executeBranch(branch, state.fork(), ctx)
    )
    
    const results = await Promise.all(promises)
    state.mergeBranches(results, step.mergeStrategy)
  }
}
```

### 6.5 æ ¸å¿ƒåŠ¨æ€è§„åˆ’å™¨ (Dynamic Planner)

> å‚è€ƒ Aime è®ºæ–‡ (arXiv:2507.11988) å’Œ Swarm-IDE èœ‚ç¾¤è®¾è®¡
> æ ¸å¿ƒèƒ½åŠ›ï¼šé¢†åŸŸåˆ†æ â†’ åŠ¨æ€ç»„è£… Agent â†’ å®æ—¶åé¦ˆè°ƒæ•´ â†’ å¹¶è¡Œç¼–æ’æ‰§è¡Œ

#### 6.5.1 è®¾è®¡åŠ¨æœºä¸é—®é¢˜åˆ†æ

ä¼ ç»Ÿçš„ Plan-and-Execute æ¡†æ¶å­˜åœ¨ä¸‰å¤§æ ¸å¿ƒç¼ºé™·ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¼ ç»Ÿ Plan-and-Execute æ¡†æ¶çš„ç¼ºé™·                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  âŒ åˆšæ€§è®¡åˆ’æ‰§è¡Œ (Rigid Plan Execution)                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚  â€¢ è®¡åˆ’ç”Ÿæˆåå›ºå®šä¸å˜ï¼ŒPlanner åœ¨æ‰§è¡ŒæœŸé—´ç©ºé—²                               â”‚
â”‚  â€¢ æ— æ³•é€‚åº”æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å®æ—¶åé¦ˆå’Œæ„å¤–ç»“æœ                                   â”‚
â”‚  â€¢ æ‰§è¡Œåç¦»è®¡åˆ’æ—¶ç¼ºä¹è‡ªé€‚åº”èƒ½åŠ›                                             â”‚
â”‚                                                                              â”‚
â”‚  âŒ é™æ€ Agent èƒ½åŠ› (Static Agent Capabilities)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚  â€¢ Agent é¢„å®šä¹‰è§’è‰²å’Œå·¥å…·é›†å›ºå®šä¸å˜                                         â”‚
â”‚  â€¢ æ— æ³•å¤„ç†éœ€è¦æ–°æŠ€èƒ½çš„æœªé¢„è§ä»»åŠ¡                                           â”‚
â”‚  â€¢ é™åˆ¶äº†ç³»ç»Ÿçš„æ‰©å±•æ€§å’Œé²æ£’æ€§                                               â”‚
â”‚                                                                              â”‚
â”‚  âŒ ä½æ•ˆé€šä¿¡ (Inefficient Communication)                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚  â€¢ Agent é—´ä»»åŠ¡äº¤æ¥å®¹æ˜“ä¸¢å¤±ä¸Šä¸‹æ–‡                                           â”‚
â”‚  â€¢ ç¼ºä¹é›†ä¸­çŠ¶æ€ç®¡ç†ï¼ŒAgent å¯¹å…¨å±€è¿›åº¦è§†å›¾ä¸å®Œæ•´                             â”‚
â”‚  â€¢ å¯¼è‡´é‡å¤å·¥ä½œå’Œåè°ƒå¤±è´¥                                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆ**ï¼šåŠ¨æ€è§„åˆ’å™¨ (Dynamic Planner) ç³»ç»Ÿï¼Œå®ç°ï¼š
- **åŠ¨æ€è®¡åˆ’è°ƒæ•´**ï¼šåŸºäºå®æ—¶åé¦ˆæŒç»­ä¼˜åŒ–ç­–ç•¥
- **æŒ‰éœ€ Agent ç»„è£…**ï¼šæ ¹æ®ä»»åŠ¡éœ€æ±‚åŠ¨æ€åˆ›å»ºä¸“ä¸šåŒ– Agent
- **é›†ä¸­è¿›åº¦ç®¡ç†**ï¼šå…¨å±€çŠ¶æ€æ„ŸçŸ¥ï¼Œæ¶ˆé™¤ä¿¡æ¯å­¤å²›

#### 6.5.2 åŠ¨æ€è§„åˆ’å™¨æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åŠ¨æ€è§„åˆ’å™¨ (Dynamic Planner) æ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚    ç”¨æˆ·è¯·æ±‚                                                                  â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      1. Domain Analyzer é¢†åŸŸåˆ†æå™¨                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚ æ„å›¾è¯†åˆ«       â”‚ â”‚ é¢†åŸŸåˆ†ç±»       â”‚ â”‚ å¤æ‚åº¦è¯„ä¼°     â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ Intent Detect  â”‚ â”‚ Domain Classifyâ”‚ â”‚ Complexity Est â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                   é¢†åŸŸåˆ†æç»“æœï¼š{ domains, skills, complexity }              â”‚
â”‚                                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      2. Dynamic Planner åŠ¨æ€è§„åˆ’å™¨                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚ ä»»åŠ¡åˆ†è§£       â”‚ â”‚ ç­–ç•¥ç”Ÿæˆ       â”‚ â”‚ ä¾èµ–åˆ†æ       â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ Task Decompose â”‚ â”‚ Strategy Gen   â”‚ â”‚ Dependency Map â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  è¾“å‡ºï¼šå…¨å±€ä»»åŠ¡åˆ—è¡¨ L = { subtask1, subtask2, ..., subtaskN }        â”‚   â”‚
â”‚  â”‚  æ¯ä¸ª subtask åŒ…å«ï¼šç›®æ ‡ã€å®Œæˆæ ‡å‡†ã€æ‰€éœ€æŠ€èƒ½ã€é¢„ä¼°æ—¶é—´                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      3. Actor Factory Agent å·¥å‚                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚ Persona ç”Ÿæˆ   â”‚ â”‚ Toolkit ç»„è£…   â”‚ â”‚ Knowledge æ³¨å…¥ â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ è§’è‰²äººè®¾       â”‚ â”‚ å·¥å…·åŒ…é€‰æ‹©     â”‚ â”‚ çŸ¥è¯†åº“åŠ è½½     â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  åŠ¨æ€åˆ›å»ºï¼šAt = { LLM, Toolkit, Prompt, Memory }                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚          â–¼                         â–¼                         â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Dynamic Actor â”‚         â”‚ Dynamic Actor â”‚         â”‚ Dynamic Actor â”‚        â”‚
â”‚  â”‚   (å¹¶è¡Œæ‰§è¡Œ)   â”‚         â”‚   (å¹¶è¡Œæ‰§è¡Œ)   â”‚         â”‚   (å¹¶è¡Œæ‰§è¡Œ)   â”‚        â”‚
â”‚  â”‚  ReAct å¾ªç¯   â”‚         â”‚  ReAct å¾ªç¯   â”‚         â”‚  ReAct å¾ªç¯   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚          â”‚                         â”‚                         â”‚              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 4. Progress Management è¿›åº¦ç®¡ç†æ¨¡å—                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚ çŠ¶æ€è¿½è¸ª       â”‚ â”‚ å®æ—¶åŒæ­¥       â”‚ â”‚ å®ŒæˆéªŒè¯       â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ Status Track   â”‚ â”‚ Real-time Sync â”‚ â”‚ Completion Val â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  å…¨å±€è¿›åº¦åˆ—è¡¨ï¼š[ ] Task1 âœ“ | [x] Task2 è¿›è¡Œä¸­ | [ ] Task3 å¾…å¼€å§‹    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                     åé¦ˆå¾ªç¯ï¼šå®æ—¶çŠ¶æ€ â†’ Dynamic Planner                     â”‚
â”‚                                    â–¼                                         â”‚
â”‚                           æŒç»­è¿­ä»£ç›´åˆ°ä»»åŠ¡å®Œæˆ                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.5.3 é¢†åŸŸåˆ†æå™¨ (Domain Analyzer)

> **äº¤å‰å¼•ç”¨ï¼š** æœ¬ç»„ä»¶ä¸ 9.3.3 IntentAnalyzer èŒè´£ç›¸è¿‘ï¼ˆéƒ½åšæ„å›¾/é¢†åŸŸåˆ†æï¼‰ã€‚åŒºåˆ†ç‚¹ï¼šDomainAnalyzer æœåŠ¡äº **åŠ¨æ€è§„åˆ’å™¨**ï¼ˆè¿è¡Œæ—¶ä»»åŠ¡åˆ†è§£ï¼‰ï¼ŒIntentAnalyzer æœåŠ¡äº **æ¨¡æ¿åˆæˆå™¨**ï¼ˆæ— åŒ¹é…æ¨¡æ¿æ—¶çš„å³å¸­ç”Ÿæˆï¼‰ã€‚**å®ç°æ—¶åº”æŠ½å– `BaseIntentAnalyzer` å…±äº«åŸºç±»**ï¼ŒåŒ…å« LLM æ„å›¾æŠ½å–ã€æ³¨å†Œè¡¨æ ¡éªŒã€å¤æ‚åº¦è¯„ä¼°ç­‰å…¬å…±é€»è¾‘ï¼Œä¸¤è€…ç»§æ‰¿å¹¶ä»…è¦†ç›–å·®å¼‚éƒ¨åˆ†ã€‚

é¢†åŸŸåˆ†æå™¨è´Ÿè´£åˆ†æç”¨æˆ·è¯·æ±‚ï¼Œè¯†åˆ«æ¶‰åŠçš„é¢†åŸŸã€æ‰€éœ€æŠ€èƒ½å’Œå¤æ‚åº¦ç­‰çº§ï¼š

```typescript
// planner/domain-analyzer.ts

/**
 * é¢†åŸŸåˆ†æå™¨
 * ç¬¬ä¸€æ­¥ï¼šåˆ†æä»»åŠ¡æ¶‰åŠçš„é¢†åŸŸå’Œæ‰€éœ€èƒ½åŠ›
 */
export interface DomainAnalyzer {
  /**
   * åˆ†æç”¨æˆ·è¯·æ±‚
   */
  analyze(request: UserRequest): Promise<DomainAnalysisResult>
}

/**
 * é¢†åŸŸåˆ†æç»“æœ
 */
export interface DomainAnalysisResult {
  // è¯†åˆ«çš„æ„å›¾
  intent: {
    primary: string           // ä¸»è¦æ„å›¾
    secondary?: string[]      // æ¬¡è¦æ„å›¾
    confidence: number        // ç½®ä¿¡åº¦ 0-1
  }
  
  // æ¶‰åŠçš„é¢†åŸŸ
  domains: DomainMatch[]
  
  // æ‰€éœ€æŠ€èƒ½
  requiredSkills: SkillRequirement[]
  
  // æ‰€éœ€å·¥å…·
  requiredTools: ToolRequirement[]
  
  // å¤æ‚åº¦è¯„ä¼°
  complexity: ComplexityAssessment
  
  // å»ºè®®çš„æ‰§è¡Œæ¨¡å¼
  suggestedMode: ExecutionMode
}

/**
 * é¢†åŸŸåŒ¹é…
 */
export interface DomainMatch {
  domain: string              // é¢†åŸŸ ID (coding, analysis, documentation, etc.)
  relevance: number           // ç›¸å…³åº¦ 0-1
  subdomains?: string[]       // å­é¢†åŸŸ
}

/**
 * æŠ€èƒ½éœ€æ±‚
 */
export interface SkillRequirement {
  skillId: string             // æŠ€èƒ½ ID
  importance: "critical" | "important" | "optional"
  reason: string              // éœ€è¦è¯¥æŠ€èƒ½çš„åŸå› 
}

/**
 * å¤æ‚åº¦è¯„ä¼°
 */
export interface ComplexityAssessment {
  level: 0 | 1 | 2 | 3 | 4    // å¯¹åº” Agentic 5 çº§åˆ†çº§
  factors: ComplexityFactor[]
  estimatedSteps: number      // é¢„ä¼°æ­¥éª¤æ•°
  estimatedDuration: string   // é¢„ä¼°è€—æ—¶
  parallelizable: boolean     // æ˜¯å¦å¯å¹¶è¡Œ
  parallelDegree?: number     // å»ºè®®å¹¶è¡Œåº¦
}

/**
 * æ‰§è¡Œæ¨¡å¼
 */
export type ExecutionMode = 
  | "single_agent"            // å• Agent æ¨¡å¼ (Level 0-1)
  | "sequential"              // é¡ºåºç¼–æ’ (Level 2)
  | "parallel"                // å¹¶è¡Œç¼–æ’ (Level 2-3)
  | "swarm"                   // èœ‚ç¾¤æ¨¡å¼ (Level 3-4ï¼Œå«å¹¶è¡Œè°ƒåº¦)

/**
 * é¢†åŸŸåˆ†æå™¨å®ç°
 */
export class LLMDomainAnalyzer implements DomainAnalyzer {
  private model: LanguageModel
  private domainRegistry: DomainRegistry
  private skillRegistry: SkillRegistry
  
  async analyze(request: UserRequest): Promise<DomainAnalysisResult> {
    // 1. æ„å»ºåˆ†æ Prompt
    const analysisPrompt = this.buildAnalysisPrompt(request)
    
    // 2. è°ƒç”¨ LLM è¿›è¡Œé¢†åŸŸåˆ†æ
    const rawAnalysis = await this.model.generate({
      messages: [
        { role: "system", content: this.getSystemPrompt() },
        { role: "user", content: analysisPrompt }
      ],
      responseFormat: { type: "json_object" }
    })
    
    // 3. è§£æå¹¶éªŒè¯ç»“æœ
    const parsed = DomainAnalysisSchema.parse(JSON.parse(rawAnalysis))
    
    // 4. ä¸æ³¨å†Œè¡¨åŒ¹é…ï¼ŒéªŒè¯å¯ç”¨æ€§
    const validated = await this.validateWithRegistries(parsed)
    
    return validated
  }
  
  private getSystemPrompt(): string {
    return `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»»åŠ¡åˆ†æä¸“å®¶ã€‚åˆ†æç”¨æˆ·è¯·æ±‚ï¼Œè¾“å‡ºç»“æ„åŒ–çš„é¢†åŸŸåˆ†æç»“æœã€‚

åˆ†æç»´åº¦ï¼š
1. æ„å›¾è¯†åˆ«ï¼šç”¨æˆ·æƒ³è¦å®Œæˆä»€ä¹ˆ
2. é¢†åŸŸåˆ†ç±»ï¼šæ¶‰åŠå“ªäº›ä¸“ä¸šé¢†åŸŸ (coding/analysis/documentation/testing/operations/management)
3. æŠ€èƒ½éœ€æ±‚ï¼šéœ€è¦å“ªäº›å…·ä½“æŠ€èƒ½
4. å¤æ‚åº¦è¯„ä¼°ï¼š
   - Level 0: çº¯æ¨ç†é—®ç­”ï¼Œæ— éœ€å·¥å…·
   - Level 1: éœ€è¦å¤–éƒ¨å·¥å…·/æ•°æ®
   - Level 2: å¤šæ­¥éª¤æˆ˜ç•¥æ€§è§„åˆ’
   - Level 3: éœ€è¦å¤š Agent åä½œ
   - Level 4: éœ€è¦åŠ¨æ€åˆ›å»ºæ–°èƒ½åŠ›
5. å¹¶è¡Œæ€§åˆ†æï¼šä»»åŠ¡æ˜¯å¦å¯æ‹†åˆ†å¹¶è¡Œæ‰§è¡Œ

å¯ç”¨é¢†åŸŸåˆ—è¡¨ï¼š
${JSON.stringify(this.domainRegistry.list(), null, 2)}

å¯ç”¨æŠ€èƒ½åˆ—è¡¨ï¼š
${JSON.stringify(this.skillRegistry.list(), null, 2)}
`
  }
}
```

#### 6.5.4 åŠ¨æ€è§„åˆ’å™¨æ ¸å¿ƒ (Dynamic Planner Core)

åŠ¨æ€è§„åˆ’å™¨æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£ä»»åŠ¡åˆ†è§£å’ŒæŒç»­ç­–ç•¥è°ƒæ•´ï¼š

```typescript
// planner/dynamic-planner.ts

/**
 * åŠ¨æ€è§„åˆ’å™¨
 * æ ¸å¿ƒåˆ›æ–°ï¼šæŒç»­æ ¹æ®å®æ—¶åé¦ˆè°ƒæ•´ç­–ç•¥
 * 
 * å½¢å¼åŒ–å®šä¹‰ (æ¥è‡ª Aime è®ºæ–‡)ï¼š
 * (L_{t+1}, g_{t+1}) = LLM_planner(P_planner, (G, L_t, H_t))
 * 
 * å…¶ä¸­ï¼š
 * - G: æ€»ä½“ç›®æ ‡
 * - L_t: å½“å‰ä»»åŠ¡åˆ—è¡¨
 * - H_t: å†å²æ‰§è¡Œç»“æœ
 * - L_{t+1}: æ›´æ–°åçš„ä»»åŠ¡åˆ—è¡¨ (æˆ˜ç•¥è¾“å‡º)
 * - g_{t+1}: ä¸‹ä¸€ä¸ªæ‰§è¡ŒåŠ¨ä½œ (æˆ˜æœ¯è¾“å‡º)
 */
export interface DynamicPlanner {
  /**
   * åˆå§‹è§„åˆ’ï¼šåˆ†è§£ç›®æ ‡ä¸ºå­ä»»åŠ¡
   */
  plan(goal: Goal, analysis: DomainAnalysisResult): Promise<TaskList>
  
  /**
   * åŠ¨æ€è°ƒæ•´ï¼šæ ¹æ®åé¦ˆæ›´æ–°è®¡åˆ’
   */
  replan(
    goal: Goal, 
    currentTaskList: TaskList, 
    executionHistory: ExecutionHistory
  ): Promise<ReplanResult>
  
  /**
   * è·å–ä¸‹ä¸€ä¸ªæ‰§è¡ŒåŠ¨ä½œ
   */
  getNextAction(taskList: TaskList): Promise<NextAction>
}

/**
 * ä»»åŠ¡åˆ—è¡¨ï¼ˆå…¨å±€çŠ¶æ€ï¼‰
 */
export interface TaskList {
  id: string
  goal: Goal
  tasks: Task[]
  status: "planning" | "executing" | "completed" | "failed"
  createdAt: Date
  updatedAt: Date
}

/**
 * ä»»åŠ¡å®šä¹‰
 */
export interface Task {
  id: string
  parentId?: string           // çˆ¶ä»»åŠ¡ IDï¼ˆæ”¯æŒå±‚çº§ï¼‰
  
  // ä»»åŠ¡æè¿°
  title: string
  description: string
  
  // å®Œæˆæ ‡å‡†ï¼ˆå…³é”®åˆ›æ–°ï¼šæ˜¾å¼å®šä¹‰ï¼‰
  completionCriteria: string[]
  
  // æ‰€éœ€èƒ½åŠ›
  requiredSkills: string[]
  requiredTools: string[]
  
  // ä¾èµ–å…³ç³»
  dependencies: string[]      // ä¾èµ–çš„å…¶ä»–ä»»åŠ¡ ID
  
  // çŠ¶æ€
  status: TaskStatus
  
  // æ‰§è¡Œç»“æœ
  result?: TaskResult
  
  // åˆ†é…çš„ Actor
  assignedActorId?: string
  
  // ä¼˜å…ˆçº§å’Œé¢„ä¼°
  priority: "critical" | "high" | "medium" | "low"
  estimatedDuration?: number  // åˆ†é’Ÿ
}

export type TaskStatus = 
  | "pending"       // å¾…å¼€å§‹
  | "ready"         // ä¾èµ–å·²æ»¡è¶³ï¼Œå¯æ‰§è¡Œ
  | "assigned"      // å·²åˆ†é… Actor
  | "in_progress"   // æ‰§è¡Œä¸­
  | "completed"     // å·²å®Œæˆ
  | "failed"        // å¤±è´¥
  | "blocked"       // è¢«é˜»å¡

/**
 * é‡è§„åˆ’ç»“æœ
 */
export interface ReplanResult {
  // æ›´æ–°åçš„ä»»åŠ¡åˆ—è¡¨ï¼ˆæˆ˜ç•¥è°ƒæ•´ï¼‰
  updatedTaskList: TaskList
  
  // å˜æ›´è¯´æ˜
  changes: TaskChange[]
  
  // ä¸‹ä¸€ä¸ªåŠ¨ä½œï¼ˆæˆ˜æœ¯å†³ç­–ï¼‰
  nextAction: NextAction
  
  // è§„åˆ’è¯´æ˜
  reasoning: string
}

/**
 * ä¸‹ä¸€ä¸ªåŠ¨ä½œ
 */
export type NextAction = 
  | { type: "dispatch"; taskId: string }           // æ´¾å‘ä»»åŠ¡
  | { type: "wait"; reason: string }               // ç­‰å¾…
  | { type: "human_input"; prompt: string }        // è¯·æ±‚äººå·¥è¾“å…¥
  | { type: "complete"; summary: string }          // å®Œæˆ
  | { type: "fail"; error: string }                // å¤±è´¥

/**
 * åŠ¨æ€è§„åˆ’å™¨å®ç°
 */
export class LLMDynamicPlanner implements DynamicPlanner {
  private model: LanguageModel
  private progressManager: ProgressManager
  
  async plan(goal: Goal, analysis: DomainAnalysisResult): Promise<TaskList> {
    const prompt = this.buildPlanningPrompt(goal, analysis)
    
    const response = await this.model.generate({
      messages: [
        { role: "system", content: this.getPlanningSystemPrompt() },
        { role: "user", content: prompt }
      ],
      responseFormat: { type: "json_object" }
    })
    
    const tasks = TaskListSchema.parse(JSON.parse(response))
    
    // åˆå§‹åŒ–è¿›åº¦ç®¡ç†
    await this.progressManager.initialize(tasks)
    
    return tasks
  }
  
  async replan(
    goal: Goal,
    currentTaskList: TaskList,
    executionHistory: ExecutionHistory
  ): Promise<ReplanResult> {
    // æ ¸å¿ƒï¼šåŒè¾“å‡ºè®¾è®¡
    // 1. æˆ˜ç•¥å±‚ï¼šæ›´æ–°å…¨å±€ä»»åŠ¡åˆ—è¡¨
    // 2. æˆ˜æœ¯å±‚ï¼šå†³å®šä¸‹ä¸€ä¸ªå…·ä½“åŠ¨ä½œ
    
    const prompt = this.buildReplanPrompt(goal, currentTaskList, executionHistory)
    
    const response = await this.model.generate({
      messages: [
        { role: "system", content: this.getReplanSystemPrompt() },
        { role: "user", content: prompt }
      ],
      responseFormat: { type: "json_object" }
    })
    
    const result = ReplanResultSchema.parse(JSON.parse(response))
    
    // åŒæ­¥æ›´æ–°è¿›åº¦ç®¡ç†å™¨
    await this.progressManager.update(result.updatedTaskList)
    
    return result
  }
  
  async getNextAction(taskList: TaskList): Promise<NextAction> {
    // æ‰¾åˆ°æ‰€æœ‰"å°±ç»ª"çŠ¶æ€çš„ä»»åŠ¡
    const readyTasks = taskList.tasks.filter(t => 
      t.status === "ready" || 
      (t.status === "pending" && this.areDependenciesMet(t, taskList))
    )
    
    if (readyTasks.length === 0) {
      // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
      const inProgress = taskList.tasks.filter(t => t.status === "in_progress")
      if (inProgress.length > 0) {
        return { type: "wait", reason: "ç­‰å¾…æ‰§è¡Œä¸­çš„ä»»åŠ¡å®Œæˆ" }
      }
      
      // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
      const allCompleted = taskList.tasks.every(t => t.status === "completed")
      if (allCompleted) {
        return { type: "complete", summary: "æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ" }
      }
      
      // å¦åˆ™å¯èƒ½æ˜¯å¤±è´¥æˆ–é˜»å¡
      return { type: "fail", error: "ä»»åŠ¡æ‰§è¡Œå—é˜»" }
    }
    
    // æŒ‰ä¼˜å…ˆçº§é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡
    const nextTask = this.selectHighestPriority(readyTasks)
    return { type: "dispatch", taskId: nextTask.id }
  }
  
  private getPlanningSystemPrompt(): string {
    return `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»»åŠ¡è§„åˆ’ä¸“å®¶ã€‚å°†ç”¨æˆ·ç›®æ ‡åˆ†è§£ä¸ºå¯æ‰§è¡Œçš„å­ä»»åŠ¡ã€‚

è§„åˆ’åŸåˆ™ï¼š
1. æ¯ä¸ªå­ä»»åŠ¡åº”è¯¥è¶³å¤Ÿå…·ä½“ï¼Œå¯ä»¥è¢«å•ç‹¬æ‰§è¡Œ
2. æ˜ç¡®å®šä¹‰æ¯ä¸ªä»»åŠ¡çš„å®Œæˆæ ‡å‡†
3. è¯†åˆ«ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»
4. è¯„ä¼°å“ªäº›ä»»åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œ
5. ä¸ºæ¯ä¸ªä»»åŠ¡æŒ‡å®šæ‰€éœ€æŠ€èƒ½å’Œå·¥å…·

è¾“å‡ºæ ¼å¼ï¼šJSON ç»“æ„çš„ä»»åŠ¡åˆ—è¡¨ï¼ŒåŒ…å«ï¼š
- tasks: ä»»åŠ¡æ•°ç»„
- parallelGroups: å¯å¹¶è¡Œçš„ä»»åŠ¡ç»„
- criticalPath: å…³é”®è·¯å¾„ä»»åŠ¡
`
  }
}
```

#### 6.5.5 Actor å·¥å‚ (Actor Factory)

> **äº¤å‰å¼•ç”¨ï¼š** æœ¬ç»„ä»¶ä¸ 9.3.4 TemplateSynthesizer éƒ½æ¶‰åŠåŠ¨æ€ç»„è£… Agentã€‚åŒºåˆ†ç‚¹ï¼šActorFactory ä¾§é‡ **å•ä¸ª Actor çš„å®ä¾‹åŒ–**ï¼ˆLLM + Tools + Prompt + Memoryï¼‰ï¼ŒTemplateSynthesizer ä¾§é‡ **å¤š Agent åœºæ™¯æ¨¡æ¿çš„ç¼–æ’ç”Ÿæˆ**ã€‚å®ç°æ—¶ TemplateSynthesizer åº”è°ƒç”¨ ActorFactory æ¥åˆ›å»ºå•ä¸ª Actorã€‚

Actor å·¥å‚è´Ÿè´£æŒ‰éœ€åˆ›å»ºä¸“ä¸šåŒ–çš„ Actorï¼Œè¿™æ˜¯åŠ¨æ€ Agent ç»„è£…çš„æ ¸å¿ƒï¼š

```typescript
// planner/actor-factory.ts

/**
 * Actor å·¥å‚
 * æ ¸å¿ƒèƒ½åŠ›ï¼šæŒ‰éœ€åˆ›å»ºä¸“ä¸šåŒ– Actorï¼ˆè‡ªåŠ©æåˆ Agentï¼‰
 * 
 * å½¢å¼åŒ–å®šä¹‰ (æ¥è‡ª Aime è®ºæ–‡)ï¼š
 * A_t = F_factory(g_t) where A_t = { LLM_t, T_t, P_t, M_t }
 */
export interface ActorFactory {
  /**
   * åˆ›å»ºä¸“ä¸šåŒ– Actor
   */
  createActor(spec: ActorSpec): Promise<DynamicActor>
  
  /**
   * è·å–å¯ç”¨çš„ç»„ä»¶
   */
  getAvailableComponents(): Promise<ActorComponents>
}

/**
 * Actor è§„æ ¼ï¼ˆæè¿°è¦åˆ›å»ºä»€ä¹ˆæ ·çš„ Actorï¼‰
 */
export interface ActorSpec {
  // ä»»åŠ¡ä¿¡æ¯
  task: Task
  
  // é¢†åŸŸåˆ†æç»“æœï¼ˆæ¥è‡ª Domain Analyzerï¼‰
  domainAnalysis: DomainAnalysisResult
  
  // ä¸Šä¸‹æ–‡ä¿¡æ¯
  context: ExecutionContext
}

/**
 * Actor ç»„ä»¶åº“
 */
export interface ActorComponents {
  // å¯ç”¨çš„è§’è‰²äººè®¾
  personas: PersonaTemplate[]
  
  // å¯ç”¨çš„å·¥å…·åŒ…
  toolBundles: ToolBundle[]
  
  // å¯ç”¨çš„çŸ¥è¯†åº“
  knowledgeBases: KnowledgeBase[]
  
  // å¯ç”¨çš„æŠ€èƒ½
  skills: SkillDefinition[]
}

/**
 * è§’è‰²äººè®¾æ¨¡æ¿
 */
export interface PersonaTemplate {
  id: string
  name: string
  description: string
  expertise: string[]
  
  // System Prompt æ¨¡æ¿
  systemPromptTemplate: string
  
  // é€‚ç”¨åœºæ™¯
  applicableDomains: string[]
  
  // æ¨èå·¥å…·
  recommendedTools: string[]
}

/**
 * å·¥å…·åŒ…ï¼ˆBundleï¼‰
 * å…³é”®è®¾è®¡ï¼šå°†å·¥å…·ç»„ç»‡ä¸ºåŠŸèƒ½åŒ…ï¼Œè€Œéæ‰å¹³åˆ—è¡¨
 */
export interface ToolBundle {
  id: string
  name: string
  description: string
  category: string
  
  // åŒ…å«çš„å·¥å…·
  tools: ToolDefinition[]
  
  // é€‚ç”¨åœºæ™¯
  useCases: string[]
}

/**
 * åŠ¨æ€ Actorï¼ˆè¿è¡Œæ—¶å®ä¾‹ï¼‰
 */
export interface DynamicActor {
  id: string
  
  // ç»„è£…çš„ç»„ä»¶
  persona: PersonaTemplate
  toolkit: ToolDefinition[]
  knowledgeBase: KnowledgeBase[]
  
  // ç”Ÿæˆçš„ System Prompt
  systemPrompt: string
  
  // æ‰§è¡Œä»»åŠ¡
  execute(task: Task): Promise<TaskResult>
  
  // æŠ¥å‘Šè¿›åº¦
  reportProgress(status: ProgressUpdate): Promise<void>
}

/**
 * Actor å·¥å‚å®ç°
 */
export class LLMActorFactory implements ActorFactory {
  private model: LanguageModel
  private personaRegistry: PersonaRegistry
  private toolBundleRegistry: ToolBundleRegistry
  private knowledgeBaseRegistry: KnowledgeBaseRegistry
  private skillRegistry: SkillRegistry
  
  async createActor(spec: ActorSpec): Promise<DynamicActor> {
    // 1. é€‰æ‹©åˆé€‚çš„ Persona
    const persona = await this.selectPersona(spec)
    
    // 2. ç»„è£…å·¥å…·åŒ…
    const toolkit = await this.assembleToolkit(spec)
    
    // 3. åŠ è½½ç›¸å…³çŸ¥è¯†åº“
    const knowledge = await this.loadKnowledge(spec)
    
    // 4. ç”Ÿæˆå®šåˆ¶åŒ– System Prompt
    const systemPrompt = await this.generateSystemPrompt(
      persona, 
      toolkit, 
      knowledge, 
      spec.task,
      spec.context
    )
    
    // 5. åˆ›å»º Actor å®ä¾‹
    return new DynamicActorImpl({
      id: generateId(),
      persona,
      toolkit,
      knowledgeBase: knowledge,
      systemPrompt,
      model: this.model,
      progressManager: spec.context.progressManager
    })
  }
  
  /**
   * é€‰æ‹© Persona
   * åŸºäºä»»åŠ¡éœ€æ±‚é€‰æ‹©æœ€åˆé€‚çš„è§’è‰²äººè®¾
   */
  private async selectPersona(spec: ActorSpec): Promise<PersonaTemplate> {
    const { task, domainAnalysis } = spec
    
    // è·å–å€™é€‰ Personas
    const candidates = await this.personaRegistry.findByDomains(
      domainAnalysis.domains.map(d => d.domain)
    )
    
    if (candidates.length === 0) {
      // åŠ¨æ€ç”Ÿæˆ Persona
      return this.generatePersona(spec)
    }
    
    // ç”¨ LLM é€‰æ‹©æœ€åˆé€‚çš„
    const selection = await this.model.generate({
      messages: [{
        role: "user",
        content: `ä»»åŠ¡ï¼š${task.title}\næè¿°ï¼š${task.description}\næ‰€éœ€æŠ€èƒ½ï¼š${task.requiredSkills.join(", ")}\n\nä»ä»¥ä¸‹è§’è‰²ä¸­é€‰æ‹©æœ€åˆé€‚çš„ï¼š\n${JSON.stringify(candidates, null, 2)}\n\nè¾“å‡ºé€‰ä¸­çš„è§’è‰² ID`
      }]
    })
    
    return candidates.find(p => p.id === selection.trim()) || candidates[0]
  }
  
  /**
   * ç»„è£…å·¥å…·åŒ…
   * Bundle æ¨¡å¼ï¼šé€‰æ‹©åŠŸèƒ½åŒ…è€Œéå•ä¸ªå·¥å…·
   */
  private async assembleToolkit(spec: ActorSpec): Promise<ToolDefinition[]> {
    const { task, domainAnalysis } = spec
    
    // 1. æ ¹æ®æ‰€éœ€å·¥å…·è·å– Bundles
    const requiredBundles = new Set<string>()
    
    for (const toolReq of domainAnalysis.requiredTools) {
      const bundle = await this.toolBundleRegistry.findByTool(toolReq.toolId)
      if (bundle) {
        requiredBundles.add(bundle.id)
      }
    }
    
    // 2. æ ¹æ®é¢†åŸŸè¡¥å……æ¨è Bundles
    for (const domain of domainAnalysis.domains) {
      const domainBundles = await this.toolBundleRegistry.findByDomain(domain.domain)
      domainBundles.forEach(b => requiredBundles.add(b.id))
    }
    
    // 3. ç»„è£…æœ€ç»ˆå·¥å…·åˆ—è¡¨
    const tools: ToolDefinition[] = []
    for (const bundleId of requiredBundles) {
      const bundle = await this.toolBundleRegistry.get(bundleId)
      tools.push(...bundle.tools)
    }
    
    // 4. æ·»åŠ é€šç”¨ç³»ç»Ÿå·¥å…·
    tools.push(this.getProgressUpdateTool())
    
    return tools
  }
  
  /**
   * ç”Ÿæˆ System Prompt
   * ç»„åˆå¤šä¸ªç»„ä»¶ç”Ÿæˆå®šåˆ¶åŒ–æç¤º
   */
  private async generateSystemPrompt(
    persona: PersonaTemplate,
    toolkit: ToolDefinition[],
    knowledge: KnowledgeBase[],
    task: Task,
    context: ExecutionContext
  ): Promise<string> {
    // å…¬å¼ (æ¥è‡ª Aime)ï¼š
    // P_t = Compose(Ï_t, desc(T_t), Îº_t, Îµ, Î“)
    
    const components = {
      // Ï_t: Persona
      persona: this.renderPersona(persona, task),
      
      // desc(T_t): Tool descriptions
      toolDescriptions: this.renderToolDescriptions(toolkit),
      
      // Îº_t: Knowledge
      knowledge: await this.renderKnowledge(knowledge, task),
      
      // Îµ: Environment
      environment: this.renderEnvironment(context),
      
      // Î“: Format requirements
      format: this.renderFormatRequirements(task)
    }
    
    return `${components.persona}

## å¯ç”¨å·¥å…·

${components.toolDescriptions}

## ç›¸å…³çŸ¥è¯†

${components.knowledge}

## ç¯å¢ƒä¿¡æ¯

${components.environment}

## è¾“å‡ºè¦æ±‚

${components.format}

## å½“å‰ä»»åŠ¡

**æ ‡é¢˜**ï¼š${task.title}
**æè¿°**ï¼š${task.description}
**å®Œæˆæ ‡å‡†**ï¼š
${task.completionCriteria.map(c => `- ${c}`).join('\n')}

è¯·å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼Œä½¿ç”¨ ReAct æ¨¡å¼ï¼šæ€è€ƒ â†’ è¡ŒåŠ¨ â†’ è§‚å¯Ÿ â†’ æ€è€ƒ â†’ ...
åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œé€‚æ—¶è°ƒç”¨ update_progress å·¥å…·æŠ¥å‘Šè¿›åº¦ã€‚
`
  }
  
  /**
   * è·å–è¿›åº¦æ›´æ–°å·¥å…·
   * ç‰¹æ®Šç³»ç»Ÿå·¥å…·ï¼Œç”¨äº Actor å‘ Planner æŠ¥å‘Šè¿›åº¦
   */
  private getProgressUpdateTool(): ToolDefinition {
    return {
      name: "update_progress",
      description: "å‘ç³»ç»ŸæŠ¥å‘Šå½“å‰ä»»åŠ¡è¿›åº¦ï¼ŒåŒ…æ‹¬é‡è¦é‡Œç¨‹ç¢‘æˆ–é‡åˆ°çš„éšœç¢",
      parameters: z.object({
        status: z.enum(["in_progress", "milestone", "blocked", "completed", "failed"]),
        message: z.string().describe("è¿›åº¦è¯´æ˜"),
        percentage: z.number().min(0).max(100).optional(),
        artifacts: z.array(z.object({
          type: z.string(),
          path: z.string()
        })).optional()
      }),
      execute: async (params, ctx) => {
        await ctx.progressManager.reportProgress(ctx.taskId, params)
        return { success: true }
      }
    }
  }
}
```

#### 6.5.6 è¿›åº¦ç®¡ç†æ¨¡å— (Progress Management)

è¿›åº¦ç®¡ç†æ¨¡å—æ˜¯ç³»ç»Ÿåè°ƒçš„æ ¸å¿ƒï¼Œæä¾›å…¨å±€çŠ¶æ€æ„ŸçŸ¥ï¼š

```typescript
// planner/progress-manager.ts

/**
 * è¿›åº¦ç®¡ç†æ¨¡å—
 * æ ¸å¿ƒèŒè´£ï¼šç»´æŠ¤å…¨å±€ä»»åŠ¡çŠ¶æ€ï¼Œä½œä¸ºç³»ç»Ÿ"å•ä¸€äº‹å®æº"
 */
export interface ProgressManager {
  /**
   * åˆå§‹åŒ–ä»»åŠ¡åˆ—è¡¨
   */
  initialize(taskList: TaskList): Promise<void>
  
  /**
   * æ›´æ–°ä»»åŠ¡åˆ—è¡¨
   */
  update(taskList: TaskList): Promise<void>
  
  /**
   * æ¥æ”¶è¿›åº¦æŠ¥å‘Š
   */
  reportProgress(taskId: string, update: ProgressUpdate): Promise<void>
  
  /**
   * è·å–å½“å‰è¿›åº¦
   */
  getProgress(): Promise<ProgressSnapshot>
  
  /**
   * è®¢é˜…è¿›åº¦å˜æ›´
   */
  subscribe(listener: ProgressListener): Unsubscribe
}

/**
 * è¿›åº¦å¿«ç…§
 */
export interface ProgressSnapshot {
  taskList: TaskList
  
  // ç»Ÿè®¡ä¿¡æ¯
  stats: {
    total: number
    completed: number
    inProgress: number
    failed: number
    blocked: number
    pending: number
  }
  
  // å®Œæˆç™¾åˆ†æ¯”
  overallProgress: number
  
  // å…³é”®è·¯å¾„çŠ¶æ€
  criticalPathStatus: "on_track" | "delayed" | "blocked"
  
  // é¢„ä¼°å‰©ä½™æ—¶é—´
  estimatedTimeRemaining?: number
}

/**
 * è¿›åº¦åˆ—è¡¨ï¼ˆMarkdown æ ¼å¼ï¼Œäººæœºå¯è¯»ï¼‰
 * 
 * ç¤ºä¾‹ï¼š
 * - Objective 1: Perform Initial Research
 *   - [x] Sub-objective 1.1: Research top attractions
 *   - [x] Sub-objective 1.2: Investigate transportation options
 * - Objective 2: Finalize Itinerary and Budget
 *   - [ ] Sub-objective 2.1: Research hotel accommodations
 *   - [ ] Sub-objective 2.2: Calculate total estimated budget
 */
export class ProgressListRenderer {
  render(taskList: TaskList): string {
    const lines: string[] = []
    
    const renderTask = (task: Task, indent: number) => {
      const prefix = "  ".repeat(indent)
      const status = task.status === "completed" ? "[x]" : "[ ]"
      const statusEmoji = this.getStatusEmoji(task.status)
      
      lines.push(`${prefix}- ${status} ${statusEmoji} ${task.title}`)
      
      // å¦‚æœæœ‰å­ä»»åŠ¡ï¼Œé€’å½’æ¸²æŸ“
      const children = taskList.tasks.filter(t => t.parentId === task.id)
      for (const child of children) {
        renderTask(child, indent + 1)
      }
    }
    
    // æ¸²æŸ“é¡¶çº§ä»»åŠ¡
    const topLevelTasks = taskList.tasks.filter(t => !t.parentId)
    for (const task of topLevelTasks) {
      renderTask(task, 0)
    }
    
    return lines.join('\n')
  }
  
  private getStatusEmoji(status: TaskStatus): string {
    const map: Record<TaskStatus, string> = {
      pending: "â³",
      ready: "ğŸŸ¡",
      assigned: "ğŸ‘¤",
      in_progress: "ğŸ”„",
      completed: "âœ…",
      failed: "âŒ",
      blocked: "ğŸš«"
    }
    return map[status]
  }
}

/**
 * è¿›åº¦ç®¡ç†å™¨å®ç°
 */
export class ProgressManagerImpl implements ProgressManager {
  private taskList: TaskList
  private listeners: Set<ProgressListener> = new Set()
  private eventEmitter: EventEmitter
  
  async initialize(taskList: TaskList): Promise<void> {
    this.taskList = taskList
    this.notifyListeners()
  }
  
  async update(taskList: TaskList): Promise<void> {
    // è®¡ç®—å·®å¼‚
    const changes = this.computeChanges(this.taskList, taskList)
    
    this.taskList = taskList
    
    // æŒä¹…åŒ–
    await this.persist()
    
    // é€šçŸ¥å˜æ›´
    this.notifyListeners(changes)
  }
  
  async reportProgress(taskId: string, update: ProgressUpdate): Promise<void> {
    const task = this.taskList.tasks.find(t => t.id === taskId)
    if (!task) return
    
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€
    if (update.status === "completed") {
      task.status = "completed"
      task.result = {
        success: true,
        output: update.message,
        artifacts: update.artifacts
      }
    } else if (update.status === "failed") {
      task.status = "failed"
      task.result = {
        success: false,
        error: update.message
      }
    } else if (update.status === "blocked") {
      task.status = "blocked"
    } else {
      task.status = "in_progress"
    }
    
    // å‘é€å®æ—¶æ›´æ–°äº‹ä»¶
    this.eventEmitter.emit("progress_update", {
      taskId,
      update,
      snapshot: await this.getProgress()
    })
    
    this.notifyListeners()
  }
  
  async getProgress(): Promise<ProgressSnapshot> {
    const tasks = this.taskList.tasks
    
    const stats = {
      total: tasks.length,
      completed: tasks.filter(t => t.status === "completed").length,
      inProgress: tasks.filter(t => t.status === "in_progress").length,
      failed: tasks.filter(t => t.status === "failed").length,
      blocked: tasks.filter(t => t.status === "blocked").length,
      pending: tasks.filter(t => t.status === "pending" || t.status === "ready").length
    }
    
    return {
      taskList: this.taskList,
      stats,
      overallProgress: Math.round((stats.completed / stats.total) * 100),
      criticalPathStatus: this.analyzeCriticalPath(),
      estimatedTimeRemaining: this.estimateRemainingTime()
    }
  }
}
```

#### 6.5.7 å¹¶è¡Œè°ƒåº¦ (Parallel Orchestration)

Swarm èœ‚ç¾¤çš„å¹¶è¡Œç¼–æ’è°ƒåº¦å™¨ï¼ŒåŸºäº PARL (Parallel-Agent Reinforcement Learning) æ€æƒ³ï¼š

```typescript
// planner/parallel-orchestrator.ts

/**
 * å¹¶è¡Œç¼–æ’å™¨
 * Swarm èœ‚ç¾¤å¹¶è¡Œè°ƒåº¦å™¨è®¾è®¡ï¼š
 * - å¯åè°ƒå¤šè¾¾ 100 ä¸ªå­ Agent
 * - æ‰§è¡Œå¤šè¾¾ 1500 æ­¥çš„å¹¶è¡Œå·¥ä½œæµ
 * - æ— éœ€é¢„å®šä¹‰è§’è‰²æˆ–æ‰‹å·¥å·¥ä½œæµ
 */
export interface ParallelOrchestrator {
  /**
   * åˆ†æä»»åŠ¡çš„å¹¶è¡Œæ½œåŠ›
   */
  analyzeParallelism(taskList: TaskList): Promise<ParallelismAnalysis>
  
  /**
   * æ‰§è¡Œå¹¶è¡Œè°ƒåº¦
   */
  executeParallel(
    tasks: Task[],
    factory: ActorFactory,
    context: ExecutionContext
  ): Promise<ParallelExecutionResult>
}

/**
 * å¹¶è¡Œåº¦åˆ†æç»“æœ
 */
export interface ParallelismAnalysis {
  // å¯å¹¶è¡Œçš„ä»»åŠ¡ç»„
  parallelGroups: TaskGroup[]
  
  // æœ€å¤§å¹¶è¡Œåº¦
  maxParallelism: number
  
  // å…³é”®æ­¥éª¤æ•°ï¼ˆå»¶è¿ŸæŒ‡æ ‡ï¼‰
  criticalSteps: number
  
  // é¢„ä¼°æ—¶é—´èŠ‚çœ
  estimatedTimeSaving: number
}

/**
 * å…³é”®æ­¥éª¤è®¡ç®—
 * Critical Steps æŒ‡æ ‡ï¼š
 * 
 * CriticalSteps = Î£(S_main(t) + max_i S_sub,i(t))
 * 
 * S_main(t): ä¸»ç¼–æ’å™¨å¼€é”€
 * max_i S_sub,i(t): æ¯é˜¶æ®µæœ€æ…¢å­ Agent
 */
export function calculateCriticalSteps(
  orchestratorSteps: number[],
  subAgentSteps: number[][]
): number {
  let total = 0
  
  for (let t = 0; t < orchestratorSteps.length; t++) {
    const mainSteps = orchestratorSteps[t]
    const maxSubSteps = subAgentSteps[t] 
      ? Math.max(...subAgentSteps[t]) 
      : 0
    
    total += mainSteps + maxSubSteps
  }
  
  return total
}

/**
 * å¹¶è¡Œç¼–æ’å™¨å®ç°
 */
export class ParallelOrchestratorImpl implements ParallelOrchestrator {
  private actorPool: Map<string, DynamicActor> = new Map()
  private maxConcurrency: number
  
  constructor(options: { maxConcurrency?: number } = {}) {
    // é»˜è®¤å¹¶è¡Œåº¦åŸºäºå®é™…èµ„æºï¼ˆAPI å¹¶å‘é™åˆ¶ã€token é¢„ç®—ï¼‰åŠ¨æ€è®¾å®š
    this.maxConcurrency = options.maxConcurrency || 10
  }
  
  async analyzeParallelism(taskList: TaskList): Promise<ParallelismAnalysis> {
    const tasks = taskList.tasks
    
    // æ„å»ºä¾èµ–å›¾
    const dependencyGraph = this.buildDependencyGraph(tasks)
    
    // æ‹“æ‰‘æ’åºï¼Œè¯†åˆ«å¯å¹¶è¡Œä»»åŠ¡
    const levels = this.topologicalLevels(dependencyGraph)
    
    // åˆ†ææ¯å±‚çš„å¹¶è¡Œåº¦
    const parallelGroups = levels.map((levelTasks, levelIndex) => ({
      level: levelIndex,
      tasks: levelTasks,
      parallelism: levelTasks.length
    }))
    
    const maxParallelism = Math.max(...parallelGroups.map(g => g.parallelism))
    
    // è®¡ç®—å…³é”®æ­¥éª¤
    const criticalSteps = this.estimateCriticalSteps(parallelGroups)
    
    // å¯¹æ¯”ä¸²è¡Œæ‰§è¡Œä¼°ç®—æ—¶é—´èŠ‚çœ
    const serialSteps = tasks.reduce((sum, t) => sum + (t.estimatedDuration || 1), 0)
    const estimatedTimeSaving = Math.max(0, serialSteps - criticalSteps)
    
    return {
      parallelGroups,
      maxParallelism,
      criticalSteps,
      estimatedTimeSaving
    }
  }
  
  async executeParallel(
    tasks: Task[],
    factory: ActorFactory,
    context: ExecutionContext
  ): Promise<ParallelExecutionResult> {
    // é™åˆ¶å¹¶è¡Œåº¦
    const concurrency = Math.min(tasks.length, this.maxConcurrency)
    
    // åˆ›å»º Actor å®ä¾‹
    const actors = await Promise.all(
      tasks.slice(0, concurrency).map(task => 
        factory.createActor({
          task,
          domainAnalysis: context.domainAnalysis,
          context
        })
      )
    )
    
    // è®°å½•å¼€å§‹æ—¶é—´
    const startTime = Date.now()
    
    // å¹¶è¡Œæ‰§è¡Œ
    const results = await Promise.allSettled(
      actors.map((actor, index) => actor.execute(tasks[index]))
    )
    
    // æ”¶é›†ç»“æœ
    const executionResults: TaskResult[] = results.map((result, index) => {
      if (result.status === "fulfilled") {
        return result.value
      } else {
        return {
          success: false,
          error: result.reason.message
        }
      }
    })
    
    // è®¡ç®—å®é™…å…³é”®æ­¥éª¤
    const actualDuration = Date.now() - startTime
    
    return {
      results: executionResults,
      parallelism: concurrency,
      duration: actualDuration,
      successRate: executionResults.filter(r => r.success).length / executionResults.length
    }
  }
  
  /**
   * æ„å»ºä¾èµ–å›¾
   */
  private buildDependencyGraph(tasks: Task[]): Map<string, string[]> {
    const graph = new Map<string, string[]>()
    
    for (const task of tasks) {
      graph.set(task.id, task.dependencies || [])
    }
    
    return graph
  }
  
  /**
   * æ‹“æ‰‘åˆ†å±‚
   * åŒä¸€å±‚çš„ä»»åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œ
   * graph: taskId â†’ dependenciesï¼ˆå‰é©±ä»»åŠ¡ï¼‰
   */
  private topologicalLevels(graph: Map<string, string[]>): Task[][] {
    const levels: Task[][] = []
    const taskMap = new Map<string, Task>()
    
    // æ„å»ºåå‘é‚»æ¥è¡¨ï¼štaskId â†’ ä¾èµ–å®ƒçš„ä»»åŠ¡ï¼ˆåç»§ï¼‰
    const dependents = new Map<string, string[]>()
    const inDegree = new Map<string, number>()
    
    for (const [id] of graph) {
      dependents.set(id, [])
      inDegree.set(id, 0)
    }
    
    for (const [id, deps] of graph) {
      // å…¥åº¦ = è¯¥ä»»åŠ¡çš„å‰é©±æ•°é‡
      inDegree.set(id, deps.length)
      // åå‘ï¼šæ¯ä¸ªå‰é©±çš„åç»§åˆ—è¡¨ä¸­åŠ å…¥å½“å‰ä»»åŠ¡
      for (const dep of deps) {
        dependents.get(dep)?.push(id)
      }
    }
    
    // BFSï¼šä»å…¥åº¦ä¸º 0 çš„ä»»åŠ¡ï¼ˆæ— å‰é©±ï¼‰å¼€å§‹
    let currentLevel = Array.from(graph.keys()).filter(id => 
      inDegree.get(id) === 0
    )
    
    while (currentLevel.length > 0) {
      levels.push(currentLevel.map(id => taskMap.get(id)!))
      
      const nextLevel: string[] = []
      for (const id of currentLevel) {
        // å®Œæˆå½“å‰ä»»åŠ¡åï¼Œå°†ä¾èµ–å®ƒçš„åç»§ä»»åŠ¡å…¥åº¦ -1
        for (const dependent of (dependents.get(id) || [])) {
          const newDegree = (inDegree.get(dependent) || 0) - 1
          inDegree.set(dependent, newDegree)
          if (newDegree === 0) {
            nextLevel.push(dependent)
          }
        }
      }
      
      currentLevel = nextLevel
    }
    
    return levels
  }
}
```

#### 6.5.8 å®Œæ•´å·¥ä½œæµç¨‹

ä»¥â€œå¼€å‘ç”¨æˆ·ç®¡ç†æ¨¡å—ï¼ˆæ³¨å†Œ/ç™»å½•/æƒé™ï¼‰â€ä¸ºä¾‹ï¼š

```
Step 1  ç”¨æˆ·è¯·æ±‚ â†’ Domain Analyzer
        è¾“å‡º: domains=[coding:0.9, docs:0.6, testing:0.7], complexity=L3, mode=parallel

Step 2  Dynamic Planner ä»»åŠ¡åˆ†è§£
        T1(æ— ä¾èµ–) â†’ T2,T3,T4,T6(ä¾èµ–T1) â†’ T5(ä¾èµ–T2,T3,T4)

Step 3  æ‹“æ‰‘åˆ†å±‚ â†’ å¹¶è¡Œåº¦åˆ†æ
        Level 0: [T1]  |  Level 1: [T2,T3,T4,T6] Ã—4å¹¶è¡Œ  |  Level 2: [T5]
        Critical Steps=3, Serial Steps=6, Savingâ‰ˆ50%

Step 4  Actor Factory åŠ¨æ€åˆ›å»º
        T1â†’Architect, T2/T3â†’Backend, T4â†’Security, T5â†’QA, T6â†’DocWriter

Step 5  å¹¶è¡Œæ‰§è¡Œ + Progress Manager å®æ—¶è¿½è¸ª
        å„ Actor ç‹¬ç«‹è¿è¡Œ ReAct å¾ªç¯ï¼Œé€šè¿‡ update_progress å·¥å…·æŠ¥å‘Šè¿›åº¦

Step 6  åŠ¨æ€é‡è§„åˆ’ï¼ˆå¦‚éœ€ï¼‰
        T4 å¤±è´¥ â†’ Planner é‡æ–°è¯„ä¼° â†’ æ·»åŠ  T4' â†’ æ›´æ–°ä¾èµ– â†’ ç»§ç»­æ‰§è¡Œ

Step 7  å®Œæˆæ±‡æ€» â†’ ç”Ÿæˆæ€»ç»“æŠ¥å‘Š â†’ è¾“å‡ºç»™ç”¨æˆ·
```
â”‚                                                                              â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   Step 5: Actor åŠ¨æ€åˆ›å»º (Actor Factory)                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                              â”‚
â”‚   T1 â†’ Actor_Architect { persona: "APIè®¾è®¡å¸ˆ", tools: [read_file, write] }   â”‚
â”‚   T2 â†’ Actor_Backend   { persona: "åç«¯å¼€å‘", tools: [code, test, debug] }   â”‚
â”‚   T3 â†’ Actor_Backend   { persona: "åç«¯å¼€å‘", tools: [code, test, debug] }   â”‚
â”‚   T4 â†’ Actor_Security  { persona: "å®‰å…¨å·¥ç¨‹å¸ˆ", tools: [code, analyze] }     â”‚
â”‚   T5 â†’ Actor_QA        { persona: "æµ‹è¯•å·¥ç¨‹å¸ˆ", tools: [test, coverage] }    â”‚
â”‚   T6 â†’ Actor_DocWriter { persona: "æŠ€æœ¯æ–‡æ¡£", tools: [read, write_doc] }     â”‚
â”‚                                                                              â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   Step 6: å¹¶è¡Œæ‰§è¡Œ + å®æ—¶åé¦ˆ                                                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                                                 â”‚
â”‚   â”‚ T1æ‰§è¡Œ â”‚ â”€â”€â”€â”€â–º å®Œæˆ â”€â”€â”€â”€â–ºâ”                                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚                                              â”‚
â”‚                               â–¼                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚   â”‚ T2æ‰§è¡Œ â”‚ â”‚ T3æ‰§è¡Œ â”‚ â”‚ T4æ‰§è¡Œ â”‚ â”‚ T6æ‰§è¡Œ â”‚  â† å¹¶è¡Œ                        â”‚
â”‚   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚       â”‚          â”‚          â”‚                                                â”‚
â”‚       â”‚ è¿›åº¦æŠ¥å‘Š â”‚ è¿›åº¦æŠ¥å‘Š â”‚ è¿›åº¦æŠ¥å‘Š                                        â”‚
â”‚       â–¼          â–¼          â–¼                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚   â”‚        Progress Manager å®æ—¶æ›´æ–°          â”‚                              â”‚
â”‚   â”‚  - [ ] T1 âœ…                              â”‚                              â”‚
â”‚   â”‚  - [ ] T2 ğŸ”„ 75%                          â”‚                              â”‚
â”‚   â”‚  - [ ] T3 ğŸ”„ 60%                          â”‚                              â”‚
â”‚   â”‚  - [ ] T4 ğŸ”„ 40%                          â”‚                              â”‚
â”‚   â”‚  - [ ] T5 â³                              â”‚                              â”‚
â”‚   â”‚  - [x] T6 âœ…                              â”‚                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                               â”‚                                              â”‚
â”‚                               â–¼                                              â”‚
â”‚   Step 7: åŠ¨æ€é‡è§„åˆ’ï¼ˆå¦‚éœ€è¦ï¼‰                                               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                              â”‚
â”‚   å¦‚æœ T4 å¤±è´¥ï¼š                                                             â”‚
â”‚   Planner é‡æ–°è¯„ä¼° â†’ æ·»åŠ  T4' (ä¿®å¤æƒé™é—®é¢˜) â†’ æ›´æ–°ä¾èµ– â†’ ç»§ç»­æ‰§è¡Œ           â”‚
â”‚                                                                              â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   Step 8: å®Œæˆæ±‡æ€»                                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                              â”‚
â”‚   æ‰€æœ‰ä»»åŠ¡å®Œæˆ â†’ ç”Ÿæˆæ€»ç»“æŠ¥å‘Š â†’ è¾“å‡ºç»™ç”¨æˆ·                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.5.9 è‡ªåŠ© Agent æåˆæ¥å£

> **äº¤å‰å¼•ç”¨ï¼š** æœ¬ç»„ä»¶æ˜¯ 6.5.5 ActorFactory çš„**ç”¨æˆ·å±‚å°è£…**ã€‚ActorFactory æ˜¯åº•å±‚ Actor åˆ›å»ºå¼•æ“ï¼ŒAgentComposer æä¾›äº¤äº’å¼ UI é©±åŠ¨çš„è‡ªå®šä¹‰æµç¨‹ï¼Œå†…éƒ¨åº”å§”æ´¾ç»™ ActorFactory å®Œæˆå®é™…åˆ›å»ºã€‚

æä¾›ç”¨æˆ·çº§åˆ«çš„ Agent è‡ªå®šä¹‰èƒ½åŠ›ï¼š

```typescript
// planner/agent-composer.ts

/**
 * Agent æåˆå™¨
 * å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ç»„è£… Agent
 */
export interface AgentComposer {
  /**
   * äº¤äº’å¼åˆ›å»º Agent
   */
  createCustomAgent(spec: CustomAgentSpec): Promise<AgentDefinition>
  
  /**
   * ä»æ¨¡æ¿åˆ›å»º
   */
  createFromTemplate(templateId: string, overrides?: Partial<CustomAgentSpec>): Promise<AgentDefinition>
  
  /**
   * éªŒè¯ Agent é…ç½®
   */
  validate(spec: CustomAgentSpec): Promise<ValidationResult>
}

/**
 * è‡ªå®šä¹‰ Agent è§„æ ¼
 */
export interface CustomAgentSpec {
  // åŸºæœ¬ä¿¡æ¯
  name: string
  description: string
  
  // è§’è‰²è®¾å®š
  persona?: {
    role: string              // è§’è‰²åç§°
    expertise: string[]       // ä¸“ä¸šé¢†åŸŸ
    personality?: string      // æ€§æ ¼ç‰¹ç‚¹
  }
  
  // System Promptï¼ˆå¯é€‰ï¼Œå¦åˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰
  systemPrompt?: string
  
  // æŠ€èƒ½é€‰æ‹©
  skills?: string[]
  
  // å·¥å…·é€‰æ‹©
  tools?: string[]
  
  // å·¥å…·åŒ…é€‰æ‹©ï¼ˆæ¨èæ–¹å¼ï¼‰
  toolBundles?: string[]
  
  // çŸ¥è¯†åº“
  knowledgeBases?: string[]
  
  // é«˜çº§é…ç½®
  advanced?: {
    // æ¨¡å‹é€‰æ‹©
    model?: string
    temperature?: number
    maxTokens?: number
    
    // æ‰§è¡Œæ¨¡å¼
    orchestrationPattern?: "react" | "cot" | "tot" | "self_refine"
    
    // æƒé™
    permissions?: PermissionSet
    
    // è®°å¿†é…ç½®
    memoryConfig?: {
      shortTermSize?: number
      longTermEnabled?: boolean
      episodicEnabled?: boolean
    }
  }
}

/**
 * Agent æåˆå™¨å®ç°
 */
export class AgentComposerImpl implements AgentComposer {
  private personaGenerator: PersonaGenerator
  private promptBuilder: PromptBuilder
  private toolRegistry: ToolRegistry
  private skillRegistry: SkillRegistry
  
  async createCustomAgent(spec: CustomAgentSpec): Promise<AgentDefinition> {
    // 1. éªŒè¯è§„æ ¼
    const validation = await this.validate(spec)
    if (!validation.valid) {
      throw new ValidationError(validation.errors)
    }
    
    // 2. ç”Ÿæˆ/ä½¿ç”¨ Persona
    const persona = spec.persona 
      ? await this.personaGenerator.fromSpec(spec.persona)
      : await this.personaGenerator.generate(spec)
    
    // 3. ç»„è£…å·¥å…·ï¼ˆä¸€æ¬¡è§£æï¼Œå¤ç”¨ï¼‰
    const tools = await this.resolveTools(spec)
    
    // 4. ç”Ÿæˆ System Prompt
    const systemPrompt = spec.systemPrompt 
      || await this.promptBuilder.build({
          persona,
          skills: spec.skills,
          tools,
        })
    
    // 5. åˆ›å»º Agent å®šä¹‰
    const agentDef: AgentDefinition = {
      id: generateId(),
      name: spec.name,
      description: spec.description,
      systemPrompt,
      
      skills: spec.skills || [],
      tools: tools.map(t => t.name),
      
      model: spec.advanced?.model || "default",
      temperature: spec.advanced?.temperature || 0.7,
      maxTokens: spec.advanced?.maxTokens || 4096,
      
      orchestrationPattern: spec.advanced?.orchestrationPattern || "react",
      
      knowledgeBases: spec.knowledgeBases || [],
      
      permissions: spec.advanced?.permissions || defaultPermissions(),
      
      metadata: {
        createdBy: "agent_composer",
        createdAt: new Date().toISOString(),
        version: "1.0.0"
      }
    }
    
    // 6. æŒä¹…åŒ–
    await this.saveAgentDefinition(agentDef)
    
    return agentDef
  }
  
  private async resolveTools(spec: CustomAgentSpec): Promise<ToolDefinition[]> {
    const tools: ToolDefinition[] = []
    
    // ä»å·¥å…·åŒ…è§£æ
    if (spec.toolBundles) {
      for (const bundleId of spec.toolBundles) {
        const bundle = await this.toolRegistry.getBundle(bundleId)
        tools.push(...bundle.tools)
      }
    }
    
    // å•ç‹¬æ·»åŠ çš„å·¥å…·
    if (spec.tools) {
      for (const toolId of spec.tools) {
        const tool = await this.toolRegistry.get(toolId)
        if (tool && !tools.find(t => t.name === tool.name)) {
          tools.push(tool)
        }
      }
    }
    
    return tools
  }
}
```

---

## 7. Swarm èœ‚ç¾¤åŠ¨æ€æ‰©å®¹ç³»ç»Ÿ

> å€Ÿé‰´ Swarm-IDE çš„è®¾è®¡æ€æƒ³ï¼Œå®ç° Agent çš„åŠ¨æ€åˆ›å»ºã€è‡ªç»„ç»‡åä½œå’Œå¼¹æ€§æ‰©ç¼©å®¹

### 7.1 Swarm æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Swarm èœ‚ç¾¤åŠ¨æ€æ‰©å®¹ç³»ç»Ÿ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Swarm Coordinator                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚ Agent Factory â”‚  â”‚ Message Hub   â”‚  â”‚ Topology Mgr  â”‚            â”‚   â”‚
â”‚  â”‚  â”‚   åŠ¨æ€åˆ›å»º     â”‚  â”‚  æ¶ˆæ¯è·¯ç”±      â”‚  â”‚   æ‹“æ‰‘ç®¡ç†     â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          Agent Runner Pool                            â”‚   â”‚
â”‚  â”‚                                                                        â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚   â”‚ Runner  â”‚  â”‚ Runner  â”‚  â”‚ Runner  â”‚  â”‚ Runner  â”‚  â”‚ Runner  â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  (1-1)  â”‚  â”‚  (1-2)  â”‚  â”‚ (1-1-1) â”‚  â”‚ (1-1-2) â”‚  â”‚   ...   â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚        â”‚            â”‚            â”‚            â”‚            â”‚         â”‚   â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚  â”‚                              â”‚                                        â”‚   â”‚
â”‚  â”‚                     Message Queue (per Agent)                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Topology Graph                                â”‚   â”‚
â”‚  â”‚                                                                        â”‚   â”‚
â”‚  â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚   â”‚
â”‚  â”‚                           â”‚  Human  â”‚ â—„â”€â”€â”€ äººç±»ä¹Ÿæ˜¯ç‰¹æ®Šçš„ Agent       â”‚   â”‚
â”‚  â”‚                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                 â”‚   â”‚
â”‚  â”‚                                â”‚                                      â”‚   â”‚
â”‚  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚   â”‚
â”‚  â”‚                   â–¼            â–¼            â–¼                         â”‚   â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚   â”‚
â”‚  â”‚              â”‚ Agent   â”‚ â”‚ Agent   â”‚ â”‚ Agent   â”‚                     â”‚   â”‚
â”‚  â”‚              â”‚  (1-1)  â”‚ â”‚  (1-2)  â”‚ â”‚  (1-3)  â”‚                     â”‚   â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚   â”‚
â”‚  â”‚                   â”‚                                                   â”‚   â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚   â”‚
â”‚  â”‚         â–¼         â–¼         â–¼                                        â”‚   â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚   â”‚
â”‚  â”‚    â”‚ Agent   â”‚ â”‚ Agent   â”‚ â”‚ Agent   â”‚                               â”‚   â”‚
â”‚  â”‚    â”‚ (1-1-1) â”‚ â”‚ (1-1-2) â”‚ â”‚ (1-1-3) â”‚                               â”‚   â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚   â”‚
â”‚  â”‚                                                                        â”‚   â”‚
â”‚  â”‚    æ‹“æ‰‘åœ¨è¿è¡Œæ—¶åŠ¨æ€æ¼”åŒ–ï¼ŒAgent æŒ‰éœ€"é›‡ä½£"ä¸‹å±                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ ¸å¿ƒæ•°æ®æ¨¡å‹

```typescript
// swarm/types.ts

// Swarm Workspace - ä¸€ä¸ªç‹¬ç«‹çš„èœ‚ç¾¤ç©ºé—´
export interface SwarmWorkspace {
  id: string
  name: string
  createdAt: Date
  
  // äººç±» Agentï¼ˆç‰¹æ®Šï¼‰
  humanAgentId: string
  
  // åˆå§‹ Agent
  initialAgentId: string
  
  // é»˜è®¤ç¾¤ç»„
  defaultGroupId: string
}

// Agent å®ä¾‹ï¼ˆè¿è¡Œæ—¶ï¼‰
export interface AgentInstance {
  id: string
  workspaceId: string
  
  // è§’è‰²ä¿¡æ¯
  role: string                        // è§’è‰²åç§° (å¦‚ "coder", "reviewer")
  roleIndex: string                   // å±‚çº§ç´¢å¼• (å¦‚ "1-1-2")
  
  // çˆ¶å­å…³ç³»
  parentId?: string                   // çˆ¶ Agent ID
  childIds: string[]                  // å­ Agent IDs
  
  // LLM å†å²ï¼ˆæŒä¹…åŒ–ï¼‰
  llmHistory: LLMMessage[]            // å• Agent å…¨å±€è®°å¿†
  
  // è¿è¡ŒçŠ¶æ€
  status: AgentStatus                 // idle | running | waiting | terminated
  
  // å…ƒæ•°æ®
  createdAt: Date
  lastActiveAt: Date
}

// Agent çŠ¶æ€
export type AgentStatus = 
  | "idle"        // ç©ºé—²ï¼Œç­‰å¾…æ¶ˆæ¯
  | "running"     // æ­£åœ¨æ‰§è¡Œ LLM æ¨ç†
  | "waiting"     // ç­‰å¾…å·¥å…·æ‰§è¡Œ
  | "terminated"  // å·²ç»ˆæ­¢

// LLM æ¶ˆæ¯æ ¼å¼
export interface LLMMessage {
  role: "system" | "user" | "assistant" | "tool"
  content: string
  toolCalls?: ToolCall[]
  toolCallId?: string
  timestamp: Date
}

// ç¾¤ç»„ï¼ˆIM ç³»ç»Ÿï¼‰
export interface SwarmGroup {
  id: string
  workspaceId: string
  name?: string                       // ç¾¤åï¼ŒP2P å¯ä¸ºç©º
  memberIds: string[]                 // æˆå‘˜ Agent IDs
  createdAt: Date
}

// ç¾¤æˆå‘˜å…³ç³»
export interface GroupMember {
  groupId: string
  agentId: string
  lastReadMessageId?: string          // æœ€åè¯»åˆ°çš„æ¶ˆæ¯ ID
  joinedAt: Date
}

// æ¶ˆæ¯
export interface SwarmMessage {
  id: string                          // UUID v7 (å¯æ’åº)
  workspaceId: string
  groupId: string
  senderId: string                    // å‘é€è€… Agent ID
  
  contentType: "text" | "image" | "file" | "tool_result"
  content: string
  
  sendTime: Date
}
```

### 7.3 Agent åŠ¨æ€åˆ›å»º

> **å®ç°ç»Ÿä¸€æ³¨é‡Šï¼š** æœ¬èŠ‚ `AgentFactory` ä¸ 6.5.5 `ActorFactory` å‡æ¶‰åŠâ€œåŠ¨æ€åˆ›å»º Agent + é€‰æ‹©å·¥å…· + ç”Ÿæˆ System Promptâ€ã€‚å®ç°æ—¶åº” **ç»Ÿä¸€ä¸ºä¸€å¥—å·¥å‚**ï¼šSwarm `AgentFactory` è´Ÿè´£ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»º/æ³¨å†Œ/Runnerå¯åŠ¨ï¼‰ï¼Œå†…éƒ¨å§”æ´¾ `ActorFactory` å®Œæˆ Persona/Toolkit/Prompt çš„ç»„è£…ã€‚

```typescript
// swarm/factory.ts
export class AgentFactory {
  private registry: AgentRegistry
  private pool: RunnerPool
  
  /**
   * åŠ¨æ€åˆ›å»º Agent
   * æ ¸å¿ƒåŸè¯­ä¹‹ä¸€ï¼šcreate
   */
  async createAgent(spec: DynamicAgentSpec): Promise<AgentInstance> {
    // 1. éªŒè¯åˆ›å»ºæƒé™
    await this.validateCreationPermission(spec)
    
    // 2. ç”Ÿæˆè§’è‰²ç´¢å¼•
    const roleIndex = await this.generateRoleIndex(spec.parentId, spec.role)
    
    // 3. åˆ›å»º Agent å®ä¾‹
    const agent: AgentInstance = {
      id: generateId(),
      workspaceId: spec.workspaceId,
      role: spec.role,
      roleIndex,
      parentId: spec.parentId,
      childIds: [],
      llmHistory: [],
      status: "idle",
      createdAt: new Date(),
      lastActiveAt: new Date(),
    }
    
    // 4. åˆå§‹åŒ– System Prompt
    const systemPrompt = await this.buildSystemPrompt(agent, spec)
    agent.llmHistory.push({
      role: "system",
      content: systemPrompt,
      timestamp: new Date(),
    })
    
    // 5. æŒä¹…åŒ–
    await Storage.agents.insert(agent)
    
    // 6. æ›´æ–°çˆ¶ Agent çš„ childIds
    if (spec.parentId) {
      const parent = await Storage.agents.get(spec.parentId)
      await Storage.agents.update(spec.parentId, {
        childIds: [...parent.childIds, agent.id],
      })
    }
    
    // 7. åˆ›å»º P2P ç¾¤ç»„ï¼ˆä¸ Humanï¼‰
    await this.createP2PGroup(spec.workspaceId, agent.id)
    
    // 8. å¯åŠ¨ Runner
    await this.pool.startRunner(agent)
    
    // 9. å‘å¸ƒäº‹ä»¶
    Bus.publish(SwarmEvent.AgentCreated, { agent })
    
    return agent
  }
  
  /**
   * ç”Ÿæˆå±‚çº§ç´¢å¼•
   * ä¾‹å¦‚ï¼šparent = "1-1", role = "coder" â†’ "1-1-1"
   */
  private async generateRoleIndex(
    parentId: string | undefined, 
    role: string
  ): Promise<string> {
    if (!parentId) {
      // æ ¹ Agentï¼Œä» 1 å¼€å§‹
      const count = await Storage.agents.countRootAgents()
      return String(count + 1)
    }
    
    const parent = await Storage.agents.get(parentId)
    const siblingCount = parent.childIds.length
    return `${parent.roleIndex}-${siblingCount + 1}`
  }
  
  /**
   * æ„å»º System Prompt
   * åŒ…å«æ‹“æ‰‘ä¿¡æ¯ã€åä½œè§„åˆ™
   */
  private async buildSystemPrompt(
    agent: AgentInstance, 
    spec: DynamicAgentSpec
  ): Promise<string> {
    const topology = await this.getTopologyInfo(agent)
    
    return `
ä½ æ˜¯ä¸€ä¸ª ${spec.role}ï¼Œåœ¨èœ‚ç¾¤åä½œç³»ç»Ÿä¸­å·¥ä½œã€‚

## ä½ çš„èº«ä»½
- è§’è‰²: ${spec.role}
- ç´¢å¼•: ${agent.roleIndex}
- çˆ¶çº§: ${spec.parentId ? `Agent ${spec.parentId}` : "æ— ï¼ˆæ ¹çº§ï¼‰"}

## èœ‚ç¾¤æ‹“æ‰‘
${topology}

## åä½œè§„åˆ™
1. ä½ å¯ä»¥ä½¿ç”¨ create_agent å·¥å…·åˆ›å»ºå­ Agent æ¥åˆ†æ‹…ä»»åŠ¡
2. ä½ å¯ä»¥ä½¿ç”¨ send_message å·¥å…·ä¸ä»»æ„ Agent é€šä¿¡
3. å½“ä»»åŠ¡ä¸æ¸…æ™°æ—¶ï¼Œå‘çˆ¶çº§æˆ–åŒçº§ Agent è¯·æ±‚æ¾„æ¸…
4. å®Œæˆä»»åŠ¡åï¼Œå‘å‘èµ·è€…æŠ¥å‘Šç»“æœ

## å¯ç”¨å·¥å…·
${spec.tools?.map(t => `- ${t}`).join('\n') || 'ç»§æ‰¿è‡ªçˆ¶çº§'}

${spec.additionalInstructions || ''}
`.trim()
  }
}

// åŠ¨æ€ Agent è§„æ ¼
export interface DynamicAgentSpec {
  workspaceId: string
  role: string                        // è§’è‰²åç§°
  parentId?: string                   // çˆ¶ Agent
  
  // å¯é€‰é…ç½®
  tools?: string[]                    // å·¥å…·åˆ—è¡¨
  model?: ModelSpec                   // æŒ‡å®šæ¨¡å‹
  additionalInstructions?: string     // é¢å¤–æŒ‡ä»¤
}
```

### 7.4 æ¶ˆæ¯ç³»ç»Ÿ

```typescript
// swarm/messaging.ts
export class MessageHub {
  private queues: Map<string, MessageQueue> = new Map()
  
  /**
   * å‘é€æ¶ˆæ¯
   * æ ¸å¿ƒåŸè¯­ä¹‹ä¸€ï¼šsend
   */
  async sendMessage(params: SendMessageParams): Promise<void> {
    // 1. åˆ›å»ºæ¶ˆæ¯
    const message: SwarmMessage = {
      id: generateULID(),
      workspaceId: params.workspaceId,
      groupId: params.groupId,
      senderId: params.senderId,
      contentType: params.contentType || "text",
      content: params.content,
      sendTime: new Date(),
    }
    
    // 2. æŒä¹…åŒ–
    await Storage.messages.insert(message)
    
    // 3. é€šçŸ¥ç¾¤æˆå‘˜
    const members = await Storage.groupMembers.byGroup(params.groupId)
    for (const member of members) {
      if (member.agentId !== params.senderId) {
        // å”¤é†’ç›®æ ‡ Agent
        await this.wakeAgent(member.agentId, message)
      }
    }
    
    // 4. å‘å¸ƒ UI äº‹ä»¶
    Bus.publish(UIEvent.MessageCreated, { message })
  }
  
  /**
   * å‘é€ç§ä¿¡
   * è‡ªåŠ¨å®šä½/åˆ›å»º P2P ç¾¤ç»„
   */
  async sendDirectMessage(params: DirectMessageParams): Promise<void> {
    // æŸ¥æ‰¾æˆ–åˆ›å»º P2P ç¾¤ç»„
    let group = await Storage.groups.findP2P(params.senderId, params.toAgentId)
    
    if (!group) {
      group = await Storage.groups.create({
        workspaceId: params.workspaceId,
        memberIds: [params.senderId, params.toAgentId],
        name: null,
      })
    }
    
    // å‘é€æ¶ˆæ¯
    await this.sendMessage({
      ...params,
      groupId: group.id,
    })
  }
  
  /**
   * å”¤é†’ Agent
   */
  async wakeAgent(agentId: string, message: SwarmMessage): Promise<void> {
    const queue = this.getOrCreateQueue(agentId)
    queue.push(message)
    
    // é€šçŸ¥ Runner
    Bus.publish(SwarmEvent.AgentWake, { agentId, messageId: message.id })
  }
  
  /**
   * è·å–æœªè¯»æ¶ˆæ¯
   */
  async getUnreadMessages(agentId: string): Promise<UnreadBatch[]> {
    // è·å–è¯¥ Agent æ‰€åœ¨çš„æ‰€æœ‰ç¾¤ç»„
    const memberships = await Storage.groupMembers.byAgent(agentId)
    
    const batches: UnreadBatch[] = []
    for (const membership of memberships) {
      const messages = await Storage.messages.after(
        membership.groupId,
        membership.lastReadMessageId
      )
      
      if (messages.length > 0) {
        batches.push({
          groupId: membership.groupId,
          messages,
        })
        
        // æ›´æ–°å·²è¯»ä½ç½®
        const lastMessage = messages[messages.length - 1]
        await Storage.groupMembers.updateLastRead(
          membership.groupId, 
          agentId, 
          lastMessage.id
        )
      }
    }
    
    return batches
  }
}

interface UnreadBatch {
  groupId: string
  messages: SwarmMessage[]
}
```

### 7.5 Agent Runner ç”Ÿå‘½å‘¨æœŸ

```typescript
// swarm/runner.ts
export class AgentRunner {
  private agent: AgentInstance
  private messageHub: MessageHub
  private llm: LLMClient
  private aborted = false
  
  /**
   * Agent ä¸»å¾ªç¯
   * æ¯ä¸ª Agent ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸é˜»å¡
   */
  async run(): Promise<void> {
    while (!this.aborted) {
      // 1. æ£€æŸ¥æœªè¯»æ¶ˆæ¯
      const unread = await this.messageHub.getUnreadMessages(this.agent.id)
      
      if (unread.length === 0) {
        // 2. æ— æ¶ˆæ¯ï¼Œè¿›å…¥ç­‰å¾…
        await this.waitForWake()
        continue
      }
      
      // 3. å¤„ç†æœªè¯»æ¶ˆæ¯
      await this.processUnreadMessages(unread)
    }
  }
  
  /**
   * å¤„ç†æœªè¯»æ¶ˆæ¯
   */
  private async processUnreadMessages(batches: UnreadBatch[]): Promise<void> {
    // å°†æ¶ˆæ¯åŠ å…¥ LLM å†å²
    for (const batch of batches) {
      const groupInfo = await Storage.groups.get(batch.groupId)
      
      for (const msg of batch.messages) {
        const sender = await Storage.agents.get(msg.senderId)
        this.agent.llmHistory.push({
          role: "user",
          content: `[æ¥è‡ª ${sender.role}(${sender.roleIndex}) åœ¨ç¾¤ç»„ ${groupInfo.name || 'P2P'}]\n${msg.content}`,
          timestamp: msg.sendTime,
        })
      }
    }
    
    // è¿›å…¥ LLM æ¨ç†å¾ªç¯
    await this.llmLoop()
  }
  
  /**
   * LLM æ¨ç†å¾ªç¯
   */
  private async llmLoop(): Promise<void> {
    this.agent.status = "running"
    
    while (true) {
      // 1. è°ƒç”¨ LLM
      const response = await this.llm.chat({
        messages: this.agent.llmHistory,
        tools: await this.getAvailableTools(),
        stream: true,
      })
      
      // 2. æµå¼è¾“å‡º
      for await (const chunk of response.stream) {
        Bus.publish(UIEvent.AgentLLMChunk, { 
          agentId: this.agent.id, 
          chunk 
        })
      }
      
      // 3. åˆ¤æ–­ç»“æœ
      const result = await response.finalMessage()
      
      this.agent.llmHistory.push({
        role: "assistant",
        content: result.content,
        toolCalls: result.toolCalls,
        timestamp: new Date(),
      })
      
      // 4. å¤„ç†å·¥å…·è°ƒç”¨
      if (result.toolCalls && result.toolCalls.length > 0) {
        await this.executeToolCalls(result.toolCalls)
        continue // ç»§ç»­å¾ªç¯å¤„ç†å·¥å…·ç»“æœ
      }
      
      // 5. æ¨ç†å®Œæˆ
      if (result.finishReason === "stop") {
        break
      }
    }
    
    // 6. æŒä¹…åŒ– LLM å†å²
    await Storage.agents.updateLLMHistory(
      this.agent.id, 
      this.agent.llmHistory
    )
    
    this.agent.status = "idle"
    Bus.publish(UIEvent.AgentLLMDone, { agentId: this.agent.id })
  }
  
  /**
   * æ‰§è¡Œå·¥å…·è°ƒç”¨
   */
  private async executeToolCalls(toolCalls: ToolCall[]): Promise<void> {
    for (const call of toolCalls) {
      this.agent.status = "waiting"
      
      Bus.publish(UIEvent.ToolCallStart, { 
        agentId: this.agent.id, 
        toolCall: call 
      })
      
      const result = await this.executeTool(call)
      
      this.agent.llmHistory.push({
        role: "tool",
        content: JSON.stringify(result),
        toolCallId: call.id,
        timestamp: new Date(),
      })
      
      Bus.publish(UIEvent.ToolCallDone, { 
        agentId: this.agent.id, 
        toolCall: call,
        result 
      })
    }
  }
  
  /**
   * ç­‰å¾…å”¤é†’
   */
  private async waitForWake(): Promise<void> {
    this.agent.status = "idle"
    
    return new Promise((resolve) => {
      const unsub = Bus.subscribe(SwarmEvent.AgentWake, (event) => {
        if (event.agentId === this.agent.id) {
          unsub()
          resolve()
        }
      })
    })
  }
}
```

### 7.6 Swarm å·¥å…·é›†

```typescript
// swarm/tools.ts

/**
 * åˆ›å»ºå­ Agent å·¥å…·
 */
export const createAgentTool = defineTool({
  id: "create_agent",
  name: "åˆ›å»ºå­ Agent",
  description: "åˆ›å»ºä¸€ä¸ªå­ Agent æ¥ååŠ©å®Œæˆä»»åŠ¡",
  category: "swarm",
  
  parameters: z.object({
    role: z.string().describe("å­ Agent çš„è§’è‰²åç§°ï¼Œå¦‚ 'coder', 'reviewer', 'analyst'"),
    task: z.string().describe("åˆ†é…ç»™å­ Agent çš„ä»»åŠ¡æè¿°"),
    tools: z.array(z.string()).optional().describe("å­ Agent å¯ç”¨çš„å·¥å…·åˆ—è¡¨"),
  }),
  
  async execute(params, ctx) {
    const factory = ctx.services.get(AgentFactory)
    
    const agent = await factory.createAgent({
      workspaceId: ctx.workspaceId,
      role: params.role,
      parentId: ctx.agentId,
      tools: params.tools,
      additionalInstructions: `ä½ çš„ä»»åŠ¡æ˜¯ï¼š${params.task}`,
    })
    
    // è‡ªåŠ¨å‘é€ä»»åŠ¡æ¶ˆæ¯
    await ctx.services.get(MessageHub).sendDirectMessage({
      workspaceId: ctx.workspaceId,
      senderId: ctx.agentId,
      toAgentId: agent.id,
      content: params.task,
    })
    
    return {
      title: `åˆ›å»ºäº†å­ Agent: ${agent.role}(${agent.roleIndex})`,
      output: `å­ Agent ID: ${agent.id}\nè§’è‰²: ${params.role}\nä»»åŠ¡å·²å‘é€`,
      metadata: { agentId: agent.id, roleIndex: agent.roleIndex },
    }
  },
})

/**
 * å‘é€æ¶ˆæ¯å·¥å…·
 */
export const sendMessageTool = defineTool({
  id: "send_message",
  name: "å‘é€æ¶ˆæ¯",
  description: "å‘å¦ä¸€ä¸ª Agent å‘é€æ¶ˆæ¯",
  category: "swarm",
  
  parameters: z.object({
    toAgentId: z.string().optional().describe("ç›®æ ‡ Agent ID"),
    toRole: z.string().optional().describe("ç›®æ ‡ Agent è§’è‰²ï¼ˆå¦‚æœä¸çŸ¥é“ IDï¼‰"),
    content: z.string().describe("æ¶ˆæ¯å†…å®¹"),
  }),
  
  async execute(params, ctx) {
    const hub = ctx.services.get(MessageHub)
    
    let targetId = params.toAgentId
    
    // å¦‚æœæä¾›çš„æ˜¯è§’è‰²åï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ Agent
    if (!targetId && params.toRole) {
      const agent = await Storage.agents.findByRole(
        ctx.workspaceId, 
        params.toRole
      )
      if (!agent) {
        throw new Error(`æœªæ‰¾åˆ°è§’è‰²ä¸º "${params.toRole}" çš„ Agent`)
      }
      targetId = agent.id
    }
    
    if (!targetId) {
      throw new Error("å¿…é¡»æä¾› toAgentId æˆ– toRole")
    }
    
    await hub.sendDirectMessage({
      workspaceId: ctx.workspaceId,
      senderId: ctx.agentId,
      toAgentId: targetId,
      content: params.content,
    })
    
    const target = await Storage.agents.get(targetId)
    
    return {
      title: `æ¶ˆæ¯å·²å‘é€ç»™ ${target.role}(${target.roleIndex})`,
      output: `æ¶ˆæ¯å†…å®¹: ${params.content.substring(0, 100)}...`,
      metadata: { targetId, targetRole: target.role },
    }
  },
})

/**
 * åˆ—å‡ºç¾¤ç»„å·¥å…·
 */
export const listGroupsTool = defineTool({
  id: "list_groups",
  name: "åˆ—å‡ºç¾¤ç»„",
  description: "åˆ—å‡ºå½“å‰ Agent æ‰€åœ¨çš„æ‰€æœ‰ç¾¤ç»„",
  category: "swarm",
  
  parameters: z.object({}),
  
  async execute(params, ctx) {
    const memberships = await Storage.groupMembers.byAgent(ctx.agentId)
    const groups = await Promise.all(
      memberships.map(m => Storage.groups.get(m.groupId))
    )
    
    const formatted = groups.map(g => ({
      id: g.id,
      name: g.name || "(P2P)",
      memberCount: g.memberIds.length,
    }))
    
    return {
      title: `æ‰¾åˆ° ${groups.length} ä¸ªç¾¤ç»„`,
      output: JSON.stringify(formatted, null, 2),
      metadata: { count: groups.length },
    }
  },
})

/**
 * æŸ¥è¯¢æ‹“æ‰‘å·¥å…·
 */
export const getTopologyTool = defineTool({
  id: "get_topology",
  name: "æŸ¥è¯¢æ‹“æ‰‘",
  description: "æŸ¥è¯¢å½“å‰ Agent åœ¨èœ‚ç¾¤ä¸­çš„ä½ç½®å’Œç›¸å…³ Agent",
  category: "swarm",
  
  parameters: z.object({
    scope: z.enum(["ancestors", "children", "siblings", "all"]).default("all"),
  }),
  
  async execute(params, ctx) {
    const topology = ctx.services.get(TopologyManager)
    const info = await topology.getInfo(ctx.agentId, params.scope)
    
    return {
      title: "æ‹“æ‰‘ä¿¡æ¯",
      output: formatTopologyTree(info),
      metadata: info,
    }
  },
})
```

### 7.7 åŠ¨æ€æ‰©ç¼©å®¹ç­–ç•¥

```typescript
// swarm/scaling.ts
export class SwarmScaler {
  /**
   * è‡ªåŠ¨æ‰©å®¹ç­–ç•¥
   */
  async evaluateAndScale(workspaceId: string): Promise<void> {
    const metrics = await this.collectMetrics(workspaceId)
    
    // ç­–ç•¥ 1: åŸºäºé˜Ÿåˆ—é•¿åº¦
    if (metrics.avgQueueLength > QUEUE_THRESHOLD) {
      await this.scaleUp(workspaceId, metrics)
    }
    
    // ç­–ç•¥ 2: åŸºäºå“åº”æ—¶é—´
    if (metrics.avgResponseTime > RESPONSE_THRESHOLD) {
      await this.scaleUp(workspaceId, metrics)
    }
    
    // ç­–ç•¥ 3: åŸºäºç©ºé—²ç‡
    if (metrics.idleRatio > IDLE_THRESHOLD) {
      await this.scaleDown(workspaceId, metrics)
    }
  }
  
  /**
   * æ‰©å®¹ï¼šè‡ªåŠ¨åˆ›å»º Worker Agent åˆ†æ‹…è´Ÿè½½
   * ç­–ç•¥ï¼šå…ˆå°è¯•è‡ªåŠ¨åˆ›å»º â†’ åˆ›å»ºå¤±è´¥åˆ™é™çº§ä¸ºå»ºè®®æ¶ˆæ¯
   */
  private async scaleUp(
    workspaceId: string, 
    metrics: SwarmMetrics
  ): Promise<void> {
    const busiest = await this.findBusiestAgent(workspaceId)
    const workerCount = Math.min(
      Math.ceil(metrics.avgQueueLength / QUEUE_THRESHOLD),
      this.maxAutoScaleWorkers
    )
    
    // 1. å°è¯•è‡ªåŠ¨åˆ›å»º Worker
    try {
      for (let i = 0; i < workerCount; i++) {
        await this.agentFactory.createAgent({
          workspaceId,
          role: `worker-${Date.now()}-${i}`,
          parentId: busiest.id,
          additionalInstructions: "å¤„ç†çˆ¶ Agent çš„ç§¯å‹ä»»åŠ¡",
        })
      }
      Bus.publish(SwarmEvent.AutoScaled, { workspaceId, added: workerCount })
    } catch (error) {
      // 2. é™çº§ï¼šå‘é€å»ºè®®æ¶ˆæ¯ï¼Œç”± Agent è‡ªè¡Œå†³ç­–
      await this.messageHub.sendMessage({
        workspaceId,
        senderId: "system",
        groupId: await this.getSystemGroupId(busiest.id),
        content: `[ç³»ç»Ÿå»ºè®®] è‡ªåŠ¨æ‰©å®¹å¤±è´¥(${error.message})ï¼Œå»ºè®®æ‰‹åŠ¨åˆ›å»ºå­ Agent åˆ†æ‹…å·¥ä½œã€‚\né˜Ÿåˆ—: ${metrics.avgQueueLength} | å“åº”: ${metrics.avgResponseTime}ms`,
      })
    }
  }
  
  /**
   * ç¼©å®¹ï¼šç»ˆæ­¢ç©ºé—²çš„ Agent
   */
  private async scaleDown(
    workspaceId: string, 
    metrics: SwarmMetrics
  ): Promise<void> {
    // æ‰¾åˆ°é•¿æœŸç©ºé—²çš„å­ Agent
    const idleAgents = await this.findIdleAgents(
      workspaceId, 
      IDLE_DURATION_THRESHOLD
    )
    
    for (const agent of idleAgents) {
      // åªç»ˆæ­¢å­ Agentï¼Œä¿ç•™æ ¹ Agent
      if (agent.parentId) {
        await this.terminateAgent(agent.id)
      }
    }
  }
  
  /**
   * ç»ˆæ­¢ Agent
   */
  async terminateAgent(agentId: string): Promise<void> {
    // 1. åœæ­¢ Runner
    await this.runnerPool.stopRunner(agentId)
    
    // 2. é€šçŸ¥çˆ¶ Agent
    const agent = await Storage.agents.get(agentId)
    if (agent.parentId) {
      await this.messageHub.sendDirectMessage({
        workspaceId: agent.workspaceId,
        senderId: "system",
        toAgentId: agent.parentId,
        content: `[ç³»ç»Ÿé€šçŸ¥] å­ Agent ${agent.role}(${agent.roleIndex}) å› é•¿æœŸç©ºé—²å·²è¢«ç»ˆæ­¢ã€‚`,
      })
      
      // æ›´æ–°çˆ¶ Agent çš„ childIds
      const parent = await Storage.agents.get(agent.parentId)
      await Storage.agents.update(agent.parentId, {
        childIds: parent.childIds.filter(id => id !== agentId),
      })
    }
    
    // 3. æ›´æ–°çŠ¶æ€
    await Storage.agents.update(agentId, { status: "terminated" })
    
    // 4. å‘å¸ƒäº‹ä»¶
    Bus.publish(SwarmEvent.AgentTerminated, { agentId })
  }
}
```

### 7.8 UI äº‹ä»¶æµ

```typescript
// swarm/ui-events.ts

/**
 * UI äº‹ä»¶ç±»å‹
 * é€šè¿‡ SSE æ¨é€åˆ°å‰ç«¯
 */
export enum UIEvent {
  // Agent äº‹ä»¶
  AgentCreated = "ui.agent.created",
  AgentTerminated = "ui.agent.terminated",
  
  // æ¶ˆæ¯äº‹ä»¶
  MessageCreated = "ui.message.created",
  
  // LLM äº‹ä»¶
  AgentLLMStart = "ui.agent.llm.start",
  AgentLLMChunk = "ui.agent.llm.chunk",
  AgentLLMDone = "ui.agent.llm.done",
  
  // å·¥å…·äº‹ä»¶
  ToolCallStart = "ui.agent.tool_call.start",
  ToolCallDone = "ui.agent.tool_call.done",
  
  // ç¾¤ç»„äº‹ä»¶
  GroupCreated = "ui.group.created",
  
  // æ‹“æ‰‘äº‹ä»¶
  TopologyChanged = "ui.topology.changed",
}

/**
 * SSE è·¯ç”±
 */
export const swarmEventRoutes = new OpenAPIHono()
  .get("/events", async (c) => {
    const workspaceId = c.req.query("workspaceId")
    
    return streamSSE(c, async (stream) => {
      const unsub = Bus.subscribe("ui.*", async (event) => {
        if (event.workspaceId === workspaceId) {
          await stream.writeSSE({
            event: event.type,
            data: JSON.stringify(event.payload),
          })
        }
      })
      
      stream.onAbort(() => unsub())
    })
  })
```

### 7.9 å‰ç«¯ Swarm å¯è§†åŒ–

åŸºäº ReactFlow å®ç° Swarm æ‹“æ‰‘çš„å®æ—¶å¯è§†åŒ–ï¼š

**æ ¸å¿ƒèƒ½åŠ›ï¼š**

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æ‹“æ‰‘æ¸²æŸ“ | å°† `TopologyGraph` æ˜ å°„ä¸º ReactFlow èŠ‚ç‚¹/è¾¹ |
| å®æ—¶æ›´æ–° | é€šè¿‡ SSE (`/api/swarm/events`) è®¢é˜… `ui.topology.changed` äº‹ä»¶ |
| æ¶ˆæ¯åŠ¨ç”» | ç›‘å¬ `ui.message.created`ï¼Œåœ¨è¾¹ä¸Šå±•ç¤º 3s æ¶ˆæ¯æµåŠ¨åŠ¨ç”» |
| èŠ‚ç‚¹ç±»å‹ | `AgentNode`ï¼ˆçŠ¶æ€è‰²ï¼šrunning=ç»¿/idle=ç°/waiting=é»„ï¼‰ã€`HumanNode` |
| è¾¹ç±»å‹ | `AnimatedMessageEdge`ï¼Œå±•ç¤º Agent é—´æ¶ˆæ¯ä¼ é€’æ–¹å‘ |
| äº¤äº’ | MiniMap ç¼©ç•¥å›¾ã€Controls ç¼©æ”¾ã€fitView è‡ªé€‚åº”å¸ƒå±€ |

### 7.10 å¤šæœºæ‰©å®¹ä¸æœåŠ¡å‘ç°

å½“å‰ Swarm è®¾è®¡ä¸ºå•è¿›ç¨‹å†…å­˜æ¶æ„ï¼ˆ`MessageHub` ç”¨å†…å­˜ `Map`ã€`Bus` ç”¨è¿›ç¨‹å†… `EventEmitter`ï¼‰ã€‚ä»¥ä¸‹è®¾è®¡ä¸ºå¤šæœºæ‰©å®¹é¢„ç•™æ¥å£ï¼Œä½† **MVP ä¸å®ç°å¤šæœºéƒ¨ç½²**ã€‚

#### 7.10.1 ä¼ è¾“å±‚æŠ½è±¡

```typescript
// swarm/transport.ts

/**
 * æ¶ˆæ¯ä¼ è¾“å±‚æ¥å£
 * å•æœºç”¨å†…å­˜å®ç°ï¼Œå¤šæœºåˆ‡æ¢ä¸º Redis/NATS
 */
export interface MessageTransport {
  // å‘å¸ƒæ¶ˆæ¯åˆ°æŒ‡å®š Agent
  publish(agentId: string, message: SwarmMessage): Promise<void>
  // è®¢é˜…æŒ‡å®š Agent çš„æ¶ˆæ¯
  subscribe(agentId: string, handler: MessageHandler): Unsubscribe
  // å¹¿æ’­äº‹ä»¶ï¼ˆæ‹“æ‰‘å˜æ›´ç­‰ï¼‰
  broadcast(event: SwarmEvent): Promise<void>
}

/**
 * Agent å®šä½å™¨æ¥å£
 * å•æœºç›´æ¥æŸ¥æœ¬åœ° Mapï¼Œå¤šæœºæŸ¥æ³¨å†Œä¸­å¿ƒ
 */
export interface AgentLocator {
  // æ³¨å†Œ Agent ä½ç½®
  register(agentId: string, location: AgentLocation): Promise<void>
  // æŸ¥æ‰¾ Agent æ‰€åœ¨èŠ‚ç‚¹
  locate(agentId: string): Promise<AgentLocation>
  // å¿ƒè·³ç»­çº¦
  heartbeat(agentId: string): Promise<void>
  // æ³¨é”€
  deregister(agentId: string): Promise<void>
}

export interface AgentLocation {
  nodeId: string        // æœºå™¨èŠ‚ç‚¹ ID
  processId: string     // è¿›ç¨‹ ID
  endpoint: string      // gRPC/HTTP åœ°å€
  lastHeartbeat: Date
}
```

#### 7.10.2 å•æœºå®ç°ï¼ˆMVP é»˜è®¤ï¼‰

```typescript
// swarm/transport-local.ts
export class LocalTransport implements MessageTransport {
  private emitter = new EventEmitter()
  
  async publish(agentId: string, message: SwarmMessage) {
    this.emitter.emit(`agent:${agentId}`, message)
  }
  
  subscribe(agentId: string, handler: MessageHandler) {
    this.emitter.on(`agent:${agentId}`, handler)
    return () => this.emitter.off(`agent:${agentId}`, handler)
  }
  
  async broadcast(event: SwarmEvent) {
    this.emitter.emit("broadcast", event)
  }
}

export class LocalAgentLocator implements AgentLocator {
  private agents = new Map<string, AgentLocation>()
  
  async locate(agentId: string) {
    return this.agents.get(agentId) ?? { nodeId: "local", processId: process.pid.toString(), endpoint: "local" }
  }
  // register / heartbeat / deregister ä»…æ›´æ–°æœ¬åœ° Map
}
```

#### 7.10.3 å¤šæœºæ‰©å®¹è·¯å¾„

```
é˜¶æ®µ 1: å•æœºï¼ˆå½“å‰æ–¹æ¡ˆï¼‰
  Transport = LocalTransport (EventEmitter)
  Locator   = LocalAgentLocator (Map)
  Storage   = SQLiteAdapter

é˜¶æ®µ 2: å•æœºå¤šè¿›ç¨‹
  Transport = RedisTransport (Redis Pub/Sub + Streams)
  Locator   = RedisAgentLocator (Redis Hash)
  Storage   = PostgreSQLAdapter

é˜¶æ®µ 3: å¤šæœºé›†ç¾¤
  Transport = NATSTransport (NATS JetStream)
  Locator   = ConsulAgentLocator æˆ– EtcdAgentLocator
  â”‚
  â”œâ”€ Agent æ³¨å†Œï¼šagentId â†’ nodeId + endpoint
  â”œâ”€ å¿ƒè·³ç»­çº¦ï¼šæ¯ 10s ä¸ŠæŠ¥ï¼Œ30s è¶…æ—¶åˆ¤å®šå¤±è”
  â”œâ”€ æ¶ˆæ¯è·¯ç”±ï¼šsendMessage å…ˆæŸ¥ Locator å®šä½ç›®æ ‡èŠ‚ç‚¹ï¼Œ
  â”‚            æœ¬åœ°åˆ™ç›´æ¥æŠ•é€’ï¼Œè¿œç¨‹åˆ™é€šè¿‡ Transport è½¬å‘
  â””â”€ æ•…éšœè½¬ç§»ï¼šå¿ƒè·³è¶…æ—¶ â†’ æ ‡è®° Agent ä¸º orphan â†’
               è°ƒåº¦å™¨åœ¨å¦ä¸€èŠ‚ç‚¹é‡å»º Agentï¼ˆæ¢å¤ LLM å†å²ï¼‰
```

> **è®¾è®¡è¦ç‚¹**ï¼š`MessageHub`ã€`AgentRunner` ç­‰ä¸Šå±‚ä»£ç åªä¾èµ– `MessageTransport` å’Œ `AgentLocator` æ¥å£ï¼Œä¸æ„ŸçŸ¥åº•å±‚å®ç°ã€‚å¤šæœºæ‰©å®¹æ˜¯**æ›¿æ¢é€‚é…å™¨**ï¼Œä¸æ”¹ä¸šåŠ¡é€»è¾‘ã€‚

### 7.11 å‰ç«¯å…¥å£ä¸å¼‚æ­¥ä»»åŠ¡é“¾è·¯

ç³»ç»Ÿæ ¸å¿ƒæ¨¡å¼ï¼š**å‰ç«¯æäº¤ä»»åŠ¡ â†’ æœåŠ¡ç«¯å¼‚æ­¥æ‰§è¡Œ â†’ SSE å®æ—¶æ¨é€è¿›åº¦**ã€‚å½“å‰æ–¹æ¡ˆçš„ SDK API æ˜¯åŒæ­¥é£æ ¼ï¼ˆ`session.prompt()`ï¼‰ï¼Œéœ€è¡¥å……å¼‚æ­¥ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

#### 7.11.1 Task ç”Ÿå‘½å‘¨æœŸ

```typescript
// task/types.ts
export interface TaskRecord {
  id: string                  // ULID
  sessionId: string
  userId: string
  // ä»»åŠ¡è¾“å…¥
  type: "prompt" | "template" | "swarm"
  input: TaskInput
  // çŠ¶æ€æœº
  status: TaskStatus
  // å…³è”çš„ Swarm workspaceï¼ˆå¦‚æœ‰ï¼‰
  swarmWorkspaceId?: string
  // æ—¶é—´çº¿
  createdAt: Date
  startedAt?: Date
  completedAt?: Date
  // ç»“æœ
  result?: TaskResult
  error?: string
}

export type TaskStatus =
  | "queued"       // å·²å…¥é˜Ÿï¼Œç­‰å¾…æ‰§è¡Œ
  | "running"      // æ‰§è¡Œä¸­
  | "suspended"    // ç­‰å¾…äººç±»å®¡æ‰¹
  | "completed"    // æˆåŠŸå®Œæˆ
  | "failed"       // æ‰§è¡Œå¤±è´¥
  | "cancelled"    // ç”¨æˆ·å–æ¶ˆ
```

#### 7.11.2 Task API

```typescript
// server/routes/task.ts
export const taskRoutes = new OpenAPIHono()
  
  // æäº¤ä»»åŠ¡ï¼ˆå¼‚æ­¥ï¼Œç«‹å³è¿”å› taskIdï¼‰
  .post("/api/tasks", async (c) => {
    const input = await c.req.json()
    const task = await TaskManager.submit({
      userId: c.get("userId"),
      sessionId: input.sessionId,
      type: input.type,
      input: input.payload,
    })
    // 202 Accepted â€” ä»»åŠ¡å·²å…¥é˜Ÿ
    return c.json({ taskId: task.id, status: "queued" }, 202)
  })

  // æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
  .get("/api/tasks/:id", async (c) => {
    const task = await TaskManager.get(c.req.param("id"))
    return c.json(task)
  })

  // å–æ¶ˆä»»åŠ¡
  .post("/api/tasks/:id/cancel", async (c) => {
    await TaskManager.cancel(c.req.param("id"))
    return c.json({ status: "cancelled" })
  })

  // SSE äº‹ä»¶æµï¼ˆæ”¯æŒæ–­çº¿é‡è¿ï¼‰
  .get("/api/tasks/:id/events", async (c) => {
    const taskId = c.req.param("id")
    const lastEventId = c.req.header("Last-Event-ID")
    
    return streamSSE(c, async (stream) => {
      // 1. è¡¥å‘æ–­çº¿æœŸé—´çš„å†å²äº‹ä»¶
      if (lastEventId) {
        const missed = await EventStore.after(taskId, lastEventId)
        for (const event of missed) {
          await stream.writeSSE({
            id: event.id,
            event: event.type,
            data: JSON.stringify(event.payload),
          })
        }
      }
      
      // 2. å®æ—¶æ¨é€åç»­äº‹ä»¶
      const unsub = Bus.subscribe(`task.${taskId}.*`, async (event) => {
        const eventId = generateULID()
        // æŒä¹…åŒ–äº‹ä»¶ï¼ˆä¾›æ–­çº¿é‡è¿è¡¥å‘ï¼‰
        await EventStore.save(taskId, { id: eventId, ...event })
        await stream.writeSSE({
          id: eventId,
          event: event.type,
          data: JSON.stringify(event.payload),
        })
      })
      
      stream.onAbort(() => unsub())
    })
  })
```

#### 7.11.3 å®Œæ•´é“¾è·¯æ—¶åº

```
å‰ç«¯                           æœåŠ¡ç«¯                         Swarm
 â”‚                              â”‚                              â”‚
 â”œâ”€ POST /api/tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
 â”‚  { type:"swarm",            â”‚â”€â–º TaskManager.submit()       â”‚
 â”‚    payload:{...} }          â”‚   status="queued"            â”‚
 â”‚â—„â”€â”€ 202 { taskId:"t-1" } â”€â”€â”€â”‚                              â”‚
 â”‚                              â”‚â”€â–º TaskExecutor.run("t-1")   â”‚
 â”‚                              â”‚   status="running"          â”‚
 â”‚                              â”‚   â”œâ”€â–º createSwarm()  â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚                              â”‚   â”‚                          â”‚â”€â–º createAgent()
 â”‚  GET /api/tasks/t-1/events  â”‚   â”‚                          â”‚â”€â–º sendMessage()
 â”‚â—„â”€â”€ SSE stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”¤ Bus: task.t-1.*          â”‚
 â”‚  event: agent.created       â”‚   â”‚                          â”‚
 â”‚  event: message.created     â”‚   â”‚                          â”‚
 â”‚  event: llm.chunk           â”‚   â”‚                          â”‚
 â”‚  ...                         â”‚   â”‚                          â”‚
 â”‚                              â”‚   â”‚                          â”‚
 â”‚  [æµè§ˆå™¨å…³é—­]                â”‚   â”‚  â† Agent ç»§ç»­è¿è¡Œ       â”‚
 â”‚                              â”‚   â”‚                          â”‚
 â”‚  [é‡æ–°æ‰“å¼€]                  â”‚   â”‚                          â”‚
 â”‚  GET /api/tasks/t-1/events  â”‚   â”‚                          â”‚
 â”‚  Last-Event-ID: "evt-42"    â”‚   â”‚                          â”‚
 â”‚â—„â”€â”€ è¡¥å‘ evt-43~evt-58 â”€â”€â”€â”€â”€â”‚   â”‚                          â”‚
 â”‚â—„â”€â”€ ç»§ç»­å®æ—¶æ¨é€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚                          â”‚
 â”‚                              â”‚   â”‚                          â”‚
 â”‚  event: task.completed      â”‚â—„â”€â”€â”¤ status="completed"       â”‚
 â”‚                              â”‚   â”‚                          â”‚
```

#### 7.11.4 å‰ç«¯é‰´æƒ

```typescript
// server/middleware/auth.ts
export const authMiddleware = createMiddleware(async (c, next) => {
  const token = c.req.header("Authorization")?.replace("Bearer ", "")
  
  if (!token) {
    return c.json({ error: "Unauthorized" }, 401)
  }
  
  // æ”¯æŒå¤šç§è®¤è¯æ–¹å¼
  const user = await AuthService.verify(token)
  if (!user) {
    return c.json({ error: "Invalid token" }, 401)
  }
  
  c.set("userId", user.id)
  c.set("permissions", user.permissions)
  await next()
})

/**
 * è®¤è¯ç­–ç•¥ï¼ˆæŒ‰éƒ¨ç½²æ¨¡å¼é€‰æ‹©ï¼‰ï¼š
 * - æœ¬åœ°å¼€å‘ï¼šè·³è¿‡è®¤è¯ï¼ˆå•ç”¨æˆ·ï¼‰
 * - å›¢é˜Ÿéƒ¨ç½²ï¼šJWT Tokenï¼ˆè‡ªç­¾å‘ï¼‰
 * - ä¼ä¸šéƒ¨ç½²ï¼šOAuth2 / OIDC å¯¹æ¥ä¼ä¸š IdP
 */
export interface AuthConfig {
  mode: "none" | "jwt" | "oauth2"
  jwt?: { secret: string; expiresIn: string }
  oauth2?: { issuer: string; clientId: string; audience: string }
}
```

---

## 8. Web äº§å“ç³»ç»Ÿ

Web ç«¯æ˜¯ Vitamin-Code é¢å‘ç”¨æˆ·çš„æ ¸å¿ƒäº¤äº’å…¥å£ï¼Œäº§å“å½¢æ€å‚è€ƒ **Kimi 2.5 Web** çš„å¯¹è¯å¼ AI ä½“éªŒ + **GitHub Copilot Web** çš„å·¥ç¨‹ä¸Šä¸‹æ–‡æ„ŸçŸ¥èƒ½åŠ›ï¼Œæä¾› Plan / Execute åŒæ¨¡å¼ã€‚Web ç³»ç»Ÿåˆ†ä¸º **ç”¨æˆ·ç«¯ï¼ˆUser Appï¼‰** å’Œ **ç®¡ç†ç«¯ï¼ˆAdmin Appï¼‰** ä¸¤ä¸ªç‹¬ç«‹åº”ç”¨ï¼Œä»¥ **Spaceï¼ˆé¡¹ç›®ç©ºé—´ï¼‰** ä¸ºæ ¸å¿ƒç»„ç»‡å•å…ƒã€‚

### 8.1 äº§å“å®šä½ä¸å‚è€ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Web äº§å“å®šä½                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ğŸ“Œ å¯¹è¯å¼ AI åŠ©æ‰‹ï¼ˆå‚è€ƒ Kimi 2.5 Webï¼‰                                     â”‚
â”‚     è‡ªç„¶è¯­è¨€å¯¹è¯ â†’ Agent ç†è§£æ„å›¾ â†’ è‡ªåŠ¨è§„åˆ’ â†’ æ‰§è¡Œä»»åŠ¡ â†’ æµå¼è¿”å›          â”‚
â”‚     æ”¯æŒå¤šè½®å¯¹è¯ã€ä¸Šä¸‹æ–‡ä¿æŒã€é•¿æ–‡æœ¬ç†è§£                                     â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Œ å·¥ç¨‹ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼ˆå‚è€ƒ GitHub Copilot Webï¼‰                                â”‚
â”‚     è¿æ¥ Git ä»“åº“ â†’ ç†è§£ä»£ç ç»“æ„ â†’ æ„ŸçŸ¥ PR / Issue / Branch ä¸Šä¸‹æ–‡          â”‚
â”‚     Agent æ‰§è¡Œæ—¶è‡ªåŠ¨ Grounding åˆ°é¡¹ç›®ä»£ç å’Œæ–‡æ¡£                              â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Œ Plan / Execute åŒæ¨¡å¼                                                    â”‚
â”‚     Plan æ¨¡å¼  â€” Agent ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ä¾›äººç±»å®¡æ ¸ï¼Œç¡®è®¤åæ‰æ‰§è¡Œ                   â”‚
â”‚     Execute æ¨¡å¼ â€” Agent è‡ªä¸»æ‰§è¡Œï¼Œå®æ—¶æµå¼å±•ç¤ºè¿‡ç¨‹ä¸ç»“æœ                     â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Œ Space é¡¹ç›®ç©ºé—´                                                           â”‚
â”‚     ä¸€ä¸ª Space = ä¸€ä¸ªå®Œæ•´é¡¹ç›®çš„å·¥ä½œä¸Šä¸‹æ–‡                                    â”‚
â”‚     åŒ…å« Git ä»“åº“ / PRD / æ–‡æ¡£ / ç‰ˆæœ¬è¿­ä»£ / æ•…äº‹æ¿ / Agent ä¼šè¯             â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Œ åŒç«¯åˆ†ç¦»                                                                 â”‚
â”‚     ç”¨æˆ·ç«¯ â€” AI å¯¹è¯ + ä»»åŠ¡æ‰§è¡Œ + é¡¹ç›®åä½œï¼ˆé¢å‘å¼€å‘è€…/PM/è®¾è®¡å¸ˆï¼‰           â”‚
â”‚     ç®¡ç†ç«¯ â€” Agent/Tool/Workflow/æ¨¡æ¿/æƒé™/ç›‘æ§ï¼ˆé¢å‘å¹³å°ç®¡ç†å‘˜ï¼‰             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Spaceï¼ˆé¡¹ç›®ç©ºé—´ï¼‰æ¨¡å‹

Space æ˜¯ Web äº§å“çš„æ ¸å¿ƒç»„ç»‡å•å…ƒï¼Œä¸€ä¸ª Space å¯¹åº”ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®ä¸Šä¸‹æ–‡ã€‚Space åŸºäºç°æœ‰çš„ `Space` å‘½åç©ºé—´ï¼ˆpackages/vitamin/src/space.tsï¼‰æ‰©å±•ï¼Œä»æœ¬åœ° Git æ„ŸçŸ¥å‡çº§ä¸ºå…¨åœºæ™¯é¡¹ç›®ç©ºé—´ã€‚

#### 8.2.1 Space æ•°æ®æ¨¡å‹

```typescript
// space/types.ts
export interface SpaceInfo {
  id: string                          // ULID
  name: string                        // é¡¹ç›®åç§°
  description?: string                // é¡¹ç›®æè¿°
  icon?: SpaceIcon                    // é¡¹ç›®å›¾æ ‡
  
  // â”€â”€ Git ä»“åº“è¿æ¥ â”€â”€
  repositories: SpaceRepository[]     // å…³è”çš„ Git ä»“åº“ï¼ˆæ”¯æŒå¤šä»“ï¼‰
  
  // â”€â”€ æ–‡æ¡£è¿æ¥ â”€â”€
  documents: SpaceDocument[]          // PRDã€è®¾è®¡æ–‡æ¡£ã€API æ–‡æ¡£ç­‰
  
  // â”€â”€ ç‰ˆæœ¬è¿­ä»£ â”€â”€
  iterations: SpaceIteration[]        // ç‰ˆæœ¬è¿­ä»£è®¡åˆ’
  
  // â”€â”€ Grounding ä¸Šä¸‹æ–‡ â”€â”€
  grounding: SpaceGrounding           // çŸ¥è¯†æ¥åœ°é…ç½®
  
  // â”€â”€ æˆå‘˜ä¸æƒé™ â”€â”€
  members: SpaceMember[]              // é¡¹ç›®æˆå‘˜
  visibility: "private" | "team" | "public"
  
  // â”€â”€ ä¼šè¯ä¸ä»»åŠ¡ â”€â”€
  activeSessions: string[]            // æ´»è·ƒçš„ Agent ä¼šè¯ ID
  
  // â”€â”€ å…ƒä¿¡æ¯ â”€â”€
  time: {
    created: number
    updated: number
    lastAccessed: number
  }
  settings: SpaceSettings
}

/**
 * Git ä»“åº“è¿æ¥
 * æ”¯æŒå‰ç«¯/åç«¯/æ–‡æ¡£ç­‰å¤šä»“åº“
 */
export interface SpaceRepository {
  id: string
  name: string                        // æ˜¾ç¤ºåï¼ˆå¦‚ "frontend", "backend", "docs"ï¼‰
  url: string                         // Git è¿œç¨‹åœ°å€
  provider: "github" | "gitlab" | "bitbucket" | "self-hosted"
  defaultBranch: string
  
  // ä»“åº“ç±»å‹æ ‡ç­¾
  role: "frontend" | "backend" | "fullstack" | "docs" | "infra" | "monorepo" | "other"
  
  // ç´¢å¼•çŠ¶æ€ï¼ˆç”¨äº Groundingï¼‰
  indexStatus: "pending" | "indexing" | "ready" | "error"
  lastIndexedAt?: number
}

/**
 * æ–‡æ¡£è¿æ¥
 * PRDã€è®¾è®¡ç¨¿ã€API æ–‡æ¡£ã€ä¼šè®®çºªè¦ç­‰
 */
export interface SpaceDocument {
  id: string
  title: string
  type: "prd" | "design" | "api" | "meeting" | "spec" | "wiki" | "other"
  
  // æ–‡æ¡£æ¥æº
  source:
    | { type: "upload"; fileId: string }          // ä¸Šä¼ æ–‡ä»¶
    | { type: "url"; url: string }                // å¤–éƒ¨é“¾æ¥ï¼ˆNotion / Confluence / Feishuï¼‰
    | { type: "git"; repoId: string; path: string } // ä»“åº“å†…æ–‡æ¡£
    | { type: "inline"; content: string }         // å†…è”å¯Œæ–‡æœ¬
  
  // Grounding ç´¢å¼•
  indexed: boolean
  tags: string[]
  
  time: { created: number; updated: number }
}

/**
 * ç‰ˆæœ¬è¿­ä»£ï¼ˆæ•…äº‹æ¿ï¼‰
 * æœªæ¥æ‰©å±•ï¼šSprint ç®¡ç†ã€çœ‹æ¿è§†å›¾ã€ç‡ƒå°½å›¾
 */
export interface SpaceIteration {
  id: string
  version: string                     // å¦‚ "v1.2.0"
  title: string                       // è¿­ä»£æ ‡é¢˜
  description?: string
  status: "planning" | "in-progress" | "review" | "released"
  
  // å…³è”å®ä½“
  stories: IterationStory[]           // ç”¨æˆ·æ•…äº‹
  branches: string[]                  // å…³è” Git åˆ†æ”¯
  pullRequests: string[]              // å…³è” PR
  
  // æ—¶é—´çº¿
  plannedStart?: number
  plannedEnd?: number
  actualStart?: number
  actualEnd?: number
}

export interface IterationStory {
  id: string
  title: string
  description: string
  priority: "critical" | "high" | "medium" | "low"
  status: "todo" | "in-progress" | "review" | "done"
  assignee?: string                   // æˆå‘˜ ID æˆ– Agent ID
  
  // ä¸ Agent ä»»åŠ¡å…³è”
  taskIds: string[]                   // å…³è”çš„ TaskRecord ID
  
  // æ•…äº‹ç‚¹
  points?: number
}

/**
 * Space Grounding é…ç½®
 * å†³å®š Agent åœ¨è¯¥ Space ä¸­çš„çŸ¥è¯†æ¥åœ°èŒƒå›´
 */
export interface SpaceGrounding {
  // è‡ªåŠ¨ç´¢å¼•èŒƒå›´
  autoIndex: {
    repositories: boolean             // è‡ªåŠ¨ç´¢å¼•æ‰€æœ‰å…³è”ä»“åº“
    documents: boolean                // è‡ªåŠ¨ç´¢å¼•æ‰€æœ‰æ–‡æ¡£
    filePatterns: string[]            // æ–‡ä»¶åŒ¹é…æ¨¡å¼ï¼ˆå¦‚ ["**/*.ts", "**/*.md"]ï¼‰
    excludePatterns: string[]         // æ’é™¤æ¨¡å¼ï¼ˆå¦‚ ["node_modules/**"]ï¼‰
  }
  
  // é¢å¤– Grounding æº
  externalSources: GroundingSource[]  // å¤–éƒ¨æ•°æ®æºï¼ˆÂ§3.4ï¼‰
}

/**
 * Space è®¾ç½®
 */
export interface SpaceSettings {
  // AI é…ç½®
  defaultModel?: string               // é»˜è®¤ä½¿ç”¨çš„æ¨¡å‹
  defaultAgent?: string               // é»˜è®¤ Agent
  executionMode: "plan" | "execute"   // é»˜è®¤æ‰§è¡Œæ¨¡å¼
  
  // ä»£ç é£æ ¼åå¥½
  codeStyle?: {
    language?: string                 // ä¸»è¦ç¼–ç¨‹è¯­è¨€
    framework?: string                // ä¸»è¦æ¡†æ¶
    conventions?: string              // ç¼–ç è§„èŒƒæ–‡æ¡£è·¯å¾„
  }
  
  // é€šçŸ¥åå¥½
  notifications: {
    taskComplete: boolean
    iterationUpdate: boolean
    prReview: boolean
  }
}
```

#### 8.2.2 Space API

```typescript
// server/routes/space.ts
export const spaceRoutes = new OpenAPIHono()

  // â”€â”€ Space CRUD â”€â”€
  .post("/api/spaces", async (c) => {
    const input = await c.req.json<CreateSpaceInput>()
    const space = await SpaceManager.create(input)
    return c.json(space, 201)
  })
  
  .get("/api/spaces", async (c) => {
    const spaces = await SpaceManager.list(c.get("userId"))
    return c.json({ spaces })
  })
  
  .get("/api/spaces/:id", async (c) => {
    const space = await SpaceManager.get(c.req.param("id"))
    return c.json(space)
  })
  
  .patch("/api/spaces/:id", async (c) => {
    const updates = await c.req.json()
    const space = await SpaceManager.update(c.req.param("id"), updates)
    return c.json(space)
  })
  
  .delete("/api/spaces/:id", async (c) => {
    await SpaceManager.archive(c.req.param("id"))
    return c.json({ status: "archived" })
  })

  // â”€â”€ ä»“åº“ç®¡ç† â”€â”€
  .post("/api/spaces/:id/repositories", async (c) => {
    const repo = await c.req.json<SpaceRepository>()
    const result = await SpaceManager.addRepository(c.req.param("id"), repo)
    // è‡ªåŠ¨è§¦å‘ä»£ç ç´¢å¼•
    await GroundingService.indexRepository(result.id, repo)
    return c.json(result, 201)
  })
  
  .delete("/api/spaces/:id/repositories/:repoId", async (c) => {
    await SpaceManager.removeRepository(c.req.param("id"), c.req.param("repoId"))
    return c.json({ status: "removed" })
  })

  // â”€â”€ æ–‡æ¡£ç®¡ç† â”€â”€
  .post("/api/spaces/:id/documents", async (c) => {
    const doc = await c.req.json<SpaceDocument>()
    const result = await SpaceManager.addDocument(c.req.param("id"), doc)
    return c.json(result, 201)
  })
  
  .get("/api/spaces/:id/documents", async (c) => {
    const docs = await SpaceManager.listDocuments(c.req.param("id"))
    return c.json({ documents: docs })
  })

  // â”€â”€ è¿­ä»£ç®¡ç† â”€â”€
  .post("/api/spaces/:id/iterations", async (c) => {
    const iteration = await c.req.json<SpaceIteration>()
    const result = await SpaceManager.createIteration(c.req.param("id"), iteration)
    return c.json(result, 201)
  })
  
  .get("/api/spaces/:id/iterations", async (c) => {
    const iterations = await SpaceManager.listIterations(c.req.param("id"))
    return c.json({ iterations })
  })
  
  .patch("/api/spaces/:id/iterations/:iterationId", async (c) => {
    const updates = await c.req.json()
    const result = await SpaceManager.updateIteration(
      c.req.param("id"), c.req.param("iterationId"), updates
    )
    return c.json(result)
  })

  // â”€â”€ æ•…äº‹æ¿ â”€â”€
  .post("/api/spaces/:id/iterations/:iterationId/stories", async (c) => {
    const story = await c.req.json<IterationStory>()
    const result = await SpaceManager.addStory(
      c.req.param("id"), c.req.param("iterationId"), story
    )
    return c.json(result, 201)
  })
  
  .patch("/api/spaces/:id/iterations/:iterationId/stories/:storyId", async (c) => {
    const updates = await c.req.json()
    const result = await SpaceManager.updateStory(
      c.req.param("id"), c.req.param("iterationId"), c.req.param("storyId"), updates
    )
    return c.json(result)
  })

  // â”€â”€ Grounding ç´¢å¼• â”€â”€
  .post("/api/spaces/:id/reindex", async (c) => {
    const job = await GroundingService.reindexSpace(c.req.param("id"))
    return c.json({ jobId: job.id, status: "indexing" }, 202)
  })
```

### 8.3 ç”¨æˆ·ç«¯ï¼ˆUser Appï¼‰

ç”¨æˆ·ç«¯æ˜¯å¼€å‘è€… / PM / è®¾è®¡å¸ˆçš„æ—¥å¸¸å·¥ä½œå…¥å£ï¼Œäº§å“å½¢æ€ç±»ä¼¼ Kimi 2.5 Web + GitHub Copilot Webã€‚

#### 8.3.1 æ•´ä½“å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vitamin-Code                              ğŸ” Search    ğŸ‘¤ Profile   âš™ï¸   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                                                    â”‚
â”‚  Space  â”‚              Main Content Area                                     â”‚
â”‚  List   â”‚                                                                    â”‚
â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â˜… My    â”‚  â”‚  Space: Project Alpha                                       â”‚   â”‚
â”‚   Proj  â”‚  â”‚                                                             â”‚   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚ â”‚Alphaâ”‚â—„â”‚  â”‚  â”‚         AI å¯¹è¯åŒº (Chat Panel)                      â”‚    â”‚   â”‚
â”‚ â”‚Beta â”‚ â”‚  â”‚  â”‚                                                     â”‚    â”‚   â”‚
â”‚ â”‚Gammaâ”‚ â”‚  â”‚  â”‚  [Plan æ¨¡å¼ ğŸ”˜] [Execute æ¨¡å¼ â—‹]                   â”‚    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚                                                     â”‚    â”‚   â”‚
â”‚         â”‚  â”‚  â”‚  ğŸ‘¤ å¸®æˆ‘åˆ†æä¸€ä¸‹è®¤è¯æ¨¡å—çš„å®‰å…¨æ¼æ´                  â”‚    â”‚   â”‚
â”‚ Recent  â”‚  â”‚  â”‚                                                     â”‚    â”‚   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚  ğŸ¤– [Plan] æˆ‘å°†æŒ‰ä»¥ä¸‹è®¡åˆ’æ‰§è¡Œï¼š                    â”‚    â”‚   â”‚
â”‚ â”‚Chat1â”‚ â”‚  â”‚  â”‚     1. æ‰«æ src/auth/ ç›®å½•ç»“æ„                     â”‚    â”‚   â”‚
â”‚ â”‚Chat2â”‚ â”‚  â”‚  â”‚     2. åˆ†æ JWT éªŒè¯é€»è¾‘                           â”‚    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚     3. æ£€æŸ¥å¯†ç å“ˆå¸Œç­–ç•¥                            â”‚    â”‚   â”‚
â”‚         â”‚  â”‚  â”‚     4. å®¡æŸ¥ OAuth2 å›è°ƒå®‰å…¨                        â”‚    â”‚   â”‚
â”‚         â”‚  â”‚  â”‚     5. ç”Ÿæˆå®‰å…¨å®¡è®¡æŠ¥å‘Š                            â”‚    â”‚   â”‚
â”‚         â”‚  â”‚  â”‚                                                     â”‚    â”‚   â”‚
â”‚         â”‚  â”‚  â”‚  [âœ… ç¡®è®¤æ‰§è¡Œ] [âœï¸ ä¿®æ”¹è®¡åˆ’] [âŒ å–æ¶ˆ]            â”‚    â”‚   â”‚
â”‚         â”‚  â”‚  â”‚                                                     â”‚    â”‚   â”‚
â”‚         â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚         â”‚  â”‚                                                             â”‚   â”‚
â”‚         â”‚  â”‚  Tabs: [ğŸ’¬ Chat] [ğŸ“‹ Iterations] [ğŸ“ Repos] [ğŸ“„ Docs]    â”‚   â”‚
â”‚         â”‚  â”‚                                                             â”‚   â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Context: main branch â€¢ 12 files indexed â€¢ Agent: code-analyst             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.3.2 æ ¸å¿ƒé¡µé¢

| é¡µé¢ | è·¯ç”± | åŠŸèƒ½ |
|------|------|------|
| **Space åˆ—è¡¨** | `/spaces` | æ‰€æœ‰é¡¹ç›®ç©ºé—´å¡ç‰‡ï¼Œæ”¯æŒæœç´¢/ç­›é€‰/æ’åº |
| **Space ä¸»é¡µ** | `/spaces/:id` | é¡¹ç›®æ¦‚è§ˆ â€” æœ€è¿‘ä¼šè¯ / è¿­ä»£è¿›åº¦ / ä»“åº“çŠ¶æ€ / å›¢é˜ŸåŠ¨æ€ |
| **AI å¯¹è¯** | `/spaces/:id/chat/:sessionId` | Kimi é£æ ¼å¯¹è¯ç•Œé¢ï¼Œæ”¯æŒ Plan / Execute æ¨¡å¼åˆ‡æ¢ |
| **è¿­ä»£çœ‹æ¿** | `/spaces/:id/iterations/:iterationId` | æ•…äº‹æ¿çœ‹æ¿è§†å›¾ï¼ˆTodo / In-Progress / Review / Doneï¼‰ |
| **ä»“åº“æµè§ˆ** | `/spaces/:id/repos/:repoId` | ä»£ç æµè§ˆ + AI è¡Œå†…æ³¨é‡Š + PR/Branch ç®¡ç† |
| **æ–‡æ¡£ä¸­å¿ƒ** | `/spaces/:id/docs` | PRD / è®¾è®¡ç¨¿ / API æ–‡æ¡£åˆ—è¡¨ï¼Œæ”¯æŒåœ¨çº¿ç¼–è¾‘å’Œ AI æ‘˜è¦ |
| **ä»»åŠ¡ä¸­å¿ƒ** | `/spaces/:id/tasks` | å¼‚æ­¥ä»»åŠ¡åˆ—è¡¨ï¼ˆçŠ¶æ€ / è¿›åº¦ / ç»“æœ / SSE å®æ—¶è¿½è¸ªï¼‰ |
| **å…¨å±€æœç´¢** | `/search` | è·¨ Space å…¨æ–‡æœç´¢ï¼ˆä»£ç  / æ–‡æ¡£ / ä¼šè¯å†å²ï¼‰ |

#### 8.3.3 Plan / Execute åŒæ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Plan / Execute åŒæ¨¡å¼                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Plan æ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ç”¨æˆ·è¾“å…¥ â†’ Agent åˆ†ææ„å›¾                                            â”‚   â”‚
â”‚  â”‚          â†’ ç”Ÿæˆç»“æ„åŒ–æ‰§è¡Œè®¡åˆ’ï¼ˆæ­¥éª¤ + é¢„ä¼°æ—¶é—´ + æ¶‰åŠæ–‡ä»¶ï¼‰          â”‚   â”‚
â”‚  â”‚          â†’ å±•ç¤ºè®¡åˆ’å¡ç‰‡ä¾›äººç±»å®¡æ ¸                                     â”‚   â”‚
â”‚  â”‚          â†’ äººç±»å¯ä¿®æ”¹/å¢åˆ /é‡æ’æ­¥éª¤                                   â”‚   â”‚
â”‚  â”‚          â†’ ç¡®è®¤åè¿›å…¥æ‰§è¡Œé˜¶æ®µ                                         â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  é€‚ç”¨åœºæ™¯ï¼šå¤æ‚é‡æ„ã€è·¨æ–‡ä»¶ä¿®æ”¹ã€ç”Ÿäº§éƒ¨ç½²ã€å®‰å…¨æ•æ„Ÿæ“ä½œ              â”‚   â”‚
â”‚  â”‚  æ ¸å¿ƒä»·å€¼ï¼šäººç±»ä¿æŒæ§åˆ¶æƒï¼ŒAgent æä¾›ä¸“ä¸šè§„åˆ’                        â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Execute æ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ç”¨æˆ·è¾“å…¥ â†’ Agent ç«‹å³å¼€å§‹æ‰§è¡Œ                                        â”‚   â”‚
â”‚  â”‚          â†’ å®æ—¶æµå¼å±•ç¤ºï¼šLLM æ€è€ƒè¿‡ç¨‹ + å·¥å…·è°ƒç”¨ + ä¸­é—´ç»“æœ          â”‚   â”‚
â”‚  â”‚          â†’ å¯éšæ—¶æš‚åœ / ä»‹å…¥ / è¿½é—®                                   â”‚   â”‚
â”‚  â”‚          â†’ æ‰§è¡Œå®Œæˆå±•ç¤ºç»“æœæ‘˜è¦                                       â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  é€‚ç”¨åœºæ™¯ï¼šå¿«é€ŸæŸ¥è¯¢ã€ä»£ç ç”Ÿæˆã€æ–‡æ¡£æ’°å†™ã€Bug åˆ†æ                    â”‚   â”‚
â”‚  â”‚  æ ¸å¿ƒä»·å€¼ï¼šä½å»¶è¿Ÿã€æµç•…ä½“éªŒï¼Œç±»ä¼¼ Kimi / ChatGPT                     â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  ä¸¤ç§æ¨¡å¼å¯åœ¨å¯¹è¯è¿‡ç¨‹ä¸­éšæ—¶åˆ‡æ¢                                              â”‚
â”‚  Space è®¾ç½®ä¸­å¯é…ç½®é»˜è®¤æ¨¡å¼                                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.3.4 Plan æ¨¡å¼äº¤äº’è®¾è®¡

```typescript
// ç”¨æˆ·ç«¯ Plan æ¨¡å¼æ•°æ®æ¨¡å‹

export interface ExecutionPlan {
  id: string
  sessionId: string
  spaceId: string
  
  // è®¡åˆ’çŠ¶æ€
  status: "drafting" | "pending_review" | "approved" | "executing" | "completed" | "rejected"
  
  // æ„å›¾åˆ†æ
  intent: {
    summary: string                    // Agent å¯¹ç”¨æˆ·æ„å›¾çš„ç†è§£
    category: string                   // é¢†åŸŸåˆ†ç±»
    complexity: "simple" | "moderate" | "complex"
    estimatedDuration: string          // é¢„ä¼°æ‰§è¡Œæ—¶é—´
  }
  
  // æ‰§è¡Œæ­¥éª¤
  steps: PlanStep[]
  
  // å½±å“èŒƒå›´
  impact: {
    files: string[]                    // å¯èƒ½æ¶‰åŠçš„æ–‡ä»¶
    repositories: string[]             // æ¶‰åŠçš„ä»“åº“
    risks: string[]                    // é£é™©æç¤º
  }
  
  // å®¡æ ¸è®°å½•
  reviews: PlanReview[]
}

export interface PlanStep {
  id: string
  order: number
  title: string
  description: string
  
  // æ­¥éª¤ç±»å‹
  type: "analyze" | "generate" | "modify" | "test" | "review" | "deploy"
  
  // å…³è”èµ„æº
  agent?: string                       // æ‰§è¡Œè¯¥æ­¥éª¤çš„ Agent
  tools?: string[]                     // ä½¿ç”¨çš„å·¥å…·
  files?: string[]                     // æ¶‰åŠçš„æ–‡ä»¶
  
  // æ‰§è¡ŒçŠ¶æ€
  status: "pending" | "running" | "completed" | "failed" | "skipped"
  result?: StepResult
  
  // äººç±»å¯ç¼–è¾‘
  editable: boolean
}

export interface PlanReview {
  timestamp: Date
  action: "approve" | "reject" | "modify"
  comment?: string
  modifications?: PlanStep[]           // ä¿®æ”¹çš„æ­¥éª¤
}
```

**Plan æ¨¡å¼å¯¹è¯æµç¨‹ï¼š**

```
ç”¨æˆ·: å¸®æˆ‘é‡æ„è®¤è¯æ¨¡å—ï¼Œä» session-based è¿ç§»åˆ° JWT

ğŸ¤– Agent [Plan æ¨¡å¼]:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ æ‰§è¡Œè®¡åˆ’                                     â”‚
â”‚  é¢„ä¼°æ—¶é—´: ~15 åˆ†é’Ÿ  â”‚  å¤æ‚åº¦: é«˜  â”‚  æ–‡ä»¶: 12  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  Step 1: åˆ†æç°æœ‰è®¤è¯æ¶æ„              [analyze] â”‚
â”‚  â†’ æ‰«æ src/auth/ ç›®å½•ï¼Œæ¢³ç†ä¾èµ–å…³ç³»            â”‚
â”‚  â†’ æ–‡ä»¶: auth.ts, session.ts, middleware.ts      â”‚
â”‚                                                  â”‚
â”‚  Step 2: è®¾è®¡ JWT è®¤è¯æ–¹æ¡ˆ              [review] â”‚
â”‚  â†’ ç”Ÿæˆ JWT æ¶æ„è®¾è®¡æ–‡æ¡£                         â”‚
â”‚  â†’ ç¡®å®š Token ç»“æ„ã€åˆ·æ–°ç­–ç•¥ã€å­˜å‚¨æ–¹æ¡ˆ           â”‚
â”‚                                                  â”‚
â”‚  Step 3: å®ç° JWT æ ¸å¿ƒæ¨¡å—            [generate] â”‚
â”‚  â†’ åˆ›å»º jwt.ts, token-service.ts                 â”‚
â”‚  â†’ å®ç°ç­¾å‘ã€éªŒè¯ã€åˆ·æ–°é€»è¾‘                      â”‚
â”‚                                                  â”‚
â”‚  Step 4: è¿ç§»ä¸­é—´ä»¶                    [modify]  â”‚
â”‚  â†’ ä¿®æ”¹ auth-middleware.ts                        â”‚
â”‚  â†’ ä» session éªŒè¯æ”¹ä¸º JWT éªŒè¯                   â”‚
â”‚                                                  â”‚
â”‚  Step 5: ç¼–å†™æµ‹è¯•ç”¨ä¾‹                    [test]  â”‚
â”‚  â†’ åˆ›å»º jwt.test.ts                              â”‚
â”‚  â†’ è¦†ç›–ç­¾å‘/éªŒè¯/è¿‡æœŸ/åˆ·æ–°åœºæ™¯                    â”‚
â”‚                                                  â”‚
â”‚  âš ï¸ é£é™©æç¤º:                                    â”‚
â”‚  â€¢ éœ€è¦å‰ç«¯åŒæ­¥ä¿®æ”¹ Token å­˜å‚¨æ–¹å¼                â”‚
â”‚  â€¢ å·²ç™»å½•ç”¨æˆ·éœ€è¦é‡æ–°è®¤è¯                         â”‚
â”‚                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [âœ… ç¡®è®¤æ‰§è¡Œ] [âœï¸ ç¼–è¾‘æ­¥éª¤] [âŒ å–æ¶ˆ]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.3.5 å¯¹è¯é¢æ¿ (Chat Panel)

æ ¸å¿ƒäº¤äº’ç»„ä»¶ï¼Œå‚è€ƒ Kimi 2.5 Web çš„æµå¼å¯¹è¯ä½“éªŒï¼š

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **æµå¼å“åº”** | SSE å®æ—¶æ¨é€ LLM è¾“å‡ºï¼Œé€å­—æ¸²æŸ“ï¼ˆMarkdown + ä»£ç é«˜äº®ï¼‰ |
| **å·¥å…·è°ƒç”¨å¯è§†åŒ–** | å±•ç¤º Agent è°ƒç”¨çš„å·¥å…·åã€è¾“å…¥å‚æ•°ã€æ‰§è¡Œç»“æœï¼ˆå¯æŠ˜å ï¼‰ |
| **ä»£ç å—å¢å¼º** | è¯­æ³•é«˜äº® + ä¸€é”®å¤åˆ¶ + "åº”ç”¨åˆ°æ–‡ä»¶" + Diff é¢„è§ˆ |
| **å¤šè½®å¯¹è¯** | ä¸Šä¸‹æ–‡è‡ªåŠ¨æºå¸¦ï¼Œæ”¯æŒå¼•ç”¨å†å²æ¶ˆæ¯é‡æ–°æé—® |
| **åˆ†æ”¯å¯¹è¯** | åœ¨ä»»æ„æ¶ˆæ¯å¤„ fork æ–°å¯¹è¯åˆ†æ”¯ï¼ˆæ¢ç´¢ä¸åŒæ–¹æ¡ˆï¼‰ |
| **Agent åˆ‡æ¢** | å¯¹è¯ä¸­å¯åˆ‡æ¢ä¸åŒ Agentï¼ˆå¦‚ä» code-analyst åˆ‡åˆ° doc-writerï¼‰ |
| **é™„ä»¶ä¸Šä¼ ** | æ”¯æŒä¸Šä¼ å›¾ç‰‡ã€æ–‡ä»¶ã€ä»£ç ç‰‡æ®µä½œä¸ºä¸Šä¸‹æ–‡ |
| **Swarm è§†å›¾** | å¤æ‚ä»»åŠ¡è‡ªåŠ¨è¿›å…¥ Swarm æ¨¡å¼æ—¶ï¼Œå±•ç¤º Agent æ‹“æ‰‘ï¼ˆé“¾æ¥ Â§7.9ï¼‰ |
| **ä»»åŠ¡è¿›åº¦** | é•¿æ—¶ä»»åŠ¡å±•ç¤ºå®æ—¶è¿›åº¦æ¡ + æ­¥éª¤åˆ—è¡¨ + é¢„ä¼°å‰©ä½™æ—¶é—´ |

#### 8.3.6 è¿­ä»£çœ‹æ¿ (Iteration Board)

æ•…äº‹æ¿ / çœ‹æ¿è§†å›¾ï¼Œç®¡ç†ç‰ˆæœ¬è¿­ä»£ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v1.2.0 â€” è®¤è¯æ¨¡å—é‡æ„                                      [+ æ–°å»ºæ•…äº‹]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ğŸ“‹ Todo     â”‚  ğŸ”„ In Progressâ”‚   ğŸ‘€ Review    â”‚       âœ… Done           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                â”‚                â”‚                â”‚                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ åˆ·æ–°Token  â”‚ â”‚ â”‚ JWT ç­¾å‘   â”‚ â”‚ â”‚ ä¸­é—´ä»¶è¿ç§» â”‚ â”‚ â”‚ æ¶æ„è®¾è®¡   â”‚          â”‚
â”‚ â”‚ ğŸ·ï¸ 3 pts  â”‚ â”‚ â”‚ ğŸ·ï¸ 5 pts  â”‚ â”‚ â”‚ ğŸ·ï¸ 5 pts  â”‚ â”‚ â”‚ ğŸ·ï¸ 3 pts  â”‚          â”‚
â”‚ â”‚ ğŸ‘¤ â€”       â”‚ â”‚ â”‚ ğŸ¤– Agent   â”‚ â”‚ â”‚ ğŸ¤– Agent   â”‚ â”‚ â”‚ ğŸ‘¤ Alice   â”‚          â”‚
â”‚ â”‚            â”‚ â”‚ â”‚ Task: t-12 â”‚ â”‚ â”‚ PR: #42    â”‚ â”‚ â”‚ âœ“ Completedâ”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                â”‚                â”‚                â”‚                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                â”‚                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ å‰ç«¯é€‚é…   â”‚ â”‚                â”‚                â”‚ â”‚ éœ€æ±‚åˆ†æ   â”‚          â”‚
â”‚ â”‚ ğŸ·ï¸ 2 pts  â”‚ â”‚                â”‚                â”‚ â”‚ ğŸ·ï¸ 2 pts  â”‚          â”‚
â”‚ â”‚ ğŸ‘¤ Bob     â”‚ â”‚                â”‚                â”‚ â”‚ ğŸ¤– Agent   â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”‚                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                â”‚                â”‚                â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•…äº‹æ¿ + Agent è”åŠ¨ï¼š**
- æ•…äº‹å¡ç‰‡å¯ç›´æ¥å…³è” Agent ä»»åŠ¡ï¼ˆtaskIdï¼‰
- æ‹–æ‹½æ•…äº‹åˆ° "In Progress" â†’ è‡ªåŠ¨åˆ›å»º Agent ä¼šè¯å¹¶å¼€å§‹æ‰§è¡Œ
- Agent å®Œæˆä»»åŠ¡ â†’ è‡ªåŠ¨åˆ›å»º PR â†’ æ•…äº‹å¡ç‰‡æµè½¬åˆ° "Review"
- æ”¯æŒ AI è¾…åŠ©ï¼šä¸€é”® "è®© Agent è¯„ä¼°æ•…äº‹ç‚¹" / "ç”Ÿæˆå­ä»»åŠ¡"

### 8.4 ç®¡ç†ç«¯ï¼ˆAdmin Appï¼‰

ç®¡ç†ç«¯é¢å‘å¹³å°ç®¡ç†å‘˜ï¼Œç®¡ç† Agent / Tool / Workflow / æ¨¡æ¿ / æƒé™ / ç›‘æ§ã€‚

#### 8.4.1 æ•´ä½“å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vitamin-Code Admin                              ğŸ‘¤ Admin   ğŸ”” Alerts      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                                                    â”‚
â”‚  Nav    â”‚              Main Content Area                                     â”‚
â”‚         â”‚                                                                    â”‚
â”‚ ğŸ“Š Dashboard                                                                â”‚
â”‚ ğŸ¤– Agents    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ ğŸ”§ Tools     â”‚  â”‚  Agent Registry                    [+ Create Agent] â”‚     â”‚
â”‚ ğŸ”€ Workflows â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚ ğŸ“‹ Templates â”‚  â”‚                                                     â”‚     â”‚
â”‚ ğŸ Swarm     â”‚  â”‚  ID          Role       Domain    Status   Actions  â”‚     â”‚
â”‚ ğŸ‘¥ Members   â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â”‚
â”‚ ğŸ” Security  â”‚  â”‚  code-analyst specialist coding   âœ… active  âœï¸ğŸ—‘ï¸  â”‚     â”‚
â”‚ ğŸ“ˆ Metrics   â”‚  â”‚  doc-writer  specialist docs      âœ… active  âœï¸ğŸ—‘ï¸  â”‚     â”‚
â”‚ âš™ï¸ Settings  â”‚  â”‚  test-runner specialist testing   âš ï¸ idle    âœï¸ğŸ—‘ï¸  â”‚     â”‚
â”‚              â”‚  â”‚  coordinator orchestrator â€”       âœ… active  âœï¸ğŸ—‘ï¸  â”‚     â”‚
â”‚              â”‚  â”‚                                                     â”‚     â”‚
â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚              â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.4.2 ç®¡ç†ç«¯åŠŸèƒ½æ¨¡å—

| æ¨¡å— | è·¯ç”± | åŠŸèƒ½ |
|------|------|------|
| **Dashboard** | `/admin` | ç³»ç»Ÿæ¦‚è§ˆ â€” Agent/Task/Session æŒ‡æ ‡ã€å¥åº·çŠ¶æ€ã€èµ„æºä½¿ç”¨ |
| **Agent ç®¡ç†** | `/admin/agents` | Agent CRUD + åŒæ¨¡å¼ç¼–è¾‘å™¨ï¼ˆå¯è§†åŒ– / YAMLï¼‰+ æµ‹è¯•æ²™ç®± |
| **Tool ç®¡ç†** | `/admin/tools` | Tool CRUD + å‚æ•° Schema ç¼–è¾‘ + è°ƒç”¨æµ‹è¯• |
| **Workflow ç®¡ç†** | `/admin/workflows` | Workflow CRUD + ReactFlow å¯è§†åŒ–ç¼–æ’å™¨ + æ‰§è¡Œå†å² |
| **æ¨¡æ¿ç®¡ç†** | `/admin/templates` | åœºæ™¯æ¨¡æ¿ CRUD + æ¨¡æ¿å‚æ•°é…ç½® + é¢„è§ˆ |
| **Swarm ç›‘æ§** | `/admin/swarm` | æ´»è·ƒ Swarm åˆ—è¡¨ + æ‹“æ‰‘å®æ—¶å¯è§†åŒ–ï¼ˆÂ§7.9ï¼‰+ æ‰©ç¼©å®¹æ—¥å¿— |
| **æˆå‘˜æƒé™** | `/admin/members` | æˆå‘˜ç®¡ç† + è§’è‰²åˆ†é… + æƒé™ç­–ç•¥ç¼–è¾‘ï¼ˆÂ§10ï¼‰ |
| **å®‰å…¨å®¡è®¡** | `/admin/security` | å®¡è®¡æ—¥å¿— + å®‰å…¨ç­–ç•¥ + Token ä½¿ç”¨é™é¢ |
| **ç³»ç»ŸæŒ‡æ ‡** | `/admin/metrics` | è¿è¡ŒæŒ‡æ ‡ + å¯è§‚æµ‹æ€§é¢æ¿ + è°ƒç”¨ç»Ÿè®¡ |
| **ç³»ç»Ÿè®¾ç½®** | `/admin/settings` | å…¨å±€é…ç½® + Provider é…ç½® + è®¤è¯è®¾ç½® + å¯¼å…¥å¯¼å‡º |

#### 8.4.3 Builder ç»„ä»¶è®¾è®¡

**Agent Builder** â€” åŒæ¨¡å¼ Agent å®šä¹‰ç¼–è¾‘å™¨ï¼ˆå¯è§†åŒ– / YAMLï¼‰ï¼ŒåŸºäº Mantine + Monaco Editorï¼š

| é¢æ¿ | åŠŸèƒ½ |
|------|------|
| åŸºæœ¬ä¿¡æ¯ | IDã€åç§°ã€æè¿°ã€é¢†åŸŸã€ç±»åˆ« |
| èƒ½åŠ›é…ç½® | å¤šé€‰èƒ½åŠ›æ ‡ç­¾ (`CapabilitySelector`) |
| å·¥å…·ç»‘å®š | å·¥å…·é›†ç¼–è¾‘ (`ToolBindingEditor`) |
| System Prompt | Prompt ç¼–è¾‘å™¨ (`PromptEditor`) |
| æƒé™è§„åˆ™ | æƒé™è§„åˆ™ç¼–è¾‘ (`PermissionEditor`) |
| ä»£ç æ¨¡å¼ | Monaco Editor ç›´æ¥ç¼–è¾‘ YAMLï¼ŒåŒå‘åŒæ­¥ `AgentDefinition` å¯¹è±¡ |

**Workflow Builder** â€” åŸºäº ReactFlow çš„æ‹–æ‹½å¼å·¥ä½œæµç¼–æ’å™¨ï¼š

ä¸‰æ å¸ƒå±€ï¼šToolboxï¼ˆæ­¥éª¤ç±»å‹é¢æ¿ï¼‰ â†’ Canvasï¼ˆReactFlow ç”»å¸ƒï¼‰ â†’ Propertiesï¼ˆå±æ€§ç¼–è¾‘ï¼‰

| æ­¥éª¤ç±»å‹ | è¯´æ˜ |
|---------|------|
| Agent è°ƒç”¨ | å§”æ´¾ä»»åŠ¡ç»™æŒ‡å®š Agent |
| å·¥å…·è°ƒç”¨ | ç›´æ¥è°ƒç”¨å·¥å…· |
| æ¡ä»¶åˆ†æ”¯ | åŸºäºæ¡ä»¶åˆ†å‘ |
| å¹¶è¡Œæ‰§è¡Œ | å¤šæ­¥éª¤å¹¶è¡Œ |
| äººå·¥ä»‹å…¥ | æš‚åœç­‰å¾…äººå·¥ç¡®è®¤ |
| å­å·¥ä½œæµ | åµŒå¥—è°ƒç”¨å…¶ä»–å·¥ä½œæµ |

### 8.5 å‰ç«¯æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Web å‰ç«¯æŠ€æœ¯æ¶æ„                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ packages/web â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  æŠ€æœ¯æ ˆ:                                                              â”‚   â”‚
â”‚  â”‚  â€¢ React 19 + TypeScript                                              â”‚   â”‚
â”‚  â”‚  â€¢ Mantine 7ï¼ˆç»„ä»¶åº“ + ä¸»é¢˜ç³»ç»Ÿï¼‰                                     â”‚   â”‚
â”‚  â”‚  â€¢ React Router v7ï¼ˆè·¯ç”±ï¼‰                                            â”‚   â”‚
â”‚  â”‚  â€¢ TanStack Query v5ï¼ˆæœåŠ¡ç«¯çŠ¶æ€ + ç¼“å­˜ï¼‰                             â”‚   â”‚
â”‚  â”‚  â€¢ React Flowï¼ˆSwarm æ‹“æ‰‘ + Workflow ç¼–æ’ï¼‰                           â”‚   â”‚
â”‚  â”‚  â€¢ Monaco Editorï¼ˆä»£ç /YAML ç¼–è¾‘å™¨ï¼‰                                  â”‚   â”‚
â”‚  â”‚  â€¢ Viteï¼ˆæ„å»ºï¼‰                                                       â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ç›®å½•ç»“æ„:                                                            â”‚   â”‚
â”‚  â”‚  src/                                                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ apps/                                                            â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ user/          # ç”¨æˆ·ç«¯åº”ç”¨                                  â”‚   â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ routes/    # é¡µé¢è·¯ç”±                                    â”‚   â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ layouts/   # å¸ƒå±€ç»„ä»¶                                    â”‚   â”‚
â”‚  â”‚  â”‚   â”‚   â””â”€â”€ app.tsx    # ç”¨æˆ·ç«¯å…¥å£                                  â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€â”€ admin/         # ç®¡ç†ç«¯åº”ç”¨                                  â”‚   â”‚
â”‚  â”‚  â”‚       â”œâ”€â”€ routes/    # é¡µé¢è·¯ç”±                                    â”‚   â”‚
â”‚  â”‚  â”‚       â”œâ”€â”€ layouts/   # å¸ƒå±€ç»„ä»¶                                    â”‚   â”‚
â”‚  â”‚  â”‚       â””â”€â”€ app.tsx    # ç®¡ç†ç«¯å…¥å£                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ shared/                                                          â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ components/    # å…±äº« UI ç»„ä»¶                                â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ hooks/         # å…±äº« Hooksï¼ˆuseSSE / useSpace / ...ï¼‰       â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ api/           # API Clientï¼ˆTanStack Query + Hono RPCï¼‰     â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ stores/        # å®¢æˆ·ç«¯çŠ¶æ€                                  â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€â”€ theme/         # Mantine ä¸»é¢˜å®šåˆ¶                            â”‚   â”‚
â”‚  â”‚  â””â”€â”€ main.tsx           # Vite å…¥å£                                   â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ API é€šä¿¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  REST â†’ TanStack Query ç®¡ç†ç¼“å­˜ + ä¹è§‚æ›´æ–°                           â”‚   â”‚
â”‚  â”‚  SSE  â†’ EventSource æ¥æ”¶å®æ—¶äº‹ä»¶ï¼ˆTask / Debug / Swarmï¼‰              â”‚   â”‚
â”‚  â”‚  RPC  â†’ Hono RPC ç±»å‹å®‰å…¨è°ƒç”¨ï¼ˆå¯é€‰ï¼‰                                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.6 API è·¯ç”±æ€»è§ˆ

æ•´åˆç”¨æˆ·ç«¯ + ç®¡ç†ç«¯çš„å®Œæ•´ APIï¼š

```typescript
// server/routes/index.ts
import { OpenAPIHono } from "@hono/zod-openapi"

const app = new OpenAPIHono()

// â”€â”€ å…¬å…± APIï¼ˆç”¨æˆ·ç«¯ + ç®¡ç†ç«¯å…±ç”¨ï¼‰â”€â”€
app.route("/api/auth",       authRoutes)        // è®¤è¯ï¼ˆÂ§7.11.4ï¼‰
app.route("/api/spaces",     spaceRoutes)       // Space CRUD + å­èµ„æº
app.route("/api/sessions",   sessionRoutes)     // ä¼šè¯ç®¡ç†
app.route("/api/tasks",      taskRoutes)        // å¼‚æ­¥ä»»åŠ¡ï¼ˆÂ§7.11.2ï¼‰
app.route("/api/chat",       chatRoutes)        // å¯¹è¯ APIï¼ˆæµå¼ + Plan/Executeï¼‰

// â”€â”€ ç®¡ç†ç«¯ API â”€â”€
app.route("/api/admin/agents",    adminAgentRoutes)    // Agent CRUD
app.route("/api/admin/tools",     adminToolRoutes)     // Tool CRUD
app.route("/api/admin/workflows", adminWorkflowRoutes) // Workflow CRUD
app.route("/api/admin/templates", adminTemplateRoutes) // æ¨¡æ¿ CRUD
app.route("/api/admin/swarm",     adminSwarmRoutes)    // Swarm ç›‘æ§
app.route("/api/admin/members",   adminMemberRoutes)   // æˆå‘˜æƒé™
app.route("/api/admin/config",    adminConfigRoutes)   // ç³»ç»Ÿé…ç½®
app.route("/api/admin/metrics",   adminMetricsRoutes)  // ç³»ç»ŸæŒ‡æ ‡

// â”€â”€ å®æ—¶äº‹ä»¶ â”€â”€
app.route("/api/events",     eventRoutes)       // SSE å…¨å±€äº‹ä»¶æµ
app.route("/api/debug",      debugRoutes)       // è°ƒè¯• APIï¼ˆÂ§12ï¼‰

// â”€â”€ é™æ€èµ„æº â”€â”€
app.get("/admin/*",  serveStatic({ root: "./web/admin" }))  // ç®¡ç†ç«¯ SPA
app.get("/*",        serveStatic({ root: "./web/user" }))   // ç”¨æˆ·ç«¯ SPA
```

#### Chat APIï¼ˆå¯¹è¯æ ¸å¿ƒï¼‰

```typescript
// server/routes/chat.ts
export const chatRoutes = new OpenAPIHono()

  // åˆ›å»ºæ–°å¯¹è¯ä¼šè¯
  .post("/api/chat/sessions", async (c) => {
    const { spaceId, agentId, mode } = await c.req.json()
    const session = await ChatService.createSession({
      spaceId,
      agentId,
      mode,                            // "plan" | "execute"
      userId: c.get("userId"),
    })
    return c.json(session, 201)
  })
  
  // å‘é€æ¶ˆæ¯ï¼ˆæµå¼å“åº”ï¼‰
  .post("/api/chat/sessions/:id/messages", async (c) => {
    const sessionId = c.req.param("id")
    const { content, attachments, mode } = await c.req.json()
    
    return streamSSE(c, async (stream) => {
      const handler = mode === "plan"
        ? ChatService.planMode(sessionId, content, attachments)
        : ChatService.executeMode(sessionId, content, attachments)
      
      for await (const event of handler) {
        await stream.writeSSE({
          event: event.type,
          data: JSON.stringify(event.payload),
        })
      }
    })
  })
  
  // Plan æ¨¡å¼ â€” å®¡æ ¸æ‰§è¡Œè®¡åˆ’
  .post("/api/chat/sessions/:id/plan/:planId/review", async (c) => {
    const { action, comment, modifications } = await c.req.json()
    const result = await ChatService.reviewPlan(
      c.req.param("id"),
      c.req.param("planId"),
      { action, comment, modifications }
    )
    return c.json(result)
  })
  
  // è·å–ä¼šè¯å†å²
  .get("/api/chat/sessions/:id/messages", async (c) => {
    const messages = await ChatService.getHistory(c.req.param("id"))
    return c.json({ messages })
  })
  
  // åˆ†æ”¯å¯¹è¯
  .post("/api/chat/sessions/:id/fork", async (c) => {
    const { fromMessageId } = await c.req.json()
    const newSession = await ChatService.fork(c.req.param("id"), fromMessageId)
    return c.json(newSession, 201)
  })

  // åˆ‡æ¢æ‰§è¡Œæ¨¡å¼
  .post("/api/chat/sessions/:id/mode", async (c) => {
    const { mode } = await c.req.json<{ mode: "plan" | "execute" }>()
    await ChatService.setMode(c.req.param("id"), mode)
    return c.json({ mode })
  })
```

---

## 9. åœºæ™¯æ¨¡æ¿ç³»ç»Ÿ

### 9.1 æ¨¡æ¿å®šä¹‰

```typescript
// template/types.ts
export interface ScenarioTemplate {
  id: string
  name: string
  description: string
  icon: string
  
  // æ¨¡æ¿åˆ†ç±»
  category: TemplateCategory
  tags: string[]
  
  // æ¨¡æ¿å†…å®¹
  domain: string                      // ä½¿ç”¨çš„é¢†åŸŸ
  agents: string[]                    // é¢„ç½® Agents
  tools: string[]                     // é¢„ç½® Tools
  workflows: string[]                 // é¢„ç½® Workflows
  
  // é…ç½®é¢„è®¾
  config: Partial<Config>
  
  // åˆå§‹åŒ–å‘å¯¼
  wizard?: TemplateWizard
  
  // ç¤ºä¾‹æ•°æ®
  examples?: TemplateExample[]
}

export type TemplateCategory = 
  | "development"     // å¼€å‘ç›¸å…³
  | "documentation"   // æ–‡æ¡£ç›¸å…³
  | "analysis"        // åˆ†æç›¸å…³
  | "testing"         // æµ‹è¯•ç›¸å…³
  | "operations"      // è¿ç»´ç›¸å…³
  | "management"      // ç®¡ç†ç›¸å…³
  | "custom"          // è‡ªå®šä¹‰
```

### 9.2 é¢„ç½®æ¨¡æ¿

#### éœ€æ±‚åˆ†ææ¨¡æ¿

```yaml
# templates/requirement-analysis.template.yaml
id: requirement-analysis
name: éœ€æ±‚åˆ†æå·¥ä½œç«™
description: å®Œæ•´çš„éœ€æ±‚åˆ†æå·¥å…·é›†ï¼Œæ”¯æŒä»åŸå§‹éœ€æ±‚åˆ°ç»“æ„åŒ–æ–‡æ¡£
icon: ğŸ“‹
category: analysis

domain: analysis

agents:
  - requirement-analyst     # éœ€æ±‚åˆ†æå¸ˆ
  - domain-expert          # é¢†åŸŸä¸“å®¶
  - stakeholder-simulator  # åˆ©ç›Šç›¸å…³è€…æ¨¡æ‹Ÿ

tools:
  - read
  - write
  - search
  - ask_user
  - generate_document
  - create_diagram

workflows:
  - requirement-extraction  # éœ€æ±‚æå–
  - use-case-analysis      # ç”¨ä¾‹åˆ†æ
  - requirement-review     # éœ€æ±‚è¯„å®¡

config:
  defaultAgent: requirement-analyst
  permissions:
    read: allow
    edit:
      "*.md": allow
      "docs/**": allow

wizard:
  steps:
    - id: project-info
      title: é¡¹ç›®ä¿¡æ¯
      fields:
        - name: projectName
          label: é¡¹ç›®åç§°
          type: text
          required: true
        - name: projectType
          label: é¡¹ç›®ç±»å‹
          type: select
          options: [Webåº”ç”¨, ç§»åŠ¨åº”ç”¨, åç«¯æœåŠ¡, SDK/åº“, å…¶ä»–]
        - name: stakeholders
          label: åˆ©ç›Šç›¸å…³è€…
          type: multiselect
          options: [äº§å“ç»ç†, å¼€å‘å›¢é˜Ÿ, QAå›¢é˜Ÿ, è¿ç»´å›¢é˜Ÿ, å®¢æˆ·]
    
    - id: requirement-source
      title: éœ€æ±‚æ¥æº
      fields:
        - name: sourceType
          label: æ¥æºç±»å‹
          type: select
          options: [ç”¨æˆ·è®¿è°ˆ, ç«å“åˆ†æ, äº§å“æ„¿æ™¯, æŠ€æœ¯è¿ç§», å…¶ä»–]
        - name: initialDocs
          label: åˆå§‹æ–‡æ¡£
          type: file
          multiple: true

examples:
  - title: ç”µå•†è®¢å•ç³»ç»Ÿ
    description: åˆ†æç”µå•†è®¢å•ç®¡ç†ç³»ç»Ÿçš„éœ€æ±‚
    input: |
      æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè®¢å•ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒç”¨æˆ·ä¸‹å•ã€æ”¯ä»˜ã€ç‰©æµè·Ÿè¸ªã€å”®åå¤„ç†ã€‚
      é¢„è®¡æ—¥è®¢å•é‡ 10 ä¸‡å•ã€‚
```

#### BUG ä¿®å¤æ¨¡æ¿

```yaml
# templates/bug-fix.template.yaml
id: bug-fix
name: BUG ä¿®å¤å·¥ä½œç«™
description: ä»é—®é¢˜å®šä½åˆ°éªŒè¯çš„å®Œæ•´ BUG ä¿®å¤æµç¨‹
icon: ğŸ›
category: development

domain: coding

agents:
  - bug-investigator       # BUG è°ƒæŸ¥å‘˜
  - root-cause-analyst     # æ ¹å› åˆ†æå¸ˆ
  - fix-implementer        # ä¿®å¤å®æ–½è€…
  - regression-tester      # å›å½’æµ‹è¯•è€…

tools:
  - read
  - write
  - edit
  - bash
  - grep
  - lsp_goto_definition
  - lsp_find_references
  - git_log
  - git_blame

workflows:
  - bug-investigation      # BUG è°ƒæŸ¥
  - root-cause-analysis    # æ ¹å› åˆ†æ
  - fix-implementation     # ä¿®å¤å®æ–½
  - regression-test        # å›å½’æµ‹è¯•

config:
  defaultAgent: bug-investigator

wizard:
  steps:
    - id: bug-info
      title: BUG ä¿¡æ¯
      fields:
        - name: bugId
          label: BUG ID
          type: text
        - name: description
          label: é—®é¢˜æè¿°
          type: textarea
          required: true
        - name: reproduction
          label: å¤ç°æ­¥éª¤
          type: textarea
        - name: expectedBehavior
          label: æœŸæœ›è¡Œä¸º
          type: textarea
        - name: actualBehavior
          label: å®é™…è¡Œä¸º
          type: textarea
        - name: environment
          label: ç¯å¢ƒä¿¡æ¯
          type: textarea
```

#### ç‰¹æ€§å¼€å‘æ¨¡æ¿

```yaml
# templates/feature-development.template.yaml
id: feature-development
name: ç‰¹æ€§å¼€å‘å·¥ä½œç«™
description: ä»éœ€æ±‚åˆ°ä¸Šçº¿çš„å®Œæ•´ç‰¹æ€§å¼€å‘æµç¨‹
icon: ğŸš€
category: development

domain: coding

agents:
  - requirement-analyst
  - tech-architect
  - build
  - code-reviewer
  - qa-engineer
  - docs-writer

workflows:
  - requirement-to-dev     # éœ€æ±‚åˆ°å¼€å‘
  - code-review           # ä»£ç å®¡æŸ¥
  - test-coverage         # æµ‹è¯•è¦†ç›–
  - documentation         # æ–‡æ¡£ç”Ÿæˆ

config:
  defaultAgent: build
```

### 9.3 åŠ¨æ€æ¨¡æ¿æåˆç³»ç»Ÿ

#### 9.3.1 è®¾è®¡åŠ¨æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é—®é¢˜ï¼šå›ºå®šæ¨¡æ¿çš„å±€é™æ€§                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ç°çŠ¶ï¼š                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚  â€¢ é¢„ç½®æ¨¡æ¿åªèƒ½è¦†ç›–å¸¸è§åœºæ™¯ï¼ˆéœ€æ±‚åˆ†æã€BUGä¿®å¤ã€ç‰¹æ€§å¼€å‘...ï¼‰               â”‚
â”‚  â€¢ ç”¨æˆ·çš„å®é™…éœ€æ±‚åƒå˜ä¸‡åŒ–ï¼Œæ°¸è¿œæ— æ³•ç©·ä¸¾æ‰€æœ‰æ¨¡æ¿                              â”‚
â”‚  â€¢ å½“ç”¨æˆ·è¾“å…¥ä¸åŒ¹é…ä»»ä½•å›ºå®šæ¨¡æ¿æ—¶ï¼Œç³»ç»Ÿæ— ä»å“åº”                              â”‚
â”‚                                                                              â”‚
â”‚  ç›®æ ‡ï¼š                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚  â€¢ æ— æ¨¡æ¿æ—¶ä¸é™çº§ä¸ºé€šç”¨å¯¹è¯ï¼Œè€Œæ˜¯"å®æ—¶æåˆ"ä¸€ä¸ªä¸“å±æ¨¡æ¿                    â”‚
â”‚  â€¢ åˆ†æç”¨æˆ· Prompt çš„æ„å›¾ã€é¢†åŸŸã€å¤æ‚åº¦ï¼Œè°ƒç”¨ AI åˆæˆæ¨¡æ¿                   â”‚
â”‚  â€¢ åˆæˆçš„æ¨¡æ¿å…·æœ‰ä¸é¢„ç½®æ¨¡æ¿ç›¸åŒçš„ç»“æ„ï¼Œå¯éªŒè¯ã€å¯ç¼“å­˜ã€å¯å¤ç”¨               â”‚
â”‚                                                                              â”‚
â”‚  æ ¸å¿ƒæ€è·¯ï¼š                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                                                              â”‚
â”‚  ç”¨æˆ· Prompt â”€â”€â†’ æ¨¡æ¿æ³¨å†Œè¡¨åŒ¹é…ï¼Ÿ                                           â”‚
â”‚                    â”‚                                                         â”‚
â”‚                YES â”‚          NO                                             â”‚
â”‚                    â–¼           â–¼                                              â”‚
â”‚              ä½¿ç”¨å›ºå®šæ¨¡æ¿    æ„å›¾åˆ†æ â†’ AI åˆæˆ â†’ éªŒè¯ â†’ ä½¿ç”¨åˆæˆæ¨¡æ¿       â”‚
â”‚                                                  â†“                           â”‚
â”‚                                            ç¼“å­˜ä¸ºåŠ¨æ€æ¨¡æ¿ï¼ˆå¯æå‡ä¸ºé¢„ç½®ï¼‰    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.3.2 æ¨¡æ¿è§£æè·¯ç”±å™¨ï¼ˆTemplate Resolution Routerï¼‰

æ¨¡æ¿è§£æè·¯ç”±å™¨æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å…¥å£â€”â€”æ¥æ”¶ç”¨æˆ·è¾“å…¥ï¼Œå†³å®šèµ°å›ºå®šæ¨¡æ¿è¿˜æ˜¯åŠ¨æ€åˆæˆï¼š

```typescript
// template/resolution-router.ts

/**
 * ä¼šè¯åˆ›å»ºè¾“å…¥ â€” æ”¯æŒä¸‰ç§æ¨¡å¼ï¼š
 *   1. æ˜¾å¼æŒ‡å®šæ¨¡æ¿ï¼štemplate + inputs
 *   2. çº¯ promptï¼šç”±ç³»ç»Ÿè‡ªåŠ¨åŒ¹é…æˆ–åˆæˆæ¨¡æ¿
 *   3. æ··åˆæ¨¡å¼ï¼štemplate + promptï¼ˆæ¨¡æ¿ä¸ºåŸºç¡€ï¼Œprompt æä¾›é¢å¤–ä¸Šä¸‹æ–‡ï¼‰
 */
export interface SessionCreateInput {
  /** æ¨¡æ¿ IDï¼ˆå¯é€‰ï¼Œç¼ºçœæ—¶ç”± prompt é©±åŠ¨è‡ªåŠ¨è§£æï¼‰ */
  template?: string
  /** ç”¨æˆ·è‡ªç„¶è¯­è¨€æè¿°ï¼ˆå½“æ—  template æ—¶ä¸ºå¿…å¡«ï¼‰ */
  prompt?: string
  /** æ¨¡æ¿å‘å¯¼çš„è¾“å…¥å‚æ•° */
  inputs?: Record<string, unknown>
}

export interface TemplateResolutionResult {
  /** è§£æç­–ç•¥ */
  strategy: 'static' | 'cached_dynamic' | 'synthesized'
  /** æœ€ç»ˆä½¿ç”¨çš„æ¨¡æ¿ */
  template: ScenarioTemplate
  /** åŒ¹é…ç½®ä¿¡åº¦ (0-1) */
  confidence: number
  /** è§£æè€—æ—¶ */
  resolveTimeMs: number
}

export class TemplateResolutionRouter {
  constructor(
    private templateRegistry: TemplateRegistry,
    private dynamicCache: DynamicTemplateCache,
    private intentAnalyzer: IntentAnalyzer,
    private templateSynthesizer: TemplateSynthesizer,
  ) {}

  /**
   * æ ¸å¿ƒè·¯ç”±é€»è¾‘ï¼šæœ‰å›ºå®šç”¨å›ºå®šï¼Œæ— å›ºå®šåˆ™æåˆ
   */
  async resolve(input: SessionCreateInput): Promise<TemplateResolutionResult> {
    const start = Date.now()

    // â”€â”€ è·¯å¾„ 1ï¼šç”¨æˆ·æ˜¾å¼æŒ‡å®šæ¨¡æ¿ â”€â”€
    if (input.template) {
      const staticTemplate = await this.templateRegistry.get(input.template)
      if (staticTemplate) {
        return {
          strategy: 'static',
          template: staticTemplate,
          confidence: 1.0,
          resolveTimeMs: Date.now() - start,
        }
      }
      // æŒ‡å®šçš„æ¨¡æ¿ä¸å­˜åœ¨ï¼Œé™çº§åˆ°è‡ªåŠ¨è§£æ
    }

    // â”€â”€ è·¯å¾„ 2ï¼šä» prompt è‡ªåŠ¨åŒ¹é…å›ºå®šæ¨¡æ¿ â”€â”€
    const prompt = input.prompt ?? input.inputs?.description ?? ''
    if (prompt) {
      const matched = await this.matchStaticTemplate(prompt)
      if (matched && matched.confidence >= 0.85) {
        return {
          strategy: 'static',
          template: matched.template,
          confidence: matched.confidence,
          resolveTimeMs: Date.now() - start,
        }
      }
    }

    // â”€â”€ è·¯å¾„ 3ï¼šæ£€æŸ¥åŠ¨æ€æ¨¡æ¿ç¼“å­˜ï¼ˆè¯­ä¹‰ç›¸ä¼¼çš„ prompt ä¹‹å‰åˆæˆè¿‡ï¼‰ â”€â”€
    const cached = await this.dynamicCache.findSimilar(prompt)
    if (cached && cached.similarity >= 0.90) {
      return {
        strategy: 'cached_dynamic',
        template: cached.template,
        confidence: cached.similarity,
        resolveTimeMs: Date.now() - start,
      }
    }

    // â”€â”€ è·¯å¾„ 4ï¼šAI å®æ—¶åˆæˆ â”€â”€
    const intent = await this.intentAnalyzer.analyze(prompt, input)
    const synthesized = await this.templateSynthesizer.synthesize(intent)

    // ç¼“å­˜åˆæˆç»“æœ
    await this.dynamicCache.store(prompt, synthesized, intent)

    return {
      strategy: 'synthesized',
      template: synthesized,
      confidence: intent.confidence,
      resolveTimeMs: Date.now() - start,
    }
  }

  /**
   * è¯­ä¹‰åŒ¹é…å›ºå®šæ¨¡æ¿
   * ç”¨ embedding ç›¸ä¼¼åº¦ + å…³é”®è¯è§„åˆ™åŒé‡åˆ¤æ–­
   */
  private async matchStaticTemplate(
    prompt: string,
  ): Promise<{ template: ScenarioTemplate; confidence: number } | null> {
    const allTemplates = await this.templateRegistry.list()

    // 1. å…³é”®è¯è§„åˆ™å¿«é€ŸåŒ¹é…
    for (const tpl of allTemplates) {
      const keywordScore = this.keywordMatch(prompt, tpl)
      if (keywordScore >= 0.95) {
        return { template: tpl, confidence: keywordScore }
      }
    }

    // 2. Embedding è¯­ä¹‰åŒ¹é…
    const promptEmbedding = await this.embed(prompt)
    let best: { template: ScenarioTemplate; confidence: number } | null = null

    for (const tpl of allTemplates) {
      const tplEmbedding = await this.getOrComputeEmbedding(tpl)
      const similarity = cosineSimilarity(promptEmbedding, tplEmbedding)
      if (!best || similarity > best.confidence) {
        best = { template: tpl, confidence: similarity }
      }
    }

    return best
  }

  private keywordMatch(prompt: string, tpl: ScenarioTemplate): number {
    const rules: Record<string, string[]> = {
      'requirement-analysis': ['éœ€æ±‚åˆ†æ', 'éœ€æ±‚æ–‡æ¡£', 'PRD', 'äº§å“éœ€æ±‚'],
      'bug-fix': ['bug', 'BUG', 'ç¼ºé™·', 'ä¿®å¤', 'ç™½å±', 'æŠ¥é”™', 'å´©æºƒ'],
      'feature-development': ['æ–°åŠŸèƒ½', 'ç‰¹æ€§å¼€å‘', 'å®ç°åŠŸèƒ½', 'å¼€å‘éœ€æ±‚'],
      'code-review': ['ä»£ç å®¡æŸ¥', 'code review', 'CR', 'å®¡æŸ¥ä»£ç '],
    }

    const keywords = rules[tpl.id] ?? tpl.tags ?? []
    const lower = prompt.toLowerCase()
    const hits = keywords.filter(kw => lower.includes(kw.toLowerCase()))
    return keywords.length > 0 ? hits.length / keywords.length : 0
  }
}
```

#### 9.3.3 æ„å›¾åˆ†æå™¨ï¼ˆIntent Analyzerï¼‰

> **äº¤å‰å¼•ç”¨ï¼š** ä¸ 6.5.3 DomainAnalyzer å…±äº«æ„å›¾åˆ†æèƒ½åŠ›ã€‚æœ¬ç»„ä»¶ä¸“æ³¨äº **æ— åŒ¹é…æ¨¡æ¿æ—¶çš„å³å¸­åˆæˆ**ï¼Œè€Œ DomainAnalyzer æœåŠ¡äºè¿è¡Œæ—¶è§„åˆ’ã€‚

æ„å›¾åˆ†æå™¨æ˜¯"æåˆ"çš„æ ¸å¿ƒç¬¬ä¸€æ­¥â€”â€”ç†è§£ç”¨æˆ·åˆ°åº•æƒ³åšä»€ä¹ˆï¼š

```typescript
// template/intent-analyzer.ts

/**
 * ä»ç”¨æˆ· Prompt ä¸­æå–çš„ç»“æ„åŒ–æ„å›¾
 */
export interface AnalyzedIntent {
  /** æ„å›¾æ‘˜è¦ï¼ˆä¸€å¥è¯ï¼‰ */
  summary: string

  /** ä»»åŠ¡é¢†åŸŸ */
  domain: string

  /** ä»»åŠ¡ç±»åˆ« */
  category: TemplateCategory

  /** ç»†åˆ†å­ç±» */
  subcategory: string

  /** æ‰€éœ€èƒ½åŠ›æ ‡ç­¾ */
  requiredCapabilities: string[]

  /** æ‰€éœ€å·¥å…·ç±»å‹ */
  requiredToolTypes: ToolType[]

  /** é¢„ä¼°å¤æ‚åº¦ */
  complexity: 'simple' | 'moderate' | 'complex' | 'expert'

  /** æ˜¯å¦éœ€è¦å¤š Agent åä½œ */
  multiAgent: boolean

  /** é¢„ä¼° Agent è§’è‰²åˆ—è¡¨ */
  suggestedRoles: RoleSuggestion[]

  /** æ˜¯å¦éœ€è¦å¤–éƒ¨æ•°æ®æº */
  needsExternalData: boolean

  /** æ˜¯å¦éœ€è¦äººå·¥å®¡æ ¸èŠ‚ç‚¹ */
  needsHumanReview: boolean

  /** åˆ†æç½®ä¿¡åº¦ */
  confidence: number

  /** åŸå§‹æç¤ºè¯ */
  originalPrompt: string

  /** æå–çš„å…³é”®å®ä½“ */
  entities: ExtractedEntity[]
}

export interface RoleSuggestion {
  role: string
  responsibility: string
  tools: string[]
  priority: 'required' | 'optional'
}

export interface ExtractedEntity {
  type: 'technology' | 'framework' | 'language' | 'tool' | 'concept' | 'constraint'
  value: string
  context: string
}

/**
 * æ„å›¾åˆ†æå™¨å®ç°
 */
export class IntentAnalyzer {
  constructor(
    private model: AIModel,
    private agentRegistry: AgentRegistry,
    private toolRegistry: ToolRegistry,
  ) {}

  async analyze(
    prompt: string,
    input: SessionCreateInput,
  ): Promise<AnalyzedIntent> {
    // â”€â”€ ç¬¬ä¸€æ­¥ï¼šè°ƒç”¨ AI è¿›è¡Œæ„å›¾æŠ½å– â”€â”€
    const rawIntent = await this.extractIntent(prompt)

    // â”€â”€ ç¬¬äºŒæ­¥ï¼šç”¨æ³¨å†Œè¡¨æ ¡éªŒå’Œä¸°å¯Œ â”€â”€
    const enriched = await this.enrichWithRegistry(rawIntent)

    // â”€â”€ ç¬¬ä¸‰æ­¥ï¼šå¤æ‚åº¦è¯„ä¼° â”€â”€
    const complexity = this.assessComplexity(enriched)

    // â”€â”€ ç¬¬å››æ­¥ï¼šè§’è‰²æ¨è â”€â”€
    const roles = await this.suggestRoles(enriched)

    return {
      ...enriched,
      complexity,
      suggestedRoles: roles,
      originalPrompt: prompt,
    }
  }

  /**
   * è°ƒç”¨ AI æ¨¡å‹è¿›è¡Œæ„å›¾æŠ½å–
   */
  private async extractIntent(prompt: string): Promise<Partial<AnalyzedIntent>> {
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ª Agent å¹³å°çš„æ„å›¾åˆ†æå™¨ã€‚
ä½ çš„ä»»åŠ¡æ˜¯ä»ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æè¿°ä¸­ï¼Œæå–ç»“æ„åŒ–çš„ä»»åŠ¡æ„å›¾ä¿¡æ¯ã€‚

è¯·åˆ†æä»¥ä¸‹ç”¨æˆ·éœ€æ±‚ï¼Œè¾“å‡º JSON æ ¼å¼çš„æ„å›¾ç»“æ„ï¼š

éœ€è¦åˆ¤æ–­çš„ç»´åº¦ï¼š
1. domain: ä»»åŠ¡æ‰€å±é¢†åŸŸï¼ˆcoding / analysis / documentation / testing / operations / management / research / designï¼‰
2. category: æ¨¡æ¿åˆ†ç±»ï¼ˆdevelopment / documentation / analysis / testing / operations / management / customï¼‰
3. subcategory: æ›´ç»†ç²’åº¦çš„åˆ†ç±»
4. requiredCapabilities: å®Œæˆæ­¤ä»»åŠ¡éœ€è¦çš„èƒ½åŠ›åˆ—è¡¨
5. requiredToolTypes: éœ€è¦çš„å·¥å…·ç±»å‹ï¼ˆfile_ops / code_ops / shell / network / search / browser / dataï¼‰
6. multiAgent: æ˜¯å¦éœ€è¦å¤šä¸ª Agent åä½œ
7. needsExternalData: æ˜¯å¦éœ€è¦å¤–éƒ¨æ•°æ®æº
8. needsHumanReview: æ˜¯å¦æ¶‰åŠå…³é”®å†³ç­–éœ€äººå·¥ç¡®è®¤
9. entities: ä»æ–‡æœ¬ä¸­æå–çš„å…³é”®å®ä½“ï¼ˆæŠ€æœ¯æ ˆã€æ¡†æ¶ã€çº¦æŸæ¡ä»¶ç­‰ï¼‰
10. summary: ä¸€å¥è¯æ€»ç»“ç”¨æˆ·æ„å›¾

è¯·ä¸¥æ ¼è¾“å‡º JSONï¼Œä¸è¦åŒ…å«å…¶ä»–å†…å®¹ã€‚`

    const response = await this.model.complete({
      system: systemPrompt,
      messages: [{ role: 'user', content: prompt }],
      responseFormat: { type: 'json_object' },
      temperature: 0.2, // ä½æ¸©åº¦ä¿è¯ç»“æ„åŒ–è¾“å‡ºçš„ç¨³å®šæ€§
    })

    return JSON.parse(response.content)
  }

  /**
   * ç”¨æ³¨å†Œè¡¨æ ¡éªŒï¼šç¡®ä¿æ¨èçš„å·¥å…·å’Œèƒ½åŠ›çœŸå®å­˜åœ¨
   */
  private async enrichWithRegistry(
    raw: Partial<AnalyzedIntent>,
  ): Promise<Partial<AnalyzedIntent>> {
    // æ ¡éªŒå·¥å…·æ˜¯å¦æ³¨å†Œ
    const availableTools = await this.toolRegistry.list()
    const toolNames = new Set(availableTools.map(t => t.name))

    // è¿‡æ»¤å‡ºå®é™…å¯ç”¨çš„å·¥å…·ç±»å‹
    const validToolTypes = (raw.requiredToolTypes ?? []).filter(tt => {
      const toolsOfType = availableTools.filter(t => t.category === tt)
      return toolsOfType.length > 0
    })

    // æ ¡éªŒ Agent èƒ½åŠ›
    const availableAgents = await this.agentRegistry.list()
    const agentCapabilities = new Set(
      availableAgents.flatMap(a => a.capabilities ?? []),
    )

    return {
      ...raw,
      requiredToolTypes: validToolTypes,
      requiredCapabilities: (raw.requiredCapabilities ?? []).map(cap =>
        agentCapabilities.has(cap) ? cap : `${cap} [éœ€æ³¨å†Œ]`,
      ),
    }
  }

  /**
   * å¤æ‚åº¦è¯„ä¼°ï¼šåŸºäºå¤šç»´åº¦æ‰“åˆ†
   */
  private assessComplexity(intent: Partial<AnalyzedIntent>): AnalyzedIntent['complexity'] {
    let score = 0

    // å·¥å…·å¤šæ ·æ€§
    score += (intent.requiredToolTypes?.length ?? 0) * 1.5
    // èƒ½åŠ›éœ€æ±‚
    score += (intent.requiredCapabilities?.length ?? 0) * 1
    // å¤š Agent
    if (intent.multiAgent) score += 3
    // å¤–éƒ¨æ•°æ®
    if (intent.needsExternalData) score += 2
    // äººå·¥å®¡æ ¸
    if (intent.needsHumanReview) score += 1.5
    // å®ä½“ä¸°å¯Œåº¦
    score += (intent.entities?.length ?? 0) * 0.5

    if (score <= 4) return 'simple'
    if (score <= 8) return 'moderate'
    if (score <= 14) return 'complex'
    return 'expert'
  }

  /**
   * æ ¹æ®æ„å›¾æ¨è Agent è§’è‰²åˆ—è¡¨
   */
  private async suggestRoles(
    intent: Partial<AnalyzedIntent>,
  ): Promise<RoleSuggestion[]> {
    // å…ˆæŸ¥å·²æ³¨å†Œçš„ Agent æ˜¯å¦æ»¡è¶³
    const available = await this.agentRegistry.list()
    const roles: RoleSuggestion[] = []

    // ç®€å•ä»»åŠ¡ï¼šå• Agent å³å¯
    if (!intent.multiAgent) {
      const best = this.findBestAgent(available, intent)
      roles.push({
        role: best?.name ?? 'generalist',
        responsibility: intent.summary ?? 'å¤„ç†ç”¨æˆ·è¯·æ±‚',
        tools: (intent.requiredToolTypes ?? []) as string[],
        priority: 'required',
      })
      return roles
    }

    // å¤æ‚ä»»åŠ¡ï¼šè°ƒç”¨ AI æ¨èè§’è‰²åˆ†å·¥
    const roleSuggestion = await this.model.complete({
      system: `æ ¹æ®ä»¥ä¸‹ä»»åŠ¡æ„å›¾ï¼Œæ¨èéœ€è¦çš„ Agent è§’è‰²åˆ†å·¥ã€‚
è¾“å‡º JSON æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å« role, responsibility, tools, priorityã€‚
å·²æ³¨å†Œçš„ Agent åˆ—è¡¨: ${available.map(a => a.name).join(', ')}`,
      messages: [{ role: 'user', content: JSON.stringify(intent) }],
      responseFormat: { type: 'json_object' },
      temperature: 0.3,
    })

    return JSON.parse(roleSuggestion.content)
  }
}
```

#### 9.3.4 æ¨¡æ¿åˆæˆå™¨ï¼ˆTemplate Synthesizerï¼‰

> **äº¤å‰å¼•ç”¨ï¼š** å•ä¸ª Agent çš„åˆ›å»ºåº”å§”æ´¾ç»™ 6.5.5 ActorFactoryï¼Œæœ¬ç»„ä»¶ä¸“æ³¨äºå¤š Agent åœºæ™¯æ¨¡æ¿çš„ç»„åˆç¼–æ’ã€‚**å®ç°æ—¶ `selectAgents / validate` åº”ç›´æ¥å¤ç”¨ 6.5.9 AgentComposer çš„é€»è¾‘**ï¼Œé¿å…é‡å¤å®ç° Agent é€‰æ‹©ä¸æ ¡éªŒã€‚

æ¨¡æ¿åˆæˆå™¨å°†æ„å›¾åˆ†æçš„ç»“æœ"ç»„è£…"æˆä¸€ä¸ªå®Œæ•´çš„ `ScenarioTemplate`ï¼š

```typescript
// template/template-synthesizer.ts

/**
 * æ¨¡æ¿åˆæˆå™¨
 * æ ¹æ®æ„å›¾åˆ†æç»“æœï¼Œè°ƒç”¨ AI åˆæˆå®Œæ•´çš„åœºæ™¯æ¨¡æ¿
 */
export class TemplateSynthesizer {
  constructor(
    private model: AIModel,
    private agentRegistry: AgentRegistry,
    private toolRegistry: ToolRegistry,
    private workflowRegistry: WorkflowRegistry,
    private validator: TemplateValidator,
  ) {}

  /**
   * æ ¸å¿ƒåˆæˆæ–¹æ³•
   */
  async synthesize(intent: AnalyzedIntent): Promise<ScenarioTemplate> {
    // â”€â”€ Phase 1ï¼šé€‰æ‹© Agent â”€â”€
    const agents = await this.selectAgents(intent)

    // â”€â”€ Phase 2ï¼šé€‰æ‹©å·¥å…· â”€â”€
    const tools = await this.selectTools(intent, agents)

    // â”€â”€ Phase 3ï¼šåˆæˆå·¥ä½œæµ â”€â”€
    const workflows = await this.synthesizeWorkflows(intent, agents, tools)

    // â”€â”€ Phase 4ï¼šç”Ÿæˆç³»ç»Ÿæç¤ºè¯ â”€â”€
    const config = await this.synthesizeConfig(intent)

    // â”€â”€ Phase 5ï¼šç»„è£…æ¨¡æ¿ â”€â”€
    const template: ScenarioTemplate = {
      id: `dynamic-${generateShortId()}`,
      name: intent.summary,
      description: `AI åˆæˆæ¨¡æ¿ï¼š${intent.summary}`,
      icon: this.pickIcon(intent.category),
      category: intent.category,
      tags: [
        intent.domain,
        intent.subcategory,
        ...intent.entities.map(e => e.value),
        '_synthesized', // æ ‡è®°ä¸ºåˆæˆæ¨¡æ¿
      ],
      domain: intent.domain,
      agents: agents.map(a => a.id),
      tools: tools.map(t => t.name),
      workflows: workflows.map(w => w.id),
      config,
      wizard: await this.generateWizard(intent),
      _synthesis: {
        intentHash: hashIntent(intent),
        synthesizedAt: new Date().toISOString(),
        confidence: intent.confidence,
        complexity: intent.complexity,
      },
    }

    // â”€â”€ Phase 6ï¼šéªŒè¯ â”€â”€
    const validation = await this.validator.validate(template)
    if (!validation.valid) {
      // è‡ªåŠ¨ä¿®å¤å¸¸è§é—®é¢˜
      return this.autoFix(template, validation)
    }

    return template
  }

  /**
   * é€‰æ‹© Agentï¼šä¼˜å…ˆåŒ¹é…å·²æ³¨å†Œçš„ï¼Œç¼ºå¤±çš„åˆ™åŠ¨æ€åˆ›å»º
   */
  private async selectAgents(
    intent: AnalyzedIntent,
  ): Promise<AgentDefinition[]> {
    const selected: AgentDefinition[] = []

    for (const role of intent.suggestedRoles) {
      // 1. å°è¯•ä»æ³¨å†Œè¡¨åŒ¹é…
      const existing = await this.agentRegistry.findByCapability(
        role.responsibility,
      )

      if (existing) {
        selected.push(existing)
        continue
      }

      // 2. æ— åŒ¹é… â†’ è°ƒç”¨ AgentComposer åŠ¨æ€åˆ›å»º
      const composer = new AgentComposerImpl()
      const dynamicAgent = await composer.createCustomAgent({
        name: role.role,
        description: role.responsibility,
        persona: {
          role: role.role,
          expertise: role.tools,
        },
        tools: role.tools,
        advanced: {
          orchestrationPattern: intent.complexity === 'simple' ? 'cot' : 'react',
        },
      })

      selected.push(dynamicAgent)
    }

    return selected
  }

  /**
   * é€‰æ‹©å·¥å…·ï¼šæ ¹æ®æ„å›¾æ‰€éœ€çš„å·¥å…·ç±»å‹ï¼Œä»æ³¨å†Œè¡¨ä¸­æŒ‘é€‰
   */
  private async selectTools(
    intent: AnalyzedIntent,
    agents: AgentDefinition[],
  ): Promise<ToolDefinition[]> {
    const toolSet = new Map<string, ToolDefinition>()

    // ä» Agent å·²ç»‘å®šçš„å·¥å…·æ”¶é›†
    for (const agent of agents) {
      for (const toolName of agent.tools) {
        const tool = await this.toolRegistry.get(toolName)
        if (tool) toolSet.set(tool.name, tool)
      }
    }

    // è¡¥å……æ„å›¾æ‰€éœ€ä½† Agent æœªè¦†ç›–çš„å·¥å…·
    for (const toolType of intent.requiredToolTypes) {
      const toolsOfType = await this.toolRegistry.findByCategory(toolType)
      for (const tool of toolsOfType) {
        if (!toolSet.has(tool.name)) {
          toolSet.set(tool.name, tool)
        }
      }
    }

    return Array.from(toolSet.values())
  }

  /**
   * åˆæˆå·¥ä½œæµï¼šè°ƒç”¨ AI ç”Ÿæˆæ­¥éª¤ç¼–æ’
   */
  private async synthesizeWorkflows(
    intent: AnalyzedIntent,
    agents: AgentDefinition[],
    tools: ToolDefinition[],
  ): Promise<WorkflowDefinition[]> {
    // ç®€å•ä»»åŠ¡ï¼šä¸éœ€è¦æ˜¾å¼å·¥ä½œæµ
    if (intent.complexity === 'simple') {
      return []
    }

    const response = await this.model.complete({
      system: `ä½ æ˜¯ä¸€ä¸ªå·¥ä½œæµç¼–æ’ä¸“å®¶ã€‚æ ¹æ®ç”¨æˆ·æ„å›¾å’Œå¯ç”¨çš„ Agent/Toolï¼Œ
è®¾è®¡ä¸€ä¸ªåˆç†çš„å·¥ä½œæµã€‚

å¯ç”¨ Agent: ${agents.map(a => `${a.name}(${a.description})`).join(', ')}
å¯ç”¨ Tools: ${tools.map(t => `${t.name}(${t.description})`).join(', ')}

è¾“å‡ºä¸€ä¸ª JSON å·¥ä½œæµå®šä¹‰ï¼ŒåŒ…å« steps æ•°ç»„ï¼Œæ¯ä¸ª step åŒ…å«:
- id: æ­¥éª¤ID
- type: "agent" | "tool" | "condition" | "parallel" | "human_review"
- agent/tool: ä½¿ç”¨çš„ Agent æˆ– Tool åç§°
- input: è¾“å…¥æ¨¡æ¿ï¼ˆå¯å¼•ç”¨å‰åºæ­¥éª¤çš„è¾“å‡º {{ steps.xxx.output }}ï¼‰
- description: æ­¥éª¤è¯´æ˜

æ³¨æ„ï¼š
1. æ­¥éª¤ä¹‹é—´è¦æœ‰åˆç†çš„ä¾èµ–å…³ç³»
2. å¯ä»¥å¹¶è¡Œçš„æ­¥éª¤ç”¨ parallel åŒ…è£…
3. å…³é”®å†³ç­–ç‚¹åŠ  human_review
4. ä¿æŒæ­¥éª¤æœ€å°åŒ–ï¼Œä¸è¦è¿‡åº¦è®¾è®¡`,
      messages: [
        {
          role: 'user',
          content: JSON.stringify({
            summary: intent.summary,
            domain: intent.domain,
            complexity: intent.complexity,
            capabilities: intent.requiredCapabilities,
          }),
        },
      ],
      responseFormat: { type: 'json_object' },
      temperature: 0.4,
    })

    const workflowSpec = JSON.parse(response.content)

    return [
      {
        id: `wf-${intent.domain}-${generateShortId()}`,
        name: `${intent.summary} å·¥ä½œæµ`,
        steps: workflowSpec.steps,
        metadata: { synthesized: true },
      },
    ]
  }

  /**
   * åˆæˆé…ç½®ï¼šæ ¹æ®æ„å›¾ç”Ÿæˆåˆé€‚çš„é»˜è®¤é…ç½®
   */
  private async synthesizeConfig(
    intent: AnalyzedIntent,
  ): Promise<Partial<Config>> {
    const config: Partial<Config> = {}

    // æ ¹æ®å¤æ‚åº¦é€‰æ‹©é»˜è®¤ Agent
    if (intent.suggestedRoles.length > 0) {
      const primary = intent.suggestedRoles.find(r => r.priority === 'required')
      config.defaultAgent = primary?.role ?? intent.suggestedRoles[0].role
    }

    // æ ¹æ®é¢†åŸŸè®¾ç½®æƒé™
    config.permissions = this.inferPermissions(intent)

    return config
  }

  /**
   * æƒé™æ¨æ–­ï¼šæ ¹æ®å·¥å…·ç±»å‹å’Œé¢†åŸŸæ¨æ–­æœ€å°æƒé™
   */
  private inferPermissions(intent: AnalyzedIntent): PermissionSet {
    const perms: PermissionSet = { read: 'allow' }

    if (intent.requiredToolTypes.includes('file_ops')) {
      perms.edit = { '*.md': 'allow', 'docs/**': 'allow' }
    }
    if (intent.requiredToolTypes.includes('code_ops')) {
      perms.edit = { ...perms.edit, 'src/**': 'allow' }
    }
    if (intent.requiredToolTypes.includes('shell')) {
      perms.shell = 'ask' // å‘½ä»¤æ‰§è¡Œéœ€ç¡®è®¤
    }
    if (intent.requiredToolTypes.includes('network')) {
      perms.network = 'ask'
    }

    return perms
  }

  /**
   * ç”Ÿæˆå‘å¯¼ï¼šä¸ºåˆæˆæ¨¡æ¿åˆ›å»ºç®€åŒ–çš„è¾“å…¥å‘å¯¼
   */
  private async generateWizard(
    intent: AnalyzedIntent,
  ): Promise<TemplateWizard | undefined> {
    // ç®€å•ä»»åŠ¡ä¸éœ€è¦å‘å¯¼
    if (intent.complexity === 'simple') return undefined

    const fields: WizardField[] = []

    // æ ¹æ®å®ä½“ç±»å‹ç”Ÿæˆå­—æ®µ
    for (const entity of intent.entities) {
      if (entity.type === 'technology' || entity.type === 'framework') {
        fields.push({
          name: `tech_${entity.value}`,
          label: `${entity.value} ç‰ˆæœ¬æˆ–é…ç½®`,
          type: 'text',
          required: false,
          defaultValue: entity.value,
        })
      }
      if (entity.type === 'constraint') {
        fields.push({
          name: `constraint_${fields.length}`,
          label: entity.value,
          type: 'textarea',
          required: false,
        })
      }
    }

    if (fields.length === 0) return undefined

    return {
      steps: [
        {
          id: 'additional-info',
          title: 'è¡¥å……ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰',
          fields,
        },
      ],
    }
  }

  private pickIcon(category: TemplateCategory): string {
    const icons: Record<TemplateCategory, string> = {
      development: 'ğŸ’»',
      documentation: 'ğŸ“',
      analysis: 'ğŸ“Š',
      testing: 'ğŸ§ª',
      operations: 'âš™ï¸',
      management: 'ğŸ“‹',
      custom: 'ğŸ”§',
    }
    return icons[category] ?? 'ğŸ¤–'
  }
}
```

#### 9.3.5 åˆæˆæ¨¡æ¿éªŒè¯ä¸æ²™ç›’è¯•è·‘

åˆæˆæ¨¡æ¿å¿…é¡»ç»è¿‡éªŒè¯æ‰èƒ½æŠ•å…¥ä½¿ç”¨ï¼Œé˜²æ­¢ AI å¹»è§‰å¯¼è‡´æ— æ•ˆæ¨¡æ¿ï¼š

```typescript
// template/template-validator.ts

export interface ValidationResult {
  valid: boolean
  errors: ValidationError[]
  warnings: ValidationWarning[]
}

export class TemplateValidator {
  constructor(
    private agentRegistry: AgentRegistry,
    private toolRegistry: ToolRegistry,
  ) {}

  async validate(template: ScenarioTemplate): Promise<ValidationResult> {
    const errors: ValidationError[] = []
    const warnings: ValidationWarning[] = []

    // 1. ç»“æ„å®Œæ•´æ€§
    if (!template.id || !template.name || !template.domain) {
      errors.push({ code: 'MISSING_REQUIRED', field: 'id|name|domain' })
    }

    // 2. Agent å­˜åœ¨æ€§
    for (const agentId of template.agents) {
      const exists = await this.agentRegistry.has(agentId)
      if (!exists) {
        // åŠ¨æ€ Agent æ ‡è®°ä¸º warning è€Œé error
        if (agentId.startsWith('dynamic-')) {
          warnings.push({
            code: 'DYNAMIC_AGENT',
            message: `Agent "${agentId}" ä¸ºåŠ¨æ€åˆ›å»ºï¼Œé¦–æ¬¡è¿è¡Œæ—¶å°†è‡ªåŠ¨æ³¨å†Œ`,
          })
        } else {
          errors.push({ code: 'AGENT_NOT_FOUND', field: agentId })
        }
      }
    }

    // 3. Tool å­˜åœ¨æ€§
    for (const toolName of template.tools) {
      const exists = await this.toolRegistry.has(toolName)
      if (!exists) {
        errors.push({ code: 'TOOL_NOT_FOUND', field: toolName })
      }
    }

    // 4. å·¥ä½œæµæ­¥éª¤å¼•ç”¨æ ¡éªŒ
    for (const wfId of template.workflows) {
      // æ ¡éªŒå·¥ä½œæµæ­¥éª¤ä¸­å¼•ç”¨çš„ Agent/Tool æ˜¯å¦åœ¨æ¨¡æ¿çš„ agents/tools åˆ—è¡¨ä¸­
      // ...
    }

    // 5. æƒé™åˆç†æ€§
    if (template.config?.permissions) {
      const hasShell = template.tools.some(t => ['bash', 'shell', 'exec'].includes(t))
      if (hasShell && template.config.permissions.shell === 'allow') {
        warnings.push({
          code: 'SHELL_AUTO_ALLOW',
          message: 'åˆæˆæ¨¡æ¿åŒ…å«å‘½ä»¤æ‰§è¡Œå·¥å…·ä¸”æƒé™ä¸ºè‡ªåŠ¨å…è®¸ï¼Œå»ºè®®è®¾ä¸º ask',
        })
      }
    }

    return { valid: errors.length === 0, errors, warnings }
  }
}

/**
 * æ²™ç›’è¯•è·‘ï¼šåœ¨çœŸæ­£åˆ›å»ºä¼šè¯å‰ï¼Œå¿«é€ŸéªŒè¯æ¨¡æ¿æ˜¯å¦å¯æ‰§è¡Œ
 */
export class TemplateSandboxRunner {
  /**
   * ç”¨ä¸€ä¸ªç®€åŒ–çš„"å¹²è·‘"éªŒè¯æ¨¡æ¿çš„å¯æ‰§è¡Œæ€§
   */
  async dryRun(template: ScenarioTemplate): Promise<DryRunResult> {
    const issues: string[] = []

    // 1. å°è¯•å®ä¾‹åŒ–æ‰€æœ‰ Agent
    for (const agentId of template.agents) {
      try {
        await this.instantiateAgent(agentId, { dryRun: true })
      } catch (e) {
        issues.push(`Agent "${agentId}" å®ä¾‹åŒ–å¤±è´¥: ${e.message}`)
      }
    }

    // 2. å°è¯•åˆå§‹åŒ–æ‰€æœ‰ Tool
    for (const toolName of template.tools) {
      try {
        await this.initializeTool(toolName, { dryRun: true })
      } catch (e) {
        issues.push(`Tool "${toolName}" åˆå§‹åŒ–å¤±è´¥: ${e.message}`)
      }
    }

    // 3. éªŒè¯å·¥ä½œæµæ­¥éª¤çš„ DAG åˆæ³•æ€§
    for (const wfId of template.workflows) {
      const dagIssues = await this.validateWorkflowDAG(wfId)
      issues.push(...dagIssues)
    }

    return {
      executable: issues.length === 0,
      issues,
    }
  }
}
```

#### 9.3.6 æ¨¡æ¿ç¼“å­˜ä¸å­¦ä¹ 

åˆæˆæ¨¡æ¿åº”è¯¥èƒ½è¢«ç¼“å­˜ã€å¤ç”¨ï¼Œç”šè‡³é€šè¿‡ç”¨æˆ·åé¦ˆé€æ­¥æå‡ä¸ºé¢„ç½®æ¨¡æ¿ï¼š

```typescript
// template/dynamic-cache.ts

export interface CachedDynamicTemplate {
  /** åŸå§‹ prompt çš„ embedding */
  promptEmbedding: number[]
  /** åˆæˆçš„æ¨¡æ¿ */
  template: ScenarioTemplate
  /** åŸå§‹æ„å›¾ */
  intent: AnalyzedIntent
  /** ä½¿ç”¨ç»Ÿè®¡ */
  stats: {
    useCount: number
    lastUsedAt: string
    avgSatisfaction: number  // ç”¨æˆ·æ»¡æ„åº¦ 0-5
    successRate: number      // ä»»åŠ¡æˆåŠŸç‡
  }
  /** åˆ›å»ºæ—¶é—´ */
  createdAt: string
}

export class DynamicTemplateCache {
  constructor(private storage: Storage) {}

  /**
   * æŸ¥æ‰¾è¯­ä¹‰ç›¸ä¼¼çš„å·²ç¼“å­˜æ¨¡æ¿
   */
  async findSimilar(
    prompt: string,
    threshold: number = 0.90,
  ): Promise<{ template: ScenarioTemplate; similarity: number } | null> {
    const embedding = await this.embed(prompt)
    const cached = await this.storage.dynamicTemplates.list()

    let best: { template: ScenarioTemplate; similarity: number } | null = null

    for (const entry of cached) {
      const similarity = cosineSimilarity(embedding, entry.promptEmbedding)
      if (similarity >= threshold && (!best || similarity > best.similarity)) {
        best = { template: entry.template, similarity }
      }
    }

    return best
  }

  /**
   * å­˜å‚¨æ–°çš„åˆæˆæ¨¡æ¿
   */
  async store(
    prompt: string,
    template: ScenarioTemplate,
    intent: AnalyzedIntent,
  ): Promise<void> {
    const embedding = await this.embed(prompt)

    await this.storage.dynamicTemplates.insert({
      promptEmbedding: embedding,
      template,
      intent,
      stats: {
        useCount: 1,
        lastUsedAt: new Date().toISOString(),
        avgSatisfaction: 0,
        successRate: 0,
      },
      createdAt: new Date().toISOString(),
    })
  }

  /**
   * æ›´æ–°ä½¿ç”¨ç»Ÿè®¡
   */
  async recordUsage(
    templateId: string,
    satisfaction: number,
    success: boolean,
  ): Promise<void> {
    const entry = await this.storage.dynamicTemplates.get(templateId)
    if (!entry) return

    const newCount = entry.stats.useCount + 1
    entry.stats.useCount = newCount
    entry.stats.lastUsedAt = new Date().toISOString()
    entry.stats.avgSatisfaction =
      (entry.stats.avgSatisfaction * (newCount - 1) + satisfaction) / newCount
    entry.stats.successRate =
      (entry.stats.successRate * (newCount - 1) + (success ? 1 : 0)) / newCount

    await this.storage.dynamicTemplates.update(templateId, entry)

    // è‡ªåŠ¨æå‡ä¸ºé¢„ç½®æ¨¡æ¿çš„æ¡ä»¶
    await this.checkPromotion(entry)
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æ»¡è¶³æå‡ä¸ºé¢„ç½®æ¨¡æ¿çš„æ¡ä»¶
   */
  private async checkPromotion(entry: CachedDynamicTemplate): Promise<void> {
    const PROMOTION_CRITERIA = {
      minUseCount: 10,         // è‡³å°‘ä½¿ç”¨ 10 æ¬¡
      minSatisfaction: 4.0,    // å¹³å‡æ»¡æ„åº¦ >= 4.0
      minSuccessRate: 0.85,    // æˆåŠŸç‡ >= 85%
    }

    if (
      entry.stats.useCount >= PROMOTION_CRITERIA.minUseCount &&
      entry.stats.avgSatisfaction >= PROMOTION_CRITERIA.minSatisfaction &&
      entry.stats.successRate >= PROMOTION_CRITERIA.minSuccessRate
    ) {
      // å‘å‡ºæå‡å»ºè®®äº‹ä»¶ï¼Œç”±ç®¡ç†å‘˜å®¡æ ¸åæ­£å¼åŠ å…¥é¢„ç½®æ¨¡æ¿
      Bus.publish(TemplateEvent.PromotionSuggested, {
        templateId: entry.template.id,
        template: entry.template,
        stats: entry.stats,
        reason: 'åŠ¨æ€æ¨¡æ¿è¾¾åˆ°è‡ªåŠ¨æå‡æ ‡å‡†',
      })
    }
  }
}
```

#### 9.3.7 å®Œæ•´æµç¨‹ç¤ºæ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               åŠ¨æ€æ¨¡æ¿æåˆå®Œæ•´æµç¨‹                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ç”¨æˆ·è¾“å…¥                                                                    â”‚
â”‚  "å¸®æˆ‘åšä¸€ä¸ªç«å“åˆ†ææŠ¥å‘Šï¼Œå¯¹æ¯” Notion å’Œ Obsidian çš„ AI åŠŸèƒ½"              â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚  1. Template Resolution Router        â”‚                                  â”‚
â”‚  â”‚     â‘  æŸ¥å›ºå®šæ¨¡æ¿ â†’ æ— ç²¾ç¡®åŒ¹é…        â”‚                                  â”‚
â”‚  â”‚     â‘¡ æŸ¥åŠ¨æ€ç¼“å­˜ â†’ æ— ç›¸ä¼¼æ¨¡æ¿        â”‚                                  â”‚
â”‚  â”‚     â‘¢ è¿›å…¥ AI åˆæˆæµç¨‹               â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                     â”‚                                                        â”‚
â”‚                     â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚  2. Intent Analyzer                   â”‚                                  â”‚
â”‚  â”‚     domain: "research"               â”‚                                  â”‚
â”‚  â”‚     category: "analysis"             â”‚                                  â”‚
â”‚  â”‚     complexity: "moderate"           â”‚                                  â”‚
â”‚  â”‚     multiAgent: true                 â”‚                                  â”‚
â”‚  â”‚     entities:                         â”‚                                  â”‚
â”‚  â”‚       - { type: "tool", value: "Notion" }                               â”‚
â”‚  â”‚       - { type: "tool", value: "Obsidian" }                             â”‚
â”‚  â”‚       - { type: "concept", value: "AI åŠŸèƒ½" }                           â”‚
â”‚  â”‚     suggestedRoles:                   â”‚                                  â”‚
â”‚  â”‚       - researcher (å¿…éœ€)            â”‚                                  â”‚
â”‚  â”‚       - analyst (å¿…éœ€)               â”‚                                  â”‚
â”‚  â”‚       - writer (å¯é€‰)                â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                     â”‚                                                        â”‚
â”‚                     â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚  3. Template Synthesizer              â”‚                                  â”‚
â”‚  â”‚     â‘  selectAgents:                   â”‚                                  â”‚
â”‚  â”‚        researcher â†’ æ³¨å†Œè¡¨æœ‰ â†’ å¤ç”¨  â”‚                                  â”‚
â”‚  â”‚        analyst â†’ æ³¨å†Œè¡¨æœ‰ â†’ å¤ç”¨     â”‚                                  â”‚
â”‚  â”‚        writer â†’ æ³¨å†Œè¡¨æœ‰ â†’ å¤ç”¨      â”‚                                  â”‚
â”‚  â”‚     â‘¡ selectTools:                    â”‚                                  â”‚
â”‚  â”‚        search, browse, read, write    â”‚                                  â”‚
â”‚  â”‚     â‘¢ synthesizeWorkflows:            â”‚                                  â”‚
â”‚  â”‚        Step 1: researcher â†’ æ”¶é›†ä¿¡æ¯ â”‚                                  â”‚
â”‚  â”‚        Step 2: analyst â†’ å¯¹æ¯”åˆ†æ    â”‚                                  â”‚
â”‚  â”‚        Step 3: writer â†’ æ’°å†™æŠ¥å‘Š     â”‚                                  â”‚
â”‚  â”‚     â‘£ ç»„è£…å®Œæ•´ ScenarioTemplate      â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                     â”‚                                                        â”‚
â”‚                     â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚  4. Validate & Dry Run                â”‚                                  â”‚
â”‚  â”‚     âœ… Agent å…¨éƒ¨å¯å®ä¾‹åŒ–             â”‚                                  â”‚
â”‚  â”‚     âœ… Tool å…¨éƒ¨å¯åˆå§‹åŒ–              â”‚                                  â”‚
â”‚  â”‚     âœ… å·¥ä½œæµ DAG åˆæ³•               â”‚                                  â”‚
â”‚  â”‚     âš ï¸  å»ºè®®ï¼šbrowse æƒé™è®¾ä¸º ask    â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                     â”‚                                                        â”‚
â”‚                     â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚  5. Cache & Use                       â”‚                                  â”‚
â”‚  â”‚     â€¢ ç¼“å­˜æ¨¡æ¿ + embedding           â”‚                                  â”‚
â”‚  â”‚     â€¢ åˆ›å»ºä¼šè¯                        â”‚                                  â”‚
â”‚  â”‚     â€¢ è®°å½•ä½¿ç”¨/æ»¡æ„åº¦                 â”‚                                  â”‚
â”‚  â”‚     â€¢ è¾¾æ ‡åå»ºè®®æå‡ä¸ºé¢„ç½®æ¨¡æ¿        â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.3.8 ç¤ºä¾‹åœºæ™¯

**åœºæ™¯ 1ï¼šç”¨æˆ·æ— æ¨¡æ¿ç›´æ¥æè¿°éœ€æ±‚**

```typescript
// ç”¨æˆ·æ²¡æœ‰æŒ‡å®šæ¨¡æ¿ï¼Œç›´æ¥æè¿°éœ€æ±‚
const session = await platform.createSession({
  prompt: "å¸®æˆ‘åšä¸€ä¸ªç«å“åˆ†ææŠ¥å‘Šï¼Œå¯¹æ¯” Notion å’Œ Obsidian çš„ AI åŠŸèƒ½",
})

// å†…éƒ¨æµç¨‹ï¼š
// 1. TemplateResolutionRouter å‘ç°æ— åŒ¹é…çš„å›ºå®šæ¨¡æ¿
// 2. IntentAnalyzer æå–æ„å›¾ï¼šdomain=research, category=analysis
// 3. TemplateSynthesizer åˆæˆæ¨¡æ¿ï¼š
//    - agents: [researcher, analyst, writer]
//    - tools: [search, browse, read, write]
//    - workflow: æ”¶é›† â†’ åˆ†æ â†’ æ’°å†™
// 4. TemplateValidator éªŒè¯é€šè¿‡
// 5. ä½¿ç”¨åˆæˆæ¨¡æ¿åˆ›å»ºä¼šè¯

// å¯¹ç”¨æˆ·æ¥è¯´ï¼Œä½“éªŒå’Œä½¿ç”¨å›ºå®šæ¨¡æ¿å®Œå…¨ä¸€è‡´
await session.prompt("è¯·é‡ç‚¹å…³æ³¨ AI å†™ä½œåŠ©æ‰‹å’Œæ™ºèƒ½æœç´¢è¿™ä¸¤ä¸ªç»´åº¦")
```

**åœºæ™¯ 2ï¼šåŠåŒ¹é… â†’ å›ºå®šæ¨¡æ¿ + åŠ¨æ€å¢å¼º**

```typescript
// ç”¨æˆ·éœ€æ±‚å¤§è‡´åŒ¹é…"éœ€æ±‚åˆ†æ"æ¨¡æ¿ï¼Œä½†æœ‰é¢å¤–é¢†åŸŸéœ€æ±‚
const session = await platform.createSession({
  prompt: "åˆ†æè¿™ä¸ªåŒºå—é“¾ DeFi é¡¹ç›®çš„å®‰å…¨éœ€æ±‚ï¼Œç‰¹åˆ«å…³æ³¨æ™ºèƒ½åˆçº¦å®¡è®¡",
})

// å†…éƒ¨æµç¨‹ï¼š
// 1. TemplateResolutionRouter åŒ¹é…åˆ° "requirement-analysis" ä½†ç½®ä¿¡åº¦ä»… 0.72
// 2. ä½äº 0.85 é˜ˆå€¼ â†’ è¿›å…¥ AI åˆæˆ
// 3. IntentAnalyzer è¯†åˆ«å‡º"å®‰å…¨åˆ†æ"+"åŒºå—é“¾"+"æ™ºèƒ½åˆçº¦å®¡è®¡"
// 4. TemplateSynthesizer åˆæˆæ—¶ï¼š
//    - å¤ç”¨ requirement-analyst Agent
//    - é¢å¤–åˆ›å»º security-auditor Agentï¼ˆåŠ¨æ€ï¼‰
//    - æ·»åŠ  smart-contract-analysis Toolï¼ˆå¦‚æœå·²æ³¨å†Œï¼‰
//    - åˆæˆåŒ…å«"å¨èƒå»ºæ¨¡ â†’ åˆçº¦å®¡è®¡ â†’ æŠ¥å‘Š"çš„å·¥ä½œæµ
```

**åœºæ™¯ 3ï¼šç¼“å­˜å‘½ä¸­ â†’ ç›´æ¥å¤ç”¨**

```typescript
// ç¬¬äºŒä¸ªç”¨æˆ·æäº†ç±»ä¼¼çš„éœ€æ±‚
const session = await platform.createSession({
  prompt: "å¯¹æ¯”åˆ†æ Notion å’Œ Coda çš„ AI èƒ½åŠ›ï¼Œå†™ä¸ªæŠ¥å‘Š",
})

// å†…éƒ¨æµç¨‹ï¼š
// 1. TemplateResolutionRouter æ— å›ºå®šæ¨¡æ¿åŒ¹é…
// 2. æ£€æŸ¥åŠ¨æ€ç¼“å­˜ â†’ å‘ç°ä¸ä¹‹å‰ "Notion vs Obsidian AI åŠŸèƒ½" ç›¸ä¼¼åº¦ 0.93
// 3. ç›´æ¥å¤ç”¨ç¼“å­˜çš„åˆæˆæ¨¡æ¿ï¼ˆä»…éœ€æ›¿æ¢å…·ä½“å®ä½“ï¼‰
// 4. è·³è¿‡ AI åˆæˆï¼ŒèŠ‚çœæ—¶é—´å’Œ token
```

**åœºæ™¯ 4ï¼šåˆæˆæ¨¡æ¿æå‡ä¸ºé¢„ç½®æ¨¡æ¿**

```typescript
// ç®¡ç†å‘˜æ”¶åˆ°æå‡å»ºè®®é€šçŸ¥
Bus.on(TemplateEvent.PromotionSuggested, async (event) => {
  console.log(`
    æ¨¡æ¿ "${event.template.name}" å»ºè®®æå‡ä¸ºé¢„ç½®æ¨¡æ¿
    ä½¿ç”¨æ¬¡æ•°: ${event.stats.useCount}
    æ»¡æ„åº¦: ${event.stats.avgSatisfaction}/5
    æˆåŠŸç‡: ${(event.stats.successRate * 100).toFixed(1)}%
  `)

  // ç®¡ç†å‘˜å®¡æ ¸åï¼Œæ­£å¼åŠ å…¥æ¨¡æ¿æ³¨å†Œè¡¨
  await templateRegistry.register({
    ...event.template,
    id: 'competitive-analysis', // èµ‹äºˆæ­£å¼ ID
    tags: event.template.tags.filter(t => t !== '_synthesized'),
  })
})
```

---

## 10. æƒé™ä¸å®‰å…¨

### 10.1 æƒé™æ¨¡å‹æ‰©å±•

```typescript
// permission/types.ts
export interface PermissionSystem {
  // æƒé™ç±»åˆ«
  categories: {
    file: FilePermissions       // æ–‡ä»¶æ“ä½œ
    code: CodePermissions       // ä»£ç æ“ä½œ
    network: NetworkPermissions // ç½‘ç»œè®¿é—®
    shell: ShellPermissions     // å‘½ä»¤æ‰§è¡Œ
    data: DataPermissions       // æ•°æ®è®¿é—®
    external: ExternalPermissions // å¤–éƒ¨æœåŠ¡
  }
  
  // æƒé™è§„åˆ™
  rules: PermissionRule[]
  
  // å®¡è®¡æ—¥å¿—
  audit: AuditLog
}

// æ–‡ä»¶æƒé™
interface FilePermissions {
  read: PermissionAction | PatternPermission
  write: PermissionAction | PatternPermission
  delete: PermissionAction | PatternPermission
  execute: PermissionAction | PatternPermission
}

// ç½‘ç»œæƒé™ï¼ˆæ–°å¢ï¼‰
interface NetworkPermissions {
  http: PermissionAction | DomainPermission
  websocket: PermissionAction | DomainPermission
  dns: PermissionAction
}

// æ•°æ®æƒé™ï¼ˆæ–°å¢ï¼‰
interface DataPermissions {
  database: PermissionAction | TablePermission
  api: PermissionAction | EndpointPermission
  secrets: PermissionAction
}
```

### 10.2 æ²™ç®±æ‰§è¡Œ

```typescript
// sandbox/executor.ts
export class SandboxExecutor {
  private container?: Container
  
  async execute(
    tool: ToolDefinition,
    params: unknown,
    ctx: ExecutionContext
  ): Promise<ToolResult> {
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ²™ç®±
    if (this.requiresSandbox(tool)) {
      return this.executeInSandbox(tool, params, ctx)
    }
    
    return tool.execute(params, ctx)
  }
  
  private async executeInSandbox(
    tool: ToolDefinition,
    params: unknown,
    ctx: ExecutionContext
  ): Promise<ToolResult> {
    // åˆ›å»ºéš”ç¦»ç¯å¢ƒ
    const sandbox = await this.createSandbox({
      permissions: tool.requiredPermissions,
      resources: {
        cpu: "0.5",
        memory: "512m",
        timeout: 60000,
      },
      network: this.getNetworkPolicy(tool),
      filesystem: this.getFilesystemPolicy(tool),
    })
    
    try {
      return await sandbox.run(tool.execute, params, ctx)
    } finally {
      await sandbox.destroy()
    }
  }
}
```

### 10.3 å®¡è®¡æ—¥å¿—

```typescript
// audit/logger.ts
export class AuditLogger {
  async log(entry: AuditEntry): Promise<void> {
    await Storage.audit.insert({
      ...entry,
      timestamp: Date.now(),
      traceId: getCurrentTrace(),
    })
    
    // å®æ—¶äº‹ä»¶
    Bus.publish(AuditEvent.Logged, entry)
  }
}

interface AuditEntry {
  type: AuditType
  actor: {
    type: "user" | "agent" | "system"
    id: string
    name: string
  }
  action: string
  resource: {
    type: string
    id: string
    path?: string
  }
  outcome: "success" | "failure" | "denied"
  details?: Record<string, unknown>
}
```

---

## 11. Agent è¯„ä¼°ä½“ç³»

> èåˆ Anthropicã€ŠDemystifying evals for AI agentsã€‹ï¼ˆ2026.01ï¼‰æ ¸å¿ƒç†å¿µï¼Œä¸º Agent å¹³å°å»ºç«‹ç³»ç»ŸåŒ–è¯„ä¼°èƒ½åŠ›

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Agent è¯„ä¼°ä½“ç³» æ€»è§ˆ                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  æ ¸å¿ƒæ´å¯Ÿï¼š                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚  â€¢ Agent çš„"ç›²é£"çŠ¶æ€æ˜¯æœ€å¤§éšæ‚£ï¼šæ”¹äº† Prompt å´æ— æ³•é‡åŒ–å½±å“                â”‚
â”‚  â€¢ æ—©æœŸé ç›´è§‰å’Œæ‰‹åŠ¨æµ‹è¯•èƒ½èµ°æŒºè¿œï¼Œä½†æ‰©å±•åå¿…é¡»ç³»ç»ŸåŒ–                         â”‚
â”‚  â€¢ è¯„ä¼°çš„å¤åˆ©æ•ˆåº”ï¼šæˆæœ¬å‰æœŸå¯è§ï¼Œæ”¶ç›ŠåæœŸç´¯ç§¯                                â”‚
â”‚  â€¢ æœ‰è¯„ä¼°çš„å›¢é˜Ÿåœ¨æ¨¡å‹å‡çº§æ—¶èƒ½å¿«é€ŸéªŒè¯ï¼Œæ•°å¤©å®Œæˆï¼›æ— è¯„ä¼°åˆ™éœ€æ•°å‘¨æ‰‹åŠ¨æµ‹è¯•      â”‚
â”‚                                                                              â”‚
â”‚  è¯„ä¼°ç»“æ„ï¼š                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                                                              â”‚
â”‚  ç®€å• LLM è¯„ä¼°ï¼š  æç¤º â†’ å“åº” â†’ è¯„åˆ†                                        â”‚
â”‚                                                                              â”‚
â”‚  Agent è¯„ä¼°ï¼š     ä»»åŠ¡ + å·¥å…· â†’ [å·¥å…·è°ƒç”¨ + æ¨ç†]Ã—N è½® â†’ ç»“æœéªŒè¯           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.1 è¯„ä¼°çš„åŸºæœ¬æ¦‚å¿µ

è¯„ä¼°ï¼ˆevalï¼‰æ˜¯ç»™ AI ç³»ç»Ÿåšçš„è‡ªåŠ¨åŒ–æµ‹è¯•ï¼šç»™å®ƒä¸€ä¸ªè¾“å…¥ï¼Œç”¨è¯„åˆ†é€»è¾‘å¯¹è¾“å‡ºæ‰“åˆ†ã€‚å•è½®è¯„ä¼°æ˜¯"æç¤ºâ†’å“åº”â†’è¯„åˆ†"ï¼Œä½† Agent æ˜¯å¤šè½®è¿è¡Œçš„â€”â€”è°ƒç”¨å·¥å…·ã€ä¿®æ”¹çŠ¶æ€ã€åŠ¨æ€è°ƒæ•´â€”â€”è¯„ä¼°å¿…é¡»ç›¸åº”å¤æ‚åŒ–ã€‚

**æ ¸å¿ƒæœ¯è¯­**

| æœ¯è¯­ | å®šä¹‰ |
|------|------|
| **ä»»åŠ¡ï¼ˆTaskï¼‰** | ç‹¬ç«‹æµ‹è¯•ç”¨ä¾‹ï¼Œæœ‰æ˜ç¡®è¾“å…¥å’ŒæˆåŠŸæ ‡å‡† |
| **è¯•éªŒï¼ˆTrialï¼‰** | å¯¹ä»»åŠ¡çš„ä¸€æ¬¡å°è¯•ï¼Œå› æ¨¡å‹è¾“å‡ºæœ‰éšæœºæ€§é€šå¸¸è·‘å¤šæ¬¡ |
| **è¯„åˆ†å™¨ï¼ˆGraderï¼‰** | æ‰“åˆ†é€»è¾‘ï¼Œä¸€ä¸ªä»»åŠ¡å¯æœ‰å¤šä¸ªè¯„åˆ†å™¨ |
| **è½¬å½•ï¼ˆTranscriptï¼‰** | ä¸€æ¬¡è¯•éªŒçš„å®Œæ•´è®°å½•ï¼ŒåŒ…æ‹¬æ‰€æœ‰å·¥å…·è°ƒç”¨ã€æ¨ç†è¿‡ç¨‹ã€ä¸­é—´ç»“æœ |
| **ç»“æœï¼ˆOutcomeï¼‰** | è¯•éªŒç»“æŸæ—¶ç¯å¢ƒçš„æœ€ç»ˆçŠ¶æ€ï¼ˆAgent è¯´"å·²å®Œæˆ"ä¸ç®—ï¼Œæ•°æ®åº“é‡Œæœ‰è®°å½•æ‰ç®—ï¼‰ |
| **è¯„ä¼°æ¡†æ¶ï¼ˆEvaluation Harnessï¼‰** | ç«¯åˆ°ç«¯è¿è¡Œè¯„ä¼°çš„åŸºç¡€è®¾æ–½ |
| **Agent æ¡†æ¶ï¼ˆAgent Harness / Scaffoldï¼‰** | è®©æ¨¡å‹èƒ½ä½œä¸º Agent è¿è¡Œçš„è„šæ‰‹æ¶ç³»ç»Ÿ |
| **è¯„ä¼°å¥—ä»¶ï¼ˆEvaluation Suiteï¼‰** | ä¸ºè¡¡é‡ç‰¹å®šèƒ½åŠ›è€Œè®¾è®¡çš„ä»»åŠ¡é›†åˆ |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¯„ä¼°ç»„ä»¶å…³ç³»å›¾                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   è¯„ä¼°å¥—ä»¶ (Evaluation Suite)                                                â”‚
â”‚   â”œâ”€â”€ ä»»åŠ¡ 1 (Task)                                                         â”‚
â”‚   â”‚   â”œâ”€â”€ è¯•éªŒ 1 (Trial) â”€â”€â”€ è½¬å½• (Transcript) â”€â”€â”€ ç»“æœ (Outcome)          â”‚
â”‚   â”‚   â”œâ”€â”€ è¯•éªŒ 2 (Trial) â”€â”€â”€ è½¬å½• (Transcript) â”€â”€â”€ ç»“æœ (Outcome)          â”‚
â”‚   â”‚   â””â”€â”€ ...                                                               â”‚
â”‚   â”œâ”€â”€ ä»»åŠ¡ 2 (Task)                                                         â”‚
â”‚   â”‚   â””â”€â”€ ...                                                               â”‚
â”‚   â””â”€â”€ ...                                                                   â”‚
â”‚                                                                              â”‚
â”‚   è¯„åˆ†å™¨ (Graders) â”€â”€â”€â”€ å¯¹æ¯ä¸ªè¯•éªŒçš„è½¬å½•å’Œç»“æœè¿›è¡Œæ‰“åˆ†                      â”‚
â”‚                                                                              â”‚
â”‚   è¯„ä¼°æ¡†æ¶ (Harness) â”€â”€ æä¾›æŒ‡ä»¤/å·¥å…·ã€å¹¶å‘è¿è¡Œã€è®°å½•æ­¥éª¤ã€æ±‡æ€»ç»“æœ         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **æœ‰è¶£æ¡ˆä¾‹ï¼š** Opus 4.5 åœ¨åš Ï„2-bench çš„èˆªç­é¢„è®¢ä»»åŠ¡æ—¶ï¼Œå‘ç°äº†æ”¿ç­–é‡Œçš„ä¸€ä¸ªæ¼æ´ï¼Œç»™ç”¨æˆ·æ‰¾åˆ°äº†æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚æŒ‰è¯„ä¼°çš„å­—é¢æ ‡å‡†å®ƒ"å¤±è´¥"äº†ï¼Œä½†å®é™…ä¸Šå®ƒæ¯”æ ‡å‡†ç­”æ¡ˆæ›´èªæ˜ã€‚è¿™è¯´æ˜ Agent è¯„ä¼°ä¸èƒ½å¤ªæ­»æ¿ï¼Œå‰æ²¿æ¨¡å‹çš„åˆ›é€ æ€§å¯èƒ½è¶…å‡ºé¢„æœŸã€‚

### 11.2 ä¸ºä»€ä¹ˆéœ€è¦è¯„ä¼°ä½“ç³»

å¾ˆå¤šå›¢é˜Ÿè§‰å¾—è¯„ä¼°æ˜¯é¢å¤–è´Ÿæ‹…ã€‚æ—©æœŸç¡®å®å¯ä»¥æ‰‹åŠ¨æµ‹æµ‹ã€å†…éƒ¨è¯•ç”¨ã€å‡­ç›´è§‰åˆ¤æ–­ã€‚ä½†æ€»æœ‰ä¸ª**ä¸´ç•Œç‚¹**ä¼šåˆ°æ¥ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ²¡æœ‰è¯„ä¼°çš„"è¢«åŠ¨å¾ªç¯"                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   ç”¨æˆ·æŠ•è¯‰"å˜è ¢äº†"                                                          â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   ä¸¤çœ¼ä¸€æŠ¹é»‘ï¼šæ˜¯çœŸé€€æ­¥äº†è¿˜æ˜¯å™ªå£°ï¼Ÿ                                          â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   æ‰‹åŠ¨å¤ç° â†’ ä¿® bug â†’ ç¥ˆç¥·æ²¡å¼•å…¥æ–°é—®é¢˜                                     â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   æ— æ³•åŒºåˆ†é€€åŒ–å’Œå™ªå£°ï¼Œæ— æ³•é‡åŒ–æ”¹è¿›                                          â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   ä¸‹æ¬¡åˆè¢«æŠ•è¯‰... (å¾ªç¯)                                                    â”‚
â”‚                                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     æœ‰è¯„ä¼°çš„"æ­£å‘é£è½®"                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   å¤±è´¥ â†’ è½¬åŒ–ä¸ºæµ‹è¯•ç”¨ä¾‹ â†’ é˜²æ­¢å›å½’ â†’ æŒ‡æ ‡å–ä»£çŒœæµ‹                          â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   æ¯æ¬¡æ”¹åŠ¨å‰è‡ªåŠ¨è·‘æ•°ç™¾åœºæ™¯ â†’ å‘å¸ƒå‰è‡ªåŠ¨æ‹¦æˆªé€€åŒ–                             â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   æ–°æ¨¡å‹å‘å¸ƒ â†’ å¿«é€ŸéªŒè¯ â†’ æ•°å¤©å®Œæˆå‡çº§                                     â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   å»¶è¿Ÿ/token/æˆæœ¬/é”™è¯¯ç‡åœ¨å›ºå®šä»»åŠ¡é›†ä¸ŠæŒç»­è¿½è¸ª                              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æˆ˜æ¡ˆä¾‹**

- **Claude Code**ï¼šä¸€å¼€å§‹åŸºäºåé¦ˆå¿«é€Ÿè¿­ä»£ï¼Œåæ¥åŠ å…¥è¯„ä¼°â€”â€”å…ˆå±€éƒ¨ï¼ˆç®€æ´æ€§ã€æ–‡ä»¶ç¼–è¾‘ï¼‰ï¼Œåæ‰©å±•åˆ°å¤æ‚è¡Œä¸ºï¼ˆè¿‡åº¦è®¾è®¡ï¼‰ã€‚è¯„ä¼°æˆäº†ç ”ç©¶å’Œäº§å“å›¢é˜Ÿåä½œçš„æ¡¥æ¢ã€‚
- **Descript**ï¼ˆè§†é¢‘ç¼–è¾‘ Agentï¼‰ï¼šå›´ç»•ä¸‰ç»´åº¦æ„å»ºâ€”â€”ä¸å‡ºé”™ã€ä¸¥æ ¼éµå¾ªè¦æ±‚ã€åšå¾—å¥½ã€‚ä»æ‰‹åŠ¨è¯„åˆ†æ¼”è¿›åˆ° LLM è¯„åˆ†å™¨ï¼Œå®šæœŸå’Œäººå·¥æ ¡å‡†ã€‚
- **Bolt**ï¼šAgent å¹¿æ³›ä½¿ç”¨åæ‰å»ºè¯„ä¼°ï¼Œ3 ä¸ªæœˆæ­äº†è¯„ä¼°ç³»ç»Ÿï¼ŒåŒ…æ‹¬é™æ€åˆ†æã€æµè§ˆå™¨ Agent æµ‹è¯•ã€LLM è¯„å§”è¯„ä¼°ã€‚

### 11.3 è¯„åˆ†å™¨ç±»å‹

Agent è¯„ä¼°é€šå¸¸ç»„åˆä¸‰ç±»è¯„åˆ†å™¨ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ä¸‰ç±»è¯„åˆ†å™¨å¯¹æ¯”                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚  â”‚  1. åŸºäºä»£ç çš„è¯„åˆ†å™¨    â”‚                                                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                 â”‚
â”‚  â”‚  æ–¹å¼ï¼šå­—ç¬¦ä¸²åŒ¹é…ã€å•å…ƒæµ‹è¯•ã€é™æ€åˆ†æ                                    â”‚
â”‚  â”‚  ä¼˜ç‚¹ï¼šå¿«ã€ä¾¿å®œã€å®¢è§‚ã€å¯å¤ç°                                            â”‚
â”‚  â”‚  ç¼ºç‚¹ï¼šè„†å¼±ï¼Œå¯¹æœ‰æ•ˆå˜ä½“ä¸å®½å®¹ï¼Œç¼ºä¹ç»†å¾®åˆ¤æ–­                              â”‚
â”‚  â”‚  é€‚ç”¨ï¼šæœ‰æ˜ç¡®æ­£ç¡®ç­”æ¡ˆçš„åœºæ™¯                                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚  â”‚  2. åŸºäºæ¨¡å‹çš„è¯„åˆ†å™¨    â”‚                                                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                 â”‚
â”‚  â”‚  æ–¹å¼ï¼šLLM è¯„å§”ã€è¯„åˆ†æ ‡å‡†æ‰“åˆ†ã€æˆå¯¹æ¯”è¾ƒ                                  â”‚
â”‚  â”‚  ä¼˜ç‚¹ï¼šçµæ´»ã€èƒ½å¤„ç†å¼€æ”¾å¼ä»»åŠ¡                                            â”‚
â”‚  â”‚  ç¼ºç‚¹ï¼šéç¡®å®šæ€§ã€æ¯”ä»£ç è´µã€éœ€å’Œäººå·¥æ ¡å‡†                                  â”‚
â”‚  â”‚  é€‚ç”¨ï¼šå¼€æ”¾å¼ã€ä¸»è§‚æ€§ä»»åŠ¡                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚  â”‚  3. äººå·¥è¯„åˆ†å™¨          â”‚                                                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                 â”‚
â”‚  â”‚  æ–¹å¼ï¼šé¢†åŸŸä¸“å®¶è¯„å®¡ã€ä¼—åŒ…åˆ¤æ–­ã€æŠ½æ ·æ£€æŸ¥                                  â”‚
â”‚  â”‚  ä¼˜ç‚¹ï¼šé»„é‡‘æ ‡å‡†                                                          â”‚
â”‚  â”‚  ç¼ºç‚¹ï¼šè´µã€æ…¢ã€éš¾ä»¥è§„æ¨¡åŒ–                                                â”‚
â”‚  â”‚  é€‚ç”¨ï¼šæ ¡å‡† LLM è¯„åˆ†å™¨ã€è¯„ä¼°ä¸»è§‚è¾“å‡º                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚                                                                              â”‚
â”‚  âš¡ å®è·µåŸåˆ™ï¼š                                                               â”‚
â”‚     å°½å¯èƒ½ç”¨ç¡®å®šæ€§è¯„åˆ†å™¨ â†’ å¿…è¦æ—¶åŠ  LLM è¯„åˆ†å™¨ â†’ äººå·¥è¯„åˆ†å™¨ç”¨æ¥æ ¡å‡†         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœ¨æœ¬å¹³å°ä¸­çš„æ˜ å°„**

```typescript
// eval/graders/types.ts
export interface GraderDefinition {
  type: 'deterministic' | 'llm' | 'human'
  id: string
  name: string
}

// åŸºäºä»£ç çš„è¯„åˆ†å™¨
export interface DeterministicGrader extends GraderDefinition {
  type: 'deterministic'
  variant:
    | { kind: 'unit_tests'; testFiles: string[] }
    | { kind: 'string_match'; expected: string; mode: 'exact' | 'contains' | 'regex' }
    | { kind: 'static_analysis'; commands: string[] }
    | { kind: 'state_check'; expect: Record<string, unknown> }
    | { kind: 'tool_calls'; required: ToolCallAssertion[] }
}

// åŸºäºæ¨¡å‹çš„è¯„åˆ†å™¨
export interface LLMGrader extends GraderDefinition {
  type: 'llm'
  variant:
    | { kind: 'rubric'; rubricPath: string; assertions?: string[] }
    | { kind: 'pairwise'; baseline: string }
    | { kind: 'nl_assertion'; assertion: string }
  model?: string // é»˜è®¤ä½¿ç”¨é«˜èƒ½åŠ›æ¨¡å‹
  calibration?: { humanAgreementRate: number } // å’Œäººå·¥æ ¡å‡†çš„ä¸€è‡´ç‡
}

// äººå·¥è¯„åˆ†å™¨
export interface HumanGrader extends GraderDefinition {
  type: 'human'
  variant:
    | { kind: 'expert_review'; rubricPath: string }
    | { kind: 'crowd_sourced'; minReviewers: number }
    | { kind: 'spot_check'; sampleRate: number }
}
```

### 11.4 èƒ½åŠ›è¯„ä¼° vs å›å½’è¯„ä¼°

è¿™æ˜¯ä¸¤ç§ä¸åŒç›®çš„çš„è¯„ä¼°ï¼Œå¿…é¡»åŒæ—¶è¿è¡Œï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    èƒ½åŠ›è¯„ä¼° vs å›å½’è¯„ä¼°                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         èƒ½åŠ›è¯„ä¼°                   â”‚          å›å½’è¯„ä¼°                        â”‚
â”‚   (Capability Evaluation)         â”‚    (Regression Evaluation)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                   â”‚                                         â”‚
â”‚  é—®ï¼šAgent æ“…é•¿åšä»€ä¹ˆï¼Ÿ           â”‚  é—®ï¼šAgent è¿˜èƒ½åšå¥½ä»¥å‰èƒ½åšçš„äº‹å—ï¼Ÿ     â”‚
â”‚                                   â”‚                                         â”‚
â”‚  é€šè¿‡ç‡ï¼šä»è¾ƒä½å¼€å§‹               â”‚  é€šè¿‡ç‡ï¼šåº”æ¥è¿‘ 100%                    â”‚
â”‚                                   â”‚                                         â”‚
â”‚  ç›®æ ‡ï¼šé’ˆå¯¹éš¾ä»¥å®Œæˆçš„ä»»åŠ¡ï¼Œ        â”‚  ç›®æ ‡ï¼šåˆ†æ•°ä¸‹é™æ„å‘³ç€å‡ºé—®é¢˜äº†           â”‚
â”‚  ç»™å›¢é˜Ÿä¸€ä¸ªç›®æ ‡å»æå‡             â”‚                                         â”‚
â”‚                                   â”‚                                         â”‚
â”‚  æ¼”è¿›ï¼šé€šè¿‡ç‡é«˜äº†ä¹‹åï¼Œ           â”‚  æ¥æºï¼šä»å·²ç¨³å®šé€šè¿‡çš„èƒ½åŠ›è¯„ä¼°           â”‚
â”‚  å‡çº§åˆ°å›å½’å¥—ä»¶                   â”‚  ä»»åŠ¡ä¸­æ¯•ä¸šè€Œæ¥                         â”‚
â”‚                                   â”‚                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ååŒå·¥ä½œæµï¼š                                                                â”‚
â”‚                                                                              â”‚
â”‚  èƒ½åŠ›è¯„ä¼°ï¼ˆçˆ¬å¡ï¼‰â”€â”€ä»»åŠ¡ç¨³å®šé€šè¿‡â”€â”€â†’ å‡çº§åˆ°å›å½’å¥—ä»¶ï¼ˆå®ˆæŠ¤ï¼‰                   â”‚
â”‚       â†‘                                       â”‚                             â”‚
â”‚       â”‚       å›å½’è¯„ä¼°å‘ç°é€€åŒ– â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚       â””â”€â”€ æ–°å¢æ›´éš¾çš„èƒ½åŠ›è¯„ä¼°ä»»åŠ¡                                             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.5 ä¸åŒç±»å‹ Agent çš„è¯„ä¼°æ–¹æ³•

#### 11.5.1 ç¼–ç  Agent

ç¼–ç  Agent å†™ä»£ç ã€è·‘æµ‹è¯•ã€è°ƒ bugã€‚è¯„ä¼°ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºè½¯ä»¶æ˜¯å¯ä»¥å®¢è§‚éªŒè¯çš„ã€‚

**å¸¸ç”¨åŸºå‡†**

| åŸºå‡† | è¯´æ˜ |
|------|------|
| SWE-bench Verified | ç»™ Agent çœŸå® GitHub issueï¼Œé€šè¿‡è¿è¡Œæµ‹è¯•å¥—ä»¶è¯„åˆ† |
| Terminal-Bench | ç«¯åˆ°ç«¯ä»»åŠ¡ï¼ˆç¼–è¯‘å†…æ ¸ã€è®­ç»ƒ ML æ¨¡å‹ç­‰ï¼‰ |

**è¯„ä¼°ç¤ºä¾‹**

```yaml
# ç¼–ç  Agent è¯„ä¼°ä»»åŠ¡å®šä¹‰
task:
  id: "fix-auth-bypass_1"
  desc: "Fix authentication bypass when password field is empty and ..."
  graders:
    - type: deterministic_tests
      required: [test_empty_pw_rejected.py, test_null_pw_rejected.py]
    - type: llm_rubric
      rubric: prompts/code_quality.md
    - type: static_analysis
      commands: [ruff, mypy, bandit]
    - type: state_check
      expect:
        security_logs: {event_type: "auth_blocked"}
    - type: tool_calls
      required:
        - {tool: read_file, params: {path: "src/auth/*"}}
        - {tool: edit_file}
        - {tool: run_tests}
  tracked_metrics:
    - type: transcript
      metrics:
        - n_turns
        - n_toolcalls
        - n_total_tokens
    - type: latency
      metrics:
        - time_to_first_token
        - output_tokens_per_sec
        - time_to_last_token
```

> å®è·µä¸­ï¼Œç¼–ç è¯„ä¼°é€šå¸¸å°±æ˜¯**å•å…ƒæµ‹è¯• + LLM ä»£ç è´¨é‡è¯„åˆ†**ï¼Œåªæœ‰åœ¨éœ€è¦æ—¶æ‰æ·»åŠ é¢å¤–è¯„åˆ†å™¨å’ŒæŒ‡æ ‡ã€‚

#### 11.5.2 å¯¹è¯ Agent

å¯¹è¯ Agent åœ¨å®¢æœã€é”€å”®æˆ–è¾…å¯¼åœºæ™¯å’Œç”¨æˆ·äº¤äº’ã€‚äº¤äº’æœ¬èº«çš„è´¨é‡ä¹Ÿæ˜¯è¯„ä¼°å†…å®¹çš„ä¸€éƒ¨åˆ†ã€‚

å¯¹è¯ Agent è¯„ä¼°é€šå¸¸éœ€è¦**ç¬¬äºŒä¸ª LLM æ¨¡æ‹Ÿç”¨æˆ·**ï¼Œè¿™ä¸å…¶ä»–ç±»å‹ä¸åŒã€‚æˆåŠŸæ˜¯å¤šç»´åº¦çš„ï¼šå·¥å•è§£å†³äº†å—ï¼Ÿåœ¨ 10 è½®å†…å®Œæˆäº†å—ï¼Ÿè¯­æ°”æ°å½“å—ï¼Ÿ

**è¯„ä¼°ç¤ºä¾‹**

```yaml
# å¯¹è¯ Agent è¯„ä¼°ä»»åŠ¡å®šä¹‰ï¼ˆå®¢æœé€€æ¬¾åœºæ™¯ï¼‰
task:
  id: "support-refund-frustrated_1"
  desc: "Handle refund for a frustrated customer"
  user_simulator:
    model: claude-sonnet
    persona: "Frustrated customer who received wrong item"
  graders:
    - type: llm_rubric
      rubric: prompts/support_quality.md
      assertions:
        - "Agent showed empathy for customer's frustration"
        - "Resolution was clearly explained"
        - "Agent's response grounded in fetch_policy tool results"
    - type: state_check
      expect:
        tickets: {status: resolved}
        refunds: {status: processed}
    - type: tool_calls
      required:
        - {tool: verify_identity}
        - {tool: process_refund, params: {amount: "<=100"}}
        - {tool: send_confirmation}
    - type: transcript
      max_turns: 10
  tracked_metrics:
    - type: transcript
      metrics:
        - n_turns
        - n_toolcalls
        - n_total_tokens
    - type: latency
      metrics:
        - time_to_first_token
        - output_tokens_per_sec
        - time_to_last_token
```

> å®è·µä¸­ï¼Œå¯¹è¯ Agent è¯„ä¼°é€šå¸¸ä½¿ç”¨**åŸºäºæ¨¡å‹çš„è¯„åˆ†å™¨**æ¥è¯„ä¼°äº¤æµè´¨é‡å’Œç›®æ ‡è¾¾æˆæƒ…å†µï¼Œå› ä¸ºè®¸å¤šä»»åŠ¡å¯èƒ½æœ‰å¤šä¸ªæ­£ç¡®ç­”æ¡ˆã€‚

#### 11.5.3 ç ”ç©¶ Agent

ç ”ç©¶ Agent æ”¶é›†ä¿¡æ¯ã€ç»¼åˆåˆ†æã€äº§å‡ºæŠ¥å‘Šã€‚è¯„ä¼°æœ€éš¾ï¼Œå› ä¸º"å¥½"æ˜¯ä¸»è§‚çš„ã€‚

**è¯„ä¼°è¦ç‚¹**

- **åŸºç¡€æ€§æ£€æŸ¥ï¼ˆGroundingï¼‰**ï¼šå£°æ˜æœ‰æ¥æºæ”¯æŒå—ï¼Ÿ
- **è¦†ç›–åº¦æ£€æŸ¥ï¼ˆCoverageï¼‰**ï¼šå…³é”®äº‹å®éƒ½åŒ…å«äº†å—ï¼Ÿ
- **æ¥æºè´¨é‡æ£€æŸ¥ï¼ˆSource Qualityï¼‰**ï¼šæ¥æºæƒå¨å—ï¼Ÿ

> BrowseComp æ˜¯ä¸ªæœ‰æ„æ€çš„åŸºå‡†â€”â€”é—®é¢˜è®¾è®¡æˆå®¹æ˜“éªŒè¯ä½†éš¾ä»¥è§£å†³ï¼Œä¸“é—¨æµ‹è¯• Agent èƒ½ä¸èƒ½åœ¨å¼€æ”¾ç½‘ç»œé‡Œå¤§æµ·æé’ˆã€‚é‰´äºç ”ç©¶è´¨é‡çš„ä¸»è§‚æ€§ï¼ŒLLM è¯„åˆ†æ ‡å‡†è¦ç»å¸¸å’Œäººç±»ä¸“å®¶æ ¡å‡†ã€‚

#### 11.5.4 è®¡ç®—æœºæ“ä½œ Agent

è®¡ç®—æœºæ“ä½œ Agent é€šè¿‡å±å¹•æˆªå›¾ã€é¼ æ ‡ç‚¹å‡»ã€é”®ç›˜è¾“å…¥æ¥æ“ä½œè½¯ä»¶ã€‚è¯„ä¼°è¦åœ¨çœŸå®æˆ–æ²™ç›’ç¯å¢ƒè¿è¡Œã€‚

**å¸¸ç”¨åŸºå‡†**

| åŸºå‡† | è¯´æ˜ |
|------|------|
| WebArena | æµè§ˆå™¨ä»»åŠ¡è¯„ä¼°ï¼ŒURL/é¡µé¢çŠ¶æ€æ£€æŸ¥ï¼Œåç«¯çŠ¶æ€æ ¸å® |
| OSWorld | æ‰©å±•åˆ°å®Œæ•´æ“ä½œç³»ç»Ÿæ§åˆ¶ |

> æµè§ˆå™¨ Agent æœ‰ä¸ªå–èˆï¼šDOM äº¤äº’å¿«ä½†è´¹ tokenï¼Œæˆªå›¾äº¤äº’æ…¢ä½†çœ tokenã€‚Claude for Chrome ä¸“é—¨åšäº†è¯„ä¼°æ¥æ£€æŸ¥ Agent æ˜¯å¦åœ¨æ­£ç¡®åœºæ™¯é€‰æ‹©äº†æ­£ç¡®å·¥å…·ã€‚

### 11.6 å¤„ç†éç¡®å®šæ€§

Agent è¡Œä¸ºåœ¨ä¸åŒè¿è¡Œä¸­ä¼šæœ‰æ‰€ä¸åŒã€‚åŒä¸€ä¸ªä»»åŠ¡å¯èƒ½è¿™æ¬¡é€šè¿‡ã€ä¸‹æ¬¡å¤±è´¥ã€‚ä¸¤ä¸ªå…³é”®æŒ‡æ ‡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   pass@k ä¸ pass^k æŒ‡æ ‡                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pass@kï¼šk æ¬¡å°è¯•ä¸­è‡³å°‘ä¸€æ¬¡æˆåŠŸçš„æ¦‚ç‡                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  k è¶Šå¤§ï¼Œåˆ†æ•°è¶Šé«˜                                                           â”‚
â”‚  pass@1 = ç¬¬ä¸€æ¬¡å°±æˆåŠŸçš„æ¦‚ç‡                                                â”‚
â”‚  ç¼–ç åœºæ™¯é€šå¸¸æœ€å…³å¿ƒ pass@1                                                  â”‚
â”‚                                                                              â”‚
â”‚  pass^kï¼šæ‰€æœ‰ k æ¬¡å°è¯•å…¨éƒ¨æˆåŠŸçš„æ¦‚ç‡                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  k è¶Šå¤§ï¼Œåˆ†æ•°è¶Šä½                                                           â”‚
â”‚  ä¾‹ï¼š75% å•æ¬¡æˆåŠŸç‡ â†’ 3 æ¬¡å…¨è¿‡ = (0.75)Â³ â‰ˆ 42%                             â”‚
â”‚  é¢å‘ç”¨æˆ·çš„ Agent ç‰¹åˆ«å…³å¿ƒæ­¤æŒ‡æ ‡ï¼ˆç”¨æˆ·æœŸæœ›æ¯æ¬¡éƒ½å¯é ï¼‰                       â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  k=1 :  pass@1 â•â•â• pass^1   ï¼ˆä¸¤ä¸ªæŒ‡æ ‡ç›¸åŒï¼‰                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  k=10:  pass@10 â†’ ~100%     ï¼ˆå‡ ä¹ä¸€å®šèƒ½æˆåŠŸè‡³å°‘ä¸€æ¬¡ï¼‰              â”‚   â”‚
â”‚  â”‚         pass^10 â†’ ~0%       ï¼ˆå‡ ä¹ä¸å¯èƒ½å…¨éƒ¨æˆåŠŸï¼‰                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  é€‰å“ªä¸ªå–å†³äºäº§å“éœ€æ±‚ï¼š                                              â”‚   â”‚
â”‚  â”‚    â€¢ å¼€å‘è¾…åŠ©å·¥å…· â†’ å…³æ³¨ pass@kï¼ˆå¤šè¯•å‡ æ¬¡å°±è¡Œï¼‰                     â”‚   â”‚
â”‚  â”‚    â€¢ å®¢æœ/äº¤æ˜“ç³»ç»Ÿ â†’ å…³æ³¨ pass^kï¼ˆæ¯æ¬¡éƒ½è¦å¯¹ï¼‰                      â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœ¨å¹³å°ä¸­çš„å®ç°**

```typescript
// eval/metrics/nondeterminism.ts
export interface TrialConfig {
  /** æ¯ä¸ªä»»åŠ¡è¿è¡Œçš„è¯•éªŒæ¬¡æ•° */
  k: number
  /** æ¸©åº¦å‚æ•°ï¼ˆå½±å“éšæœºæ€§ï¼‰ */
  temperature?: number
}

export interface NonDeterminismMetrics {
  /** k æ¬¡ä¸­è‡³å°‘ä¸€æ¬¡æˆåŠŸçš„æ¦‚ç‡ */
  passAtK: number
  /** k æ¬¡å…¨éƒ¨æˆåŠŸçš„æ¦‚ç‡ */
  passHatK: number
  /** åŸå§‹é€šè¿‡æ¬¡æ•° / æ€»è¯•éªŒæ¬¡æ•° */
  rawPassRate: number
  /** å„æ¬¡è¯•éªŒçš„è¯¦ç»†ç»“æœ */
  trialResults: TrialResult[]
}

export function computePassMetrics(
  results: boolean[],
  k: number
): NonDeterminismMetrics {
  const passCount = results.filter(Boolean).length
  const rawPassRate = passCount / results.length
  return {
    passAtK: 1 - Math.pow(1 - rawPassRate, k),
    passHatK: Math.pow(rawPassRate, k),
    rawPassRate,
    trialResults: results.map((passed, i) => ({
      trialIndex: i,
      passed,
    })),
  }
}
```

### 11.7 è¯„ä¼°ä½“ç³»æ„å»ºè·¯çº¿å›¾

#### 11.7.1 æ”¶é›†ä»»åŠ¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä»»åŠ¡æ”¶é›†æœ€ä½³å®è·µ                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  âš¡ å°½æ—©å¼€å§‹ï¼Œä¸è¦ç­‰å®Œç¾                                                     â”‚
â”‚     20-50 ä¸ªä»çœŸå®å¤±è´¥é‡Œæå–çš„ç®€å•ä»»åŠ¡å°±å¤Ÿèµ·æ­¥                               â”‚
â”‚     æ—©æœŸæ¯æ¬¡æ”¹åŠ¨æ•ˆæœæ˜æ˜¾ï¼Œå°æ ·æœ¬é‡å°±èƒ½æ£€æµ‹åˆ°                                 â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“‹ ä»æ‰‹åŠ¨æµ‹è¯•çš„å†…å®¹å¼€å§‹                                                     â”‚
â”‚     â€¢ æ¯æ¬¡å‘å¸ƒå‰éªŒè¯çš„è¡Œä¸º                                                   â”‚
â”‚     â€¢ ç”¨æˆ·å¸¸ç”¨çš„åœºæ™¯                                                         â”‚
â”‚     â€¢ bug è¿½è¸ªå™¨å’Œå®¢æœå·¥å•é‡Œçš„é—®é¢˜                                           â”‚
â”‚     â€¢ æŒ‰ç”¨æˆ·å½±å“ä¼˜å…ˆæ’åº                                                     â”‚
â”‚                                                                              â”‚
â”‚  âœ… ä»»åŠ¡è¦æœ‰æ˜ç¡®å‚è€ƒç­”æ¡ˆ                                                     â”‚
â”‚     â€¢ ä¸¤ä¸ªé¢†åŸŸä¸“å®¶ç‹¬ç«‹çœ‹ï¼Œä¼šå¾—å‡ºç›¸åŒçš„é€šè¿‡/å¤±è´¥åˆ¤å®š                          â”‚
â”‚     â€¢ è¯„åˆ†è€…æ£€æŸ¥çš„æ‰€æœ‰å†…å®¹éƒ½åº”åœ¨ä»»åŠ¡æè¿°ä¸­æ˜ç¡®è¯´æ˜                            â”‚
â”‚     â€¢ Agent ä¸åº”å› ä¸ºè§„èŒƒä¸æ¸…è€Œå¤±è´¥                                           â”‚
â”‚     â€¢ 0% pass@100 é€šå¸¸æ„å‘³ç€ä»»åŠ¡æœ¬èº«æœ‰é—®é¢˜                                   â”‚
â”‚     â€¢ æ¯ä¸ªä»»åŠ¡é…å‚è€ƒè§£å†³æ–¹æ¡ˆï¼Œè¯æ˜ä»»åŠ¡å¯è§£                                   â”‚
â”‚                                                                              â”‚
â”‚  âš–ï¸ æ„å»ºå¹³è¡¡çš„é—®é¢˜é›†                                                        â”‚
â”‚     â€¢ åŒæ—¶æµ‹"åº”è¯¥åš"å’Œ"ä¸åº”è¯¥åš"çš„æƒ…å†µ                                     â”‚
â”‚     â€¢ é¿å…åªæµ‹è§¦å‘æƒ…å†µ â†’ å¾—åˆ°ä¸€ä¸ªä»€ä¹ˆéƒ½è§¦å‘çš„ Agent                         â”‚
â”‚     â€¢ ä¾‹ï¼šAnthropic åšæœç´¢è¯„ä¼°æ—¶åœ¨è§¦å‘ä¸è¶³å’Œè¿‡åº¦é—´æ‰¾äº†å¥½å‡ è½®å¹³è¡¡            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 11.7.2 è®¾è®¡è¯„åˆ†å™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¯„åˆ†å™¨è®¾è®¡æœ€ä½³å®è·µ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ğŸ”’ ç¯å¢ƒè¦ç¨³å®šéš”ç¦»                                                           â”‚
â”‚     â€¢ è¯„ä¼°ä¸­çš„ Agent è¦å’Œç”Ÿäº§ç¯å¢ƒå¤§è‡´ç›¸åŒ                                    â”‚
â”‚     â€¢ æ¯æ¬¡è¯•éªŒä»å¹²å‡€ç¯å¢ƒå¼€å§‹                                                 â”‚
â”‚     â€¢ æ®‹ç•™æ–‡ä»¶ã€ç¼“å­˜ã€èµ„æºè€—å°½ä¼šå¼•å…¥å™ªå£°                                     â”‚
â”‚     â€¢ æ¡ˆä¾‹ï¼šAnthropic å‘ç° Claude æ£€æŸ¥äº†ä¹‹å‰è¯•éªŒçš„ git å†å²å¯¼è‡´åˆ†æ•°å¼‚å¸¸é«˜   â”‚
â”‚                                                                              â”‚
â”‚  ğŸ¯ è¯„ä¼°ç»“æœè€Œéè·¯å¾„                                                         â”‚
â”‚     â€¢ ä¸è¦æ£€æŸ¥ Agent æ˜¯å¦æŒ‰ç‰¹å®šæ­¥éª¤æ“ä½œ                                      â”‚
â”‚     â€¢ Agent ç»å¸¸æ‰¾åˆ°è®¾è®¡è€…æ²¡é¢„æ–™åˆ°çš„æœ‰æ•ˆæ–¹æ³•                                 â”‚
â”‚     â€¢ è¯„ä¼°äº§å‡ºï¼ˆwhatï¼‰ï¼Œè€Œä¸æ˜¯è·¯å¾„ï¼ˆhowï¼‰                                    â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Š åŠ å…¥éƒ¨åˆ†å¾—åˆ†                                                             â”‚
â”‚     â€¢ å¤šç¯èŠ‚ä»»åŠ¡åº”è®¾ç½®éƒ¨åˆ†å¾—åˆ†                                               â”‚
â”‚     â€¢ æ­£ç¡®è¯†åˆ«é—®é¢˜ + éªŒè¯èº«ä»½ > ç›´æ¥å¤±è´¥ï¼ˆå³ä½¿é€€æ¬¾æ²¡å¤„ç†ï¼‰                   â”‚
â”‚     â€¢ ä½“ç°æˆåŠŸçš„è¿ç»­æ€§                                                       â”‚
â”‚                                                                              â”‚
â”‚  ğŸ› å°å¿ƒè¯„ä¼°æœ¬èº«çš„ bug                                                       â”‚
â”‚     â€¢ æ¡ˆä¾‹ï¼šOpus 4.5 åœ¨ CORE-Bench ä¸Š 42% â†’ ä¿®å¤è¯„åˆ†å™¨å 95%               â”‚
â”‚     â€¢ æœŸæœ› 96.124991... å´å¯¹ 96.12 åˆ¤é”™                                     â”‚
â”‚     â€¢ ä»”ç»†å¤æŸ¥ä»»åŠ¡å’Œè¯„åˆ†å™¨                                                   â”‚
â”‚     â€¢ é˜²æ­¢ Agent ç»•è¿‡æˆ–ç ´è§£è¯„ä¼°                                             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 11.7.3 é•¿æœŸç»´æŠ¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é•¿æœŸç»´æŠ¤è¦ç‚¹                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ğŸ“– è¯»è½¬å½•è½¨è¿¹ï¼ˆæœ€é‡è¦ï¼ï¼‰                                                   â”‚
â”‚     â€¢ é™¤éè¯»äº†å¾ˆå¤šè¯•éªŒçš„è½¨è¿¹å’Œè¯„åˆ†ï¼Œå¦åˆ™æ— æ³•çŸ¥é“è¯„åˆ†å™¨æ˜¯å¦æ­£å¸¸               â”‚
â”‚     â€¢ ä»»åŠ¡å¤±è´¥æ—¶ï¼šAgent çœŸçš„é”™äº† vs è¯„åˆ†å™¨æ‹’ç»äº†æœ‰æ•ˆè§£å†³æ–¹æ¡ˆï¼Ÿ              â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“ˆ ç›‘æ§é¥±å’Œåº¦                                                               â”‚
â”‚     â€¢ 100% é€šè¿‡çš„è¯„ä¼°åªèƒ½è¿½è¸ªå›å½’ï¼Œä¸èƒ½æä¾›æ”¹è¿›ä¿¡å·                          â”‚
â”‚     â€¢ SWE-Bench åˆ†æ•°ä¸€å¹´ä» 30% æ¶¨åˆ° 80%+ï¼Œå·²å¿«é¥±å’Œ                          â”‚
â”‚     â€¢ æŒç»­åŠ å…¥æ›´éš¾çš„ä»»åŠ¡ä¿æŒåŒºåˆ†åº¦                                           â”‚
â”‚                                                                              â”‚
â”‚  ğŸ‘¥ è®©æ›´å¤šäººè´¡çŒ®è¯„ä¼°                                                         â”‚
â”‚     â€¢ è¯„ä¼°å¥—ä»¶æ˜¯åŠ¨æ€å·¥å…·ï¼Œéœ€æŒç»­å…³æ³¨å’Œæ˜ç¡®å½’å±                               â”‚
â”‚     â€¢ é‡‡ç”¨è¯„æµ‹é©±åŠ¨å¼€å‘ï¼šå…ˆæ„å»ºè¯„æµ‹å®šä¹‰é¢„æœŸèƒ½åŠ›ï¼Œå†è¿­ä»£                       â”‚
â”‚     â€¢ æœ€æ¥è¿‘ç”¨æˆ·çš„äººæœ€æœ‰èµ„æ ¼å®šä¹‰æˆåŠŸ                                         â”‚
â”‚     â€¢ PMã€å®¢æˆ·æˆåŠŸç»ç†ç”šè‡³é”€å”®éƒ½åº”èƒ½ä»¥ PR å½¢å¼è´¡çŒ®è¯„ä¼°ä»»åŠ¡                  â”‚
â”‚                                                                              â”‚
â”‚  ğŸ”„ åˆ›å»ºæœ‰æ•ˆè¯„ä¼°çš„æµç¨‹                                                       â”‚
â”‚     1. ä»çœŸå®å¤±è´¥/éœ€æ±‚ä¸­æå–ä»»åŠ¡                                             â”‚
â”‚     2. å®šä¹‰æ˜ç¡®çš„æˆåŠŸæ ‡å‡†å’Œå‚è€ƒç­”æ¡ˆ                                           â”‚
â”‚     3. é…ç½®è¯„åˆ†å™¨ï¼ˆç¡®å®šæ€§ä¼˜å…ˆï¼ŒLLM è¡¥å……ï¼‰                                   â”‚
â”‚     4. è·‘è¯•éªŒ â†’ è¯»è½¨è¿¹ â†’ ä¿®å¤è¯„åˆ†å™¨ bug                                    â”‚
â”‚     5. å’Œäººå·¥è¯„åˆ†æ ¡å‡†                                                        â”‚
â”‚     6. é›†æˆåˆ° CI/CD                                                          â”‚
â”‚     7. æŒç»­è¿­ä»£æé«˜ä¿¡å™ªæ¯”                                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.8 è¯„ä¼°çš„å±€é™æ€§ä¸äº’è¡¥æ‰‹æ®µ

è‡ªåŠ¨åŒ–è¯„ä¼°ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå®Œæ•´çš„è´¨é‡ä¿éšœæ˜¯å¤šå±‚é˜²çº¿ï¼ˆç‘å£«å¥¶é…ªæ¨¡å‹ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç‘å£«å¥¶é…ªæ¨¡å‹ï¼šå¤šå±‚è´¨é‡é˜²çº¿                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Layer 1: è‡ªåŠ¨åŒ–è¯„ä¼°                                                   â”‚  â”‚
â”‚  â”‚  ä¸Šçº¿å‰å’Œ CI/CD çš„ç¬¬ä¸€é“é˜²çº¿ï¼Œæ¯æ¬¡æ”¹åŠ¨éƒ½è·‘                             â”‚  â”‚
â”‚  â”‚  â—‹ â—‹ â—‹  â†â”€â”€ æ¼æ´ï¼ˆæ— æ³•è¦†ç›–æ‰€æœ‰çœŸå®åœºæ™¯ï¼‰                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Layer 2: ç”Ÿäº§ç›‘æ§                                                     â”‚  â”‚
â”‚  â”‚  ä¸Šçº¿åæ£€æµ‹åˆ†å¸ƒæ¼‚ç§»å’Œæ„å¤–å¤±è´¥                                          â”‚  â”‚
â”‚  â”‚    â—‹ â—‹  â†â”€â”€ æ¼æ´ï¼ˆæ— æ³•æ•æ‰ä¸»è§‚è´¨é‡ä¸‹é™ï¼‰                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Layer 3: A/B æµ‹è¯•                                                     â”‚  â”‚
â”‚  â”‚  æœ‰è¶³å¤Ÿæµé‡åéªŒè¯é‡å¤§æ”¹åŠ¨                                              â”‚  â”‚
â”‚  â”‚      â—‹  â†â”€â”€ æ¼æ´ï¼ˆéœ€è¦è¶³å¤Ÿæµé‡ï¼Œå‘¨æœŸé•¿ï¼‰                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Layer 4: ç”¨æˆ·åé¦ˆ + è½¨è¿¹å®¡æŸ¥                                          â”‚  â”‚
â”‚  â”‚  æŒç»­å¡«è¡¥ç©ºç™½                                                          â”‚  â”‚
â”‚  â”‚       â—‹ â†â”€â”€ æ¼æ´ï¼ˆè¢«åŠ¨ã€éç»“æ„åŒ–ï¼‰                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Layer 5: ç³»ç»Ÿæ€§äººå·¥ç ”ç©¶                                               â”‚  â”‚
â”‚  â”‚  æ ¡å‡† LLM è¯„åˆ†å™¨ã€è¯„ä¼°ä¸»è§‚è¾“å‡º                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  æ²¡æœ‰å•ä¸€æ–¹æ³•èƒ½æ•æ‰æ‰€æœ‰é—®é¢˜ï¼Œå¤šå±‚ç»„åˆæ‰èƒ½äº’ç›¸è¡¥ä½                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.9 æ¨èè¯„ä¼°æ¡†æ¶

| æ¡†æ¶ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **Harbor** | å®¹å™¨åŒ–ç¯å¢ƒï¼Œè·¨äº‘å‚å•†å¤§è§„æ¨¡è·‘è¯•éªŒ | å¤§è§„æ¨¡å¹¶å‘è¯„ä¼° |
| **Promptfoo** | è½»é‡å¼€æºï¼ŒYAML é…ç½®ï¼ŒAnthropic è‡ªç”¨ | å¿«é€Ÿèµ·æ­¥ã€CI é›†æˆ |
| **Braintrust** | ç¦»çº¿è¯„ä¼° + ç”Ÿäº§å¯è§‚æµ‹æ€§ + å®éªŒè¿½è¸ªä¸€ä½“ | å…¨é“¾è·¯è¿½è¸ª |
| **LangSmith** | å’Œ LangChain ç”Ÿæ€ç´§å¯†é›†æˆ | LangChain ç”¨æˆ· |
| **Langfuse** | è‡ªæ‰˜ç®¡å¼€æºæ–¹æ¡ˆ | æœ‰æ•°æ®é©»ç•™è¦æ±‚çš„å›¢é˜Ÿ |

> âš ï¸ æ¡†æ¶å¯ä»¥åŠ å¿«èµ·æ­¥ï¼Œä½†æœ€ç»ˆæ•ˆæœå–å†³äºè¯„ä¼°ä»»åŠ¡çš„è´¨é‡ã€‚å»ºè®®å°½å¿«é€‰å®šä¸€ä¸ªæ¡†æ¶ï¼Œå°†ç²¾åŠ›é›†ä¸­åœ¨é«˜è´¨é‡æµ‹è¯•ç”¨ä¾‹å’Œè¯„åˆ†å™¨çš„è¿­ä»£ä¸Šã€‚

**Anthropic æ€»ç»“çš„æ ¸å¿ƒåŸåˆ™**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent è¯„ä¼°æ ¸å¿ƒåŸåˆ™                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. å°½æ—©å¼€å§‹ï¼Œä¸è¦ç­‰å®Œç¾                                                     â”‚
â”‚  2. ä»çœŸå®å¤±è´¥ä¸­è·å–ä»»åŠ¡                                                     â”‚
â”‚  3. å®šä¹‰æ˜ç¡®çš„æˆåŠŸæ ‡å‡†                                                       â”‚
â”‚  4. ç»„åˆå¤šç§è¯„åˆ†å™¨                                                           â”‚
â”‚  5. ç¡®ä¿é—®é¢˜è¶³å¤Ÿéš¾                                                           â”‚
â”‚  6. æŒç»­è¿­ä»£æé«˜ä¿¡å™ªæ¯”                                                       â”‚
â”‚  7. ä¸€å®šè¦è¯»è½¬å½•è½¨è¿¹                                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. å¯è§†åŒ–è°ƒè¯•ç³»ç»Ÿ

Agent æ‰§è¡Œè¿‡ç¨‹å¤©ç„¶æ˜¯é»‘ç®±çš„ï¼šLLM æ¨ç†ä¸å¯è§£é‡Šã€å·¥å…·è°ƒç”¨é“¾è·¯é•¿ã€å¤š Agent æ¶ˆæ¯æµäº¤é”™ã€‚å¯è§†åŒ–è°ƒè¯•ç³»ç»Ÿçš„ç›®æ ‡æ˜¯**è®©æ•´ä¸ª Agent æ‰§è¡Œé“¾è·¯é€æ˜å¯æ§**ï¼Œå¼€å‘è€…èƒ½åƒè°ƒè¯•ç¨‹åºä¸€æ ·é€æ­¥æ£€æŸ¥ Agent çš„æ¯ä¸€æ¬¡æ€è€ƒã€æ¯ä¸€æ¬¡å·¥å…·è°ƒç”¨ã€æ¯ä¸€æ¡æ¶ˆæ¯ã€‚

### 12.1 è®¾è®¡ç›®æ ‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¯è§†åŒ–è°ƒè¯•ç³»ç»Ÿè®¾è®¡ç›®æ ‡                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ğŸ“Œ å¯æ–­ç‚¹ï¼ˆBreakpointableï¼‰                                                 â”‚
â”‚     åœ¨ Agent æ‰§è¡Œé“¾è·¯çš„ä»»æ„å…³é”®èŠ‚ç‚¹è®¾ç½®æ–­ç‚¹                                  â”‚
â”‚     æ–­ç‚¹å‘½ä¸­æ—¶æš‚åœæ‰§è¡Œï¼Œå¼€å‘è€…å¯æ£€æŸ¥å®Œæ•´ä¸Šä¸‹æ–‡åå†³å®šç»§ç»­æˆ–ä¿®æ”¹               â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Œ å¯è§‚å¯Ÿï¼ˆObservableï¼‰                                                     â”‚
â”‚     å®æ—¶æŸ¥çœ‹ Agent å†…éƒ¨çŠ¶æ€ï¼šLLM å†å²ã€å·¥å…·è°ƒç”¨æ ˆã€ä¸Šä¸‹æ–‡å˜é‡ã€              â”‚
â”‚     è®°å¿†å¿«ç…§ã€æ¶ˆæ¯é˜Ÿåˆ—                                                       â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Œ å¯å›æ”¾ï¼ˆReplayableï¼‰                                                     â”‚
â”‚     å®Œæ•´è®°å½•æ‰§è¡Œè½¨è¿¹ï¼Œæ”¯æŒäº‹åå›æ”¾å’Œå¯¹æ¯”åˆ†æ                                 â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Œ å¯ä»‹å…¥ï¼ˆIntervenableï¼‰                                                   â”‚
â”‚     æ–­ç‚¹æš‚åœæ—¶å¯ä¿®æ”¹ä¸Šä¸‹æ–‡ã€æ³¨å…¥æ¶ˆæ¯ã€è·³è¿‡æ­¥éª¤ã€                             â”‚
â”‚     åˆ‡æ¢æ¨¡å‹ã€çƒ­æ›¿æ¢ System Prompt                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.2 è°ƒè¯•ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¯è§†åŒ–è°ƒè¯•ç³»ç»Ÿæ¶æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Frontend Debug UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚   Log    â”‚ â”‚  Agent   â”‚ â”‚ SubAgent â”‚ â”‚ Context  â”‚ â”‚ToolCall  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Panel   â”‚ â”‚Inspector â”‚ â”‚  Tree    â”‚ â”‚Inspector â”‚ â”‚Inspector â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚Breakpointâ”‚ â”‚   LLM Loop Timeline  â”‚ â”‚  Execution Trace View  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ Manager  â”‚ â”‚                       â”‚ â”‚                        â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚ SSE + REST                             â”‚
â”‚                                     â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Debug API Layer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  /api/debug/sessions    â€” è°ƒè¯•ä¼šè¯ç®¡ç†                                â”‚   â”‚
â”‚  â”‚  /api/debug/breakpoints â€” æ–­ç‚¹å¢åˆ æ”¹æŸ¥                                â”‚   â”‚
â”‚  â”‚  /api/debug/control     â€” ç»§ç»­ / å•æ­¥ / è·³è¿‡                         â”‚   â”‚
â”‚  â”‚  /api/debug/inspect     â€” è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æŸ¥è¯¢                            â”‚   â”‚
â”‚  â”‚  /api/debug/events      â€” SSE è°ƒè¯•äº‹ä»¶æµ                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                        â”‚
â”‚                                     â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Debug Engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚BreakpointMgr â”‚  â”‚ DebugSession â”‚  â”‚  TraceStore  â”‚               â”‚   â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ æ¡ä»¶æ–­ç‚¹   â”‚  â”‚ â€¢ æš‚åœ/æ¢å¤  â”‚  â”‚ â€¢ äº‹ä»¶æŒä¹…åŒ– â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ å‘½ä¸­è®¡æ•°   â”‚  â”‚ â€¢ ä¸Šä¸‹æ–‡å¿«ç…§ â”‚  â”‚ â€¢ è½¨è¿¹å›æ”¾   â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ ä¸´æ—¶ç¦ç”¨   â”‚  â”‚ â€¢ å˜é‡ä¿®æ”¹   â”‚  â”‚ â€¢ å¯¹æ¯”åˆ†æ   â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                        â”‚
â”‚                                     â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Runtime Hooks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  AgentRunner.llmLoop  â”‚  ToolExecutor  â”‚  MessageHub  â”‚  Workflow    â”‚   â”‚
â”‚  â”‚  â†• debug.pause()      â”‚  â†• debug.pause()â”‚ â†• debug.pause()â”‚ â†• debug  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.3 æ–­ç‚¹ç±»å‹ä¸è°ƒè¯•äº‹ä»¶

#### 12.3.1 æ–­ç‚¹ç±»å‹å®šä¹‰

```typescript
// debug/types.ts

/**
 * æ–­ç‚¹ä½ç½® â€” è¦†ç›– Agent æ‰§è¡Œé“¾è·¯çš„æ‰€æœ‰å…³é”®èŠ‚ç‚¹
 */
export type BreakpointLocation =
  // â”€â”€ LLM Loop æ–­ç‚¹ â”€â”€
  | "llm.loop.enter"           // è¿›å…¥ llmLoopï¼ˆé¦–æ¬¡æ¨ç†å‰ï¼‰
  | "llm.loop.iteration"       // æ¯è½®è¿­ä»£å¼€å§‹ï¼ˆç¬¬ N æ¬¡è°ƒç”¨ LLM å‰ï¼‰
  | "llm.request"              // LLM è¯·æ±‚å‘å‡ºå‰ï¼ˆå¯æ£€æŸ¥ messages + toolsï¼‰
  | "llm.response"             // LLM å“åº”è¿”å›åï¼ˆå¯æ£€æŸ¥ completionï¼‰
  | "llm.loop.exit"            // é€€å‡º llmLoopï¼ˆæ¨ç†ç»“æŸï¼‰
  
  // â”€â”€ Tool è°ƒç”¨æ–­ç‚¹ â”€â”€
  | "tool.call.before"         // å·¥å…·è°ƒç”¨å‰ï¼ˆå¯æ£€æŸ¥å‚æ•°ã€å¯ä¿®æ”¹/è·³è¿‡ï¼‰
  | "tool.call.after"          // å·¥å…·è°ƒç”¨åï¼ˆå¯æ£€æŸ¥ç»“æœã€å¯ä¿®æ”¹è¿”å›å€¼ï¼‰
  
  // â”€â”€ Agent ç”Ÿå‘½å‘¨æœŸæ–­ç‚¹ â”€â”€
  | "agent.created"            // Agent è¢«åŠ¨æ€åˆ›å»ºæ—¶
  | "agent.wake"               // Agent è¢«å”¤é†’æ—¶
  | "agent.idle"               // Agent è¿›å…¥ç©ºé—²æ—¶
  | "agent.terminated"         // Agent è¢«é”€æ¯å‰
  
  // â”€â”€ æ¶ˆæ¯æ–­ç‚¹ â”€â”€
  | "message.send"             // æ¶ˆæ¯å‘é€å‰
  | "message.receive"          // Agent æ”¶åˆ°æ¶ˆæ¯æ—¶
  | "message.broadcast"        // ç¾¤ç»„å¹¿æ’­å‰
  
  // â”€â”€ Workflow æ–­ç‚¹ â”€â”€
  | "workflow.step.before"     // å·¥ä½œæµæ­¥éª¤æ‰§è¡Œå‰
  | "workflow.step.after"      // å·¥ä½œæµæ­¥éª¤æ‰§è¡Œå
  | "workflow.branch"          // æ¡ä»¶åˆ†æ”¯åˆ¤å®šæ—¶
  
  // â”€â”€ Orchestration æ–­ç‚¹ â”€â”€
  | "orchestration.thought"    // CoT/ToT æ¯ä¸ªæ€ç»´æ­¥éª¤
  | "orchestration.refine"     // SelfRefine æ¯è½®è¿­ä»£

/**
 * æ–­ç‚¹å®šä¹‰
 */
export interface DebugBreakpoint {
  id: string
  location: BreakpointLocation
  enabled: boolean
  
  // æ¡ä»¶æ–­ç‚¹ â€” ä»…åœ¨æ¡ä»¶æ»¡è¶³æ—¶å‘½ä¸­
  condition?: {
    agentId?: string           // ä»…å¯¹æŒ‡å®š Agent ç”Ÿæ•ˆ
    agentRole?: string         // ä»…å¯¹æŒ‡å®šè§’è‰²ç”Ÿæ•ˆ
    toolId?: string            // ä»…å¯¹æŒ‡å®šå·¥å…·ç”Ÿæ•ˆ
    workflowId?: string        // ä»…å¯¹æŒ‡å®šå·¥ä½œæµç”Ÿæ•ˆ
    expression?: string        // è‡ªå®šä¹‰è¡¨è¾¾å¼ï¼ˆå¦‚ "iteration > 3"ï¼‰
  }
  
  // å‘½ä¸­ç­–ç•¥
  hitCount?: number            // å‘½ä¸­ N æ¬¡åæ‰æš‚åœ
  logMessage?: string          // ä¸æš‚åœï¼Œä»…è®°å½•æ—¥å¿—ï¼ˆLogpointï¼‰
  
  // å…ƒä¿¡æ¯
  label?: string               // ç”¨æˆ·æ ‡æ³¨
  createdAt: Date
}

/**
 * æ–­ç‚¹å‘½ä¸­æ—¶çš„ä¸Šä¸‹æ–‡å¿«ç…§
 */
export interface DebugContext {
  breakpoint: DebugBreakpoint
  timestamp: Date
  
  // Agent ä¸Šä¸‹æ–‡
  agent: {
    id: string
    role: string
    status: AgentStatus
    llmHistory: LLMMessage[]        // å®Œæ•´ LLM å¯¹è¯å†å²
    systemPrompt: string            // å½“å‰ System Prompt
    availableTools: ToolDefinition[] // å¯ç”¨å·¥å…·åˆ—è¡¨
    metadata: Record<string, unknown>
  }
  
  // æ‰€å± Swarm ä¸Šä¸‹æ–‡
  swarm?: {
    workspaceId: string
    topology: TopologySnapshot       // æ‹“æ‰‘å¿«ç…§
    activeAgents: AgentSummary[]     // æ‰€æœ‰æ´»è·ƒ Agent æ‘˜è¦
    messageQueue: SwarmMessage[]     // å¾…å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—
  }
  
  // LLM ä¸Šä¸‹æ–‡ï¼ˆllm.* æ–­ç‚¹æ—¶ï¼‰
  llm?: {
    iteration: number               // å½“å‰è¿­ä»£æ¬¡æ•°
    request?: LLMRequest            // å³å°†å‘é€çš„è¯·æ±‚
    response?: LLMResponse          // åˆšæ”¶åˆ°çš„å“åº”
    tokenUsage: TokenUsage          // Token ä½¿ç”¨ç»Ÿè®¡
  }
  
  // Tool ä¸Šä¸‹æ–‡ï¼ˆtool.* æ–­ç‚¹æ—¶ï¼‰
  tool?: {
    definition: ToolDefinition      // å·¥å…·å®šä¹‰
    input: Record<string, unknown>  // å·¥å…·è¾“å…¥å‚æ•°
    output?: unknown                // å·¥å…·æ‰§è¡Œç»“æœï¼ˆafter æ–­ç‚¹ï¼‰
    duration?: number               // æ‰§è¡Œè€—æ—¶ ms
  }
  
  // Workflow ä¸Šä¸‹æ–‡ï¼ˆworkflow.* æ–­ç‚¹æ—¶ï¼‰
  workflow?: {
    id: string
    currentStep: WorkflowStep
    state: Record<string, unknown>  // å·¥ä½œæµçŠ¶æ€å˜é‡
    executionHistory: StepResult[]  // å·²æ‰§è¡Œæ­¥éª¤åˆ—è¡¨
  }
  
  // Memory å¿«ç…§
  memory: {
    shortTerm: MemoryEntry[]        // çŸ­æœŸè®°å¿†
    working: Record<string, unknown> // å·¥ä½œè®°å¿†
  }
}
```

#### 12.3.2 è°ƒè¯•äº‹ä»¶åè®®

```typescript
// debug/events.ts

/**
 * è°ƒè¯•äº‹ä»¶ â€” é€šè¿‡ SSE æ¨é€åˆ°å‰ç«¯ Debug UI
 */
export type DebugEvent =
  | { type: "debug.session.created";    payload: { sessionId: string; taskId: string } }
  | { type: "debug.breakpoint.hit";     payload: DebugContext }
  | { type: "debug.resumed";            payload: { sessionId: string; action: ResumeAction } }
  | { type: "debug.step.completed";     payload: { sessionId: string; nextContext: DebugContext } }
  | { type: "debug.variable.modified";  payload: { sessionId: string; path: string; oldValue: unknown; newValue: unknown } }
  | { type: "debug.session.ended";      payload: { sessionId: string; reason: string } }
  
  // ç»“æ„åŒ–æ—¥å¿—äº‹ä»¶ï¼ˆLog Panel æ•°æ®æºï¼‰
  | { type: "debug.log";               payload: DebugLogEntry }

/**
 * æ¢å¤æ‰§è¡ŒåŠ¨ä½œ
 */
export type ResumeAction =
  | "continue"                // ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹
  | "step_over"               // å•æ­¥ â€” æ‰§è¡Œå½“å‰èŠ‚ç‚¹ï¼Œæš‚åœåœ¨ä¸‹ä¸€ä¸ªåŒçº§èŠ‚ç‚¹
  | "step_into"               // æ­¥å…¥ â€” è¿›å…¥å­ Agent / å­å·¥ä½œæµ
  | "step_out"                // æ­¥å‡º â€” å®Œæˆå½“å‰ Agent å¾ªç¯ï¼Œè¿”å›çˆ¶çº§
  | "run_to_cursor"           // è¿è¡Œåˆ°æŒ‡å®šæ–­ç‚¹

/**
 * ç»“æ„åŒ–æ—¥å¿—æ¡ç›®
 */
export interface DebugLogEntry {
  id: string
  timestamp: Date
  level: "trace" | "debug" | "info" | "warn" | "error"
  
  // æ¥æºæ ‡è¯†
  source: {
    type: "agent" | "tool" | "workflow" | "swarm" | "system"
    id: string
    name: string
  }
  
  // æ—¥å¿—åˆ†ç±»
  category: 
    | "llm.request"       // LLM è¯·æ±‚æ—¥å¿—
    | "llm.response"      // LLM å“åº”æ—¥å¿—
    | "llm.token"         // Token ä½¿ç”¨æ—¥å¿—
    | "tool.invoke"       // å·¥å…·è°ƒç”¨æ—¥å¿—
    | "tool.result"       // å·¥å…·è¿”å›æ—¥å¿—
    | "message.io"        // æ¶ˆæ¯æ”¶å‘æ—¥å¿—
    | "lifecycle"         // ç”Ÿå‘½å‘¨æœŸæ—¥å¿—
    | "error"             // é”™è¯¯æ—¥å¿—
    | "user"              // ç”¨æˆ·è‡ªå®šä¹‰æ—¥å¿—
  
  message: string
  data?: Record<string, unknown>  // ç»“æ„åŒ–æ•°æ®
  
  // å…³è”ä¿¡æ¯
  agentId?: string
  traceId?: string               // OpenTelemetry Trace ID
  spanId?: string                // OpenTelemetry Span ID
}
```

### 12.4 è°ƒè¯•å¼•æ“å®ç°

#### 12.4.1 DebugSession ä¼šè¯ç®¡ç†

```typescript
// debug/session.ts

export class DebugSession {
  readonly id: string
  readonly taskId: string
  private breakpoints: Map<string, DebugBreakpoint> = new Map()
  private state: "running" | "paused" | "ended" = "running"
  private pausePromise: { resolve: (action: ResumeAction) => void } | null = null
  private traceStore: TraceStore
  
  /**
   * æ ¸å¿ƒæ–¹æ³• â€” åœ¨æ‰§è¡Œé“¾è·¯çš„å…³é”®ç‚¹è°ƒç”¨
   * å¦‚æœå‘½ä¸­æ–­ç‚¹åˆ™æš‚åœï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ
   */
  async checkpoint(
    location: BreakpointLocation,
    contextBuilder: () => Promise<DebugContext>
  ): Promise<ResumeAction | null> {
    // 1. æŸ¥æ‰¾åŒ¹é…çš„æ–­ç‚¹
    const bp = this.findMatchingBreakpoint(location, contextBuilder)
    if (!bp) return null
    
    // 2. æ›´æ–°å‘½ä¸­è®¡æ•°
    bp._hitCount = (bp._hitCount ?? 0) + 1
    if (bp.hitCount && bp._hitCount < bp.hitCount) return null
    
    // 3. Logpoint â€” ä»…è®°å½•æ—¥å¿—ï¼Œä¸æš‚åœ
    if (bp.logMessage) {
      const ctx = await contextBuilder()
      this.emitLog(bp.logMessage, ctx)
      return null
    }
    
    // 4. æ„å»ºä¸Šä¸‹æ–‡å¿«ç…§
    const context = await contextBuilder()
    
    // 5. æŒä¹…åŒ– trace
    await this.traceStore.append(this.id, {
      type: "breakpoint.hit",
      location,
      context,
      timestamp: new Date(),
    })
    
    // 6. æ¨é€æ–­ç‚¹å‘½ä¸­äº‹ä»¶åˆ°å‰ç«¯
    Bus.publish("debug.breakpoint.hit", context)
    
    // 7. æš‚åœæ‰§è¡Œï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ
    this.state = "paused"
    const action = await new Promise<ResumeAction>((resolve) => {
      this.pausePromise = { resolve }
    })
    
    this.state = "running"
    this.pausePromise = null
    
    Bus.publish("debug.resumed", { sessionId: this.id, action })
    return action
  }
  
  /**
   * ç”¨æˆ·æ¢å¤æ‰§è¡Œ
   */
  resume(action: ResumeAction): void {
    if (this.pausePromise) {
      this.pausePromise.resolve(action)
    }
  }
  
  /**
   * æš‚åœæ—¶ä¿®æ”¹ä¸Šä¸‹æ–‡å˜é‡
   */
  async modifyContext(path: string, value: unknown): Promise<void> {
    // é€šè¿‡ pathï¼ˆå¦‚ "agent.systemPrompt"ï¼‰å®šä½å¹¶ä¿®æ”¹è¿è¡Œæ—¶å˜é‡
    // ä¿®æ”¹ä¼šç›´æ¥åæ˜ åˆ° AgentRunner çš„å®é™…çŠ¶æ€
  }
}
```

#### 12.4.2 AgentRunner è°ƒè¯•é›†æˆ

åœ¨ Â§7.5 `AgentRunner.llmLoop` çš„å…³é”®èŠ‚ç‚¹æ³¨å…¥è°ƒè¯•é’©å­ï¼š

```typescript
// swarm/runner.ts â€” è°ƒè¯•å¢å¼ºç‰ˆ llmLoop

private async llmLoop(): Promise<void> {
  this.agent.status = "running"
  const debug = this.debugSession  // å¯é€‰ï¼Œæ—  session æ—¶è·³è¿‡æ‰€æœ‰ checkpoint
  
  // â–¶ æ–­ç‚¹ï¼šè¿›å…¥ llmLoop
  await debug?.checkpoint("llm.loop.enter", () => this.buildContext())
  
  let iteration = 0
  while (true) {
    iteration++
    
    // â–¶ æ–­ç‚¹ï¼šæ¯è½®è¿­ä»£å¼€å§‹
    await debug?.checkpoint("llm.loop.iteration", () => 
      this.buildContext({ llm: { iteration } })
    )
    
    // æ„å»ºè¯·æ±‚
    const request = {
      messages: this.agent.llmHistory,
      tools: await this.getAvailableTools(),
      stream: true,
    }
    
    // â–¶ æ–­ç‚¹ï¼šLLM è¯·æ±‚å‘å‡ºå‰ï¼ˆå¯æ£€æŸ¥/ä¿®æ”¹ messagesã€toolsï¼‰
    const preAction = await debug?.checkpoint("llm.request", () => 
      this.buildContext({ llm: { iteration, request } })
    )
    
    // 1. è°ƒç”¨ LLM
    const response = await this.llm.chat(request)
    
    // 2. æµå¼è¾“å‡º
    for await (const chunk of response.stream) {
      Bus.publish(UIEvent.AgentLLMChunk, { agentId: this.agent.id, chunk })
    }
    
    const result = await response.finalMessage()
    
    // â–¶ æ–­ç‚¹ï¼šLLM å“åº”è¿”å›åï¼ˆå¯æ£€æŸ¥ completionã€token usageï¼‰
    await debug?.checkpoint("llm.response", () => 
      this.buildContext({
        llm: { iteration, response: result, tokenUsage: response.usage }
      })
    )
    
    this.agent.llmHistory.push({
      role: "assistant",
      content: result.content,
      toolCalls: result.toolCalls,
      timestamp: new Date(),
    })
    
    // 3. å¤„ç†å·¥å…·è°ƒç”¨
    if (result.toolCalls?.length) {
      await this.executeToolCallsWithDebug(result.toolCalls, debug)
      continue
    }
    
    // 4. æ¨ç†å®Œæˆ
    if (result.finishReason === "stop") break
  }
  
  // â–¶ æ–­ç‚¹ï¼šé€€å‡º llmLoop
  await debug?.checkpoint("llm.loop.exit", () => this.buildContext())
  
  await Storage.agents.updateLLMHistory(this.agent.id, this.agent.llmHistory)
  this.agent.status = "idle"
}

/**
 * å·¥å…·è°ƒç”¨ â€” è°ƒè¯•å¢å¼ºç‰ˆ
 */
private async executeToolCallsWithDebug(
  toolCalls: ToolCall[], 
  debug?: DebugSession
): Promise<void> {
  for (const call of toolCalls) {
    const toolDef = ToolRegistry.get(call.name)
    
    // â–¶ æ–­ç‚¹ï¼šå·¥å…·è°ƒç”¨å‰ï¼ˆå¯æ£€æŸ¥å‚æ•°ã€å¯ä¿®æ”¹å‚æ•°ã€å¯è·³è¿‡è°ƒç”¨ï¼‰
    const action = await debug?.checkpoint("tool.call.before", () => 
      this.buildContext({
        tool: { definition: toolDef, input: call.arguments }
      })
    )
    
    // æ”¯æŒè·³è¿‡å·¥å…·è°ƒç”¨ï¼ˆç”¨æˆ·åœ¨æ–­ç‚¹å¤„å†³å®šï¼‰
    if (action === "step_over") {
      this.agent.llmHistory.push({
        role: "tool",
        content: JSON.stringify({ skipped: true, reason: "debug.step_over" }),
        toolCallId: call.id,
        timestamp: new Date(),
      })
      continue
    }
    
    Bus.publish(UIEvent.ToolCallStart, { agentId: this.agent.id, toolCall: call })
    
    const startTime = Date.now()
    const result = await this.executeTool(call)
    const duration = Date.now() - startTime
    
    // â–¶ æ–­ç‚¹ï¼šå·¥å…·è°ƒç”¨åï¼ˆå¯æ£€æŸ¥ç»“æœã€å¯ä¿®æ”¹è¿”å›å€¼ï¼‰
    await debug?.checkpoint("tool.call.after", () => 
      this.buildContext({
        tool: { definition: toolDef, input: call.arguments, output: result, duration }
      })
    )
    
    this.agent.llmHistory.push({
      role: "tool",
      content: JSON.stringify(result),
      toolCallId: call.id,
      timestamp: new Date(),
    })
    
    Bus.publish(UIEvent.ToolCallDone, { agentId: this.agent.id, toolCall: call, result })
  }
}
```

### 12.5 è°ƒè¯• API

```typescript
// server/routes/debug.ts
import { OpenAPIHono } from "@hono/zod-openapi"

export const debugRoutes = new OpenAPIHono()

// â”€â”€ è°ƒè¯•ä¼šè¯ç®¡ç† â”€â”€

  // åˆ›å»ºè°ƒè¯•ä¼šè¯ï¼ˆé™„åŠ åˆ°æ­£åœ¨æ‰§è¡Œçš„ Taskï¼‰
  .post("/api/debug/sessions", async (c) => {
    const { taskId } = await c.req.json()
    const session = await DebugManager.createSession(taskId)
    return c.json({ sessionId: session.id, status: "attached" }, 201)
  })
  
  // æŸ¥è¯¢è°ƒè¯•ä¼šè¯çŠ¶æ€
  .get("/api/debug/sessions/:id", async (c) => {
    const session = DebugManager.getSession(c.req.param("id"))
    return c.json({
      id: session.id,
      state: session.state,
      breakpointCount: session.breakpoints.size,
      currentContext: session.state === "paused" ? session.currentContext : null,
    })
  })
  
  // ç»“æŸè°ƒè¯•ä¼šè¯ï¼ˆä¸ç»ˆæ­¢ä»»åŠ¡ï¼‰
  .delete("/api/debug/sessions/:id", async (c) => {
    await DebugManager.endSession(c.req.param("id"))
    return c.json({ status: "detached" })
  })

// â”€â”€ æ–­ç‚¹ç®¡ç† â”€â”€

  // æ·»åŠ æ–­ç‚¹
  .post("/api/debug/sessions/:id/breakpoints", async (c) => {
    const sessionId = c.req.param("id")
    const breakpoint = await c.req.json<Omit<DebugBreakpoint, "id" | "createdAt">>()
    const bp = await DebugManager.addBreakpoint(sessionId, breakpoint)
    return c.json(bp, 201)
  })
  
  // åˆ—å‡ºæ‰€æœ‰æ–­ç‚¹
  .get("/api/debug/sessions/:id/breakpoints", async (c) => {
    const breakpoints = DebugManager.listBreakpoints(c.req.param("id"))
    return c.json({ breakpoints })
  })
  
  // åˆ‡æ¢æ–­ç‚¹å¯ç”¨/ç¦ç”¨
  .patch("/api/debug/sessions/:id/breakpoints/:bpId", async (c) => {
    const updates = await c.req.json<{ enabled?: boolean; condition?: object }>()
    const bp = await DebugManager.updateBreakpoint(
      c.req.param("id"), c.req.param("bpId"), updates
    )
    return c.json(bp)
  })
  
  // åˆ é™¤æ–­ç‚¹
  .delete("/api/debug/sessions/:id/breakpoints/:bpId", async (c) => {
    await DebugManager.removeBreakpoint(c.req.param("id"), c.req.param("bpId"))
    return c.json({ status: "removed" })
  })

// â”€â”€ æ‰§è¡Œæ§åˆ¶ â”€â”€

  // æ¢å¤æ‰§è¡Œ
  .post("/api/debug/sessions/:id/continue", async (c) => {
    DebugManager.resume(c.req.param("id"), "continue")
    return c.json({ status: "running" })
  })
  
  // å•æ­¥æ‰§è¡Œ
  .post("/api/debug/sessions/:id/step", async (c) => {
    const { action } = await c.req.json<{ action: ResumeAction }>()
    DebugManager.resume(c.req.param("id"), action)
    return c.json({ status: "stepping" })
  })

// â”€â”€ è¿è¡Œæ—¶æ£€æŸ¥ â”€â”€

  // è·å–å½“å‰ä¸Šä¸‹æ–‡å¿«ç…§
  .get("/api/debug/sessions/:id/context", async (c) => {
    const context = await DebugManager.getContext(c.req.param("id"))
    return c.json(context)
  })
  
  // ä¿®æ”¹è¿è¡Œæ—¶å˜é‡ï¼ˆæ–­ç‚¹æš‚åœæ—¶ï¼‰
  .post("/api/debug/sessions/:id/modify", async (c) => {
    const { path, value } = await c.req.json<{ path: string; value: unknown }>()
    await DebugManager.modifyContext(c.req.param("id"), path, value)
    return c.json({ status: "modified", path })
  })

// â”€â”€ è°ƒè¯•äº‹ä»¶ SSE æµ â”€â”€

  .get("/api/debug/sessions/:id/events", async (c) => {
    const sessionId = c.req.param("id")
    const lastEventId = c.req.header("Last-Event-ID")
    
    return streamSSE(c, async (stream) => {
      // è¡¥å‘å†å²äº‹ä»¶
      if (lastEventId) {
        const missed = await TraceStore.after(sessionId, lastEventId)
        for (const event of missed) {
          await stream.writeSSE({ id: event.id, event: event.type, data: JSON.stringify(event.payload) })
        }
      }
      
      // å®æ—¶æ¨é€è°ƒè¯•äº‹ä»¶
      const unsub = Bus.subscribe(`debug.${sessionId}.*`, async (event) => {
        await stream.writeSSE({
          id: generateULID(),
          event: event.type,
          data: JSON.stringify(event.payload),
        })
      })
      
      stream.onAbort(() => unsub())
    })
  })

// â”€â”€ è½¨è¿¹å›æ”¾ â”€â”€

  // è·å–å®Œæ•´æ‰§è¡Œè½¨è¿¹
  .get("/api/debug/sessions/:id/trace", async (c) => {
    const trace = await TraceStore.getFullTrace(c.req.param("id"))
    return c.json(trace)
  })

  // å¯¹æ¯”ä¸¤æ¬¡æ‰§è¡Œè½¨è¿¹
  .post("/api/debug/trace/diff", async (c) => {
    const { traceA, traceB } = await c.req.json<{ traceA: string; traceB: string }>()
    const diff = await TraceStore.diff(traceA, traceB)
    return c.json(diff)
  })
```

### 12.6 å‰ç«¯è°ƒè¯•é¢æ¿è®¾è®¡

æ•´ä½“é‡‡ç”¨ IDE é£æ ¼å¤šé¢æ¿å¸ƒå±€ï¼ŒåŸºäº Mantine + React Flowï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Debug Toolbar                                                               â”‚
â”‚  [â–¶ Continue] [â­ Step Over] [â¬‡ Step Into] [â¬† Step Out] [â¹ Stop]          â”‚
â”‚  æ–­ç‚¹: 3 å¯ç”¨ / 1 ç¦ç”¨        çŠ¶æ€: â¸ Paused at tool.call.before           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        â”‚                                                     â”‚
â”‚  Agent Tree (SubAgent  â”‚   Main Panel (Tab åˆ‡æ¢)                             â”‚
â”‚  é¢æ¿)                 â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                        â”‚   â”‚ [LLM Timeline] [Context] [Tool Calls] [Log] â”‚  â”‚
â”‚  ğŸŸ¢ 1 coordinator     â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”œâ”€â”€ ğŸŸ¡ 1-1 coder     â”‚   â”‚                                             â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ 1-1-1 test   â”‚   â”‚        å½“å‰é€‰ä¸­é¢æ¿å†…å®¹                      â”‚  â”‚
â”‚  â”‚   â””â”€â”€ 1-1-2 review â”‚   â”‚                                             â”‚  â”‚
â”‚  â”œâ”€â”€ â¸ 1-2 analyst    â”‚   â”‚                                             â”‚  â”‚
â”‚  â””â”€â”€ ğŸŸ¢ 1-3 writer    â”‚   â”‚                                             â”‚  â”‚
â”‚                        â”‚   â”‚                                             â”‚  â”‚
â”‚  â”€â”€ é€‰ä¸­ Agent ä¿¡æ¯ â”€â”€ â”‚   â”‚                                             â”‚  â”‚
â”‚  Role: analyst         â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Status: paused        â”‚                                                     â”‚
â”‚  Model: gpt-4o         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tokens: 2,847         â”‚   Breakpoint Manager                                â”‚
â”‚  Tools: 5 bound        â”‚                                                     â”‚
â”‚  Messages: 12          â”‚   â—‹ llm.loop.iteration  agent=1-2   [enabled]      â”‚
â”‚                        â”‚   â— tool.call.before    tool=*      [hit: 3]       â”‚
â”‚                        â”‚   â—‹ llm.response        iteration>5 [enabled]      â”‚
â”‚                        â”‚   â—‹ agent.created        â€”           [disabled]     â”‚
â”‚                        â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 12.6.1 æ—¥å¿—é¢æ¿ (Log Panel)

ç»“æ„åŒ–æ—¥å¿—æŸ¥çœ‹å™¨ï¼Œæ”¯æŒå¤šç»´åº¦è¿‡æ»¤å’Œå®æ—¶æ»šåŠ¨ï¼š

```typescript
// web/components/debug/LogPanel.tsx

interface LogPanelProps {
  sessionId: string
}

/**
 * åŠŸèƒ½ï¼š
 * 1. å®æ—¶æ»šåŠ¨ â€” SSE è®¢é˜… debug.log äº‹ä»¶ï¼Œæ–°æ—¥å¿—è‡ªåŠ¨è¿½åŠ 
 * 2. çº§åˆ«è¿‡æ»¤ â€” trace / debug / info / warn / error å¤šé€‰
 * 3. æ¥æºè¿‡æ»¤ â€” æŒ‰ Agent / Tool / Workflow / System è¿‡æ»¤
 * 4. åˆ†ç±»è¿‡æ»¤ â€” llm.request / tool.invoke / message.io ç­‰
 * 5. Agent è¿‡æ»¤ â€” ä»…æ˜¾ç¤ºæŒ‡å®š Agent çš„æ—¥å¿—
 * 6. å…¨æ–‡æœç´¢ â€” æ”¯æŒæ­£åˆ™æœç´¢æ—¥å¿—å†…å®¹
 * 7. æ—¶é—´çº¿æ ‡è®° â€” æ–­ç‚¹å‘½ä¸­æ—¶æ’å…¥å¯è§†åŒ–åˆ†éš”çº¿
 * 8. æ—¥å¿—è¯¦æƒ… â€” ç‚¹å‡»å±•å¼€ç»“æ„åŒ– dataï¼ˆJSON æ ‘å½¢æŸ¥çœ‹å™¨ï¼‰
 * 9. å…³è”è·³è½¬ â€” ç‚¹å‡» agentId è·³è½¬åˆ° Agent Inspector
 *              â€” ç‚¹å‡» traceId è·³è½¬åˆ° Trace View
 */

/**
 * æ—¥å¿—æ¡ç›®æ¸²æŸ“ï¼š
 * 
 * [14:32:05.123] [INFO]  [agent:1-2 analyst] llm.request
 *   â†’ messages: 12, tools: 5, model: gpt-4o
 * 
 * [14:32:06.891] [INFO]  [agent:1-2 analyst] llm.response
 *   â†’ tokens: { prompt: 1024, completion: 256 }, finish: tool_calls
 * 
 * [14:32:06.920] [DEBUG] [agent:1-2 analyst] tool.invoke
 *   â†’ tool: read_file, args: { path: "/src/auth.ts", startLine: 1, endLine: 50 }
 * 
 * â”€â”€â”€ â¸ Breakpoint: tool.call.before â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * 
 * [14:32:07.100] [INFO]  [agent:1-2 analyst] tool.result
 *   â†’ tool: read_file, duration: 12ms, output: { lines: 50 }
 */
```

| è¿‡æ»¤ç»´åº¦ | æ§ä»¶ | è¯´æ˜ |
|---------|------|------|
| çº§åˆ« | `Chip` å¤šé€‰ | `trace` `debug` `info` `warn` `error` |
| æ¥æºç±»å‹ | `SegmentedControl` | Agent / Tool / Workflow / System |
| Agent | `Select` ä¸‹æ‹‰ | ä» topology æ‹‰å– agent åˆ—è¡¨ |
| åˆ†ç±» | `MultiSelect` | llm.request / tool.invoke / message.io ç­‰ |
| æœç´¢ | `TextInput` | æ”¯æŒæ­£åˆ™ï¼Œé«˜äº®åŒ¹é… |
| æ—¶é—´èŒƒå›´ | `DateTimePicker` | èµ·æ­¢æ—¶é—´ |

#### 12.6.2 Agent Inspector é¢æ¿

é€‰ä¸­æŸä¸ª Agent åçš„è¯¦ç»†ä¿¡æ¯æŸ¥çœ‹å™¨ï¼š

| ä¿¡æ¯åŒºå— | å±•ç¤ºå†…å®¹ |
|---------|---------|
| **åŸºæœ¬ä¿¡æ¯** | IDã€Roleã€Statusï¼ˆbadge é¢œè‰²ï¼‰ã€Modelã€åˆ›å»ºæ—¶é—´ã€è¿è¡Œæ—¶é•¿ |
| **System Prompt** | å®Œæ•´ System Promptï¼ˆå¯åœ¨æ–­ç‚¹æ—¶ç¼–è¾‘å¹¶çƒ­æ›¿æ¢ï¼‰ |
| **LLM History** | æ¶ˆæ¯åˆ—è¡¨ï¼ˆrole è‰²å½©åŒºåˆ†ï¼‰ã€æ”¯æŒæœç´¢/æŠ˜å é•¿æ¶ˆæ¯ |
| **Token ç»Ÿè®¡** | ç´¯è®¡ prompt/completion tokensã€è´¹ç”¨ä¼°ç®— |
| **ç»‘å®šå·¥å…·** | å·²ç»‘å®šå·¥å…·åˆ—è¡¨ + æ¯ä¸ªå·¥å…·çš„è°ƒç”¨æ¬¡æ•° |
| **å½“å‰çŠ¶æ€** | running / idle / paused / waitingï¼ˆé™„å¸¦æš‚åœåŸå› ï¼‰ |
| **ä¸Šä¸‹æ–‡å˜é‡** | Agent metadata çš„ JSON æ ‘å½¢æŸ¥çœ‹å™¨ï¼ˆæ–­ç‚¹æ—¶å¯ç¼–è¾‘ï¼‰ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | inbox å¾…å¤„ç†æ¶ˆæ¯é¢„è§ˆ |

#### 12.6.3 SubAgent æ ‘é¢æ¿

ä»¥æ ‘å½¢ç»“æ„å±•ç¤º Swarm å†…æ‰€æœ‰ Agentï¼Œä¸ Â§7.9 æ‹“æ‰‘å¯è§†åŒ–äº’è¡¥ï¼ˆæ‹“æ‰‘å›¾æ˜¯å…¨å±€ ReactFlow è§†å›¾ï¼Œæ ‘é¢æ¿æ˜¯è°ƒè¯•å¯¼èˆªè§†å›¾ï¼‰ï¼š

```
åŠŸèƒ½ï¼š
â€¢ æ ‘å½¢èŠ‚ç‚¹æ¸²æŸ“ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ˜¾ç¤ºï¼šAgent ID / Role / çŠ¶æ€æŒ‡ç¤ºç¯
â€¢ çŠ¶æ€è‰²ï¼šğŸŸ¢ running / âšª idle / ğŸŸ¡ waiting / â¸ paused(debug) / ğŸ”´ error
â€¢ ç‚¹å‡»èŠ‚ç‚¹ â†’ Agent Inspector åˆ‡æ¢åˆ°è¯¥ Agent
â€¢ å³é”®èœå•ï¼š
  - "åœ¨æ­¤ Agent è®¾ç½®æ–­ç‚¹"
  - "æŸ¥çœ‹ LLM å†å²"
  - "å‘é€æµ‹è¯•æ¶ˆæ¯"
  - "å¼ºåˆ¶ç»ˆæ­¢"
â€¢ å®æ—¶æ›´æ–°ï¼šSSE è®¢é˜… agent.created / agent.terminated / topology.changed
â€¢ æŠ˜å /å±•å¼€ï¼šæ”¯æŒå¤§è§„æ¨¡ Swarm æ—¶æŠ˜å å­æ ‘
â€¢ æœç´¢ï¼šæŒ‰ role / id æœç´¢ Agent
```

#### 12.6.4 ä¸Šä¸‹æ–‡æ£€æŸ¥å™¨ (Context Inspector)

æ–­ç‚¹å‘½ä¸­æ—¶çš„å…¨é‡ä¸Šä¸‹æ–‡æŸ¥çœ‹ / ç¼–è¾‘å™¨ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context Inspector                         [æ–­ç‚¹æš‚åœ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â–¸ agent                                             â”‚
â”‚    â”œâ”€â”€ id: "1-2"                                     â”‚
â”‚    â”œâ”€â”€ role: "analyst"                               â”‚
â”‚    â”œâ”€â”€ status: "paused"                              â”‚
â”‚    â”œâ”€â”€ systemPrompt: "You are a code analyst..."  âœï¸ â”‚
â”‚    â”œâ”€â”€ â–¸ llmHistory: Array(12)                       â”‚
â”‚    â”‚     â”œâ”€â”€ [0] { role: "system", content: "..." }  â”‚
â”‚    â”‚     â”œâ”€â”€ [1] { role: "user", content: "..." }    â”‚
â”‚    â”‚     â””â”€â”€ ...                                     â”‚
â”‚    â””â”€â”€ â–¸ availableTools: Array(5)                    â”‚
â”‚                                                      â”‚
â”‚  â–¸ llm                                               â”‚
â”‚    â”œâ”€â”€ iteration: 3                                  â”‚
â”‚    â”œâ”€â”€ â–¸ request: { messages: [...], tools: [...] }  â”‚
â”‚    â””â”€â”€ â–¸ tokenUsage: { prompt: 1024, completion: 0 } â”‚
â”‚                                                      â”‚
â”‚  â–¸ memory                                            â”‚
â”‚    â”œâ”€â”€ â–¸ shortTerm: Array(8)                         â”‚
â”‚    â””â”€â”€ â–¸ working: { currentTask: "åˆ†æè®¤è¯æ¨¡å—" }     â”‚
â”‚                                                      â”‚
â”‚  âœï¸ = å¯åœ¨æ–­ç‚¹æš‚åœæ—¶ç¼–è¾‘                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 12.6.5 å·¥å…·è°ƒç”¨æ£€æŸ¥å™¨ (Tool Call Inspector)

ä¸“é—¨ç”¨äºå·¥å…·è°ƒç”¨å‰åå¯¹æ¯”æ£€æŸ¥ï¼š

| è§†å›¾ | è¯´æ˜ |
|------|------|
| **Before è§†å›¾** | å·¥å…·å®šä¹‰ + è¾“å…¥å‚æ•°ï¼ˆJSON æ ¼å¼åŒ–ï¼‰+ å‚æ•° Schema æ ¡éªŒçŠ¶æ€ |
| **After è§†å›¾** | è¾“å‡ºç»“æœï¼ˆJSON æ ¼å¼åŒ–ï¼‰+ æ‰§è¡Œè€—æ—¶ + è¿”å›å€¼å¤§å° |
| **Diff å¯¹æ¯”** | é€‰ä¸­ä¸¤æ¬¡åŒåå·¥å…·è°ƒç”¨ï¼Œä¾§è¾¹ diff å¯¹æ¯” input/output å·®å¼‚ |
| **è°ƒç”¨é“¾** | å½“å‰ llmLoop ä¸­æ‰€æœ‰å·¥å…·è°ƒç”¨çš„æ—¶é—´çº¿ï¼ˆç”˜ç‰¹å›¾æ ·å¼ï¼‰ |
| **å¹²é¢„æ“ä½œ** | æš‚åœåœ¨ `tool.call.before` æ—¶ï¼šç¼–è¾‘å‚æ•° / è·³è¿‡è°ƒç”¨ / æ›¿æ¢è¿”å›å€¼ |

#### 12.6.6 LLM Loop æ—¶é—´çº¿ (LLM Loop Timeline)

ä»¥æ—¶é—´è½´æ–¹å¼å¯è§†åŒ–å•ä¸ª Agent çš„å®Œæ•´æ¨ç†å¾ªç¯ï¼š

```
LLM Loop Timeline â€” Agent 1-2 (analyst)
                                                                    
 Iteration 1          Iteration 2           Iteration 3        â† å½“å‰
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ ğŸ§  LLM Call â”‚      â”‚ ğŸ§  LLM Call â”‚       â”‚ ğŸ§  LLM   â”‚
 â”‚ 450 tokens  â”‚      â”‚ 820 tokens  â”‚       â”‚ 1024 tok â”‚
 â”‚ 1.2s        â”‚      â”‚ 2.1s        â”‚       â”‚ ...      â”‚
 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                    â”‚
        â–¼                     â–¼                    â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ ğŸ”§ read_fileâ”‚      â”‚ ğŸ”§ grep     â”‚       â”‚ â¸ PAUSED â”‚
 â”‚ 12ms        â”‚      â”‚ 45ms        â”‚       â”‚ tool.callâ”‚
 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚ .before  â”‚
        â”‚                     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–¼                     â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ ğŸ§  LLM Call â”‚      â”‚ ğŸ”§ read_fileâ”‚
 â”‚ 380 tokens  â”‚      â”‚ 8ms         â”‚
 â”‚ 0.9s        â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ ğŸ§  LLM Call â”‚
                       â”‚ 650 tokens  â”‚
                       â”‚ finish:stop â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             âœ…
```

| äº¤äº’ | è¯´æ˜ |
|------|------|
| ç‚¹å‡»èŠ‚ç‚¹ | å±•å¼€è¯¥æ­¥éª¤çš„è¯¦ç»†ä¿¡æ¯ï¼ˆLLM è¯·æ±‚/å“åº”ã€å·¥å…· input/outputï¼‰ |
| ç¼©æ”¾ | é¼ æ ‡æ»šè½®ç¼©æ”¾æ—¶é—´çº¿ |
| è¿‡æ»¤ | ä»…æ˜¾ç¤º LLM èŠ‚ç‚¹ / ä»…æ˜¾ç¤º Tool èŠ‚ç‚¹ |
| è·³è½¬ | å›æ”¾æ¨¡å¼ä¸‹ç‚¹å‡»èŠ‚ç‚¹è·³è½¬åˆ°è¯¥æ—¶é—´ç‚¹ |

### 12.7 è°ƒè¯•æ—¶åº â€” å®Œæ•´é“¾è·¯

```
å¼€å‘è€…                     Frontend Debug UI                Debug API              AgentRunner
  â”‚                              â”‚                            â”‚                        â”‚
  â”œâ”€â”€ æ‰“å¼€ Debug é¢æ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚                        â”‚
  â”‚                              â”œâ”€â”€ POST /debug/sessions â”€â”€â”€â–ºâ”‚                        â”‚
  â”‚                              â”‚â—„â”€â”€ { sessionId } â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€ attach(taskId) â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                              â”‚                            â”‚                        â”‚
  â”œâ”€â”€ è®¾ç½®æ–­ç‚¹                   â”‚                            â”‚                        â”‚
  â”‚   "tool.call.before"  â”€â”€â”€â”€â”€â”€â–ºâ”œâ”€â”€ POST /breakpoints â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€ addBreakpoint() â”€â”€â”€â”€â–ºâ”‚
  â”‚   condition: tool=read_file  â”‚â—„â”€â”€ { bpId } â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
  â”‚                              â”‚                            â”‚                        â”‚
  â”‚                              â”‚â—„â”€â”€ SSE: debug.log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€ llmLoop è¿è¡Œä¸­ â”€â”€â”€â”€â”€â”‚
  â”‚                              â”‚    (æ—¥å¿—é¢æ¿å®æ—¶æ»šåŠ¨)       â”‚                        â”‚
  â”‚                              â”‚                            â”‚                        â”‚
  â”‚                              â”‚â—„â”€â”€ SSE: breakpoint.hit â”€â”€â”€â”€â”‚â—„â”€â”€ checkpoint() â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                              â”‚    { tool: read_file,      â”‚    (æš‚åœç­‰å¾…)           â”‚
  â”‚                              â”‚      input: {...},          â”‚                        â”‚
  â”‚                              â”‚      agent: {...} }         â”‚                        â”‚
  â”‚                              â”‚                            â”‚                        â”‚
  â”œâ”€â”€ æŸ¥çœ‹ Tool Inspector â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚                        â”‚
  â”œâ”€â”€ æŸ¥çœ‹ Context Inspector â”€â”€â”€â–ºâ”‚                            â”‚                        â”‚
  â”œâ”€â”€ ä¿®æ”¹å‚æ•°                   â”‚                            â”‚                        â”‚
  â”‚   path â†’ "/src/new.ts" â”€â”€â”€â”€â”€â–ºâ”œâ”€â”€ POST /modify â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€ modifyContext() â”€â”€â”€â”€â–ºâ”‚
  â”‚                              â”‚â—„â”€â”€ { modified } â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
  â”‚                              â”‚                            â”‚                        â”‚
  â”œâ”€â”€ ç‚¹å‡» [Step Over] â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”œâ”€â”€ POST /step â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€ resume("step_over") â–ºâ”‚
  â”‚                              â”‚                            â”‚    (æ¢å¤æ‰§è¡Œ)           â”‚
  â”‚                              â”‚â—„â”€â”€ SSE: step.completed â”€â”€â”€â”€â”‚â—„â”€â”€ ä¸‹ä¸€ä¸ª checkpoint â”€â”€â”‚
  â”‚                              â”‚    (ä¸‹ä¸€ä¸ªæ–­ç‚¹ä¸Šä¸‹æ–‡)       â”‚                        â”‚
  â”‚                              â”‚                            â”‚                        â”‚
  â”œâ”€â”€ ç‚¹å‡» [Continue] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”œâ”€â”€ POST /continue â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€ resume("continue") â”€â–ºâ”‚
  â”‚                              â”‚                            â”‚    (ç»§ç»­è¿è¡Œ)           â”‚
  â”‚                              â”‚â—„â”€â”€ SSE: debug.log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€ ç»§ç»­ llmLoop â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                              â”‚    ...                      â”‚                        â”‚
```

### 12.8 è½¨è¿¹å›æ”¾ä¸å¯¹æ¯”åˆ†æ

è°ƒè¯•ç³»ç»Ÿå°†æ¯æ¬¡æ‰§è¡Œçš„å®Œæ•´è½¨è¿¹æŒä¹…åŒ–åˆ° `TraceStore`ï¼Œæ”¯æŒäº‹ååˆ†æï¼š

```typescript
// debug/trace-store.ts

export interface TraceRecord {
  id: string
  sessionId: string
  timestamp: Date
  type: "breakpoint.hit" | "resumed" | "variable.modified" | "log"
  location?: BreakpointLocation
  context?: DebugContext
  data?: Record<string, unknown>
}

/**
 * è½¨è¿¹å›æ”¾èƒ½åŠ›ï¼š
 * 
 * 1. æ—¶é—´çº¿å›æ”¾ â€” åœ¨ LLM Loop Timeline ä¸Šé€æ­¥å›æ”¾å†å²æ‰§è¡Œ
 * 2. ä¸Šä¸‹æ–‡è¿˜åŸ â€” å›æ”¾åˆ°ä»»æ„æ—¶é—´ç‚¹ï¼Œè¿˜åŸå½“æ—¶çš„ DebugContext
 * 3. æ‰§è¡Œå¯¹æ¯” â€” é€‰æ‹©ä¸¤æ¬¡æ‰§è¡Œè½¨è¿¹ï¼Œå¯¹æ¯”ï¼š
 *    - LLM è°ƒç”¨æ¬¡æ•°å·®å¼‚
 *    - Token æ¶ˆè€—å¯¹æ¯”
 *    - å·¥å…·è°ƒç”¨åºåˆ— diff
 *    - æœ€ç»ˆç»“æœ diff
 * 4. æ¨¡å¼è¯†åˆ« â€” è¯†åˆ«é‡å¤å¤±è´¥æ¨¡å¼ï¼ˆå¦‚åŒä¸€å·¥å…·åå¤è°ƒç”¨å¤±è´¥ï¼‰
 * 5. å¯¼å‡º â€” è½¨è¿¹å¯¼å‡ºä¸º JSON / OpenTelemetry æ ¼å¼ï¼Œä¾›å¤–éƒ¨åˆ†æ
 */

export interface TraceDiff {
  summary: {
    traceA: { id: string; duration: number; llmCalls: number; toolCalls: number; totalTokens: number }
    traceB: { id: string; duration: number; llmCalls: number; toolCalls: number; totalTokens: number }
  }
  diffs: {
    type: "added" | "removed" | "changed"
    path: string
    valueA?: unknown
    valueB?: unknown
  }[]
}
```

### 12.9 æ€§èƒ½å½±å“ä¸ç”Ÿäº§å®‰å…¨

| å…³æ³¨ç‚¹ | è®¾è®¡ç­–ç•¥ |
|--------|---------|
| **è°ƒè¯•å¼€é”€** | æ—  DebugSession é™„åŠ æ—¶ï¼Œæ‰€æœ‰ `checkpoint()` è°ƒç”¨ä¸ºç©ºæ“ä½œï¼ˆ`debug?.checkpoint` çŸ­è·¯ï¼‰ï¼Œé›¶å¼€é”€ |
| **ç”Ÿäº§ç¯å¢ƒ** | è°ƒè¯• API é»˜è®¤ä»…åœ¨ `NODE_ENV=development` æˆ– `config.debug.enabled=true` æ—¶å¯ç”¨ |
| **å†…å­˜å ç”¨** | `DebugContext` å¿«ç…§æŒ‰éœ€æ„å»ºï¼ˆ`contextBuilder` æƒ°æ€§æ±‚å€¼ï¼‰ï¼Œä»…åœ¨æ–­ç‚¹å‘½ä¸­æ—¶åˆ›å»º |
| **è½¨è¿¹å­˜å‚¨** | `TraceStore` æ”¯æŒ TTL è‡ªåŠ¨æ¸…ç†ï¼Œé»˜è®¤ä¿ç•™æœ€è¿‘ 100 æ¬¡è°ƒè¯•è½¨è¿¹ |
| **å¹¶å‘å®‰å…¨** | æ¯ä¸ª Task æœ€å¤šé™„åŠ ä¸€ä¸ª DebugSessionï¼Œé¿å…å¤šä¼šè¯ç«äº‰ |
| **SSE å¸¦å®½** | æ—¥å¿—äº‹ä»¶é‡‡æ ·ï¼ˆ`trace` çº§åˆ«é»˜è®¤ä¸æ¨é€ï¼‰ï¼Œæ–­ç‚¹äº‹ä»¶å…¨é‡æ¨é€ |

---

## 13. å®ç°è·¯çº¿å›¾

### 13.1 é˜¶æ®µåˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®ç°è·¯çº¿å›¾                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Phase 1: æ ¸å¿ƒæŠ½è±¡ (4 å‘¨)                                                    â”‚
â”‚  â”œâ”€â”€ Domain é¢†åŸŸæŠ½è±¡                                                         â”‚
â”‚  â”œâ”€â”€ Agent æ³¨å†Œç³»ç»Ÿé‡æ„                                                      â”‚
â”‚  â”œâ”€â”€ Tool æ³¨å†Œç³»ç»Ÿé‡æ„                                                       â”‚
â”‚  â””â”€â”€ é…ç½®ç³»ç»Ÿæ‰©å±•                                                            â”‚
â”‚                                                                              â”‚
â”‚  Phase 2: Workflow å¼•æ“ (4 å‘¨)                                               â”‚
â”‚  â”œâ”€â”€ Workflow å®šä¹‰è§„èŒƒ                                                       â”‚
â”‚  â”œâ”€â”€ æ­¥éª¤æ‰§è¡Œå™¨å®ç°                                                          â”‚
â”‚  â”œâ”€â”€ çŠ¶æ€æœºç®¡ç†                                                              â”‚
â”‚  â””â”€â”€ é”™è¯¯å¤„ç†ä¸æ¢å¤                                                          â”‚
â”‚                                                                              â”‚
â”‚  Phase 3: Swarm èœ‚ç¾¤ç³»ç»Ÿ (5 å‘¨) â˜… æ–°å¢                                       â”‚
â”‚  â”œâ”€â”€ Agent åŠ¨æ€åˆ›å»º/é”€æ¯                                                     â”‚
â”‚  â”œâ”€â”€ æ¶ˆæ¯ç³»ç»Ÿ (create + send åŸè¯­)                                           â”‚
â”‚  â”œâ”€â”€ Runner Pool è¿è¡Œæ—¶                                                      â”‚
â”‚  â”œâ”€â”€ æ‹“æ‰‘ç®¡ç†ä¸å¯è§†åŒ–                                                        â”‚
â”‚  â””â”€â”€ åŠ¨æ€æ‰©ç¼©å®¹ç­–ç•¥                                                          â”‚
â”‚                                                                              â”‚
â”‚  Phase 4: Web äº§å“ç³»ç»Ÿ (6 å‘¨)                                                â”‚
â”‚  â”œâ”€â”€ Space é¡¹ç›®ç©ºé—´æ¨¡å‹ + API                                                  â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·ç«¯: AI å¯¹è¯ + Plan/Execute åŒæ¨¡å¼                                     â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·ç«¯: è¿­ä»£çœ‹æ¿ + ä»“åº“æµè§ˆ + æ–‡æ¡£ä¸­å¿ƒ                                  â”‚
â”‚  â”œâ”€â”€ ç®¡ç†ç«¯: Agent/Tool/Workflow Builder                                       â”‚
â”‚  â”œâ”€â”€ Swarm Graph å¯è§†åŒ– â˜… æ–°å¢                                               â”‚
â”‚  â””â”€â”€ ç›‘æ§ Dashboard                                                          â”‚
â”‚                                                                              â”‚
â”‚  Phase 5: åœºæ™¯æ¨¡æ¿ (4 å‘¨)                                                    â”‚
â”‚  â”œâ”€â”€ æ¨¡æ¿ç³»ç»Ÿå®ç°                                                            â”‚
â”‚  â”œâ”€â”€ é¢„ç½®æ¨¡æ¿å¼€å‘                                                            â”‚
â”‚  â”‚   â”œâ”€â”€ éœ€æ±‚åˆ†ææ¨¡æ¿                                                        â”‚
â”‚  â”‚   â”œâ”€â”€ BUG ä¿®å¤æ¨¡æ¿                                                        â”‚
â”‚  â”‚   â”œâ”€â”€ ç‰¹æ€§å¼€å‘æ¨¡æ¿                                                        â”‚
â”‚  â”‚   â””â”€â”€ æ–‡æ¡£æ’°å†™æ¨¡æ¿                                                        â”‚
â”‚  â””â”€â”€ æ¨¡æ¿å¸‚åœº MVP                                                            â”‚
â”‚                                                                              â”‚
â”‚  Phase 6: å®‰å…¨ä¸ä¼˜åŒ– (4 å‘¨)                                                  â”‚
â”‚  â”œâ”€â”€ æƒé™ç³»ç»Ÿæ‰©å±•                                                            â”‚
â”‚  â”œâ”€â”€ æ²™ç®±æ‰§è¡Œç¯å¢ƒ                                                            â”‚
â”‚  â”œâ”€â”€ å®¡è®¡æ—¥å¿—                                                                â”‚
â”‚  â””â”€â”€ æ€§èƒ½ä¼˜åŒ–                                                                â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | æ—¶é—´ | äº¤ä»˜ç‰© |
|--------|------|--------|
| M1 | Week 4 | æ ¸å¿ƒæŠ½è±¡å±‚ï¼Œå¯é€šè¿‡é…ç½®æ³¨å†Œè‡ªå®šä¹‰ Agent/Tool |
| M2 | Week 8 | Workflow å¼•æ“ï¼Œæ”¯æŒ YAML å®šä¹‰å·¥ä½œæµ |
| M3 | Week 13 | Swarm èœ‚ç¾¤ç³»ç»Ÿï¼Œæ”¯æŒåŠ¨æ€åˆ›å»º/åä½œ/æ‰©å®¹ â˜… |
| M4 | Week 19 | Web ç”¨æˆ·ç«¯ MVP + ç®¡ç†ç«¯ MVP + Space + Swarm å¯è§†åŒ– |
| M5 | Week 23 | 4 ä¸ªåœºæ™¯æ¨¡æ¿å¯ç”¨ |
| M6 | Week 27 | å®Œæ•´å®‰å…¨ä½“ç³»ï¼Œç”Ÿäº§å°±ç»ª |
| M7 | Week 31 | Agent è¯„ä¼°ä½“ç³» MVPï¼ŒCI/CD é›†æˆ â˜… |

---

## 14. API è®¾è®¡

### 14.1 Agent SDK

```typescript
// @aspect-build/agent-sdk
import { defineAgent, AgentContext } from "@aspect-build/agent-sdk"

// å®šä¹‰ Agent
export const myAgent = defineAgent({
  id: "my-agent",
  name: "My Agent",
  domain: "custom",
  category: "specialist",
  
  // èƒ½åŠ›å£°æ˜
  capabilities: ["document.read", "document.write"],
  
  // å·¥å…·ç»‘å®š
  tools: ["read", "write", "search"],
  
  // System Prompt
  systemPrompt: `You are a specialized agent for...`,
  
  // ç”Ÿå‘½å‘¨æœŸé’©å­
  hooks: {
    beforeExecute: async (ctx: AgentContext, input: string) => {
      // é¢„å¤„ç†
    },
    afterExecute: async (ctx: AgentContext, output: string) => {
      // åå¤„ç†
    },
  },
})
```

### 14.2 Tool SDK

```typescript
// @aspect-build/tool-sdk
import { defineTool, ToolContext, z } from "@aspect-build/tool-sdk"

// å®šä¹‰ Tool
export const myTool = defineTool({
  id: "my-tool",
  name: "My Tool",
  category: "utility",
  
  // å‚æ•°å®šä¹‰
  parameters: z.object({
    input: z.string().describe("Input value"),
    options: z.object({
      format: z.enum(["json", "yaml", "text"]).default("json"),
    }).optional(),
  }),
  
  // æ‰§è¡Œå‡½æ•°
  async execute(params, ctx: ToolContext) {
    // è¯·æ±‚æƒé™
    await ctx.ask({
      permission: "custom",
      patterns: [params.input],
      metadata: {},
    })
    
    // æ‰§è¡Œé€»è¾‘
    const result = await processInput(params.input, params.options)
    
    return {
      title: "Processed input",
      output: result,
      metadata: { format: params.options?.format },
    }
  },
})
```

### 14.3 Workflow SDK

```typescript
// @aspect-build/workflow-sdk
import { defineWorkflow, step, condition, parallel } from "@aspect-build/workflow-sdk"

// å®šä¹‰ Workflow
export const myWorkflow = defineWorkflow({
  id: "my-workflow",
  name: "My Workflow",
  
  inputs: z.object({
    data: z.string(),
  }),
  
  steps: [
    // Agent æ­¥éª¤
    step.agent({
      id: "analyze",
      agent: "analyst",
      input: "Analyze: {{ inputs.data }}",
      output: "analysis",
    }),
    
    // æ¡ä»¶åˆ†æ”¯
    condition({
      id: "check",
      if: "steps.analyze.output.includes('critical')",
      then: [
        step.agent({
          id: "escalate",
          agent: "escalation-handler",
          input: "Handle critical issue: {{ steps.analyze.output }}",
        }),
      ],
      else: [
        step.tool({
          id: "log",
          tool: "log_event",
          params: { message: "{{ steps.analyze.output }}" },
        }),
      ],
    }),
    
    // å¹¶è¡Œæ‰§è¡Œ
    parallel({
      id: "notify",
      branches: [
        [step.tool({ id: "email", tool: "send_email", params: {} })],
        [step.tool({ id: "slack", tool: "send_slack", params: {} })],
      ],
    }),
  ],
})
```

### 14.4 Swarm SDK

```typescript
// @aspect-build/swarm-sdk
import { SwarmClient, defineSwarmAgent } from "@aspect-build/swarm-sdk"

// åˆ›å»º Swarm å®¢æˆ·ç«¯
const swarm = new SwarmClient({
  workspaceId: "ws-123",
})

// åŠ¨æ€åˆ›å»º Agent
const coder = await swarm.createAgent({
  role: "coder",
  tools: ["read", "write", "edit", "bash"],
  task: "å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½",
})

// å‘é€æ¶ˆæ¯
await swarm.sendMessage({
  to: coder.id,
  content: "è¯·å…ˆåˆ†æ src/auth ç›®å½•çš„ä»£ç ç»“æ„",
})

// ç›‘å¬äº‹ä»¶
swarm.on("agent.created", (agent) => {
  console.log(`æ–° Agent åˆ›å»º: ${agent.role}(${agent.roleIndex})`)
})

swarm.on("message.created", (msg) => {
  console.log(`[${msg.senderRole}] ${msg.content}`)
})

swarm.on("topology.changed", (topology) => {
  renderTopologyGraph(topology)
})

// å®šä¹‰è‡ªç»„ç»‡ Agent
export const autoScalingAgent = defineSwarmAgent({
  role: "task-coordinator",
  
  // è‡ªåŠ¨æ‰©å®¹è§„åˆ™
  scaling: {
    // å½“æ¶ˆæ¯é˜Ÿåˆ—è¶…è¿‡é˜ˆå€¼æ—¶åˆ›å»ºå­ Agent
    onHighLoad: async (ctx) => {
      const worker = await ctx.createAgent({
        role: "worker",
        task: "å¤„ç†ç§¯å‹ä»»åŠ¡",
      })
      await ctx.delegateTo(worker, ctx.pendingTasks)
    },
    
    // å­ Agent ç©ºé—²æ—¶è‡ªåŠ¨å›æ”¶
    idleTimeout: 300000, // 5 åˆ†é’Ÿ
  },
  
  // åä½œè§„åˆ™
  collaboration: {
    // é‡åˆ°ä¸ç†Ÿæ‚‰çš„ä»»åŠ¡æ—¶å’¨è¯¢ä¸“å®¶
    onUnknownTask: async (ctx, task) => {
      const expert = await ctx.findAgent({ 
        capability: task.requiredCapability 
      })
      if (expert) {
        return ctx.askFor(expert, task)
      } else {
        return ctx.createAgent({
          role: `${task.requiredCapability}-expert`,
          task: task.description,
        })
      }
    },
  },
})
```

---

## 15. ç¤ºä¾‹åœºæ™¯

> ä»¥ä¸‹ç¤ºä¾‹å±•ç¤º API è°ƒç”¨æ¨¡å¼ã€‚æ¨¡æ¿å®šä¹‰è¯¦è§ [9.2 å†…ç½®æ¨¡æ¿](#92-å†…ç½®åœºæ™¯æ¨¡æ¿)ï¼ŒSwarm åä½œè¯¦è§ [ç¬¬ 7 èŠ‚](#7-swarm-èœ‚ç¾¤ç³»ç»Ÿ)ã€‚

### 15.1 æ¨¡æ¿é©±åŠ¨åœºæ™¯

| æ¨¡æ¿ | ç”¨é€” | å…³é”®è¾“å…¥ |
|------|------|----------|
| `requirement-analysis` | éœ€æ±‚åˆ†æ | projectName, projectType |
| `bug-fix` | BUG ä¿®å¤ | bugId, description, reproduction, environment |
| `prd-writing` | PRD æ’°å†™ | productName, targetUsers |

```typescript
// ç»Ÿä¸€è°ƒç”¨æ¨¡å¼ï¼ˆä»¥ BUG ä¿®å¤ä¸ºä¾‹ï¼‰
const session = await platform.createSession({
  template: "bug-fix",
  inputs: { bugId: "BUG-12345", description: "ç™»å½•åç™½å±" },
})
// Agent æŒ‰æ¨¡æ¿å®šä¹‰çš„å·¥ä½œæµè‡ªåŠ¨æ‰§è¡Œï¼šæ—¥å¿—åˆ†æ â†’ å®šä½ â†’ æ ¹å›  â†’ ä¿®å¤ â†’ éªŒè¯
```

### 15.2 Swarm èœ‚ç¾¤åä½œåœºæ™¯

```typescript
// ä½¿ç”¨ Swarm æ¨¡å¼å¤„ç†å¤æ‚ä»»åŠ¡
const swarm = await platform.createSwarm({
  workspaceId: "project-alpha",
})

// äººç±»å‘èµ·ä»»åŠ¡
await swarm.sendMessage({
  content: `
    æˆ‘ä»¬éœ€è¦é‡æ„æ•´ä¸ªè®¤è¯æ¨¡å—ï¼š
    1. åˆ†æç°æœ‰ä»£ç ç»“æ„
    2. è®¾è®¡æ–°çš„è®¤è¯æ¶æ„
    3. å®ç° JWT + OAuth2 æ”¯æŒ
    4. ç¼–å†™å•å…ƒæµ‹è¯•
    5. æ›´æ–° API æ–‡æ¡£
  `,
})

// ä¸» Agent è‡ªåŠ¨åˆ†è§£ä»»åŠ¡ï¼ŒåŠ¨æ€åˆ›å»ºå­ Agentï¼ˆæ‹“æ‰‘æ¼”åŒ–è¯¦è§ 7.3-7.5ï¼‰

// äººç±»å¯éšæ—¶ä»‹å…¥ä»»æ„ Agent
await swarm.chatWith("1-3-2", `
  OAuth2 çš„ scope è®¾è®¡éœ€è¦è€ƒè™‘å“ªäº›åœºæ™¯ï¼Ÿ
`)

// æŸ¥çœ‹å®æ—¶æ‹“æ‰‘
const topology = await swarm.getTopology()
console.log(topology.toASCII())

// æŸ¥çœ‹æŸä¸ª Agent çš„ LLM å†å²ï¼ˆä¸å†æ˜¯é»‘ç®±ï¼‰
const history = await swarm.getAgentHistory("1-3")
console.log(history.messages)
```

---

## æ€»ç»“

æœ¬è®¾è®¡æ–¹æ¡ˆå°† Vitamin-Code å®šä½ä¸ºé€šç”¨ Agent å¹³å°ï¼Œèåˆ Swarm èœ‚ç¾¤æ™ºèƒ½æ€æƒ³ä¸ Anthropic Agent è¯„ä¼°ç†å¿µï¼Œæ ¸å¿ƒèƒ½åŠ›åŒ…æ‹¬ï¼š

1. **é¢†åŸŸæŠ½è±¡** - æ”¯æŒå¤šç§ä¸šåŠ¡é¢†åŸŸï¼ˆç¼–ç ã€åˆ†æã€æ–‡æ¡£ã€æµ‹è¯•ç­‰ï¼‰
2. **æ³¨å†Œç³»ç»Ÿ** - Agent å’Œ Tool å¯åŠ¨æ€æ³¨å†Œã€çƒ­æ’æ‹”
3. **å·¥ä½œæµå¼•æ“** - æ”¯æŒå¤æ‚ä¸šåŠ¡æµç¨‹ç¼–æ’
4. **Swarm èœ‚ç¾¤ç³»ç»Ÿ** - åŠ¨æ€åˆ›å»ºã€è‡ªç»„ç»‡åä½œã€å¼¹æ€§æ‰©ç¼©å®¹ â˜…
5. **Web äº§å“** - ç”¨æˆ·ç«¯ï¼ˆAI å¯¹è¯ + Plan/Executeï¼‰+ ç®¡ç†ç«¯ï¼ŒåŸºäº Space é¡¹ç›®ç©ºé—´ â˜…
6. **åœºæ™¯æ¨¡æ¿** - å¼€ç®±å³ç”¨çš„ä¸šåŠ¡åœºæ™¯ + AI åŠ¨æ€æåˆæ¨¡æ¿ â˜…
7. **å®‰å…¨ä½“ç³»** - ç»†ç²’åº¦æƒé™æ§åˆ¶å’Œå®¡è®¡
8. **è¯„ä¼°ä½“ç³»** - ç³»ç»ŸåŒ– Agent è¯„ä¼°ï¼ŒCI/CD é›†æˆï¼Œå¤šå±‚è´¨é‡é˜²çº¿ â˜…
9. **å¯è§†åŒ–è°ƒè¯•** - æ–­ç‚¹è°ƒè¯•ã€ä¸Šä¸‹æ–‡æ£€æŸ¥ã€è½¨è¿¹å›æ”¾ï¼ŒAgent ä¸å†æ˜¯é»‘ç®± â˜…

### Swarm èœ‚ç¾¤æ ¸å¿ƒä»·å€¼

- **æç®€åŸè¯­** â€” åªéœ€ `create` + `send` ä¸¤ä¸ªåŸè¯­å³å¯æ„å»ºä»»æ„å¤æ‚çš„å¤š Agent ç³»ç»Ÿ
- **æ¶²æ€æ‹“æ‰‘** â€” Agent æŒ‰éœ€åˆ›å»ºï¼Œæ‹“æ‰‘åœ¨è¿è¡Œæ—¶è‡ªæ¼”åŒ–ï¼Œæ— éœ€é¢„è®¾å›ºå®šç»“æ„
- **æ‰å¹³åä½œ** â€” äººç±»å¯éšæ—¶ä»‹å…¥ä»»æ„å±‚çº§çš„ Agentï¼Œåƒå¾®ä¿¡èŠå¤©ä¸€æ ·è‡ªç„¶
- **å¼¹æ€§æ‰©ç¼©å®¹** â€” æ ¹æ®è´Ÿè½½è‡ªåŠ¨æ‰©å®¹ï¼Œç©ºé—²æ—¶è‡ªåŠ¨ç¼©å®¹
- **å¯è§‚æµ‹æ€§** â€” å®æ—¶å¯è§†åŒ–æ‹“æ‰‘å›¾ã€æ¶ˆæ¯æµã€LLM å†å²ï¼ŒAgent ä¸å†æ˜¯é»‘ç®±
- **å¯è°ƒè¯•æ€§** â€” æ–­ç‚¹æœºåˆ¶è´¯ç©¿ LLM Loop / å·¥å…·è°ƒç”¨ / æ¶ˆæ¯ä¼ é€’å…¨é“¾è·¯ï¼Œæ”¯æŒæš‚åœæ£€æŸ¥ã€å˜é‡ä¿®æ”¹ã€è½¨è¿¹å›æ”¾ï¼ˆÂ§12ï¼‰

é€šè¿‡è¿™äº›è®¾è®¡ï¼ŒVitamin-Code å°†æˆä¸ºä¸€ä¸ª**å¯æ‰©å±•ã€å¯é…ç½®ã€å¯ç»„åˆã€å¯è‡ªç»„ç»‡ã€å¯è¯„ä¼°ã€å¯è°ƒè¯•**çš„é€šç”¨ AI Agent å¹³å°ã€‚
